<%- include('partials/header') %>

<% const isAdminUserFlag = authUser && ['admin','super_admin','global_admin'].includes(authUser.role); %>
<% const isSuperAdminUserFlag = authUser && ['super_admin','global_admin'].includes(authUser.role); %>
<% const viewerHasBlockedUser = blockState && blockState.viewerBlocked; %>
<% const userIsBlockedByOther = blockState && blockState.blockedByOther; %>
<div class="messages-page">
  <% const participantCount = (typeof participants !== 'undefined' && participants ? participants.length : 0); %>
  <% const conversationCount = (typeof conversations !== 'undefined' && conversations ? conversations.length : 0); %>
  <div class="messages-header">
    <div class="messages-header-left">
      <p class="messages-kicker">Inbox</p>
      <div class="messages-title-row">
        <h1 class="messages-title">Messages</h1>
        <span class="header-chip live">Live</span>
      </div>
      <div class="messages-meta-row">
        <span><strong><%= participantCount || 0 %></strong> active members</span>
        <span><strong><%= conversationCount || 0 %></strong> conversations</span>
      </div>
    </div>
    <div class="messages-header-actions">
      <button type="button" class="header-btn" id="shareConversationBtn" onclick="shareConversation()" <%= currentConversation ? '' : 'disabled' %>>Share</button>
      <button type="button" class="header-btn secondary" id="headerTipsBtn" onclick="showPinnedTips()" <%= currentConversation && currentConversation.is_group ? '' : 'disabled' %>>Tips</button>
      <button type="button" class="header-btn primary" id="headerAddBtn" onclick="toggleInlineAddMember()" <%= currentConversation && currentConversation.is_group ? '' : 'disabled' %>>Add people</button>
    </div>
  </div>

  <% if (isAdminUserFlag) { %>
    <div class="admin-banner">
      <div class="admin-banner-copy">
        <strong>Admin tools enabled.</strong>
        <span>Review, flag, or jump to latest messages without leaving this screen.</span>
      </div>
      <div class="admin-banner-actions">
        <button type="button" class="header-btn secondary" onclick="scrollToBottom()"><span class="icon-down"></span> Jump to latest</button>
        <button type="button" class="header-btn" onclick="toggleAdminMenu(event)"><span class="icon-dots"></span></button>
      </div>
    </div>
  <% } %>

  <section class="messages-layout">
  <!-- Conversations Column -->
  <aside class="conversations-column">
    <div class="conversations-header">
      <div>
        <p class="conversations-kicker">Inbox ‚Ä¢ Live</p>
        <h2 class="conversations-title">Conversations</h2>
      </div>
      <div class="conversation-actions">
        <button type="button" class="compact-button" id="newGroupBtn" title="New Group"><span class="icon-circle">+</span> New Group</button>
      </div>
    </div>
    <div class="conversation-search">
            <div class="conversation-search-icon" aria-hidden="true"></div>
      <input type="text" class="conversation-search-input" placeholder="Search" aria-label="Search conversations" />
    </div>
    <ul class="conversation-list" role="list">
      <% if(conversations && conversations.length > 0) { %>
        <% conversations.forEach(function(conv){ %>
          <li class="conversation-item <%= currentConversation && currentConversation.id === conv.id ? 'active' : '' %>" data-conversation-id="<%= conv.id %>" onclick="switchConversation('<%= conv.id %>')">
            <% if (conv.other_user_picture) { %>
              <img src="/uploads/<%= conv.other_user_picture %>" alt="<%= conv.other_user_name %>" class="conversation-avatar" style="object-fit:cover;border-radius:50%;width:48px;height:48px;cursor:pointer;" ondblclick="event.stopPropagation();window.location.href='/profile/<%= conv.other_user_id %>'">
            <% } else { %>
              <div class="conversation-avatar" style="cursor:pointer;" ondblclick="event.stopPropagation();window.location.href='/profile/<%= conv.other_user_id %>'"><%= (conv.other_user_name || 'U').charAt(0) %></div>
            <% } %>
            <div class="conversation-meta">
              <span class="conversation-name"><%= conv.other_user_name %></span>
              <% if (conv.last_message) { %>
                <span class="conversation-last"><%= conv.last_message %></span>
              <% } else { %>
                <span class="conversation-last empty">No messages yet</span>
              <% } %>
            </div>
            <div class="conversation-pill <%= conv.is_group ? 'pill-group' : 'pill-direct' %>"><%= conv.is_group ? 'Group' : 'Direct' %></div>
            <div class="conversation-time"><%= conv.last_message_time || '' %></div>
            <% if(conv.unread_count > 0){ %>
              <span class="conversation-unread"><%= conv.unread_count %></span>
            <% } %>
          </li>
        <% }); %>
      <% } else { %>
        <li class="conversation-item empty-state">
          <span class="empty-title">No conversations yet</span>
          <span class="empty-subtitle">Start by messaging someone from their profile.</span>
        </li>
      <% } %>
    </ul>
  </aside>

  <!-- Chat Column -->
  <div class="chat-column">
    <div class="chat-surface">
    <% if(currentConversation) { %>
      <header class="chat-header">
        <div class="chat-header-left">
          <% if (currentConversation.is_group) { %>
            <div class="chat-avatar chat-avatar-gradient">GX</div>
            <div class="chat-partner-info">
              <span class="chat-partner-name"><%= currentConversation.group_name || 'Group Chat' %></span>
              <span class="chat-partner-passion" style="background:#667eea;"><%= participants.length %> members</span>
            </div>
          <% } else { %>
            <% if (currentConversation.other_user_picture) { %>
              <img src="/uploads/<%= currentConversation.other_user_picture %>" alt="<%= currentConversation.other_user_name %>" class="chat-avatar" style="object-fit:cover;border-radius:50%;width:48px;height:48px;cursor:pointer;" ondblclick="window.location.href='/profile/<%= currentConversation.other_user_id %>'">
            <% } else { %>
              <div class="chat-avatar" style="cursor:pointer;" ondblclick="window.location.href='/profile/<%= currentConversation.other_user_id %>'"><%= (currentConversation.other_user_name || 'U').charAt(0) %></div>
            <% } %>
            <div class="chat-partner-info">
              <span class="chat-partner-name"><%= currentConversation.other_user_name %></span>
              <span class="chat-partner-passion">DreamX Member</span>
            </div>
          <% } %>
        </div>
        <div class="chat-header-actions">
          <div class="chat-quick-actions">
            <% if (currentConversation.is_group) { %>
              <button type="button" class="pill-action" onclick="openGroupSettings()"><span class="icon-dot"></span> Group Settings</button>
              <button type="button" class="pill-action ghost" data-role="share-group" onclick="copyGroupShare()"><span class="icon-link"></span> Share group</button>
            <% } else { %>
              <a href="/profile/<%= currentConversation.other_user_id %>" class="pill-link"><span class="icon-user"></span> View Profile</a>
            <% } %>
          </div>
          <div class="chat-safety">
            <button type="button" class="icon-button" onclick="toggleSafetyMenu(event)" aria-label="Safety controls"><span class="icon-shield"></span></button>
            <div class="safety-menu" id="safetyMenu">
              <div class="safety-menu-header">
                <span>Safety controls</span>
                <% if (!currentConversation.is_group && viewerHasBlockedUser) { %>
                  <span class="menu-status-pill blocked">Blocked</span>
                <% } else if (!currentConversation.is_group && userIsBlockedByOther) { %>
                  <span class="menu-status-pill muted">They blocked you</span>
                <% } %>
              </div>
              <% if (!currentConversation.is_group && viewerHasBlockedUser) { %>
                <div class="safety-menu-banner">You've blocked this user. Unblock to let them reach out again.</div>
              <% } %>
              <button type="button" class="safety-item" onclick="reportConversation()"><span class="icon-flag"></span> Report conversation</button>
              <% if (!currentConversation.is_group) { %>
                <% if (viewerHasBlockedUser) { %>
                  <button type="button" class="safety-item" onclick="unblockConversationUser('<%= currentConversation.other_user_id %>')"><span class="icon-unblock"></span> Unblock <%= currentConversation.other_user_name %></button>
                <% } else { %>
                  <button type="button" class="safety-item danger" onclick="blockConversationUser('<%= currentConversation.other_user_id %>')"><span class="icon-block"></span> Block <%= currentConversation.other_user_name %></button>
                <% } %>
              <% } else { %>
                <button type="button" class="safety-item" onclick="toggleInlineAddMember()"><span class="icon-plus"></span> Add people</button>
              <% } %>
            </div>
          </div>
          <% if (authUser && ['admin','super_admin','global_admin'].includes(authUser.role)) { %>
            <div class="chat-admin">
              <span class="admin-mode-pill" title="Admin controls active">Admin</span>
              <button type="button" class="icon-button" aria-label="Admin actions" onclick="toggleAdminMenu(event)"><span class="icon-dots"></span></button>
              <div class="safety-menu" id="adminMenu">
                <div class="safety-menu-header">Admin actions</div>
                <button type="button" class="safety-item" onclick="reportConversation(true)"><span class="icon-flag"></span> Flag content</button>
                <% if (!currentConversation.is_group) { %>
                  <% if (viewerHasBlockedUser) { %>
                    <button type="button" class="safety-item" onclick="unblockConversationUser(<%= currentConversation.other_user_id %>)"><span class="icon-unblock"></span> Unblock participant</button>
                  <% } else { %>
                    <button type="button" class="safety-item" onclick="blockConversationUser(<%= currentConversation.other_user_id %>)"><span class="icon-block"></span> Block participant</button>
                  <% } %>
                  <% if (isSuperAdminUserFlag) { %>
                    <button type="button" class="safety-item" onclick="suspendConversationUser(<%= currentConversation.other_user_id %>)"><span class="icon-pause"></span> Suspend user</button>
                  <% } %>
                  <button type="button" class="safety-item" id="freezeActionBtn" onclick="toggleChatFreeze(<%= currentConversation.other_user_id %>)"><span class="icon-snow"></span> Toggle chat freeze</button>
                <% } else { %>
                  <button type="button" class="safety-item" onclick="openGroupSettings()"><span class="icon-gear"></span> Manage group</button>
                <% } %>
                <button type="button" class="safety-item" onclick="scrollToBottom()"><span class="icon-down"></span> Jump to latest</button>
              </div>
            </div>
          <% } %>
        </div>
      </header>

      <div class="chat-top-badges">
        <span class="pill-soft">Threaded replies are on</span>
        <span class="pill-soft">Reactions ready</span>
      </div>

      <% if (currentConversation.is_group) { %>
        <div class="group-meta-bar">
          <div class="group-avatar-stack">
            <% participants.slice(0,6).forEach(function(p){ %>
              <% if (p.profile_picture) { %>
                <img src="/uploads/<%= p.profile_picture %>" alt="<%= p.full_name %>" />
              <% } else { %>
                <div class="group-initial"><%= p.full_name.charAt(0) %></div>
              <% } %>
            <% }); %>
            <% if (participants.length > 6) { %>
              <div class="group-more">+<%= participants.length - 6 %></div>
            <% } %>
          </div>
          <div class="group-meta-actions">
            <button type="button" class="ghost-pill" id="inlineAddBtn" onclick="toggleInlineAddMember()" aria-expanded="false">‚ûï Add people</button>
            <button type="button" class="ghost-pill" id="tipsToggleBtn" onclick="showPinnedTips()" aria-expanded="false">üìå Tips</button>
          </div>
        </div>
        <div id="inlineAddMember" class="inline-add-member" style="display:none;">
          <input type="text" id="inlineAddMemberInput" placeholder="Search people to invite" aria-label="Add member" />
          <div id="inlineAddMemberResults"></div>
        </div>
        <div id="groupTips" class="group-tips" style="display:none;">
          <p class="tips-title">Group superpowers</p>
          <ul>
            <li>Reply in-thread to keep context.</li>
            <li>Long-press or hover for quick reactions.</li>
            <li>Use the share link to bring teammates in fast.</li>
          </ul>
        </div>
      <% } %>

      <div class="chat-history" id="chatHistory" aria-live="polite">
        <% if(messages && messages.length > 0) { %>
          <% messages.forEach(function(msg){ %>
            <div class="chat-message-wrapper <%= msg.sender_id === authUser.id ? 'outgoing' : 'incoming' %>" data-message-id="<%= msg.id %>" data-created-at="<%= msg.created_at %>" data-sender-name="<%= msg.sender_name %>" data-reply-preview="<%= (msg.content || (msg.attachment_url ? 'Attachment' : '')) %>" data-reply-has-attachment="<%= msg.attachment_url ? 'true' : 'false' %>" data-reaction-counts='<%- JSON.stringify(msg.reaction_counts || {}) %>'>
              <div class="chat-bubble-container" style="position:relative;display:inline-block;">
                <div class="chat-bubble">
                  <% if (msg.reply_to_message_id) { %>
                    <div class="reply-context">
                      <div class="reply-author"><%= msg.reply_sender_name || 'Reply' %></div>
                      <% if (msg.reply_attachment_url) { %>
                        <div class="reply-preview">üìé <%= msg.reply_content && msg.reply_content.length ? msg.reply_content.substring(0,80) : 'Attachment' %></div>
                      <% } else { %>
                        <div class="reply-preview"><%= (msg.reply_content || 'Replied message') %></div>
                      <% } %>
                    </div>
                  <% } %>
                  <% if (msg.content) { %>
                    <p class="chat-text"><%= msg.content %></p>
                  <% } else if (msg.attachment_url) { %>
                    <p class="chat-text" style="font-size:0.85rem;opacity:0.8;">üìé <%= msg.attachment_url.split('/').pop().replace(/^chat-\d+-\d+-/, '') %></p>
                  <% } %>
                  <% if (msg.attachment_url) { %>
                    <% const mime = (msg.attachment_mime || '').toLowerCase(); %>
                    <% if (mime.startsWith('image/')) { %>
                      <img class="chat-attachment-image" src="<%= msg.attachment_url %>" alt="Image attachment" onclick="openImageCarousel(this)" />
                    <% } else if (mime.startsWith('video/')) { %>
                      <video class="chat-attachment-video" controls src="<%= msg.attachment_url %>"></video>
                    <% } else if (mime.startsWith('audio/')) { %>
                      <audio class="chat-attachment-audio" controls src="<%= msg.attachment_url %>"></audio>
                    <% } else if (mime === 'application/pdf') { %>
                      <a class="chat-attachment-file" href="<%= msg.attachment_url %>" target="_blank" rel="noopener">View PDF</a>
                    <% } else if (mime === 'text/plain') { %>
                      <a class="chat-attachment-file" href="<%= msg.attachment_url %>" target="_blank" rel="noopener">View Text File</a>
                    <% } else { %>
                      <a class="chat-attachment-file" href="<%= msg.attachment_url %>" target="_blank" rel="noopener">Download attachment</a>
                    <% } %>
                  <% } %>
                  <span class="chat-time" data-read="<%= msg.read %>"><%= new Date(msg.created_at).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) %><% if (!currentConversation.is_group && msg.sender_id === authUser.id && msg.read) { %> <span class="chat-status">‚úì‚úì</span><% } %></span>
                </div>

                <!-- Message action menu button (only for incoming messages from other user) -->
                <% if (msg.sender_id !== authUser.id) { %>
                <button type="button" class="msg-action-btn" data-message-id="<%= msg.id %>" data-sender-id="<%= msg.sender_id %>" onclick="toggleMessageActions('<%= msg.id %>')">‚ãÆ</button>
                <div class="msg-action-menu" id="msgActions<%= msg.id %>">
                  <button class="msg-action-item" onclick="reportChatMessage('<%= msg.id %>', '<%= msg.sender_id %>')">‚ö†Ô∏è Report Message</button>
                  <% if (!currentConversation.is_group && viewerHasBlockedUser) { %>
                    <button class="msg-action-item" onclick="unblockChatUser('<%= msg.sender_id %>')">‚úÖ Unblock User</button>
                  <% } else { %>
                    <button class="msg-action-item danger" onclick="blockChatUser('<%= msg.sender_id %>')">üö´ Block User</button>
                  <% } %>
                </div>
                <% } %>

                <button type="button" class="reply-btn" data-message-id="<%= msg.id %>" title="Reply" aria-label="Reply">‚Ü©Ô∏è</button>

                <!-- Quick reaction button (long-press for more options) -->
                <button type="button" class="quick-react-btn" data-message-id="<%= msg.id %>" style="position:absolute;bottom:6px;right:6px;left:auto;background:white;border:1px solid #e5e7eb;border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;opacity:0;transition:opacity 0.2s;box-shadow:0 2px 8px rgba(0,0,0,0.1);z-index:5;">‚ù§Ô∏è</button>
                <!-- Reaction picker (shown on long-press) -->
                <div class="reaction-picker" data-message-id="<%= msg.id %>" style="position:absolute;bottom:40px;right:0;left:auto;background:white;border:1px solid #e5e7eb;border-radius:24px;padding:8px;display:none;flex-direction:row;gap:4px;box-shadow:0 4px 16px rgba(0,0,0,0.15);z-index:100;">
                  <button type="button" class="reaction-option" data-type="like" style="background:none;border:none;font-size:20px;cursor:pointer;padding:4px 8px;border-radius:12px;transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">‚ù§Ô∏è</button>
                  <button type="button" class="reaction-option" data-type="love" style="background:none;border:none;font-size:20px;cursor:pointer;padding:4px 8px;border-radius:12px;transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">üòç</button>
                  <button type="button" class="reaction-option" data-type="laugh" style="background:none;border:none;font-size:20px;cursor:pointer;padding:4px 8px;border-radius:12px;transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">üòÇ</button>
                  <button type="button" class="reaction-option" data-type="wow" style="background:none;border:none;font-size:20px;cursor:pointer;padding:4px 8px;border-radius:12px;transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">üòÆ</button>
                  <button type="button" class="reaction-option" data-type="fire" style="background:none;border:none;font-size:20px;cursor:pointer;padding:4px 8px;border-radius:12px;transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">üî•</button>
                  <button type="button" class="reaction-option" data-type="thumbsup" style="background:none;border:none;font-size:20px;cursor:pointer;padding:4px 8px;border-radius:12px;transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">üëç</button>
                </div>
                <!-- Reaction display -->
                <div class="message-reactions" data-message-id="<%= msg.id %>" style="display:none;margin-top:4px;gap:4px;flex-wrap:wrap;"></div>
              </div>
            </div>
          <% }); %>
        <% } else { %>
          <div class="chat-empty">
            <p class="chat-empty-title">No messages yet</p>
            <p class="chat-empty-sub">Say hello to start the conversation.</p>
            <% if(currentConversation && currentConversation.other_user_id){ %>
              <a class="chat-start" href="/profile/<%= currentConversation.other_user_id %>">View profile ‚Üí</a>
            <% } %>
          </div>
        <% } %>
      </div>

      <div id="fileStatusIndicator" style="display:none;padding:.75rem;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:8px;margin-bottom:.5rem;font-size:.85rem;font-weight:600;align-items:center;gap:.5rem;">
        <span id="fileStatusIcon">üìé</span>
        <span id="fileStatusText">Ready to send</span>
      </div>
      <div id="typingIndicator" style="display:none;margin-bottom:.25rem;color:var(--text-light);font-size:.85rem;font-weight:600;">Typing...</div>
      <div id="replyPreviewBar" class="reply-preview-bar" style="display:none;">
        <div class="reply-preview-icon">‚Ü©Ô∏è</div>
        <div class="reply-preview-text">
          <div class="replying-to"></div>
          <div class="replying-body"></div>
        </div>
        <button type="button" class="reply-cancel" onclick="clearReplyTarget()" aria-label="Cancel reply">‚úï</button>
      </div>
      <form id="messageForm" class="chat-input-row" enctype="multipart/form-data">
        <label class="chat-attach-btn" for="fileInput" title="Attach file" aria-label="Attach file">üìé</label>
        <input type="file" id="fileInput" name="files" accept="image/*,video/*,audio/*,.pdf,.txt" multiple style="display:none" />
        <div id="filePreview" style="display:none;padding:.5rem;border:2px dashed var(--border-color);border-radius:8px;margin-bottom:.5rem;font-size:.7rem;"></div>
        <textarea id="messageInput" class="chat-input" rows="1" placeholder="Type a message..." aria-label="Message input"></textarea>
        <button type="submit" class="chat-send-btn" id="sendBtn">Send</button>
      </form>
      <div id="uploadProgress" style="display:none;padding:.5rem;background:var(--bg-light);border-radius:8px;margin-top:.5rem;">
        <div style="font-size:.7rem;margin-bottom:.25rem;font-weight:600;">Uploading...</div>
        <div style="background:#e5e7eb;border-radius:8px;height:6px;overflow:hidden;">
          <div id="progressBar" style="background:var(--primary-color);height:100%;width:0%;transition:width .3s;"></div>
        </div>
      </div>
    <% } else { %>
      <div style="display:flex;align-items:center;justify-content:center;height:100%;color:#999;">
        Select a conversation to start messaging
      </div>
    <% } %>
    </div>
  </div>
</section>

</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = (typeof io !== 'undefined') ? io() : null;
  if (!socket) {
    console.warn('Socket.io unavailable; realtime messaging disabled');
  }
  const currentConversationId = <%= currentConversation ? currentConversation.id : 'null' %>;
  const authUserId = <%= authUser ? authUser.id : 'null' %>;
  const authUserName = '<%= authUser ? (authUser.full_name || '').replace(/'/g, "\\'") : '' %>';
  const isGroupConversation = <%= currentConversation && currentConversation.is_group ? 'true' : 'false' %>;
  const currentConversationMeta = <%- currentConversation ? JSON.stringify({ id: currentConversation.id, is_group: currentConversation.is_group, group_name: currentConversation.group_name, other_user_name: currentConversation.other_user_name }) : 'null' %>;
  const viewerHasBlocked = <%= currentConversation && !currentConversation.is_group && blockState ? (blockState.viewerBlocked ? 'true' : 'false') : 'false' %>;
  const blockedByOtherUser = <%= currentConversation && !currentConversation.is_group && blockState ? (blockState.blockedByOther ? 'true' : 'false') : 'false' %>;
  const conversationParticipants = <%- currentConversation && currentConversation.is_group ? JSON.stringify(participants || []) : '[]' %>;
  const isAdminUser = <%= authUser && ['admin','super_admin','global_admin'].includes(authUser.role) ? 'true' : 'false' %>;
  const isSuperAdminUser = <%= authUser && ['super_admin','global_admin'].includes(authUser.role) ? 'true' : 'false' %>;
  const moderationTarget = <%- JSON.stringify(moderationTarget || null) %>;
  let chatFreezeState = moderationTarget ? !!moderationTarget.chat_privileges_frozen : false;

  window.addEventListener('DOMContentLoaded', () => {
    const freezeBtn = document.getElementById('freezeActionBtn');
    if (freezeBtn) {
      freezeBtn.textContent = chatFreezeState ? '‚ùÑÔ∏è Unfreeze chat' : '‚ùÑÔ∏è Freeze chat';
    }
  });

  let replyToMessageId = null;
  let activeReplyWrapper = null;

  // Join current conversation room
  if (socket && currentConversationId) {
    socket.emit('join-conversation', currentConversationId);
  }

  // Listen for new messages
  if (socket) {
    socket.on('new-message', (message) => {
      if (message.conversation_id === currentConversationId) {
        appendMessage(message);
        scrollToBottom();

        // Mark as read
        fetch(`/api/messages/${currentConversationId}/read`, { method: 'POST' })
          .catch(err => console.error('Failed to mark as read:', err));
      }
    });
  }

  function notify(message) {
    if (typeof showToast === 'function') return showToast(message);
    alert(message);
  }

  function copyToClipboard(text) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      return navigator.clipboard.writeText(text);
    }

    return new Promise((resolve, reject) => {
      try {
        const tempInput = document.createElement('textarea');
        tempInput.value = text;
        tempInput.setAttribute('aria-hidden', 'true');
        tempInput.style.position = 'fixed';
        tempInput.style.opacity = '0';
        document.body.appendChild(tempInput);
        tempInput.select();
        const success = document.execCommand('copy');
        document.body.removeChild(tempInput);
        if (success) {
          resolve();
        } else {
          reject(new Error('Copy command was blocked'));
        }
      } catch (err) {
        reject(err);
      }
    });
  }

  function closeFloatingMenus(skip = []) {
    ['safetyMenu', 'adminMenu'].forEach(id => {
      if (!skip.includes(id)) {
        const menu = document.getElementById(id);
        if (menu) menu.classList.remove('open');
      }
    });
  }

  document.addEventListener('keydown', (e) => {
    if (e.key !== 'Escape') return;
    closeFloatingMenus();
    if (typeof closeGroupModal === 'function') closeGroupModal();
    if (typeof closeGroupSettings === 'function') closeGroupSettings();
    if (typeof clearReplyTarget === 'function') clearReplyTarget();
  });

  function toggleSafetyMenu(event) {
    event?.stopPropagation();
    closeFloatingMenus(['safetyMenu']);
    const menu = document.getElementById('safetyMenu');
    if (menu) menu.classList.toggle('open');
  }

  function toggleAdminMenu(event) {
    if (!isAdminUser) return;
    event?.stopPropagation();
    closeFloatingMenus(['adminMenu']);
    const menu = document.getElementById('adminMenu');
    if (menu) menu.classList.toggle('open');
  }

  window.addEventListener('click', () => closeFloatingMenus());
  document.getElementById('safetyMenu')?.addEventListener('click', (e) => e.stopPropagation());
  document.getElementById('adminMenu')?.addEventListener('click', (e) => e.stopPropagation());

  function reportConversation(isFromAdmin = false) {
    if (!currentConversationId) return;
    <% if (currentConversation && currentConversation.is_group) { %>
      notify('Report specific messages in this group to help moderators focus on the issue.');
      closeFloatingMenus();
      return;
    <% } else if (currentConversation) { %>
      const message = isFromAdmin ? 'Flag this conversation for moderation review?' : 'Report this conversation for review?';
      showConfirm(message, async function() {
        try {
          const res = await fetch(`/api/users/<%= currentConversation.other_user_id %>/report`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason: 'conversation', description: `Conversation report for ID ${currentConversationId}${isFromAdmin ? ' (admin initiated)' : ''}` })
          });
          const data = await res.json();
          if (data.success) {
            showSuccess('Conversation reported to DreamX moderators.', 'Report submitted');
          } else {
            showError(data.error || 'Could not submit report', 'Report error');
          }
        } catch (err) {
          console.error('Conversation report error', err);
          showError('Could not submit report right now', 'Report error');
        } finally {
          closeFloatingMenus();
        }
      }, null, 'Report conversation', 'üõü');
    <% } %>
  }

  function blockConversationUser(userId) {
    if (!userId) {
      notify('Pick a participant to block first.');
      closeFloatingMenus();
      return;
    }
    blockChatUser(userId);
    closeFloatingMenus();
  }

  function unblockConversationUser(userId) {
    if (!userId) {
      notify('Pick a participant to unblock first.');
      closeFloatingMenus();
      return;
    }
    unblockChatUser(userId);
    closeFloatingMenus();
  }

  function copyGroupShare() {
    if (!currentConversationId) {
      notify('Pick a conversation to share first.');
      return;
    }

    if (!isGroupConversation) {
      notify('Sharing is only available for group chats.');
      return;
    }

    const link = `${window.location.origin}/messages?conversation=${currentConversationId}`;
    const shareData = { title: 'Join my DreamX group chat', text: 'Jump into this conversation on DreamX.', url: link };
    const shareBtn = document.querySelector('button[data-role="share-group"]');
    const cleanupShareState = () => shareBtn?.removeAttribute('aria-busy');
    const copyFallback = () => copyToClipboard(link)
      .then(() => notify('Share link copied'))
      .catch(() => alert('Copied group link: ' + link));

    shareBtn?.setAttribute('aria-busy', 'true');

    if (navigator.share) {
      navigator.share(shareData)
        .then(() => notify('Share invite sent'))
        .catch((err) => {
          if (err && err.name === 'AbortError') return;
          return copyFallback();
        })
        .finally(cleanupShareState);
      return;
    }

    copyFallback().finally(cleanupShareState);
  }

  function shareConversation() {
    if (!currentConversationId) {
      notify('Pick a conversation to share.');
      return;
    }

    const title = isGroupConversation ? `Join ${(currentConversationMeta && currentConversationMeta.group_name) || 'my DreamX group'}` : 'Chat with me on DreamX';
    const text = isGroupConversation ? 'Jump into this group conversation on DreamX.' : 'Continue our chat on DreamX.';
    const link = `${window.location.origin}/messages?conversation=${currentConversationId}`;

    if (navigator.share) {
      navigator.share({ title, text, url: link })
        .then(() => notify('Share sent'))
        .catch((err) => {
          if (err?.name === 'AbortError') return;
          navigator.clipboard?.writeText(link)
            .then(() => notify('Share link copied'))
            .catch(() => alert('Copied conversation link: ' + link));
        });
      return;
    }

    navigator.clipboard?.writeText(link)
      .then(() => notify('Share link copied'))
      .catch(() => alert('Copied conversation link: ' + link));
  }

  function toggleInlineAddMember() {
    const panel = document.getElementById('inlineAddMember');
    const toggleBtn = document.getElementById('inlineAddBtn');
    if (!panel) return;
    const isHidden = panel.style.display === 'none' || panel.style.display === '';
    panel.style.display = isHidden ? 'block' : 'none';
    panel.classList.toggle('active', isHidden);
    if (toggleBtn) {
      toggleBtn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
      toggleBtn.textContent = isHidden ? '‚ûñ Hide add panel' : '‚ûï Add people';
    }
    if (isHidden) {
      document.getElementById('inlineAddMemberInput')?.focus();
    } else {
      document.getElementById('inlineAddMemberResults').innerHTML = '';
      const inlineInput = document.getElementById('inlineAddMemberInput');
      if (inlineInput) inlineInput.value = '';
    }
  }

  function showPinnedTips() {
    const tips = document.getElementById('groupTips');
    const toggleBtn = document.getElementById('tipsToggleBtn');
    const headerBtn = document.getElementById('headerTipsBtn');
    if (!tips) {
      notify('Group tips are only available in group conversations.');
      return;
    }
    const shouldShow = tips.style.display === 'none' || tips.style.display === '';
    tips.style.display = shouldShow ? 'block' : 'none';
    if (toggleBtn) {
      toggleBtn.setAttribute('aria-expanded', shouldShow ? 'true' : 'false');
      toggleBtn.textContent = shouldShow ? 'üìå Hide tips' : 'üìå Tips';
    }
    if (headerBtn) {
      headerBtn.setAttribute('aria-expanded', shouldShow ? 'true' : 'false');
      headerBtn.textContent = shouldShow ? 'Hide tips' : 'Tips';
    }
  }

  // Inline add member search
  const inlineAddInput = document.getElementById('inlineAddMemberInput');
  let inlineSearchTimeout = null;
  inlineAddInput?.addEventListener('input', () => {
    clearTimeout(inlineSearchTimeout);
    const q = (inlineAddInput.value || '').trim();
    if (!q) {
      document.getElementById('inlineAddMemberResults').innerHTML = '';
      return;
    }
    inlineSearchTimeout = setTimeout(async () => {
      try {
        const res = await fetch(`/api/users/search?q=${encodeURIComponent(q)}`);
        const data = await res.json();
        const existingIds = conversationParticipants.map(p => p.id);
        const filtered = (data.results || []).filter(u => !existingIds.includes(u.id));
        const html = filtered.length === 0 ? '<div class="inline-empty">No people found</div>' : filtered.map(u => `
          <div class="inline-result" onclick="addGroupMember(${u.id}, '${u.full_name.replace(/'/g, "\\'")}', '${u.profile_picture || ''}')">
            ${u.profile_picture ? `<img src="/uploads/${u.profile_picture}" alt="${u.full_name}">` : `<div class="inline-avatar">${u.full_name.charAt(0)}</div>`}
            <div class="inline-copy">${u.full_name}${u.handle ? ` <span>@${u.handle}</span>` : ''}</div>
          </div>
        `).join('');
        document.getElementById('inlineAddMemberResults').innerHTML = html;
      } catch (err) {
        document.getElementById('inlineAddMemberResults').innerHTML = '<div class="inline-empty">Search failed</div>';
      }
    }, 250);
  });

  // Read receipts: mark outgoing messages as seen up to a given ID
  if (socket) {
    socket.on('read-receipt', (payload) => {
      try {
        if (!payload || payload.conversationId !== currentConversationId) return;
        if (typeof payload.lastReadMessageId === 'number') {
          markSeenForOutgoingUpTo(payload.lastReadMessageId);
        }
      } catch (e) { console.error('read-receipt handling error', e); }
    });
  }

  // Reply-to helpers
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.reply-btn');
    if (btn) {
      const wrapper = btn.closest('.chat-message-wrapper');
      if (wrapper) setReplyTarget(wrapper);
    }
  });

  // Send message form handler (with optional file + drag-drop + progress)
  let selectedFiles = [];
  const fileInput = document.getElementById('fileInput');
  const filePreview = document.getElementById('filePreview');
  const uploadProgress = document.getElementById('uploadProgress');
  const progressBar = document.getElementById('progressBar');
  const sendBtn = document.getElementById('sendBtn');
  const typingIndicator = document.getElementById('typingIndicator');
  const replyBar = document.getElementById('replyPreviewBar');
  const replyToText = document.querySelector('.replying-to');
  const replyBodyText = document.querySelector('.replying-body');

  fileInput?.addEventListener('change', (e) => {
    selectedFiles = e.target.files ? Array.from(e.target.files) : [];
    updateFilePreview();
  });

  function updateFilePreview() {
    const statusIndicator = document.getElementById('fileStatusIndicator');
    const statusIcon = document.getElementById('fileStatusIcon');
    const statusText = document.getElementById('fileStatusText');
    
    if (!selectedFiles || selectedFiles.length === 0) {
      filePreview.style.display = 'none';
      filePreview.innerHTML = '';
      statusIndicator.style.display = 'none';
      return;
    }
    
    // Show status indicator
    statusIndicator.style.display = 'flex';
    statusIcon.textContent = 'üìé';
    statusText.textContent = selectedFiles.length === 1 ? `Ready to send: ${selectedFiles[0].name}` : `Ready to send ${selectedFiles.length} files`;
    
    filePreview.style.display = 'block';
    filePreview.innerHTML = selectedFiles.map((f, idx) => `
      <div style="display:flex;align-items:center;gap:.5rem;margin:.15rem 0;">
        <span style="font-weight:700;">${f.name}</span>
        <span style="color:var(--text-light);">(${(f.size / 1024).toFixed(1)} KB)</span>
        <button type="button" onclick="removeSelectedFile(${idx})" style="margin-left:auto;background:none;border:none;cursor:pointer;color:var(--primary-color);font-weight:700;">‚úï</button>
      </div>
    `).join('') + `
      <div style="text-align:right;margin-top:.25rem;">
        <button type="button" onclick="clearFile()" style="background:none;border:none;cursor:pointer;color:#ef4444;font-weight:700;">Clear all</button>
      </div>`;
  }

  window.clearFile = () => {
    selectedFiles = [];
    fileInput.value = '';
    updateFilePreview();
  };
  window.removeSelectedFile = (idx) => {
    if (!selectedFiles || idx < 0 || idx >= selectedFiles.length) return;
    selectedFiles.splice(idx, 1);
    const dt = new DataTransfer();
    selectedFiles.forEach(f => dt.items.add(f));
    fileInput.files = dt.files;
    updateFilePreview();
  };

  function setReplyTarget(wrapper) {
    replyToMessageId = parseInt(wrapper.getAttribute('data-message-id'), 10);
    const sender = wrapper.getAttribute('data-sender-name') || 'A member';
    const preview = wrapper.getAttribute('data-reply-preview') || 'Message';
    const hasAttachment = wrapper.getAttribute('data-reply-has-attachment') === 'true';
    if (activeReplyWrapper && activeReplyWrapper !== wrapper) {
      activeReplyWrapper.classList.remove('reply-target');
    }
    activeReplyWrapper = wrapper;
    wrapper.classList.add('reply-target');
    if (replyBar && replyToText && replyBodyText) {
      replyToText.textContent = `Replying to ${sender}`;
      replyBodyText.textContent = `${hasAttachment ? 'üìé ' : ''}${preview}`;
      replyBar.style.display = 'flex';
    }
  }

  window.clearReplyTarget = function() {
    replyToMessageId = null;
    if (activeReplyWrapper) {
      activeReplyWrapper.classList.remove('reply-target');
      activeReplyWrapper = null;
    }
    if (replyBar) replyBar.style.display = 'none';
  }

  // Drag-and-drop support
  const chatHistory = document.getElementById('chatHistory');
  chatHistory?.addEventListener('dragover', (e) => {
    e.preventDefault();
    e.stopPropagation();
    chatHistory.style.background = 'rgba(124,58,237,0.05)';
  });
  chatHistory?.addEventListener('dragleave', (e) => {
    e.preventDefault();
    e.stopPropagation();
    chatHistory.style.background = '';
  });
  chatHistory?.addEventListener('drop', (e) => {
    e.preventDefault();
    e.stopPropagation();
    chatHistory.style.background = '';
    const files = e.dataTransfer?.files;
    if (files && files.length) {
      selectedFiles = Array.from(files);
      const dt = new DataTransfer();
      selectedFiles.forEach(f => dt.items.add(f));
      fileInput.files = dt.files;
      updateFilePreview();
    }
  });

  document.getElementById('messageForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const input = document.getElementById('messageInput');
    const content = (input.value || '').trim();
    
    if ((!content && (!selectedFiles || selectedFiles.length === 0)) || !currentConversationId) return;
    
    try {
      const statusIndicator = document.getElementById('fileStatusIndicator');
      const statusIcon = document.getElementById('fileStatusIcon');
      const statusText = document.getElementById('fileStatusText');
      const hasFiles = selectedFiles && selectedFiles.length > 0;

      progressBar.style.width = '0%';
      uploadProgress.style.display = hasFiles ? 'block' : 'none';
      sendBtn.disabled = true;

      if (hasFiles && statusIndicator && statusIcon && statusText) {
        statusIndicator.style.display = 'flex';
        statusIcon.textContent = '‚è≥';
        statusText.textContent = selectedFiles.length === 1 ? 'Uploading...' : `Uploading ${selectedFiles.length} files...`;
      }

      const form = new FormData();
      form.append('conversationId', currentConversationId);
      form.append('content', content);
      if (replyToMessageId) {
        form.append('replyToMessageId', replyToMessageId);
      }
      if (selectedFiles && selectedFiles.length > 0) {
        selectedFiles.forEach(f => form.append('files', f));
      }

      // XMLHttpRequest for real progress tracking
      const xhr = new XMLHttpRequest();
      xhr.upload.addEventListener('progress', (evt) => {
        if (evt.lengthComputable) {
          const pct = (evt.loaded / evt.total) * 100;
          progressBar.style.width = pct + '%';
          if (hasFiles && statusText) {
            statusText.textContent = `Uploading... ${Math.round(pct)}%`;
          }
        }
      });
      xhr.addEventListener('load', () => {
        const statusIndicator = document.getElementById('fileStatusIndicator');
        const statusIcon = document.getElementById('fileStatusIcon');
        const statusText = document.getElementById('fileStatusText');
        let responseData = null;
        try {
          responseData = JSON.parse(xhr.responseText || '{}');
        } catch (e) {
          responseData = null;
        }

        if (xhr.status >= 200 && xhr.status < 300) {
          input.value = '';
          input.style.height = 'auto';
          clearFile();
          clearReplyTarget();
          uploadProgress.style.display = 'none';
          const shouldAppendLocally = !socket || !socket.connected;
          if (shouldAppendLocally && responseData && Array.isArray(responseData.messages)) {
            responseData.messages.forEach((msg) => appendMessage(msg));
          }
          if (statusIndicator && statusIcon && statusText && hasFiles) {
            progressBar.style.width = '100%';
            statusIndicator.style.display = 'flex';
            statusIcon.textContent = '‚úÖ';
            statusText.textContent = 'Upload complete';
            setTimeout(() => { statusIndicator.style.display = 'none'; }, 1200);
          }
          sendBtn.disabled = false;
        } else {
          const data = responseData || {};
          alert(data.error || 'Failed to send message');
          uploadProgress.style.display = 'none';
          if (statusIndicator && statusIcon && statusText && hasFiles) {
            statusIndicator.style.display = 'flex';
            statusIcon.textContent = '‚ö†Ô∏è';
            statusText.textContent = 'Upload failed. Try again.';
          }
          sendBtn.disabled = false;
        }
      });
      xhr.addEventListener('error', () => {
        const statusIndicator = document.getElementById('fileStatusIndicator');
        const statusIcon = document.getElementById('fileStatusIcon');
        const statusText = document.getElementById('fileStatusText');
        alert('Error sending message');
        uploadProgress.style.display = 'none';
        if (statusIndicator && statusIcon && statusText && hasFiles) {
          statusIndicator.style.display = 'flex';
          statusIcon.textContent = '‚ö†Ô∏è';
          statusText.textContent = 'Upload failed. Try again.';
        }
        sendBtn.disabled = false;
      });
      xhr.open('POST', '/api/messages/send');
      xhr.send(form);
    } catch (err) {
      console.error('Error sending message:', err);
      alert('Error sending message');
      uploadProgress.style.display = 'none';
      sendBtn.disabled = false;
    }
  });

  // Helper: Append message to chat history (supports attachments)
  function appendMessage(msg) {
    const chatHistory = document.getElementById('chatHistory');
    const isOutgoing = msg.sender_id === authUserId;

    const wrapper = document.createElement('div');
    wrapper.className = `chat-message-wrapper ${isOutgoing ? 'outgoing' : 'incoming'}`;
    wrapper.setAttribute('data-message-id', msg.id);
    if (msg.created_at) {
      wrapper.setAttribute('data-created-at', msg.created_at);
    }
    wrapper.setAttribute('data-sender-name', msg.sender_name || (isOutgoing ? authUserName : 'Member'));
    wrapper.setAttribute('data-reply-preview', msg.content || (msg.attachment_url ? 'Attachment' : ''));
    wrapper.setAttribute('data-reply-has-attachment', msg.attachment_url ? 'true' : 'false');
    wrapper.setAttribute('data-reaction-counts', JSON.stringify(msg.reaction_counts || msg.reactions || {}));

    const bubble = document.createElement('div');
    bubble.className = 'chat-bubble';

    if (msg.reply_to_message_id) {
      const ctx = document.createElement('div');
      ctx.className = 'reply-context';
      const author = document.createElement('div');
      author.className = 'reply-author';
      author.textContent = msg.reply_sender_name || 'Reply';
      const preview = document.createElement('div');
      preview.className = 'reply-preview';
      if (msg.reply_attachment_url) {
        preview.textContent = `üìé ${msg.reply_content && msg.reply_content.length ? msg.reply_content.substring(0,80) : 'Attachment'}`;
      } else {
        preview.textContent = msg.reply_content || 'Replied message';
      }
      ctx.appendChild(author);
      ctx.appendChild(preview);
      bubble.appendChild(ctx);
    }

    if (msg.content) {
      const text = document.createElement('p');
      text.className = 'chat-text';
      text.textContent = msg.content;
      bubble.appendChild(text);
    } else if (msg.attachment_url) {
      // Show filename when there's no message content
      const text = document.createElement('p');
      text.className = 'chat-text';
      text.style.fontSize = '0.85rem';
      text.style.opacity = '0.8';
      const filename = msg.attachment_url.split('/').pop().replace(/^chat-\d+-\d+-/, '');
      text.textContent = 'üìé ' + filename;
      bubble.appendChild(text);
    }

    if (msg.attachment_url) {
      const m = (msg.attachment_mime || '').toLowerCase();
      if (m.startsWith('image/')) {
        const img = document.createElement('img');
        img.className = 'chat-attachment-image';
        img.src = msg.attachment_url;
        img.alt = 'Image attachment';
        img.addEventListener('click', () => openImageCarousel(img));
        bubble.appendChild(img);
      } else if (m.startsWith('video/')) {
        const v = document.createElement('video');
        v.className = 'chat-attachment-video';
        v.controls = true;
        v.src = msg.attachment_url;
        bubble.appendChild(v);
      } else if (m.startsWith('audio/')) {
        const a = document.createElement('audio');
        a.className = 'chat-attachment-audio';
        a.controls = true;
        a.src = msg.attachment_url;
        bubble.appendChild(a);
      } else if (m === 'application/pdf') {
        const link = document.createElement('a');
        link.className = 'chat-attachment-file';
        link.href = msg.attachment_url;
        link.target = '_blank';
        link.rel = 'noopener';
        link.textContent = 'View PDF';
        bubble.appendChild(link);
      } else if (m === 'text/plain') {
        const link = document.createElement('a');
        link.className = 'chat-attachment-file';
        link.href = msg.attachment_url;
        link.target = '_blank';
        link.rel = 'noopener';
        link.textContent = 'View Text File';
        bubble.appendChild(link);
      } else {
        const link = document.createElement('a');
        link.className = 'chat-attachment-file';
        link.href = msg.attachment_url;
        link.target = '_blank';
        link.rel = 'noopener';
        link.textContent = 'Download attachment';
        bubble.appendChild(link);
      }
    }

    const time = document.createElement('span');
    time.className = 'chat-time';
    time.setAttribute('data-read', msg.read || 0);
    time.textContent = new Date(msg.created_at).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    if (!isGroupConversation && isOutgoing && msg.read) {
      const status = document.createElement('span');
      status.className = 'chat-status';
      status.textContent = ' ‚úì‚úì';
      time.appendChild(status);
    }

    bubble.appendChild(time);
    wrapper.appendChild(bubble);
    chatHistory.appendChild(wrapper);

    updateMessageReactions(msg.id, msg.reaction_counts || msg.reactions || {});
  }

  // Mark all outgoing messages with id <= lastId as seen (double check)
  function markSeenForOutgoingUpTo(lastId) {
    if (!lastId) return;
    const nodes = document.querySelectorAll('.chat-message-wrapper.outgoing');
    nodes.forEach(w => {
      const mid = parseInt(w.getAttribute('data-message-id'), 10);
      if (!isNaN(mid) && mid <= lastId) {
        const bubble = w.querySelector('.chat-bubble');
        const timeEl = bubble?.querySelector('.chat-time');
        if (!timeEl) return;
        timeEl.setAttribute('data-read', '1');
        if (!timeEl.querySelector('.chat-status')) {
          const status = document.createElement('span');
          status.className = 'chat-status';
          status.textContent = ' ‚úì‚úì';
          timeEl.appendChild(status);
        }
      }
    });
  }

  // Helper: Scroll to bottom
  function scrollToBottom() {
    const chatHistory = document.getElementById('chatHistory');
    if (!chatHistory) return; // Ensure chatHistory exists before accessing its properties
    chatHistory.scrollTop = chatHistory.scrollHeight;
  }

  // Switch conversation function
  function switchConversation(conversationId) {
    window.location.href = `/messages?conversation=${conversationId}`;
  }

  // Auto-resize textarea
  const messageInput = document.getElementById('messageInput');
  messageInput?.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
    handleTyping();
  });

  // Typing indicator emit/debounce and listeners
  let typingTimeout = null;
  let typingSent = false;
  function handleTyping(){
    if (!socket || !currentConversationId || !authUserId) return;
    try {
      if (!typingSent) {
        socket.emit('typing', { conversationId: currentConversationId, userId: authUserId });
        typingSent = true;
      }
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        socket.emit('stop-typing', { conversationId: currentConversationId, userId: authUserId });
        typingSent = false;
      }, 1500);
    } catch(e) { console.error('typing emit error', e); }
  }

  if (socket) {
    socket.on('typing', (payload) => {
      if (!payload || payload.conversationId !== currentConversationId) return;
      if (payload.userId && authUserId && payload.userId === authUserId) return; // ignore self
      typingIndicator.style.display = 'block';
      typingIndicator.textContent = 'Typing...';
    });
    socket.on('stop-typing', (payload) => {
      if (!payload || payload.conversationId !== currentConversationId) return;
      if (payload.userId && authUserId && payload.userId === authUserId) return;
      typingIndicator.style.display = 'none';
    });
  }

  // Scroll to bottom on load
  if (currentConversationId) {
    scrollToBottom();
  }

  // Image carousel modal
  function collectGroupImages(clickedImg) {
    const wrapper = clickedImg.closest('.chat-message-wrapper');
    let imgs = Array.from(wrapper.querySelectorAll('.chat-attachment-image'));
    if (imgs.length <= 1) {
      const isOutgoing = wrapper.classList.contains('outgoing');
      const baseTime = new Date(wrapper.getAttribute('data-created-at') || Date.now()).getTime();
      const siblings = Array.from(document.querySelectorAll('.chat-message-wrapper.' + (isOutgoing ? 'outgoing' : 'incoming')));
      const windowMs = 2 * 60 * 1000;
      const grouped = [];
      siblings.forEach(w => {
        const t = new Date(w.getAttribute('data-created-at') || 0).getTime();
        if (Math.abs(t - baseTime) <= windowMs) {
          grouped.push(...Array.from(w.querySelectorAll('.chat-attachment-image')));
        }
      });
      if (grouped.length > 0) imgs = grouped;
    }
    const startIdx = imgs.findIndex(i => i === clickedImg);
    if (startIdx > 0) imgs = imgs.slice(startIdx).concat(imgs.slice(0, startIdx));
    return imgs.map(i => i.getAttribute('src'));
  }

  function openImageCarousel(imgEl) {
    const images = collectGroupImages(imgEl);
    if (!images || images.length === 0) return;
    const overlay = document.getElementById('imageCarouselOverlay');
    const track = document.getElementById('imageCarouselTrack');
    track.innerHTML = images.map(src => `<div class="carousel-slide"><img src="${src}" alt="preview"></div>`).join('');
    overlay.style.display = 'flex';
    let idx = 0;
    updateCarousel(idx);
    function updateCarousel(i){
      const slides = track.children.length;
      idx = ((i % slides) + slides) % slides;
      track.style.transform = `translateX(-${idx * 100}%)`;
      document.getElementById('carouselCounter').textContent = `${idx+1}/${slides}`;
    }
    window._carouselPrev = () => updateCarousel(idx - 1);
    window._carouselNext = () => updateCarousel(idx + 1);
    window._carouselClose = () => { overlay.style.display = 'none'; track.innerHTML=''; };
  }

  // Keep a richer shape so we can re-render chips beautifully
  window.selectedUsers = [];

  window.openGroupModal = () => {
    const modal = document.getElementById('groupModal');
    if (!modal) return;
    modal.classList.add('is-open');
    modal.setAttribute('aria-hidden', 'false');
    renderSelectedUsers();
    const nameInput = document.getElementById('groupNameInput');
    if (nameInput) {
      nameInput.focus();
    }
  };

  window.closeGroupModal = () => {
    const modal = document.getElementById('groupModal');
    if (!modal) return;
    modal.classList.remove('is-open');
    modal.setAttribute('aria-hidden', 'true');
    const searchInput = document.getElementById('groupUserSearch');
    if (searchInput) searchInput.value = '';
    const results = document.getElementById('groupUserResults');
    if (results) results.innerHTML = '';
    window.selectedUsers = [];
    renderSelectedUsers();
  };

  document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('groupModal');
    const newGroupBtn = document.getElementById('newGroupBtn');

    // Guarantee a closed, hidden start state (covers stale cached CSS/JS)
    if (modal) {
      modal.classList.remove('is-open');
      modal.setAttribute('aria-hidden', 'true');
    }

    if (newGroupBtn) {
      newGroupBtn.addEventListener('click', openGroupModal);
    }

    modal?.addEventListener('click', (e) => {
      if (e.target.id === 'groupModal') {
        closeGroupModal();
      }
    });
  });

  function renderSelectedUsers() {
    const target = document.getElementById('selectedUsers');
    const counter = document.getElementById('selectedCount');
    if (!target) return;

    if (counter) {
      counter.textContent = `${window.selectedUsers.length} selected`;
    }

    if (!window.selectedUsers.length) {
      target.innerHTML = '<div class="empty-selected">Add a couple of people to kick off the vibe.</div>';
      return;
    }

    target.innerHTML = window.selectedUsers.map(u => `
      <div class="group-chip" data-id="${u.id}">
        ${u.pic ? `<img src="/uploads/${u.pic}" alt="${u.name}">` : `<span>${u.name.charAt(0)}</span>`}
        <span class="chip-name">${u.name}</span>
        <button type="button" onclick="removeUserFromGroup(${u.id})" aria-label="Remove ${u.name}">‚úï</button>
      </div>
    `).join('');
  }

  window.addUserToGroup = (id, name, pic) => {
    if (window.selectedUsers.find(u => u.id === id)) return;
    window.selectedUsers.push({ id, name, pic });
    renderSelectedUsers();
    document.getElementById('groupUserSearch').value = '';
    document.getElementById('groupUserResults').innerHTML = '';
  };

  window.removeUserFromGroup = (id) => {
    window.selectedUsers = window.selectedUsers.filter(u => u.id !== id);
    renderSelectedUsers();
  };

  window.createGroup = async () => {
    const groupName = document.getElementById('groupNameInput').value.trim() || 'Group Chat';
    if (window.selectedUsers.length === 0) {
      alert('Add at least one participant');
      return;
    }
    try {
      const res = await fetch('/messages/group/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ participantIds: window.selectedUsers.map(u => u.id), groupName })
      });
      const data = await res.json();
      if (data.success) {
        window.location.href = `/messages?conversation=${data.conversationId}`;
      } else {
        alert(data.error || 'Failed to create group');
      }
    } catch(e) {
      console.error('Group creation error:', e);
      alert('Failed to create group');
    }
  };

  // Message Reactions - Quick react and long-press for picker
  const reactionEmojis = {
    like: '‚ù§Ô∏è',
    love: 'üòç',
    laugh: 'üòÇ',
    wow: 'üòÆ',
    fire: 'üî•',
    thumbsup: 'üëç'
  };

  function parseReactionCounts(raw) {
    if (!raw) return {};
    try {
      const parsed = JSON.parse(raw);
      return parsed && typeof parsed === 'object' ? parsed : {};
    } catch (e) {
      return {};
    }
  }

  function hydrateInitialReactions() {
    document.querySelectorAll('.chat-message-wrapper').forEach(wrapper => {
      const counts = parseReactionCounts(wrapper.getAttribute('data-reaction-counts'));
      const messageId = wrapper.getAttribute('data-message-id');
      if (Object.keys(counts).length > 0) {
        updateMessageReactions(messageId, counts);
      }
    });
  }

  document.addEventListener('DOMContentLoaded', hydrateInitialReactions);

  // Show quick react button on hover
  document.addEventListener('mouseover', (e) => {
    const wrapper = e.target.closest('.chat-message-wrapper');
    if (wrapper) {
      const btn = wrapper.querySelector('.quick-react-btn');
      if (btn) btn.style.opacity = '1';
    }
  });

  document.addEventListener('mouseout', (e) => {
    const wrapper = e.target.closest('.chat-message-wrapper');
    if (wrapper && !wrapper.contains(e.relatedTarget)) {
      const btn = wrapper.querySelector('.quick-react-btn');
      if (btn) btn.style.opacity = '0';
    }
  });

  // Quick react click handler
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.quick-react-btn');
    if (btn) {
      const messageId = btn.getAttribute('data-message-id');
      await reactToMessage(messageId, 'like');
    }
  });

  // Long press to show reaction picker
  let pressTimer = null;
  let pressTarget = null;

  document.addEventListener('mousedown', (e) => {
    const wrapper = e.target.closest('.chat-message-wrapper');
    if (wrapper) {
      pressTarget = wrapper;
      pressTimer = setTimeout(() => {
        const picker = wrapper.querySelector('.reaction-picker');
        if (picker) {
          picker.style.display = 'flex';
        }
      }, 500); // 500ms long press
    }
  });

  document.addEventListener('mouseup', () => {
    if (pressTimer) {
      clearTimeout(pressTimer);
      pressTimer = null;
      pressTarget = null;
    }
  });

  document.addEventListener('mouseleave', () => {
    if (pressTimer) {
      clearTimeout(pressTimer);
      pressTimer = null;
      pressTarget = null;
    }
  });

  // Touch support for mobile long-press
  document.addEventListener('touchstart', (e) => {
    const wrapper = e.target.closest('.chat-message-wrapper');
    if (wrapper) {
      pressTarget = wrapper;
      pressTimer = setTimeout(() => {
        const picker = wrapper.querySelector('.reaction-picker');
        if (picker) {
          picker.style.display = 'flex';
        }
      }, 500);
    }
  });

  document.addEventListener('touchend', () => {
    if (pressTimer) {
      clearTimeout(pressTimer);
      pressTimer = null;
      pressTarget = null;
    }
  });

  // Reaction option click handler
  document.addEventListener('click', async (e) => {
    const option = e.target.closest('.reaction-option');
    if (option) {
      const type = option.getAttribute('data-type');
      const picker = option.closest('.reaction-picker');
      const messageId = picker.getAttribute('data-message-id');
      await reactToMessage(messageId, type);
      picker.style.display = 'none';
    }
  });

  // Close reaction picker when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.reaction-picker') && !e.target.closest('.chat-message-wrapper')) {
      document.querySelectorAll('.reaction-picker').forEach(picker => {
        picker.style.display = 'none';
      });
    }
  });

  // React to message function
  async function reactToMessage(messageId, reactionType) {
    try {
      const res = await fetch(`/api/messages/${messageId}/react`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reactionType })
      });
      const data = await res.json();
      if (data.success) {
        updateMessageReactions(messageId, data.counts);
      }
    } catch (err) {
      console.error('Reaction error:', err);
    }
  }

  // Update message reactions display
  function updateMessageReactions(messageId, counts) {
    const wrapper = document.querySelector(`.chat-message-wrapper[data-message-id="${messageId}"]`);
    if (!wrapper) return;

    const reactionsDiv = wrapper.querySelector('.message-reactions');
    if (!reactionsDiv) return;

    const safeCounts = counts || {};
    const hasReactions = Object.values(safeCounts).some(c => c > 0);
    if (!hasReactions) {
      reactionsDiv.style.display = 'none';
      reactionsDiv.innerHTML = '';
      return;
    }

    reactionsDiv.style.display = 'flex';
    reactionsDiv.innerHTML = Object.entries(safeCounts)
      .filter(([_, count]) => count > 0)
      .map(([type, count]) => `
        <span class="message-reaction-chip">
          ${reactionEmojis[type] || '‚ù§Ô∏è'} ${count}
        </span>
      `).join('');
  }

  // Listen for message reaction events via socket
  if (socket) {
    socket.on('message-reaction', (payload) => {
      if (!payload || (payload.conversationId && payload.conversationId !== currentConversationId)) return;
      if (payload.messageId) {
        updateMessageReactions(payload.messageId, payload.reactionCounts || payload.counts);
      }
    });
  }

  // Group Modal Setup - Initialize after DOM is ready
  function initGroupModal() {
    const groupSearchInput = document.getElementById('groupUserSearch');
    if (!groupSearchInput) {
      console.error('Group search input not found');
      return;
    }
    
    let groupSearchTimeout = null;
    groupSearchInput.addEventListener('input', async () => {
      clearTimeout(groupSearchTimeout);
      const q = (groupSearchInput.value || '').trim();
      if (!q) {
        document.getElementById('groupUserResults').innerHTML = '';
        return;
      }
      groupSearchTimeout = setTimeout(async () => {
        try {
          const res = await fetch(`/api/users/search?q=${encodeURIComponent(q)}`);
          const data = await res.json();
          if (!res.ok) {
            console.error('Search failed:', data.error);
            document.getElementById('groupUserResults').innerHTML = '<div style="padding:.75rem;text-align:center;color:#ef4444;font-size:.8rem;">Search failed. Please try again.</div>';
            return;
          }
          const users = (data.results || []).filter(u => !window.selectedUsers.find(sel => sel.id === u.id));
          if (users.length === 0) {
            document.getElementById('groupUserResults').innerHTML = '<div style="padding:.75rem;text-align:center;color:var(--text-light);font-size:.8rem;">No users found</div>';
            return;
          }
          document.getElementById('groupUserResults').innerHTML = users.map(u => `
            <div class="group-result-item" onclick="addUserToGroup(${u.id}, '${u.full_name.replace(/'/g,"\\'")}', '${u.profile_picture || ''}')">
              ${u.profile_picture ? `<img src="/uploads/${u.profile_picture}" class="group-result-avatar" alt="${u.full_name}">` : `<div class="group-result-avatar fallback">${u.full_name.charAt(0)}</div>`}
              <div class="group-result-meta">
                <span class="name">${u.full_name}</span>
                ${u.handle ? `<span class="handle">@${u.handle}</span>` : ''}
              </div>
              <span class="action-pill">Invite</span>
            </div>
          `).join('');
        } catch(e) {
          console.error('Group search error:', e);
          document.getElementById('groupUserResults').innerHTML = '<div style="padding:.75rem;text-align:center;color:#ef4444;font-size:.8rem;">Error searching users</div>';
        }
      }, 250);
    });
  }
</script>

<!-- Group Creation Modal -->
  <div id="groupModal" class="modal-overlay">
    <div class="group-modal-card">
      <div class="group-modal-hero">
        <div>
          <p class="group-hero-kicker">Premium messaging</p>
          <h3 class="group-hero-title">Create a group</h3>
          <p class="group-hero-sub">Invite your inner circle with a polished invite and curated roster.</p>
          <div class="group-hero-tags">
            <span class="group-tag">Curated list</span>
            <span class="group-tag">Invite link ready</span>
            <span class="group-tag">Threaded by default</span>
          </div>
        </div>
        <button type="button" class="modal-close-btn" onclick="closeGroupModal()" aria-label="Close group creation">&times;</button>
      </div>

      <div class="group-modal-body">
        <div class="group-field">
          <label for="groupNameInput">Group name</label>
          <div class="group-input-shell">
            <span class="input-lead">‚ú®</span>
            <input type="text" id="groupNameInput" placeholder="Give your group a standout name" />
          </div>
          <p class="field-hint">Tip: highlight the purpose so members know why they were chosen.</p>
        </div>

        <div class="group-field">
          <label for="groupUserSearch">Add participants</label>
          <div class="group-input-shell">
            <span class="input-lead">üîç</span>
            <input type="text" id="groupUserSearch" placeholder="Search people by name or handle" />
          </div>
          <div id="groupUserResults" class="group-user-results"></div>
        </div>

        <div class="group-field">
          <div class="group-field-head">
            <label for="selectedUsers">Selected members</label>
            <span class="chip-soft" id="selectedCount">0 selected</span>
          </div>
          <div id="selectedUsers" class="selected-users"></div>
        </div>

        <button type="button" class="group-primary-btn" onclick="createGroup()">Send premium invite</button>
      </div>
    </div>
  </div>

<script>
  // Initialize group modal after DOM is loaded
  if (typeof initGroupModal === 'function') {
    initGroupModal();
  }
  
  // Message action handlers
  window.toggleMessageActions = function(messageId) {
    // Close all other menus
    document.querySelectorAll('.msg-action-menu').forEach(menu => {
      if (menu.id !== `msgActions${messageId}`) {
        menu.classList.remove('show');
      }
    });

    const menu = document.getElementById(`msgActions${messageId}`);
    menu.classList.toggle('show');
  };
  
  // Close message action menus on outside click
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.msg-action-btn') && !e.target.closest('.msg-action-menu')) {
      document.querySelectorAll('.msg-action-menu').forEach(menu => {
        menu.classList.remove('show');
      });
    }
  });
  
  // Show action buttons on message hover
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.chat-message-wrapper').forEach(wrapper => {
      wrapper.addEventListener('mouseenter', function() {
        const actionBtn = this.querySelector('.msg-action-btn');
        if (actionBtn) actionBtn.style.display = 'flex';
      });
      wrapper.addEventListener('mouseleave', function() {
        const actionBtn = this.querySelector('.msg-action-btn');
        if (actionBtn) actionBtn.style.display = 'none';
      });
    });
  });
  
  window.reportChatMessage = function(messageId, senderId) {
    showConfirm(
      'Report this message to our moderation team? This action will help keep the community safe.',
      async function() {
        try {
          const res = await fetch(`/api/users/${senderId}/report`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              reason: 'inappropriate',
              description: `Reported from chat message ID: ${messageId}`
            })
          });
          const data = await res.json();
          
          if (data.success) {
            showSuccess('Message reported successfully. Our moderation team will review it.', 'Report Submitted');
          } else {
            showError(data.error || 'Failed to report message', 'Report Failed');
          }
        } catch (error) {
          console.error('Report error:', error);
          showError('An error occurred while reporting this message', 'Report Failed');
        }
      },
      null,
      'Report Message',
      '‚ö†Ô∏è'
    );
  };

  window.suspendConversationUser = function(userId) {
    if (!isSuperAdminUser) {
      showError('Only super admins can suspend users.', 'Permission denied');
      closeFloatingMenus();
      return;
    }
    const defaultDays = moderationTarget?.account_status === 'suspended' ? 7 : 3;
    const days = parseInt(prompt('Suspend this user for how many days?', defaultDays), 10);
    if (!days || Number.isNaN(days)) return;

    const reason = prompt('Reason for suspension (optional)', 'Suspended from messages view');

    showConfirm(
      `Suspend this user for ${days} day(s)? They will lose platform access until reinstated.`,
      async function() {
        try {
          const res = await fetch(`/admin/users/${userId}/suspend`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ days, reason, notifyUser: true })
          });
          const data = await res.json();
          if (data.success) {
            showSuccess('User suspended successfully.', 'Suspended');
          } else {
            if (res.status === 403) {
              showError('You need super admin privileges to suspend users.', 'Permission denied');
            } else {
              showError(data.error || 'Failed to suspend user', 'Suspend Failed');
            }
          }
        } catch (err) {
          console.error('Suspend error', err);
          showError('Could not suspend this user right now.', 'Suspend Failed');
        } finally {
          closeFloatingMenus();
        }
      },
      null,
      'Suspend User',
      '‚è∏Ô∏è'
    );
  };

  window.toggleChatFreeze = function(userId) {
    const action = chatFreezeState ? 'unfreeze' : 'freeze';
    const reason = chatFreezeState ? 'Restoring chat privileges' : 'Frozen from messages view';
    const confirmText = chatFreezeState
      ? 'Restore chat privileges for this user? They will be able to send messages again.'
      : 'Freeze chat privileges? They will not be able to send messages until unfrozen.';

    showConfirm(
      confirmText,
      async function() {
        try {
          const res = await fetch(`/admin/users/${userId}/freeze-chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Accept: 'application/json' },
            body: JSON.stringify({ action, reason })
          });
          const data = await res.json();
          if (data.success) {
            chatFreezeState = data.frozen;
            const btn = document.getElementById('freezeActionBtn');
            if (btn) btn.textContent = data.frozen ? '‚ùÑÔ∏è Unfreeze chat' : '‚ùÑÔ∏è Freeze chat';
            showSuccess(data.message || 'Chat privileges updated.', data.frozen ? 'Chat Frozen' : 'Chat Restored');
          } else {
            if (res.status === 403) {
              showError('You need admin privileges to change chat status.', 'Permission denied');
            } else {
              showError(data.error || 'Failed to update chat privileges', 'Action failed');
            }
          }
        } catch (err) {
          console.error('Freeze chat error', err);
          showError('Could not update chat privileges right now.', 'Action failed');
        } finally {
          closeFloatingMenus();
        }
      },
      null,
      action === 'freeze' ? 'Freeze Chat' : 'Unfreeze Chat',
      '‚ùÑÔ∏è'
    );
  };
  
  window.blockChatUser = function(userId) {
    showConfirm(
      'Block this user? You will no longer receive messages from them and they won\'t be able to message you.',
      async function() {
        try {
          const res = await fetch(`/api/users/${userId}/block`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason: 'Blocked from chat' })
          });
          const data = await res.json();
          
          if (res.status === 403) {
            showError(data.error || 'You cannot block users at this time.', 'Block Restricted');
            return;
          }
          
          if (data.success) {
            showSuccess('User blocked successfully. Refreshing...', 'User Blocked');
            setTimeout(() => window.location.reload(), 1500);
          } else {
            showError(data.error || 'Failed to block user', 'Block Failed');
          }
        } catch (error) {
          console.error('Block error:', error);
          showError('An error occurred while blocking this user', 'Block Failed');
        }
      },
      null,
      'Block User',
      'üö´'
    );
  };

  window.unblockChatUser = function(userId) {
    showConfirm(
      'Unblock this user? They will be able to message you again.',
      async function() {
        try {
          const res = await fetch(`/api/users/${userId}/unblock`, { method: 'POST' });
          const data = await res.json();

          if (data.success) {
            showSuccess('User unblocked successfully. Refreshing...', 'User Unblocked');
            setTimeout(() => window.location.reload(), 1200);
          } else {
            showError(data.error || 'Failed to unblock user', 'Unblock Failed');
          }
        } catch (error) {
          console.error('Unblock error:', error);
          showError('An error occurred while unblocking this user', 'Unblock Failed');
        }
      },
      null,
      'Unblock User',
      '‚úÖ'
    );
  };
</script>

<!-- Group Settings Modal -->
  <div id="groupSettingsModal" style="display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;padding:20px;">
    <div style="background:white;border-radius:20px;max-width:600px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
    <div style="padding:1.5rem;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;">
      <h3 style="margin:0;font-size:1.25rem;font-weight:700;">Group Settings</h3>
      <button type="button" onclick="closeGroupSettings()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-light);">&times;</button>
    </div>
    
    <div style="padding:1.5rem;">
      <!-- Group Name -->
      <div style="margin-bottom:1.5rem;">
        <label style="display:block;margin-bottom:.5rem;font-weight:600;font-size:.8rem;">Group Name</label>
        <div style="display:flex;gap:.5rem;">
          <input type="text" id="editGroupName" value="<%= currentConversation && currentConversation.group_name || 'Group Chat' %>" style="flex:1;padding:.65rem;border:2px solid var(--border-color);border-radius:8px;font-size:.85rem;">
          <button type="button" onclick="updateGroupName()" style="background:var(--primary-color);color:#fff;border:none;padding:.65rem 1.25rem;border-radius:8px;font-weight:600;cursor:pointer;font-size:.85rem;">Save</button>
        </div>
      </div>

      <!-- Members List -->
      <div style="margin-bottom:1.5rem;">
        <label style="display:block;margin-bottom:.75rem;font-weight:600;font-size:.8rem;">Members (<span id="memberCount"><%= participants ? participants.length : 0 %></span>)</label>
        <div id="groupMembersList" style="max-height:300px;overflow-y:auto;border:1px solid var(--border-color);border-radius:8px;">
          <% if (currentConversation && currentConversation.is_group && participants) { %>
            <% participants.forEach(p => { %>
              <div class="group-member-item" data-user-id="<%= p.id %>" style="display:flex;align-items:center;gap:.75rem;padding:.75rem;border-bottom:1px solid var(--border-color);transition:background .2s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
                <% if (p.profile_picture) { %>
                  <img src="/uploads/<%= p.profile_picture %>" style="width:40px;height:40px;border-radius:50%;object-fit:cover;" alt="<%= p.full_name %>">
                <% } else { %>
                  <div style="width:40px;height:40px;border-radius:50%;background:var(--primary-color);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.9rem;"><%= p.full_name.charAt(0) %></div>
                <% } %>
                <div style="flex:1;">
                  <div style="font-weight:600;font-size:.85rem;"><%= p.full_name %></div>
                  <% if (p.handle) { %>
                    <div style="font-size:.7rem;color:var(--text-light);">@<%= p.handle %></div>
                  <% } %>
                </div>
                <% if (p.id !== authUser.id) { %>
                  <button type="button" onclick="removeGroupMember(<%= p.id %>, '<%= p.full_name.replace(/'/g, "\\'") %>')" style="background:#ef4444;color:#fff;border:none;padding:.4rem .8rem;border-radius:6px;font-size:.7rem;font-weight:600;cursor:pointer;" title="Remove from group">Remove</button>
                <% } %>
              </div>
            <% }); %>
          <% } %>
        </div>
      </div>

      <!-- Add Members -->
      <div style="margin-bottom:1.5rem;">
        <label style="display:block;margin-bottom:.5rem;font-weight:600;font-size:.8rem;">Add Members</label>
        <input type="text" id="addMemberSearch" placeholder="Search users to add..." style="width:100%;padding:.65rem;border:2px solid var(--border-color);border-radius:8px;font-size:.85rem;margin-bottom:.5rem;">
        <div id="addMemberResults" style="max-height:200px;overflow-y:auto;border:1px solid var(--border-color);border-radius:8px;"></div>
      </div>

      <!-- Group Actions -->
      <div style="padding:1rem;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;">
        <h4 style="margin:0 0 .75rem 0;font-size:.9rem;color:#991b1b;font-weight:700;">‚ö†Ô∏è Danger Zone</h4>
        <button type="button" onclick="leaveGroup()" style="width:100%;background:#ef4444;color:#fff;border:none;padding:.65rem;border-radius:8px;font-weight:600;cursor:pointer;font-size:.85rem;transition:background .2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">Leave Group</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Group Settings Functions
  window.openGroupSettings = () => {
    document.getElementById('groupSettingsModal').style.display = 'flex';
    initAddMemberSearch();
  };

  window.closeGroupSettings = () => {
    document.getElementById('groupSettingsModal').style.display = 'none';
    document.getElementById('addMemberSearch').value = '';
    document.getElementById('addMemberResults').innerHTML = '';
  };

  document.getElementById('groupSettingsModal')?.addEventListener('click', (e) => {
    if (e.target.id === 'groupSettingsModal') {
      closeGroupSettings();
    }
  });

  window.updateGroupName = async () => {
    const newName = document.getElementById('editGroupName').value.trim();
    if (!newName) {
      alert('Group name cannot be empty');
      return;
    }
    try {
      const res = await fetch(`/messages/group/<%= currentConversation && currentConversation.id || '' %>/name`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ groupName: newName })
      });
      const data = await res.json();
      if (data.success) {
        location.reload();
      } else {
        alert(data.error || 'Failed to update group name');
      }
    } catch (e) {
      console.error('Update group name error:', e);
      alert('Failed to update group name');
    }
  };

  window.removeGroupMember = async (userId, userName) => {
    if (!confirm(`Remove ${userName} from this group?`)) return;
    try {
      const res = await fetch(`/messages/group/<%= currentConversation && currentConversation.id || '' %>/remove`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId })
      });
      const data = await res.json();
      if (data.success) {
        location.reload();
      } else {
        alert(data.error || 'Failed to remove member');
      }
    } catch (e) {
      console.error('Remove member error:', e);
      alert('Failed to remove member');
    }
  };

  window.addGroupMember = async (userId, userName) => {
    try {
      const res = await fetch(`/messages/group/<%= currentConversation && currentConversation.id || '' %>/add`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId })
      });
      const data = await res.json();
      if (data.success) {
        location.reload();
      } else {
        alert(data.error || 'Failed to add member');
      }
    } catch (e) {
      console.error('Add member error:', e);
      alert('Failed to add member');
    }
  };

  window.leaveGroup = async () => {
    if (!confirm('Are you sure you want to leave this group? You won\'t be able to see messages anymore.')) return;
    try {
      const res = await fetch(`/messages/group/<%= currentConversation && currentConversation.id || '' %>/leave`, {
        method: 'POST'
      });
      const data = await res.json();
      if (data.success) {
        window.location.href = '/messages';
      } else {
        alert(data.error || 'Failed to leave group');
      }
    } catch (e) {
      console.error('Leave group error:', e);
      alert('Failed to leave group');
    }
  };

  function initAddMemberSearch() {
    const searchInput = document.getElementById('addMemberSearch');
    if (!searchInput) return;
    
    let searchTimeout;
    const currentMembers = <%= currentConversation && currentConversation.is_group && participants ? JSON.stringify(participants.map(p => p.id)) : '[]' %>;
    
    searchInput.addEventListener('input', async () => {
      clearTimeout(searchTimeout);
      const q = searchInput.value.trim();
      if (!q) {
        document.getElementById('addMemberResults').innerHTML = '';
        return;
      }
      
      searchTimeout = setTimeout(async () => {
        try {
          const res = await fetch(`/api/users/search?q=${encodeURIComponent(q)}`);
          const data = await res.json();
          if (!res.ok) {
            document.getElementById('addMemberResults').innerHTML = '<div style="padding:.75rem;text-align:center;color:#ef4444;font-size:.8rem;">Search failed</div>';
            return;
          }
          
          const users = (data.results || []).filter(u => !currentMembers.includes(u.id));
          if (users.length === 0) {
            document.getElementById('addMemberResults').innerHTML = '<div style="padding:.75rem;text-align:center;color:var(--text-light);font-size:.8rem;">No users found</div>';
            return;
          }
          
          document.getElementById('addMemberResults').innerHTML = users.map(u => `
            <div style="display:flex;align-items:center;gap:.5rem;padding:.5rem;border-bottom:1px solid var(--border-color);cursor:pointer;" onclick="addGroupMember(${u.id}, '${u.full_name.replace(/'/g, "\\'")}')">
              ${u.profile_picture ? `<img src="/uploads/${u.profile_picture}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">` : `<div style="width:32px;height:32px;border-radius:50%;background:var(--primary-color);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.75rem;">${u.full_name.charAt(0)}</div>`}
              <div style="display:flex;flex-direction:column;">
                <span style="font-weight:600;font-size:.8rem;">${u.full_name}</span>
                ${u.handle ? `<span style="font-size:.7rem;color:var(--text-light);">@${u.handle}</span>` : ''}
              </div>
            </div>
          `).join('');
        } catch (e) {
          console.error('Member search error:', e);
          document.getElementById('addMemberResults').innerHTML = '<div style="padding:.75rem;text-align:center;color:#ef4444;font-size:.8rem;">Error searching users</div>';
        }
      }, 250);
    });
  }
</script>

<!-- Image Carousel Modal -->
<div id="imageCarouselOverlay" style="display:none;position:fixed;z-index:2500;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.9);align-items:center;justify-content:center;">
  <button onclick="_carouselClose()" aria-label="Close" style="position:absolute;top:16px;right:16px;background:none;border:none;color:#fff;font-size:28px;cursor:pointer;">√ó</button>
  <button onclick="_carouselPrev()" aria-label="Previous" style="position:absolute;left:8px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;border-radius:999px;width:40px;height:40px;cursor:pointer;">‚Äπ</button>
  <div style="width:94%;max-width:920px;overflow:hidden;">
    <div id="imageCarouselTrack" style="display:flex;transition:transform .3s ease;">
      <!-- slides injected here -->
    </div>
  </div>
  <button onclick="_carouselNext()" aria-label="Next" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;border-radius:999px;width:40px;height:40px;cursor:pointer;">‚Ä∫</button>
  <div id="carouselCounter" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);color:#fff;font-weight:700;">1/1</div>
</div>

<%- include('partials/footer') %>
