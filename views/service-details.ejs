<%- include('partials/header') %>

<style>
  body { background: linear-gradient(180deg, #0f0f23 0%, #1a1a2e 100%); min-height: 100vh; }
  
  .service-hero-banner {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #ff4fa3 100%);
    padding: 60px 20px 40px;
    position: relative;
    overflow: hidden;
  }
  
  .service-hero-banner::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    opacity: 0.1;
  }
  
  .service-hero-content {
    max-width: 1200px;
    margin: 0 auto;
    position: relative;
    z-index: 1;
  }
  
  .service-breadcrumb {
    display: flex;
    align-items: center;
    gap: 8px;
    color: rgba(255,255,255,0.8);
    font-size: 0.9rem;
    margin-bottom: 24px;
  }
  
  .service-breadcrumb a {
    color: rgba(255,255,255,0.9);
    text-decoration: none;
    transition: color 0.2s;
  }
  
  .service-breadcrumb a:hover { color: #fff; }
  
  .service-header {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 16px;
  }
  
  .provider-avatar-large {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    font-weight: 700;
    color: #333;
    box-shadow: 0 8px 24px rgba(255, 215, 0, 0.4);
    border: 4px solid rgba(255, 255, 255, 0.3);
  }
  
  .provider-avatar-large img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
  }
  
  .service-header-text h1 {
    margin: 0 0 8px;
    font-size: 2.5rem;
    font-weight: 800;
    color: #fff;
    text-shadow: 0 2px 12px rgba(0,0,0,0.3);
  }
  
  .service-provider-meta {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }
  
  .provider-name {
    font-size: 1.1rem;
    font-weight: 600;
    color: rgba(255,255,255,0.95);
  }
  
  .service-rating-display {
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(10px);
    padding: 6px 14px;
    border-radius: 20px;
  }
  
  .service-stars {
    color: #fbbf24;
    font-size: 18px;
    letter-spacing: 2px;
  }
  
  .service-rating-text {
    color: #fff;
    font-weight: 600;
  }
  
  .service-content-wrapper {
    max-width: 1200px;
    margin: -30px auto 60px;
    padding: 0 20px;
    display: grid;
    grid-template-columns: 1fr 420px;
    gap: 32px;
    position: relative;
    z-index: 2;
  }
  
  @media (max-width: 1024px) {
    .service-content-wrapper { grid-template-columns: 1fr; }
  }
  
  .service-main-card, .service-booking-card {
    background: rgba(255, 255, 255, 0.03);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 24px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    overflow: hidden;
  }
  
  .service-main-card {
    padding: 40px;
  }
  
  .section-heading {
    margin: 0 0 20px;
    font-size: 1.75rem;
    font-weight: 700;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .section-heading svg {
    color: #ff4fa3;
  }
  
  .service-description {
    color: #cbd5e1;
    line-height: 1.8;
    font-size: 1.05rem;
  }
  
  .service-details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 32px;
    padding-top: 32px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .service-detail-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .service-detail-label {
    color: #94a3b8;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .service-detail-value {
    color: #e5e7eb;
    font-size: 1.1rem;
    font-weight: 600;
  }
  
  .service-booking-card {
    position: sticky;
    top: 20px;
    height: fit-content;
  }
  
  .booking-card-inner {
    padding: 32px;
  }
  
  .booking-price-display {
    display: flex;
    align-items: baseline;
    gap: 8px;
    margin-bottom: 24px;
    padding-bottom: 24px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .booking-price {
    font-size: 3rem;
    font-weight: 800;
    background: linear-gradient(135deg, #667eea, #ff4fa3);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .booking-price-unit {
    color: #94a3b8;
    font-size: 1.1rem;
  }
  
  .booking-form-group {
    margin-bottom: 20px;
  }
  
  .booking-label {
    display: block;
    margin-bottom: 8px;
    color: #cbd5e1;
    font-weight: 600;
    font-size: 0.95rem;
  }
  
  .booking-input, .booking-select {
    width: 100%;
    background: rgba(15, 23, 42, 0.6);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    color: #e5e7eb;
    padding: 14px 16px;
    font-size: 1rem;
    transition: all 0.3s;
  }
  
  .booking-input:focus, .booking-select:focus {
    outline: none;
    border-color: #ff4fa3;
    background: rgba(15, 23, 42, 0.8);
    box-shadow: 0 0 0 3px rgba(255, 79, 163, 0.1);
  }
  
  .booking-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
  }
  
  .booking-btn {
    flex: 1;
    padding: 16px 24px;
    border-radius: 12px;
    border: none;
    font-weight: 700;
    font-size: 1.05rem;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  
  .booking-btn-primary {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: #fff;
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
  }
  
  .booking-btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 30px rgba(102, 126, 234, 0.5);
  }
  
  .booking-btn-secondary {
    background: rgba(255, 255, 255, 0.05);
    color: #e5e7eb;
    border: 2px solid rgba(255, 255, 255, 0.1);
  }
  
  .booking-btn-secondary:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.2);
  }
  
  .booking-note {
    margin-top: 16px;
    color: #94a3b8;
    font-size: 0.85rem;
    text-align: center;
    line-height: 1.5;
  }
  
  .reviews-section {
    max-width: 1200px;
    margin: 0 auto 60px;
    padding: 0 20px;
  }
  
  .reviews-header {
    margin-bottom: 32px;
  }
  
  .review-form-card {
    background: rgba(255, 255, 255, 0.03);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 20px;
    padding: 32px;
    margin-bottom: 32px;
  }
  
  .review-form-title {
    margin: 0 0 20px;
    font-size: 1.5rem;
    font-weight: 700;
    color: #fff;
  }
  
  .review-list {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  
  .review-card {
    background: rgba(255, 255, 255, 0.03);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 16px;
    padding: 24px;
    transition: all 0.3s;
  }
  
  .review-card:hover {
    border-color: rgba(255, 255, 255, 0.15);
    transform: translateX(4px);
  }
  
  .review-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
  }
  
  .reviewer-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: #fff;
    font-size: 1.2rem;
  }
  
  .reviewer-avatar img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
  }
  
  .reviewer-info {
    flex: 1;
  }
  
  .reviewer-name {
    margin: 0 0 4px;
    font-size: 1.1rem;
    font-weight: 600;
    color: #e5e7eb;
  }
  
  .review-rating {
    color: #fbbf24;
    font-size: 1rem;
  }
  
  .review-comment {
    margin: 0;
    color: #cbd5e1;
    line-height: 1.7;
  }
  
  .empty-reviews {
    text-align: center;
    padding: 60px 20px;
    color: #94a3b8;
  }
  
  .empty-reviews svg {
    margin: 0 auto 20px;
    opacity: 0.3;
  }
</style>

<section class="service-hero-banner">
  <div class="service-hero-content">
    <div class="service-breadcrumb">
      <a href="/services">Services</a>
      <span>â€º</span>
      <span><%= service.category %></span>
    </div>
    
    <div class="service-header">
      <% if (service.profile_picture) { %>
        <div class="provider-avatar-large">
          <img src="/uploads/<%= service.profile_picture %>" alt="<%= service.full_name %>" />
        </div>
      <% } else { %>
        <div class="provider-avatar-large"><%= (service.full_name||'D')[0] %></div>
      <% } %>
      
      <div class="service-header-text">
        <h1><%= service.title %></h1>
        <div class="service-provider-meta">
          <span class="provider-name">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline;vertical-align:middle;margin-right:4px">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <%= service.full_name %>
          </span>
          <div class="service-rating-display">
            <span class="service-stars">
              <% const avg = Number(service.rating_avg || 0); const fullStars = Math.floor(avg); const half = (avg - fullStars) >= 0.5; %>
              <% for (let i=0;i<fullStars;i++){ %>â˜…<% } %>
              <% if (half) { %>â˜…<% } %>
              <% for (let i=fullStars + (half?1:0); i<5; i++){ %>â˜†<% } %>
            </span>
            <span class="service-rating-text"><%= (avg || 0).toFixed(1) %> (<%= service.rating_count || 0 %>)</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<div class="service-content-wrapper">
  <div class="service-main-card">
    <h2 class="section-heading">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M12 16v-4"></path>
        <path d="M12 8h.01"></path>
      </svg>
      About This Service
    </h2>
    <p class="service-description"><%= service.description %></p>
    
    <div class="service-details-grid">
      <div class="service-detail-item">
        <span class="service-detail-label">Category</span>
        <span class="service-detail-value"><%= service.category %></span>
      </div>
      <div class="service-detail-item">
        <span class="service-detail-label">Experience Level</span>
        <span class="service-detail-value"><%= service.experience_level || 'All levels' %></span>
      </div>
      <div class="service-detail-item">
        <span class="service-detail-label">Format</span>
        <span class="service-detail-value"><%= service.format || 'Flexible' %></span>
      </div>
      <div class="service-detail-item">
        <span class="service-detail-label">Duration</span>
        <span class="service-detail-value"><%= service.duration_minutes %> minutes</span>
      </div>
    </div>
  </div>

  <aside class="service-booking-card">
    <div class="booking-card-inner">
      <div class="booking-price-display">
        <span class="booking-price">$<%= service.price_per_hour %></span>
        <span class="booking-price-unit">/ hour</span>
      </div>
      
      <% if (isOwner) { %>
        <div style="text-align:center;padding:24px 0;">
          <div style="font-size:48px;margin-bottom:12px;">ðŸŽ¯</div>
          <h3 style="color:#cbd5e1;margin:0 0 8px;font-size:18px;">This is your service!</h3>
          <p style="color:#94a3b8;margin:0 0 20px;font-size:14px;">You can't book your own sessions, silly! But you can edit or manage it below.</p>
          <a href="/services/<%= service.id %>/edit" class="booking-btn booking-btn-primary" style="width:100%;text-decoration:none;margin-bottom:12px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            Edit Service
          </a>
        </div>
      <% } else { %>
      <form id="bookingForm">
        <div class="booking-form-group">
          <label class="booking-label" for="sessionLength">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline;vertical-align:middle;margin-right:6px">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            Session Length
          </label>
          <select id="sessionLength" class="booking-select">
            <option value="<%= service.duration_minutes %>"><%= service.duration_minutes %> minutes</option>
            <option value="30">30 minutes</option>
            <option value="45">45 minutes</option>
            <option value="60">60 minutes</option>
            <option value="90">90 minutes</option>
          </select>
        </div>
        
        <div class="booking-form-group">
          <label class="booking-label" for="sessionDate">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline;vertical-align:middle;margin-right:6px">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            Preferred Date
          </label>
          <select id="sessionDate" class="booking-select" required>
            <option value="" selected disabled>Select a date</option>
          </select>
        </div>
        
        <div class="booking-form-group">
          <label class="booking-label" for="sessionTime">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline;vertical-align:middle;margin-right:6px">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            Preferred Time
          </label>
          <select id="sessionTime" class="booking-select" required disabled>
            <option value="" selected disabled>Select a time</option>
          </select>
        </div>
        
        <div class="booking-actions">
          <button type="submit" class="booking-btn booking-btn-primary">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
              <line x1="1" y1="10" x2="23" y2="10"></line>
            </svg>
            Book & Pay
          </button>
          <a class="booking-btn booking-btn-secondary" href="/messages/start/<%= service.user_id %>">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            Chat
          </a>
        </div>
        
        <p class="booking-note">ðŸ”’ Payments are securely processed. Message the provider directly with any questions.</p>
      </form>
      <% } %>
      
      <% if (false && isOwner) { %>
        <div style="margin-top:20px;padding-top:20px;border-top:1px solid rgba(255,255,255,0.1);">
          <a href="/services/<%= service.id %>/edit" class="booking-btn booking-btn-secondary" style="width:100%;text-decoration:none;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            Edit Service
          </a>
        </div>
      <% } %>
    </div>
  </aside>
</div>

<section class="reviews-section">
  <div class="reviews-header">
    <h2 class="section-heading">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
      </svg>
      Reviews
    </h2>
  </div>
  
  <% if (canReview) { %>
    <div class="review-form-card">
      <h3 class="review-form-title">Share Your Experience</h3>
      <form id="reviewForm">
        <div class="booking-form-group">
          <label class="booking-label" for="rating">Your Rating</label>
          <select name="rating" id="rating" class="booking-select" required>
            <option value="">Select a rating</option>
            <option value="5">â˜…â˜…â˜…â˜…â˜… Excellent</option>
            <option value="4">â˜…â˜…â˜…â˜…â˜† Very Good</option>
            <option value="3">â˜…â˜…â˜…â˜†â˜† Good</option>
            <option value="2">â˜…â˜…â˜†â˜†â˜† Fair</option>
            <option value="1">â˜…â˜†â˜†â˜†â˜† Poor</option>
          </select>
        </div>
        <div class="booking-form-group">
          <label class="booking-label" for="comment">Comment (Optional)</label>
          <textarea name="comment" id="comment" class="booking-input" rows="4" placeholder="Share details about your experience..." style="resize:vertical;"></textarea>
        </div>
        <button type="submit" class="booking-btn booking-btn-primary" style="width:100%;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          Submit Review
        </button>
      </form>
    </div>
  <% } %>
  
  <div class="review-list">
    <% if (reviews && reviews.length > 0) { %>
      <% reviews.forEach(function(r){ %>
        <div class="review-card" data-review-id="<%= r.id %>">
          <div class="review-header">
            <% if (r.profile_picture) { %>
              <div class="reviewer-avatar">
                <img src="/uploads/<%= r.profile_picture %>" alt="<%= r.user %>" />
              </div>
            <% } else { %>
              <div class="reviewer-avatar"><%= r.user[0] %></div>
            <% } %>
            <div class="reviewer-info">
              <h4 class="reviewer-name"><%= r.user %></h4>
              <div class="review-rating">
                <% for (let i=0; i<r.rating; i++) { %>â˜…<% } %>
                <% for (let i=r.rating; i<5; i++) { %>â˜†<% } %>
              </div>
            </div>
            <% if (typeof authUser !== 'undefined' && authUser && (authUser.role === 'admin' || authUser.role === 'super_admin' || authUser.role === 'global_admin')) { %>
              <div class="review-actions" style="position:relative;margin-left:auto;">
                <button type="button" class="review-dots-btn" data-review-id="<%= r.id %>" style="background:none;border:none;font-size:20px;color:#94a3b8;cursor:pointer;padding:4px 8px;border-radius:6px;transition:all .2s;" onmouseover="this.style.background='rgba(255,255,255,.08)'" onmouseout="this.style.background='none'">â‹®</button>
                <div id="reviewMenu<%= r.id %>" class="review-dropdown" style="display:none;position:absolute;right:0;top:100%;background:#0f172a;border:1px solid rgba(255,255,255,.12);border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,.3);min-width:140px;z-index:100;">
                  <button type="button" class="review-moderate-btn" data-review-id="<%= r.id %>" data-action="hide" style="width:100%;text-align:left;background:none;border:none;padding:10px 14px;color:#e5e7eb;font-size:14px;cursor:pointer;transition:all .2s;" onmouseover="this.style.background='rgba(255,255,255,.08)'" onmouseout="this.style.background='none'">Hide Review</button>
                  <button type="button" class="review-moderate-btn" data-review-id="<%= r.id %>" data-action="delete" style="width:100%;text-align:left;background:none;border:none;padding:10px 14px;color:#ef4444;font-size:14px;cursor:pointer;transition:all .2s;" onmouseover="this.style.background='rgba(239,68,68,.12)'" onmouseout="this.style.background='none'">Delete Review</button>
                </div>
              </div>
            <% } %>
          </div>
          <% if (r.comment) { %>
            <p class="review-comment"><%= r.comment %></p>
          <% } %>
        </div>
      <% }); %>
    <% } else { %>
      <div class="empty-reviews">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
        </svg>
        <h3 style="color:#cbd5e1;margin:0 0 8px;">No reviews yet</h3>
        <p style="margin:0;">Be the first to review this service after booking!</p>
      </div>
    <% } %>
  </div>
</section>

<!-- Availability JSON for client parsing -->
<script type="application/json" id="availability-data"><%- JSON.stringify(service.availability || '') %></script>

<script>
  // Build booking dropdowns from provider availability
  (function initAvailability(){
    const availabilityRawText = (document.getElementById('availability-data')?.textContent || '""');
    let availabilityRaw = '';
    try { availabilityRaw = JSON.parse(availabilityRawText) || ''; } catch(_) { availabilityRaw = ''; }
    const dateSel = document.getElementById('sessionDate');
    const timeSel = document.getElementById('sessionTime');
    function fmtDate(d){
      try { const dt = new Date(d + 'T00:00:00'); return dt.toLocaleDateString(undefined,{weekday:'short', month:'short', day:'numeric'}); } catch(_){ return d; }
    }
    try {
      const parsed = availabilityRaw ? JSON.parse(availabilityRaw) : null;
      const dates = parsed && Array.isArray(parsed.dates) ? parsed.dates : [];
      if (dates.length === 0) return;
      // Populate dates
      dateSel.innerHTML = '<option value="" disabled selected>Select a date</option>' + dates.map(d => `<option value="${d.date}">${fmtDate(d.date)}</option>`).join('');
      dateSel.disabled = false;
      dateSel.addEventListener('change', () => {
        const sel = dates.find(x => x.date === dateSel.value);
        const times = sel && Array.isArray(sel.times) ? sel.times : [];
        timeSel.innerHTML = '<option value="" disabled selected>Select a time</option>' + times.map(t => `<option value="${t}">${t}</option>`).join('');
        timeSel.disabled = times.length === 0;
      });
    } catch(e){ /* ignore, fallback to empty selects */ }
  })();

  // Review moderation functions (admin only)
  function toggleReviewMenu(reviewId) {
    const menu = document.getElementById('reviewMenu' + reviewId);
    if (!menu) return;
    // Close other menus
    document.querySelectorAll('.review-dropdown').forEach(m => {
      if (m !== menu) m.style.display = 'none';
    });
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
  }

  function moderateReview(reviewId, action) {
    showConfirm(
      `This will ${action} the review. Continue?`,
      () => {
        fetch(`/api/reviews/${reviewId}/moderate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action })
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            showSuccess(`Review ${action === 'hide' ? 'hidden' : 'deleted'} successfully`, {
              onConfirm: () => location.reload()
            });
          } else {
            showError(data.error || 'Failed to moderate review');
          }
        })
        .catch(err => {
          console.error('Moderation error:', err);
          showError('Failed to moderate review');
        });
      }
    );
  }

  // Attach event listeners
  document.addEventListener('DOMContentLoaded', () => {
    // Toggle review menus
    document.querySelectorAll('.review-dots-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const reviewId = btn.dataset.reviewId;
        if (reviewId) toggleReviewMenu(reviewId);
      });
    });

    // Moderate review actions
    document.querySelectorAll('.review-moderate-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const reviewId = btn.dataset.reviewId;
        const action = btn.dataset.action;
        if (reviewId && action) moderateReview(reviewId, action);
      });
    });

    // Close menus when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.review-actions')) {
        document.querySelectorAll('.review-dropdown').forEach(m => m.style.display = 'none');
      }
    });
  });


  // Booking form handler
  const bookingForm = document.getElementById('bookingForm');
  let lastBookingPayload = null;
  if (bookingForm) {
    bookingForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const sessionLength = document.getElementById('sessionLength').value;
      const sessionDate = document.getElementById('sessionDate').value;
      const sessionTime = document.getElementById('sessionTime').value;
      
      if (!sessionDate || !sessionTime) {
        showWarning('Please select both date and time for your session.');
        return;
      }
      
      try {
        lastBookingPayload = { sessionLength, sessionDate, sessionTime };
        const resp = await fetch('/services/<%= service.id %>/book', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(lastBookingPayload)
        });
        
        const data = await resp.json();
        
        if (data && data.success) {
          showSuccess('Booking confirmed! You can now leave a verified review after the session.', {
            onConfirm: () => window.location.reload()
          });
        } else if (data && data.requirePayment) {
          if (window.openPaymentModal) window.openPaymentModal();
        } else {
          showError(data.error || 'Booking failed. Please try again.');
        }
      } catch (err) {
        console.error('Booking error:', err);
        showError('Booking failed. Please try again.');
      }
    });
  }
  
  // Review form handler
  const reviewForm = document.getElementById('reviewForm');
  if (reviewForm) {
    reviewForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const rating = document.getElementById('rating').value;
      const comment = document.getElementById('comment').value;
      
      if (!rating) {
        showWarning('Please select a rating.');
        return;
      }
      
      try {
        const resp = await fetch('/api/services/<%= service.id %>/reviews', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ rating: parseInt(rating), comment })
        });
        
        const data = await resp.json();
        
        if (data.success) {
          showSuccess('Review submitted successfully!', {
            onConfirm: () => window.location.reload()
          });
        } else {
          showError(data.error || 'Failed to submit review');
        }
      } catch (err) {
        console.error('Review error:', err);
        showError('Failed to submit review. Please try again.');
      }
    });
  }
</script>

<!-- Payment Modal -->
<style>
  .dx-modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center; }
  .dx-modal { background: rgba(255,255,255,0.06); backdrop-filter: blur(20px); border:1px solid rgba(255,255,255,0.12); border-radius:20px; padding:24px; width: 95%; max-width: 560px; box-shadow:0 20px 60px rgba(0,0,0,0.4); color:#e5e7eb; }
  .dx-modal h3 { margin:0 0 4px; font-size:1.4rem; font-weight:800; }
  .dx-modal p { margin:0 0 16px; color:#94a3b8; }
  .dx-tabs { display:flex; gap:8px; margin-bottom:12px; }
  .dx-tab { flex:1; padding:10px 12px; text-align:center; border-radius:10px; border:1px solid rgba(255,255,255,0.12); cursor:pointer; user-select:none; }
  .dx-tab.active { background: linear-gradient(135deg,#667eea,#764ba2); border-color: transparent; box-shadow: 0 10px 24px rgba(118,75,162,0.35); }
  .dx-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .dx-field { display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
  .dx-label { font-size:0.9rem; color:#cbd5e1; font-weight:600; }
  .dx-input, .dx-select { background: rgba(15,23,42,0.6); border:2px solid rgba(255,255,255,0.1); border-radius:12px; color:#e5e7eb; padding:12px 14px; font-size:1rem; }
  .dx-input:focus, .dx-select:focus { outline:none; border-color:#ff4fa3; box-shadow:0 0 0 3px rgba(255,79,163,0.1); }
  .dx-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:14px; }
  .dx-btn { padding:12px 16px; border-radius:10px; border:none; font-weight:700; cursor:pointer; }
  .dx-btn.primary { background: linear-gradient(135deg,#667eea,#764ba2); color:#fff; }
  .dx-btn.secondary { background: rgba(255,255,255,0.08); color:#e5e7eb; border:1px solid rgba(255,255,255,0.12); }
</style>

<div id="paymentModal" class="dx-modal-overlay">
  <div class="dx-modal">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px; margin-bottom:8px;">
      <div>
        <h3>Payment Required</h3>
        <p>Add a payment method to complete your booking.</p>
      </div>
      <button id="pmClose" class="dx-btn secondary" style="font-size:20px;line-height:1;padding:8px 12px;">Ã—</button>
    </div>
    <div class="dx-tabs">
      <div id="tabCard" class="dx-tab active">Credit/Debit Card</div>
      <div id="tabBank" class="dx-tab">Bank Account</div>
    </div>
    <form id="pmCard" class="pm-pane">
      <div class="dx-grid">
        <div class="dx-field">
          <label class="dx-label">Card Type</label>
          <select id="pmCardType" class="dx-select">
            <option value="visa">Visa</option>
            <option value="mastercard">Mastercard</option>
            <option value="amex">American Express</option>
          </select>
        </div>
        <div class="dx-field">
          <label class="dx-label">Card Number</label>
          <input id="pmCardNumber" class="dx-input" placeholder="4242 4242 4242 4242" />
        </div>
        <div class="dx-field">
          <label class="dx-label">Expiry Month</label>
          <input id="pmExpMonth" class="dx-input" type="number" min="1" max="12" placeholder="12" />
        </div>
        <div class="dx-field">
          <label class="dx-label">Expiry Year</label>
          <input id="pmExpYear" class="dx-input" type="number" min="2025" max="2050" placeholder="2027" />
        </div>
        <div class="dx-field">
          <label class="dx-label">CVV</label>
          <input id="pmCvv" class="dx-input" placeholder="123" />
        </div>
      </div>
    </form>
    <form id="pmBank" class="pm-pane" style="display:none;">
      <div class="dx-grid">
        <div class="dx-field">
          <label class="dx-label">Country</label>
          <select id="pmBankCountry" class="dx-select">
            <option value="US">United States</option>
            <option value="CA">Canada</option>
            <option value="GB">United Kingdom</option>
            <option value="AU">Australia</option>
          </select>
        </div>
        <div class="dx-field">
          <label class="dx-label">Account Number</label>
          <input id="pmBankAccount" class="dx-input" placeholder="000123456789" />
        </div>
        <div class="dx-field">
          <label class="dx-label">Routing Number</label>
          <input id="pmRouting" class="dx-input" placeholder="110000000" />
        </div>
      </div>
    </form>
    <div class="dx-actions">
      <button id="pmCancel" class="dx-btn secondary">Cancel</button>
      <button id="pmSave" class="dx-btn primary">Save & Continue</button>
    </div>
  </div>
  
</div>

<script>
  const paymentModal = document.getElementById('paymentModal');
  const tabCard = document.getElementById('tabCard');
  const tabBank = document.getElementById('tabBank');
  const paneCard = document.getElementById('pmCard');
  const paneBank = document.getElementById('pmBank');
  const pmClose = document.getElementById('pmClose');
  const pmCancel = document.getElementById('pmCancel');
  const pmSave = document.getElementById('pmSave');

  window.openPaymentModal = function(){ paymentModal.style.display = 'flex'; };
  window.closePaymentModal = function(){ paymentModal.style.display = 'none'; };

  tabCard.addEventListener('click', () => {
    tabCard.classList.add('active'); tabBank.classList.remove('active');
    paneCard.style.display = ''; paneBank.style.display = 'none';
  });
  tabBank.addEventListener('click', () => {
    tabBank.classList.add('active'); tabCard.classList.remove('active');
    paneBank.style.display = ''; paneCard.style.display = 'none';
  });
  pmClose.addEventListener('click', closePaymentModal);
  pmCancel.addEventListener('click', (e)=>{ e.preventDefault(); closePaymentModal(); });

  pmSave.addEventListener('click', async (e) => {
    e.preventDefault();
    try {
      if (tabCard.classList.contains('active')) {
        const cardType = document.getElementById('pmCardType').value;
        const cardNumber = document.getElementById('pmCardNumber').value.replace(/\s+/g,'');
        const expiryMonth = document.getElementById('pmExpMonth').value;
        const expiryYear = document.getElementById('pmExpYear').value;
        const cvv = document.getElementById('pmCvv').value;
        if (!cardType || !cardNumber || !expiryMonth || !expiryYear || !cvv) {
          showWarning('Please complete all card fields.');
          return;
        }
        const res = await fetch('/api/payment-methods/add', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cardType, cardNumber, expiryMonth, expiryYear, setDefault: true })
        });
        const out = await res.json();
        if (!res.ok || !out.success) { 
          showError(out.error || 'Failed to save card');
          return;
        }
      } else {
        const bankCountry = document.getElementById('pmBankCountry').value;
        const bankAccount = document.getElementById('pmBankAccount').value;
        const routingNumber = document.getElementById('pmRouting').value;
        if (!bankCountry || !bankAccount || !routingNumber) {
          showWarning('Please complete all bank fields.');
          return;
        }
        const res = await fetch('/api/banking/save', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ bankCountry, bankAccount, routingNumber })
        });
        const out = await res.json();
        if (!res.ok || !out.success) { 
          showError(out.error || 'Failed to save bank info');
          return;
        }
      }
      // Retry booking after saving payment method
      closePaymentModal();
      if (lastBookingPayload) {
        const resp = await fetch('/services/<%= service.id %>/book', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(lastBookingPayload)
        });
        const data = await resp.json();
        if (data && data.success) {
          showSuccess('Booking confirmed!', {
            onConfirm: () => window.location.reload()
          });
        } else {
          showError(data.error || 'Booking failed. Please try again.');
        }
      }
    } catch (err) {
      console.error('Payment save error:', err);
      showError('Failed to save payment method. Please try again.');
    }
  });
</script>

<%- include('partials/footer') %>
