<%- include('partials/header') %>

<style>
  .dx-sd-hero{background:linear-gradient(135deg,#111827,#0b1020);padding:32px 0;color:#e5e7eb}
  .dx-wrap{max-width:1040px;margin:0 auto;padding:0 20px}
  .dx-title{margin:0 0 6px;font-size:28px;font-weight:800}
  .dx-meta{display:flex;align-items:center;gap:12px;color:#9ca3af}
  .dx-avatar{width:40px;height:40px;border-radius:50%;background:#1f2937;display:inline-flex;align-items:center;justify-content:center;font-weight:700}
  .dx-grid{display:grid;grid-template-columns:1fr 360px;gap:24px;margin:24px 0}
  @media (max-width:900px){.dx-grid{grid-template-columns:1fr}}
  .dx-card{background:#0f172a;border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:0 12px 30px rgba(0,0,0,.35)}
  .dx-card .dx-body{padding:20px}
  .dx-section-title{margin:0 0 10px;color:#cbd5e1;font-size:18px}
  .dx-book{padding:20px}
  .dx-price{display:flex;align-items:baseline;gap:6px}
  .dx-price .amt{font-size:28px;font-weight:800;color:#fff}
  .dx-price .unit{color:#94a3b8}
  .dx-form-row{margin-top:12px}
  .dx-label{display:block;margin-bottom:6px;color:#94a3b8;font-size:13px}
  .dx-input,.dx-select{width:100%;background:#0b1020;border:1px solid rgba(255,255,255,.1);border-radius:12px;color:#e5e7eb;padding:12px 14px}
  .dx-cta{margin-top:14px;display:flex;gap:8px}
  .dx-btn{padding:12px 16px;border-radius:999px;border:0;font-weight:700;cursor:pointer}
  .dx-btn-primary{background:linear-gradient(135deg,#7c3aed,#06b6d4);color:#fff;flex:1}
  .dx-btn-secondary{background:#1f2937;color:#e5e7eb}
  .dx-stars{color:#fbbf24;font-size:16px}
  .dx-note{margin-top:8px;color:#94a3b8;font-size:12px}
</style>

<section class="dx-sd-hero">
  <div class="dx-wrap">
    <h1 class="dx-title"><%= service.title %></h1>
    <div class="dx-meta">
      <% if (service.profile_picture) { %>
        <img class="dx-avatar" src="/uploads/<%= service.profile_picture %>" alt="<%= service.full_name %>" />
      <% } else { %>
        <div class="dx-avatar"><%= (service.full_name||'')[0] || 'D' %></div>
      <% } %>
      <span><%= service.full_name %></span>
      <span>•</span>
      <span class="dx-stars" aria-label="Average rating">
        <% const avg = Number(service.rating_avg || 0); const fullStars = Math.floor(avg); const half = (avg - fullStars) >= 0.5; %>
        <% for (let i=0;i<fullStars;i++){ %>★<% } %>
        <% if (half) { %>☆<% } %>
        <% for (let i=fullStars + (half?1:0); i<5; i++){ %>☆<% } %>
      </span>
      <span><%= (avg || 0).toFixed(1) %> (<%= service.rating_count || 0 %>)</span>
    </div>
  </div>
</section>

<div class="dx-wrap">
  <div class="dx-grid">
    <div class="dx-card">
      <div class="dx-body">
        <h2 class="dx-section-title">About this service</h2>
        <p style="color:#cbd5e1;line-height:1.8"><%= service.description %></p>
      </div>
    </div>

    <aside class="dx-card">
      <div class="dx-book">
        <div class="dx-price">
          <span class="amt">$<%= service.price_per_hour %></span>
          <span class="unit">/ hour</span>
        </div>
        <form id="bookingForm" class="dx-form">
          <div class="dx-form-row">
            <label class="dx-label" for="sessionLength">Session Length</label>
            <select id="sessionLength" class="dx-select">
              <option value="60">60 minutes</option>
              <option value="45">45 minutes</option>
              <option value="30">30 minutes</option>
            </select>
          </div>
          <div class="dx-form-row">
            <label class="dx-label" for="sessionDate">Preferred Date</label>
            <input id="sessionDate" type="date" class="dx-input" />
          </div>
          <div class="dx-form-row">
            <label class="dx-label" for="sessionTime">Preferred Time</label>
            <input id="sessionTime" type="time" class="dx-input" />
          </div>
          <div class="dx-cta">
            <button type="submit" class="dx-btn dx-btn-primary">Book & Pay</button>
            <a class="dx-btn dx-btn-secondary" href="/messages/start/<%= service.user_id %>">Chat</a>
          </div>
          <p class="dx-note">Payments are securely processed. Messaging opens a direct chat with the provider.</p>
        </form>
        <% if (isOwner) { %>
          <div class="dx-cta" style="margin-top:10px">
            <a href="/services/<%= service.id %>/edit" class="dx-btn dx-btn-secondary" style="width:100%;text-align:center">Edit Service</a>
          </div>
        <% } %>
      </div>
    </aside>
  </div>
</div>

<section class="service-reviews-section">
  <div class="dx-wrap">
    <h2 class="dx-section-title">Reviews</h2>
    <% if (canReview) { %>
      <form id="reviewForm" class="dx-form" style="margin:10px 0 16px">
        <div class="dx-form-row">
          <label class="dx-label">Your Rating</label>
          <select name="rating" id="rating" class="dx-select" required>
            <option value="">Select</option>
            <option value="5">★★★★★</option>
            <option value="4">★★★★☆</option>
            <option value="3">★★★☆☆</option>
            <option value="2">★★☆☆☆</option>
            <option value="1">★☆☆☆☆</option>
          </select>
        </div>
        <div class="dx-form-row">
          <label class="dx-label">Comment (optional)</label>
          <textarea name="comment" id="comment" class="dx-input" rows="3" placeholder="Share details about your experience..."></textarea>
        </div>
        <button type="submit" class="dx-btn dx-btn-primary">Submit Review</button>
      </form>
      <script>
      document.getElementById('reviewForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const rating = (document.getElementById('rating').value||'').trim();
        const comment = document.getElementById('comment').value||'';
        if (!rating) { alert('Please select a rating'); return; }
        try {
          const resp = await fetch('/api/services/<%= service.id %>/reviews', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ rating, comment }) });
          const data = await resp.json();
          if (data.success) { window.location.reload(); } else { alert(data.error || 'Failed to submit review'); }
        } catch (err) { alert('Failed to submit review'); }
      });
      </script>
    <% } %>
    <div class="reviews-list">
      <% reviews.forEach(function(r){ %>
        <div class="review-item" style="background:#0f172a;border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:14px;margin:10px 0">
          <div class="review-header" style="display:flex;align-items:center;gap:10px">
            <% if (r.profile_picture) { %>
              <img src="/uploads/<%= r.profile_picture %>" alt="<%= r.user %>" style="width:36px;height:36px;border-radius:50%;object-fit:cover;" />
            <% } else { %>
              <div class="review-avatar" style="width:36px;height:36px;border-radius:50%;background:#1f2937;display:flex;align-items:center;justify-content:center;font-weight:700;color:#e5e7eb"><%= r.user.charAt(0) %></div>
            <% } %>
            <div class="review-meta" style="display:flex;flex-direction:column">
              <span class="review-user" style="color:#e5e7eb"><%= r.user %></span>
              <span class="review-stars" style="color:#fbbf24">Rating: <%= r.rating %>★</span>
            </div>
          </div>
          <p class="review-comment" style="margin:10px 0 0;color:#cbd5e1"><%= r.comment %></p>
        </div>
      <% }); %>
    </div>
  </div>
</section>

<%- include('partials/footer') %>

<script>
  const form = document.getElementById('bookingForm');
  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const resp = await fetch('/services/<%= service.id %>/book', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({
          sessionLength: document.getElementById('sessionLength').value,
          sessionDate: document.getElementById('sessionDate').value,
          sessionTime: document.getElementById('sessionTime').value
        })});
        const data = await resp.json();
        if (data && data.success) {
          alert('Booking confirmed! You can now leave a verified review after the session.');
          window.location.reload();
        } else {
          alert(data.error || 'Booking failed');
        }
      } catch (err) {
        alert('Booking failed');
      }
    });
  }
</script>
