<%- include('partials/header') %>

<section class="billing-hero">
  <div class="billing-hero-inner">
    <h1 class="billing-title">Billing & Subscription</h1>
    <p class="billing-subtitle">Manage your Dream X plan, payment methods, and billing history.</p>
  </div>
</section>

<section class="billing-container">
  
  <!-- SECTION 1: CURRENT PLAN OVERVIEW -->
  <div class="billing-card billing-card-featured">
    <h2 class="billing-card-title">Current Plan</h2>
    <% 
      const tierDetails = {
        free: { name: 'Free User', desc: 'your social home for productive passions.', price: '$0', badge: 'neutral', badgeColor: '#6b7280' },
        pro_buyer: { name: 'Pro Buyer', desc: 'power user of the social side.', price: '$5.99', badge: 'blue', badgeColor: '#3b82f6' },
        pro_seller: { name: 'Pro Seller', desc: 'turn your craft into a brand.', price: '$9.99', badge: 'pink', badgeColor: '#ff4fa3' },
        elite_seller: { name: 'Elite Seller', desc: 'build a full microbrand.', price: '$29.99', badge: 'purple', badgeColor: '#a855f7' },
        enterprise: { name: 'Enterprise Creator', desc: 'social and learning hub for your community.', price: '$99.99', badge: 'teal', badgeColor: '#14b8a6' }
      };
      const rawTier = (typeof userTier !== 'undefined' && userTier) ? String(userTier).toLowerCase() : 'pro_seller';
      const normalized = rawTier.replace(/-/g, '_');
      const currentTier = tierDetails[normalized] || tierDetails.pro_seller;
    %>
    <p class="billing-plan-subheading">
      <%= currentTier.name %> — <%= currentTier.desc %>
    </p>
    <div class="billing-plan-details">
      <div class="billing-plan-info">
        <div class="billing-info-row">
          <span class="billing-info-label">Plan:</span>
          <span class="billing-info-value-with-badge">
            <span class="plan-name-text"><%= currentTier.name %></span>
            <span class="billing-badge billing-badge-<%= currentTier.badge %>"><%= normalized === 'pro_seller' ? 'PRO SELLER' : currentTier.name.toUpperCase() %></span>
          </span>
        </div>
        <div class="billing-info-row">
          <span class="billing-info-label">Monthly Price:</span>
          <span class="billing-info-value billing-price"><%= currentTier.price %>/mo</span>
        </div>
        <% if (normalized !== 'free') { %>
        <div class="billing-info-row">
          <span class="billing-info-label">Next Billing Date:</span>
          <span class="billing-info-value">January 15, 2026</span>
        </div>
        <% } %>
      </div>
    </div>
    <div class="billing-actions">
      <a href="/pricing" class="billing-btn billing-btn-primary">Change Plan</a>
      <% if (normalized !== 'free') { %>
        <button type="button" class="billing-btn billing-btn-secondary" onclick="openCancelModal()">Cancel Subscription</button>
      <% } %>
    </div>
    <p class="billing-note">
      Upgrades apply immediately. Downgrades take effect at the next billing cycle.
    </p>
  </div>

  <!-- SECTION 2: PAYMENT METHODS -->
  <div class="billing-card">
    <h2 class="billing-card-title">Payment Methods</h2>
    <p class="billing-card-desc">Manage your cards used for Dream X subscriptions.</p>
    <div class="payment-methods-list">
      <div class="payment-method">
        <div class="payment-method-info">
          <div class="payment-card-icon"></div>
          <div class="payment-method-details">
            <div class="payment-method-brand">Visa •••• 4242</div>
            <div class="payment-method-expiry">Expires 12/2026</div>
          </div>
        </div>
        <div class="payment-method-actions">
          <span class="payment-default-label">Default</span>
        </div>
      </div>
      <div class="payment-method">
        <div class="payment-method-info">
          <div class="payment-card-icon"></div>
          <div class="payment-method-details">
            <div class="payment-method-brand">Mastercard •••• 8888</div>
            <div class="payment-method-expiry">Expires 08/2025</div>
          </div>
        </div>
        <div class="payment-method-actions">
          <button class="payment-action-link">Set as default</button>
        </div>
      </div>
    </div>
    <div class="billing-actions" style="margin-top: 1.5rem;">
      <button class="billing-btn billing-btn-outline">+ Add new payment method</button>
    </div>
  </div>

  <!-- SECTION 3: BILLING HISTORY -->
  <div class="billing-card">
    <h2 class="billing-card-title">Billing History</h2>
    <div class="billing-table-wrapper">
      <table class="billing-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Invoice</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Dec 15, 2024</td>
            <td>Pro Seller — monthly subscription</td>
            <td>$9.99</td>
            <td><span class="billing-status billing-status-paid">Paid</span></td>
            <td><a href="#" class="billing-invoice-link">View invoice</a></td>
          </tr>
          <tr>
            <td>Nov 15, 2024</td>
            <td>Pro Seller — monthly subscription</td>
            <td>$9.99</td>
            <td><span class="billing-status billing-status-paid">Paid</span></td>
            <td><a href="#" class="billing-invoice-link">View invoice</a></td>
          </tr>
          <tr>
            <td>Oct 15, 2024</td>
            <td>Pro Buyer — monthly subscription</td>
            <td>$5.99</td>
            <td><span class="billing-status billing-status-paid">Paid</span></td>
            <td><a href="#" class="billing-invoice-link">View invoice</a></td>
          </tr>
          <tr>
            <td>Jan 15, 2026</td>
            <td>Pro Seller — monthly subscription</td>
            <td>$9.99</td>
            <td><span class="billing-status billing-status-upcoming">Upcoming</span></td>
            <td>—</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- SECTION 4: PLAN COMPARISON MINI-GRID -->
  <div class="billing-card">
    <h2 class="billing-card-title">All Plans</h2>
    <p class="billing-card-desc">Compare all Dream X subscription tiers and switch anytime.</p>
    
    <div class="billing-tiers-grid">
      
      <!-- Free User -->
      <div class="tier-card <%= normalized === 'free' ? 'tier-card-current' : '' %>">
        <h3 class="tier-card-name">Free User</h3>
        <p class="tier-card-tagline">Social home for productive passions.</p>
        <div class="tier-card-price">$0<span>/mo</span></div>
        <ul class="tier-card-features">
          <li>Post photos, videos, project updates</li>
          <li>Follow creators, mentors, students, professionals</li>
          <li>Rich profiles (skills, passions, portfolio, achievements)</li>
          <li>Up to 10 Project Collections</li>
          <li>Book sessions, basic messaging, post analytics (views + likes)</li>
          <li>Ads from Fortune 100 brands only</li>
        </ul>
        <div class="tier-card-action">
          <% if (normalized === 'free') { %>
            <button class="tier-btn tier-btn-current" disabled>Current plan</button>
          <% } else { %>
            <button class="tier-btn tier-btn-outline js-switch-tier" data-tier="free">Switch to Free</button>
          <% } %>
        </div>
      </div>

      <!-- Pro Buyer -->
      <div class="tier-card <%= normalized === 'pro_buyer' ? 'tier-card-current' : '' %>">
        <h3 class="tier-card-name">Pro Buyer</h3>
        <p class="tier-card-tagline">Power user of the social side.</p>
        <div class="tier-card-price">$5.99<span>/mo</span></div>
        <ul class="tier-card-features">
          <li>Ad-free experience</li>
          <li>Enhanced discovery filters (top rising creators, people near you, people who match interests)</li>
          <li>Unlimited Project Collections</li>
          <li>Priority messaging</li>
          <li>Post up to 3 one-time request listings per month</li>
          <li>Early access to premium sellers</li>
          <li>Basic AI mentor/creator recommendations</li>
        </ul>
        <div class="tier-card-action">
          <% if (normalized === 'pro_buyer') { %>
            <button class="tier-btn tier-btn-current" disabled>Current plan</button>
          <% } else { %>
            <button class="tier-btn tier-btn-outline js-switch-tier" data-tier="pro-buyer">Switch to Pro Buyer</button>
          <% } %>
        </div>
      </div>

      <!-- Pro Seller -->
      <div class="tier-card <%= normalized === 'pro_seller' ? 'tier-card-current' : '' %>">
        <h3 class="tier-card-name">Pro Seller</h3>
        <p class="tier-card-tagline">Turn your craft into a brand.</p>
        <div class="tier-card-price">$9.99<span>/mo</span></div>
        <ul class="tier-card-features">
          <li>Pro badge + priority in discovery</li>
          <li>Pin 3 posts to profile</li>
          <li>Weekly insights (reach, audience interests, followers by profession/skill)</li>
          <li>Custom profile banner & theme</li>
          <li>5 service listings, unlimited messaging</li>
          <li>Payment tools, basic CRM</li>
          <li>Scheduling, reminders, custom availability</li>
          <li>Coupons, discounts, basic buyer analytics</li>
        </ul>
        <div class="tier-card-action">
          <% if (normalized === 'pro_seller') { %>
            <button class="tier-btn tier-btn-current" disabled>Current plan</button>
          <% } else { %>
            <button class="tier-btn tier-btn-primary js-switch-tier" data-tier="pro-seller">Switch to Pro Seller</button>
          <% } %>
        </div>
      </div>

      <!-- Elite Seller -->
      <div class="tier-card <%= normalized === 'elite_seller' ? 'tier-card-current' : '' %>">
        <h3 class="tier-card-name">Elite Seller</h3>
        <p class="tier-card-tagline">You're a top creator — build a full microbrand.</p>
        <div class="tier-card-price">$29.99<span>/mo</span></div>
        <ul class="tier-card-features">
          <li>Verified status, full portfolio builder, video banners</li>
          <li>In-depth analytics (peak times, demographics, top-performing categories)</li>
          <li>Cross-platform link hub, featured on Discover when trending</li>
          <li>Unlimited listings, recurring subscriptions</li>
          <li>Advanced analytics & automation</li>
          <li>CRM + workflow automation</li>
          <li>Custom storefront page, tax reports</li>
          <li>Integrations, auto-responses, Smart rebooking AI</li>
        </ul>
        <div class="tier-card-action">
          <% if (normalized === 'elite_seller') { %>
            <button class="tier-btn tier-btn-current" disabled>Current plan</button>
          <% } else { %>
            <button class="tier-btn tier-btn-outline js-switch-tier" data-tier="elite-seller">Switch to Elite Seller</button>
          <% } %>
        </div>
      </div>

      <!-- Enterprise Creator -->
      <div class="tier-card <%= normalized === 'enterprise' ? 'tier-card-current' : '' %>">
        <h3 class="tier-card-name">Enterprise Creator</h3>
        <p class="tier-card-tagline">Dream X is your community's social + learning hub.</p>
        <div class="tier-card-price">$99.99<span>/mo</span></div>
        <ul class="tier-card-features">
          <li>Multi-user team posting</li>
          <li>Event pages, showcase collections</li>
          <li>Custom homepage blocks, co-branded community page</li>
          <li>Invite followers to events, livestreams, seminars</li>
          <li>Multi-instructor scheduling, team-wide analytics</li>
          <li>Bulk payouts, shared CRM</li>
          <li>Dedicated account manager</li>
          <li>Featured category placement, sponsored creator onboarding</li>
        </ul>
        <div class="tier-card-action">
          <% if (normalized === 'enterprise') { %>
            <button class="tier-btn tier-btn-current" disabled>Current plan</button>
          <% } else { %>
            <button class="tier-btn tier-btn-outline">Contact sales</button>
          <% } %>
        </div>
        <p class="tier-card-note">Best for tutoring companies, mentorship orgs, clubs, and studios.</p>
      </div>

    </div>
  </div>

  <!-- SECTION 5: UPCOMING CHARGES -->
  <% if (normalized !== 'free') { %>
  <div class="billing-card billing-card-compact">
    <h2 class="billing-card-title">Upcoming Charges</h2>
    <div class="upcoming-charge-details">
      <div class="upcoming-charge-row">
        <span class="upcoming-charge-label">Next Payment:</span>
        <span class="upcoming-charge-value"><%= currentTier.price %> on January 15, 2026</span>
      </div>
      <div class="upcoming-charge-row">
        <span class="upcoming-charge-label">Plan:</span>
        <span class="upcoming-charge-value"><%= currentTier.name %></span>
      </div>
    </div>
    <p class="billing-note" style="margin-top: 1rem;">
      Upgrading now will be prorated. You'll only pay the difference for this cycle.
    </p>
  </div>
  <% } %>

  <!-- SECTION 6: BILLING SUPPORT -->
  <div class="billing-card billing-card-support">
    <h2 class="billing-card-title">Need help with billing?</h2>
    <p class="billing-card-desc">
      If you have questions about charges, refunds, or plan changes, we're here to help.
    </p>
    <div class="billing-actions">
      <a href="/contact" class="billing-btn billing-btn-primary">Contact Billing Support</a>
    </div>
    <p class="billing-support-email">
      Email us at <a href="mailto:support@dreamx.app">support@dreamx.app</a>
    </p>
  </div>

</section>

<!-- Cancel Subscription Modal -->
<div id="cancelSubscriptionModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;">
  <div style="background:white;border-radius:16px;padding:32px;max-width:500px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
      <h3 style="margin:0;font-size:24px;color:#1f2937;">Cancel Subscription</h3>
      <button onclick="closeCancelModal()" style="background:none;border:none;font-size:32px;color:#6b7280;cursor:pointer;line-height:1;">&times;</button>
    </div>
    
    <p style="margin-bottom:20px;color:#6b7280;line-height:1.6;">
      We're sorry to see you go! Your subscription will remain active until the end of your current billing period (January 15, 2026), and you'll continue to have access to all premium features until then.
    </p>
    
    <div style="margin-bottom:24px;">
      <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;">Why are you cancelling? (Optional)</label>
      <textarea id="cancelReason" rows="4" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-family:inherit;resize:vertical;" placeholder="Let us know how we can improve..."></textarea>
    </div>
    
    <div style="display:flex;gap:12px;justify-content:flex-end;">
      <button onclick="closeCancelModal()" style="padding:12px 24px;background:#f3f4f6;color:#374151;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s;">Keep Subscription</button>
      <button onclick="confirmCancelSubscription()" style="padding:12px 24px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s;">Cancel Subscription</button>
    </div>
  </div>
</div>

<%- include('partials/footer') %>

<script>
  (function(){
    const paidTiers = new Set(['pro-buyer','pro-seller','elite-seller']);
    const buttons = document.querySelectorAll('.js-switch-tier');

    // Build modal lazily
    function ensureModal(){
      if (document.getElementById('checkoutModal')) return;
      const modal = document.createElement('div');
      modal.id = 'checkoutModal';
      modal.style.cssText = 'display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;';
      modal.innerHTML = `
        <div style="background:white;padding:24px;border-radius:12px;max-width:520px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
          <h3 style="margin:0 0 12px;font-size:1.25rem;font-weight:700;">Subscribe to <span id="cm-plan-name"></span></h3>
          <p style="color:#6b7280;margin:0 0 12px;">Enter payment details to start your subscription. This is a mock checkout.</p>
          <form id="checkoutForm">
            <input type="hidden" name="tier" id="cm-tier" />
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
              <div>
                <label style="display:block;font-weight:600;margin-bottom:4px;">Card Type</label>
                <select name="cardType" class="settings-input" required>
                  <option value="visa">Visa</option>
                  <option value="mastercard">Mastercard</option>
                  <option value="amex">American Express</option>
                </select>
              </div>
              <div>
                <label style="display:block;font-weight:600;margin-bottom:4px;">Card Number</label>
                <input name="cardNumber" class="settings-input" placeholder="4242424242424242" required />
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:12px;">
              <div>
                <label style="display:block;font-weight:600;margin-bottom:4px;">Expiry Month</label>
                <input name="expiryMonth" type="number" min="1" max="12" class="settings-input" placeholder="12" required />
              </div>
              <div>
                <label style="display:block;font-weight:600;margin-bottom:4px;">Expiry Year</label>
                <input name="expiryYear" type="number" min="2025" max="2050" class="settings-input" placeholder="2026" required />
              </div>
              <div>
                <label style="display:block;font-weight:600;margin-bottom:4px;">CVV</label>
                <input name="cvv" class="settings-input" placeholder="123" required />
              </div>
            </div>
            <label class="toggle-row" style="margin:12px 0;">
              <input type="checkbox" name="saveCard" checked />
              <span>Save this card as default</span>
            </label>
            <div style="display:flex;gap:8px;justify-content:flex-end;">
              <button type="button" id="cm-cancel" class="settings-btn" style="background:#eee;">Cancel</button>
              <button type="submit" class="settings-btn primary">Confirm</button>
            </div>
          </form>
        </div>`;
      document.body.appendChild(modal);
      document.getElementById('cm-cancel').addEventListener('click', () => modal.style.display = 'none');
      document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const body = Object.fromEntries(fd.entries());
        body.saveCard = !!body.saveCard; // checkbox -> boolean
        try {
          const res = await fetch('/api/checkout/subscribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          const out = await res.json();
          if (res.ok && out.success) {
            alert('Subscription updated successfully');
            window.location.reload();
          } else {
            alert(out.error || 'Failed to update subscription');
          }
        } catch (err) {
          alert('Network error. Please try again.');
        }
      });
    }

    function openModalForTier(tier){
      ensureModal();
      const modal = document.getElementById('checkoutModal');
      document.getElementById('cm-tier').value = tier;
      const pretty = tier.replace('-', ' ').replace(/\b\w/g, c => c.toUpperCase());
      document.getElementById('cm-plan-name').textContent = pretty;
      modal.style.display = 'flex';
    }

    async function submitFree(){
      try {
        const res = await fetch('/api/checkout/subscribe', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tier: 'free' })
        });
        const out = await res.json();
        if (res.ok && out.success) {
          alert('Switched to Free plan');
          window.location.reload();
        } else {
          alert(out.error || 'Failed to switch plan');
        }
      } catch (e) {
        alert('Network error. Please try again.');
      }
    }

    buttons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const tier = btn.getAttribute('data-tier');
        if (!tier) return;
        if (tier === 'free') return submitFree();
        if (paidTiers.has(tier)) return openModalForTier(tier);
      });
    });
  })();

  // Cancel Subscription Modal Functions
  function openCancelModal() {
    const modal = document.getElementById('cancelSubscriptionModal');
    if (modal) {
      modal.style.display = 'flex';
    }
  }

  function closeCancelModal() {
    const modal = document.getElementById('cancelSubscriptionModal');
    if (modal) {
      modal.style.display = 'none';
    }
  }

  async function confirmCancelSubscription() {
    const reason = document.getElementById('cancelReason')?.value?.trim() || 'No reason provided';
    
    if (!confirm('Are you sure you want to cancel your subscription? You will lose access to premium features at the end of your current billing period.')) {
      return;
    }

    try {
      const res = await fetch('/api/subscription/cancel', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason })
      });
      const data = await res.json();
      
      if (res.ok && data.success) {
        alert('Your subscription has been cancelled. You will retain access until the end of your billing period.');
        closeCancelModal();
        window.location.reload();
      } else {
        alert(data.error || 'Failed to cancel subscription. Please try again.');
      }
    } catch (err) {
      console.error('Cancel subscription error:', err);
      alert('Network error. Please try again.');
    }
  }

  // Close modal when clicking outside
  window.addEventListener('click', (e) => {
    const modal = document.getElementById('cancelSubscriptionModal');
    if (modal && e.target === modal) {
      closeCancelModal();
    }
  });
</script>
