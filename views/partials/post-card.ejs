<article class="post-card <%= post.is_premium ? 'premium' : '' %>" data-post-id="<%= post.id %>">
  <header class="post-header">
    <% if (post.profile_picture) { %>
      <img src="/uploads/<%= post.profile_picture %>" alt="<%= post.full_name %>" class="avatar" style="width:52px;height:52px;object-fit:cover;cursor:pointer;" ondblclick="window.location.href='/profile/<%= post.user_id %>'">
    <% } else { %>
      <div class="avatar" style="width:52px;height:52px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.25rem;cursor:pointer;" ondblclick="window.location.href='/profile/<%= post.user_id %>'"><%= post.full_name.charAt(0) %></div>
    <% } %>
    <div class="post-user-meta">
      <h3 class="post-user-name"><%= post.full_name %></h3>
      <div class="post-meta-line">
        <% if (post.activity_label) { %>
          <span class="post-passion-tag"><%= post.activity_label %></span>
        <% } %>
        <span class="post-time">â€¢ <%= new Date(post.created_at).toLocaleString('en-US', { hour: 'numeric', minute: '2-digit', month: 'short', day: 'numeric' }) %></span>
      </div>
    </div>
    <% if (typeof authUser !== 'undefined' && authUser && (authUser.role === 'super_admin' || authUser.role === 'global_admin' || authUser.role === 'admin')) { %>
      <div style="position:relative;display:inline-block;">
        <button class="admin-post-actions-btn" style="background:#f3f4f6;color:#6b7280;border:none;border-radius:6px;padding:4px 10px;font-size:1.2rem;cursor:pointer;transition:all 0.2s ease;line-height:1;" onclick="event.stopPropagation();const menu = this.nextElementSibling; menu.style.display = menu.style.display === 'block' ? 'none' : 'block'">â‹®</button>
        <div class="admin-post-actions-menu" style="display:none;position:absolute;right:0;top:100%;margin-top:4px;background:white;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.15);z-index:100;min-width:160px;">
          <button onclick="event.stopPropagation();hidePost(<%= post.id %>)" style="width:100%;text-align:left;padding:10px 14px;border:none;background:none;cursor:pointer;font-size:0.875rem;color:#374151;transition:background 0.2s;" onmouseover="this.style.background='#fef3c7';this.style.color='#92400e'" onmouseout="this.style.background='none';this.style.color='#374151'">ğŸ‘ï¸â€ğŸ—¨ï¸ Hide Post</button>
          <button onclick="event.stopPropagation();deletePost(<%= post.id %>)" style="width:100%;text-align:left;padding:10px 14px;border:none;background:none;cursor:pointer;font-size:0.875rem;color:#374151;border-top:1px solid #e5e7eb;transition:background 0.2s;" onmouseover="this.style.background='#fee2e2';this.style.color='#991b1b'" onmouseout="this.style.background='none';this.style.color='#374151'">ğŸ—‘ï¸ Delete Post</button>
          <a href="/profile/<%= post.user_id %>" style="display:block;width:100%;text-align:left;padding:10px 14px;text-decoration:none;color:#374151;font-size:0.875rem;border-top:1px solid #e5e7eb;transition:background 0.2s;" onmouseover="this.style.background='#dbeafe'" onmouseout="this.style.background='none'">ğŸ‘¤ View Profile</a>
        </div>
      </div>
      <script>
        function hidePost(postId) {
          if (!confirm('Hide this post? It will be removed from public view but not deleted.')) return;
          
          fetch(`/admin/posts/${postId}/hide`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                const article = document.querySelector(`[data-post-id="${postId}"]`);
                if (article) {
                  article.style.opacity = '0.5';
                  article.style.pointerEvents = 'none';
                  const badge = document.createElement('div');
                  badge.style.cssText = 'background:#fef3c7;color:#92400e;padding:8px;border-radius:8px;font-weight:600;text-align:center;margin-top:8px;';
                  badge.textContent = 'This post has been hidden by an administrator';
                  article.appendChild(badge);
                }
                alert('Post hidden successfully');
              } else {
                alert('Failed to hide post');
              }
            })
            .catch(err => {
              console.error(err);
              alert('Error hiding post');
            });
        }
        
        function deletePost(postId) {
          if (!confirm('Permanently delete this post? This action cannot be undone.')) return;
          
          fetch(`/admin/posts/${postId}/delete`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                const article = document.querySelector(`[data-post-id="${postId}"]`);
                if (article) {
                  article.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                  article.style.opacity = '0';
                  article.style.transform = 'translateY(-20px)';
                  setTimeout(() => article.remove(), 300);
                }
              } else {
                alert('Failed to delete post');
              }
            })
            .catch(err => {
              console.error(err);
              alert('Error deleting post');
            });
        }
        
        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
          document.querySelectorAll('.admin-post-actions-menu').forEach(menu => {
            if (!menu.previousElementSibling.contains(e.target) && !menu.contains(e.target)) {
              menu.style.display = 'none';
            }
          });
        });
      </script>
    <% } %>
  </header>
  <div class="post-body">
    <% if (post.text_content) { %>
      <p class="post-text"><%= post.text_content %></p>
    <% } %>
    <% if (post.media_url) { 
         let mediaUrl = String(post.media_url);
         if (!mediaUrl.startsWith('/')) mediaUrl = '/' + mediaUrl;
         // Normalize to /uploads/posts/ if not already under /uploads
         if (!mediaUrl.startsWith('/uploads/')) {
           mediaUrl = '/uploads/posts/' + mediaUrl.replace(/^\/+/, '');
         }
         const isImage = /\.(jpg|jpeg|png|gif|webp|avif)$/i.test(mediaUrl) || post.content_type === 'image';
         const isVideo = /\.(mp4|webm|ogg|mov)$/i.test(mediaUrl) || post.content_type === 'video';
    %>
      <% if (post.is_reel && isVideo) { %>
        <div style="position:relative;margin-top:1rem;border-radius:16px;overflow:hidden;background:#000;box-shadow:0 8px 24px rgba(0,0,0,0.15);">
          <video src="<%= mediaUrl %>" controls playsinline style="width:100%;max-height:640px;display:block;"></video>
          <div style="position:absolute;top:12px;left:12px;background:linear-gradient(135deg,rgba(255,79,163,0.95),rgba(230,62,143,0.95));color:#fff;padding:6px 14px;border-radius:50px;font-size:0.75rem;font-weight:700;box-shadow:0 4px 12px rgba(255,79,163,0.4);backdrop-filter:blur(10px);">ğŸ¬ Reel</div>
        </div>
      <% } else if (isImage) { %>
        <img src="<%= mediaUrl %>" alt="Post image" class="post-image" loading="lazy" onerror="console.error('Failed to load image:', this.src); this.style.border='3px solid red'; this.style.minHeight='200px'; this.alt='Image failed to load: ' + this.src;">
      <% } else if (isVideo) { %>
        <video src="<%= mediaUrl %>" controls class="post-video" loading="lazy"></video>
      <% } else { %>
        <div style="margin-top:1rem;padding:2rem;border:2px dashed #e5e7eb;border-radius:16px;text-align:center;font-size:.85rem;color:#6b7280;">Unsupported media format</div>
      <% } %>
    <% } %>
  </div>
  <footer class="post-footer" style="padding-top:1.25rem;margin-top:1.25rem;border-top:2px solid rgba(229,231,235,0.5);">
    <div class="reactions-row">
      <% const rx = post.reactions || {}; const ur = post.user_reaction; %>
      <button type="button" class="rx-btn<%= ur==='like' ? ' active' : '' %>" data-type="like">
        <span>ğŸ‘</span><span class="rx-count" data-type="like"><%= rx.like || 0 %></span>
      </button>
      <button type="button" class="rx-btn<%= ur==='love' ? ' active' : '' %>" data-type="love">
        <span>â¤ï¸</span><span class="rx-count" data-type="love"><%= rx.love || 0 %></span>
      </button>
      <button type="button" class="rx-btn<%= ur==='clap' ? ' active' : '' %>" data-type="clap">
        <span>ğŸ‘</span><span class="rx-count" data-type="clap"><%= rx.clap || 0 %></span>
      </button>
      <button type="button" class="rx-btn<%= ur==='fire' ? ' active' : '' %>" data-type="fire">
        <span>ğŸ”¥</span><span class="rx-count" data-type="fire"><%= rx.fire || 0 %></span>
      </button>
      <button type="button" class="rx-btn<%= ur==='rocket' ? ' active' : '' %>" data-type="rocket">
        <span>ğŸš€</span><span class="rx-count" data-type="rocket"><%= rx.rocket || 0 %></span>
      </button>
      <button type="button" class="rx-btn<%= ur==='celebrate' ? ' active' : '' %>" data-type="celebrate">
        <span>ğŸ‰</span><span class="rx-count" data-type="celebrate"><%= rx.celebrate || 0 %></span>
      </button>
      <button type="button" class="comment-toggle">
        Show comments (<span class="comment-count"><%= post.comments_count || 0 %></span>)
      </button>
    </div>
  </footer>
  <div class="comments-panel" style="max-height:0;opacity:0;overflow:hidden;transition:max-height .4s cubic-bezier(0.4, 0, 0.2, 1), opacity .3s ease;">
    <div class="comments-list" style="display:flex;flex-direction:column;gap:1rem;margin-bottom:1rem;"></div>
    <div class="comment-input-row" style="display:flex;gap:0.75rem;align-items:center;">
      <span class="replying-indicator" style="display:none;align-items:center;gap:0.5rem;background:white;border:2px solid #e5e7eb;border-radius:50px;padding:0.5rem 1rem;font-size:0.85rem;color:#6b7280;">
        Replying to <strong class="replying-name" style="margin-left:0.25rem;color:#111827;">user</strong>
        <button type="button" class="cancel-reply" style="margin-left:0.5rem;background:transparent;border:none;color:#ef4444;cursor:pointer;font-weight:700;font-size:1.25rem;line-height:1;">Ã—</button>
      </span>
      <input type="text" class="comment-input" placeholder="Write a thoughtful comment...">
      <button type="button" class="comment-send">Send</button>
    </div>
  </div>
  <script>
    (function(){
      const H = window.DXPostHelpers; if (!H) return;
      H.ensureSocketSetup();
      const article = document.currentScript.closest('article.post-card');
      article.setAttribute('data-post-id', '<%= post.id %>');
      const postId = <%= post.id %>;
      function setToggleLabel(open){
        const cc = article.querySelector('.comment-count');
        const num = cc ? (cc.textContent || '0') : '0';
        const btn = article.querySelector('.comment-toggle');
        if (!btn) return;
        btn.innerHTML = (open ? 'Hide comments (' : 'Show comments (') + '<span class="comment-count">' + num + '</span>)';
      }
      article.querySelectorAll('.rx-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const type = btn.getAttribute('data-type');
          const res = await fetch(`/api/posts/${postId}/react`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ type }) });
          const data = await res.json();
          if (!data.success) return; H.updateReactions(article, data.counts, type, data.status);
        });
      });
      const toggleBtn = article.querySelector('.comment-toggle');
      const panel = article.querySelector('.comments-panel');
      let open = false;
      toggleBtn.addEventListener('click', async ()=>{
        if (!open) {
          await H.loadComments(article, postId);
          panel.style.opacity = '0'; panel.style.maxHeight = '0px';
          requestAnimationFrame(() => {
            panel.style.opacity = '1';
            panel.style.maxHeight = '280px';
            panel.style.overflowY = 'auto';
          });
        } else {
          panel.style.opacity = '0';
          panel.style.maxHeight = '0px';
          panel.style.overflowY = 'hidden';
        }
        open = !open;
        setToggleLabel(open);
      });
      const cancel = article.querySelector('.cancel-reply');
      if (cancel) cancel.addEventListener('click', () => {
        article.removeAttribute('data-reply-parent-id');
        article.querySelector('.replying-indicator').style.display = 'none';
        const input = article.querySelector('.comment-input'); input.placeholder = 'Write a thoughtful comment...'; input.focus();
      });
      article.querySelector('.comment-send').addEventListener('click', ()=>{ H.sendComment(article, postId); setToggleLabel(true); });
      article.querySelector('.comment-input').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); H.sendComment(article, postId); }});
      // Initialize label on load
      setToggleLabel(false);
    })();
  </script>
</article>
