<%- include('partials/header') %>
<link rel="stylesheet" href="/css/admin.css">

<main class="admin-dashboard-container">
  <header class="admin-dashboard-header">
    <div class="header-content">
      <div class="header-text">
        <h1>Admin Command Center</h1>
        <p>Real-time platform management and analytics</p>
      </div>
      <div class="header-actions">
        <button class="admin-header-btn" onclick="window.location.reload()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
          </svg>
          Refresh
        </button>
        <span class="admin-role-badge"><%= authUser.role.replace('_', ' ').toUpperCase() %></span>
      </div>
    </div>
  </header>

  <nav class="admin-tabs grouped" style="display:flex; gap:18px; position:relative;">
    <style>
      .group-wrapper { position:relative; }
      .group-toggle { 
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(168, 85, 247, 0.15));
        border: 2px solid rgba(139, 92, 246, 0.4);
        padding: 12px 20px;
        border-radius: 16px;
        font-weight: 700;
        font-size: 0.9rem;
        letter-spacing: 0.5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        color: white;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.2), 0 2px 6px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
      }
      .group-toggle::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
        transition: left 0.6s ease;
      }
      .group-toggle:hover::before {
        left: 100%;
      }
      .group-toggle:hover, .group-toggle.open { 
        background: linear-gradient(135deg, #6366f1, #a855f7);
        color: #fff;
        border-color: rgba(168, 85, 247, 0.8);
        box-shadow: 0 8px 30px rgba(99, 102, 241, 0.45), 0 4px 12px rgba(168, 85, 247, 0.3);
        transform: translateY(-3px);
      }
      .group-toggle:active {
        transform: translateY(-1px);
      }
      .group-dropdown { 
        position: absolute;
        top: 110%;
        left: 0;
        background: linear-gradient(to bottom, #ffffff, #f9fafb);
        padding: 16px;
        border-radius: 18px;
        box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(99, 102, 241, 0.15);
        display: none;
        min-width: 240px;
        z-index: 50;
        backdrop-filter: blur(8px);
        border: 2px solid rgba(99, 102, 241, 0.2);
      }
      .group-dropdown.open { 
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
        animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .group-dropdown .tab-btn { width: 100%; justify-content: flex-start; }
      .group-dropdown .tab-btn svg { margin-right: 8px; }
      @keyframes slideDown { 
        from { 
          opacity: 0;
          transform: translateY(-15px) scale(0.95);
        }
        to { 
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
    </style>
    <div class="group-wrapper">
      <button type="button" class="group-toggle" data-group="core">Core ‚ñæ</button>
      <div class="group-dropdown" id="group-core">
        <button class="tab-btn active" data-tab="metrics">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
          Metrics
        </button>
        <button class="tab-btn" data-tab="users">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          Users
        </button>
        <button class="tab-btn" data-tab="careers">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
          Careers
        </button>
      </div>
    </div>
    <div class="group-wrapper">
      <button type="button" class="group-toggle" data-group="appeals">Appeals ‚ñæ</button>
      <div class="group-dropdown" id="group-appeals">
        <button class="tab-btn" data-tab="content-appeals">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
          Content Appeals
        </button>
        <button class="tab-btn" data-tab="account-appeals">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          Account Appeals
        </button>
      </div>
    </div>
    <div class="group-wrapper">
      <button type="button" class="group-toggle" data-group="manage">Manage ‚ñæ</button>
      <div class="group-dropdown" id="group-manage">
        <button class="tab-btn" data-tab="services">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
          Services
        </button>
        <button class="tab-btn" data-tab="refund-requests">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 8v4l3 3M9 16h6M7 9h10"></path></svg>
          Refund Requests
        </button>
      </div>
    </div>
    <% if (authUser && (authUser.role === 'super_admin' || authUser.role === 'global_admin')) { %>
    <div class="group-wrapper">
      <button type="button" class="group-toggle" data-group="moderation">Moderation ‚ñæ</button>
      <div class="group-dropdown" id="group-moderation">
        <button class="tab-btn" data-tab="user-moderation">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          User Moderation
        </button>
        <button class="tab-btn" data-tab="audit">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
          Audit Logs
        </button>
      </div>
    </div>
    <% } %>
  </nav>
  <script>
    (function(){
      const toggles = document.querySelectorAll('.group-toggle');
      function closeAll(){ document.querySelectorAll('.group-dropdown.open').forEach(dd=>dd.classList.remove('open')); toggles.forEach(t=>t.classList.remove('open')); }
      toggles.forEach(t => {
        t.addEventListener('click', () => {
          const id = 'group-' + t.getAttribute('data-group');
          const dd = document.getElementById(id);
          const isOpen = dd.classList.contains('open');
          closeAll();
          if(!isOpen){ dd.classList.add('open'); t.classList.add('open'); }
        });
      });
      document.addEventListener('click', (e) => {
        if(!e.target.closest('.group-wrapper')) closeAll();
      });
      // Close dropdown after selecting a tab
      document.querySelectorAll('.group-dropdown .tab-btn').forEach(btn => {
        btn.addEventListener('click', () => { closeAll(); });
      });
    })();
  </script>

  <% if (typeof success !== 'undefined' && success) { %>
    <div class="admin-alert admin-alert-success">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
        <polyline points="22 4 12 14.01 9 11.01"></polyline>
      </svg>
      <%= success %>
    </div>
  <% } %>
  <% if (typeof error !== 'undefined' && error) { %>
    <div class="admin-alert admin-alert-error">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="15" y1="9" x2="9" y2="15"></line>
        <line x1="9" y1="9" x2="15" y2="15"></line>
      </svg>
      <%= error %>
    </div>
  <% } %>

  <!-- Metrics Grid -->
  <section class="tab-panel show" data-tab="metrics">
    <div class="admin-wrapper" style="padding:0;">
      <% 
        const avgMsgs = (stats && stats.users) ? Math.round((stats.messages || 0) / Math.max(stats.users,1) * 10) / 10 : 0;
        const convPerUser = (stats && stats.users) ? Math.round((stats.conversations || 0) / Math.max(stats.users,1) * 10) / 10 : 0;
        const careerOpen = (careers || []).filter(c => (c.status||'new')==='new' || c.status==='under_review').length;
        const contentOpen = (contentAppeals || []).filter(a => a.status==='open' || a.status==='under_review').length;
        const accountOpen = (accountAppeals || []).filter(a => a.status==='open' || a.status==='under_review').length;
      %>
      
      <div class="metrics-overview">
        <div class="metric-card glow">
          <div class="metric-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
          </div>
          <div class="metric-content">
            <div class="metric-label">Total Users</div>
            <div class="metric-value"><%= stats.users %></div>
            <div class="metric-subtitle">Registered accounts</div>
          </div>
        </div>

        <div class="metric-card glow">
          <div class="metric-icon accent-2">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
          </div>
          <div class="metric-content">
            <div class="metric-label">Conversations</div>
            <div class="metric-value"><%= stats.conversations %></div>
            <div class="metric-subtitle">Active chats</div>
          </div>
        </div>

        <div class="metric-card glow">
          <div class="metric-icon accent-3">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
            </svg>
          </div>
          <div class="metric-content">
            <div class="metric-label">Total Messages</div>
            <div class="metric-value"><%= stats.messages %></div>
            <div class="metric-subtitle">All time</div>
          </div>
        </div>

        <div class="metric-card glow">
          <div class="metric-icon accent-4">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="1" x2="12" y2="23"></line>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
          </div>
          <div class="metric-content">
            <div class="metric-label">Avg Msgs/User</div>
            <div class="metric-value"><%= avgMsgs %></div>
            <div class="metric-subtitle">Engagement metric</div>
          </div>
        </div>
      </div>

      <div class="analytics-row">
        <div class="analytics-card">
          <div class="analytics-header">
            <h3>User Engagement</h3>
            <span class="analytics-badge"><%= convPerUser %> avg conversations</span>
          </div>
          <div class="progress-bar-wrapper">
            <% const convPct = Math.min(100, Math.round((convPerUser/3)*100)); %>
            <div class="progress-bar">
              <div class="progress-fill" style="width:<%= convPct %>%">
                <span class="progress-label"><%= convPct %>%</span>
              </div>
            </div>
          </div>
          <div class="analytics-footer">Target: 3 conversations per user</div>
        </div>

        <div class="analytics-card">
          <div class="analytics-header">
            <h3>Moderation Queue</h3>
            <span class="analytics-badge urgent"><%= careerOpen + contentOpen + accountOpen %> total</span>
          </div>
          <div class="queue-grid">
            <div class="queue-item">
              <div class="queue-icon careers">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                  <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                </svg>
              </div>
              <div class="queue-content">
                <div class="queue-label">Careers</div>
                <div class="queue-count"><%= careerOpen %></div>
              </div>
            </div>
            <div class="queue-item">
              <div class="queue-icon content">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                </svg>
              </div>
              <div class="queue-content">
                <div class="queue-label">Content</div>
                <div class="queue-count"><%= contentOpen %></div>
              </div>
            </div>
            <div class="queue-item">
              <div class="queue-icon account">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="8" x2="12" y2="12"></line>
                  <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
              </div>
              <div class="queue-content">
                <div class="queue-label">Accounts</div>
                <div class="queue-count"><%= accountOpen %></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="timestamp-footer">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        Last updated <%= new Date().toLocaleString() %>
      </div>
    </div>
  </section>

  <!-- Quick Actions removed as requested -->

  <!-- User Management -->
  <section class="admin-panel tab-panel" data-tab="users" style="display:none;">
    <div class="panel-head">
      <h2>User Management</h2>
      <div class="panel-actions">
        <button class="admin-header-btn" onclick="openUserWizard()" style="margin-right:12px;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <line x1="19" y1="8" x2="19" y2="14"></line>
            <line x1="16" y1="11" x2="22" y2="11"></line>
          </svg>
          Launch Add User Wizard
        </button>
        <form action="/admin" method="GET" class="admin-search-form">
          <div class="search-input-wrapper">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input 
              type="text" 
              name="q" 
              value="<%= typeof q !== 'undefined' ? q : '' %>" 
              placeholder="Search by name or email..." 
              class="admin-search-input"
            >
          </div>
          <input type="hidden" name="page" value="1" />
          <button type="submit" class="admin-search-btn">Search</button>
          <% if (q) { %>
            <a href="/admin" class="admin-search-clear">Clear</a>
          <% } %>
        </form>
      </div>
    </div>
    
    <div class="table-responsive">
      <div class="filter-row">
        <div class="search-input-wrapper">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <input type="text" id="filterUsers" placeholder="Quick filter users..." class="admin-search-input">
        </div>
        <span class="filter-hint">Type to filter by name, email, or role</span>
      </div>
      <table class="admin-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Status</th>
            <th>Joined</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% users.forEach(u => { %>
            <tr class="row-user" data-user-id="<%= u.id %>" data-name="<%= u.full_name %>" data-email="<%= u.email %>" data-role="<%= u.role %>">
              <td><span class="user-id">#<%= u.id %></span></td>
              <td>
                <div class="user-info">
                  <div class="user-avatar">
                    <%= u.full_name.charAt(0).toUpperCase() %>
                  </div>
                  <strong><%= u.full_name %></strong>
                </div>
              </td>
              <td><%= u.email %></td>
              <td>
                <span class="role-badge role-<%= u.role.replace('_', '-') %>"><%= u.role.replace('_', ' ') %></span>
              </td>
              <td>
                <% 
                  const accountStatus = u.account_status || 'active';
                  let statusClass = 'role-user';
                  let statusText = 'Active';
                  if (accountStatus === 'banned') {
                    statusClass = 'role-banned';
                    statusText = 'Banned';
                  } else if (accountStatus === 'suspended') {
                    statusClass = 'role-suspended';
                    statusText = 'Suspended';
                  }
                %>
                <span class="role-badge <%= statusClass %>"><%= statusText %></span>
              </td>
              <td><%= new Date(u.created_at).toLocaleDateString() %></td>
              <td>
                <div style="display:flex; gap:8px; align-items:center;">
                  <form action="/admin/users/<%= u.id %>/role" method="POST" class="role-update-form" style="margin:0;">
                    <select name="role" class="role-select">
                      <option value="user" <%= u.role === 'user' ? 'selected' : '' %>>User</option>
                      <option value="admin" <%= u.role === 'admin' ? 'selected' : '' %>>Admin</option>
                      <option value="super_admin" <%= u.role === 'super_admin' ? 'selected' : '' %>>Super Admin</option>
                      <% if (authUser && authUser.role === 'global_admin') { %>
                        <option value="global_admin" <%= u.role === 'global_admin' ? 'selected' : '' %>>Global Admin</option>
                      <% } %>
                      <option value="hr" <%= u.role === 'hr' ? 'selected' : '' %>>HR</option>
                    </select>
                    <button type="submit" class="btn-update">Update</button>
                  </form>
                  
                  <% if (authUser && (authUser.role === 'super_admin' || authUser.role === 'global_admin')) { %>
                    <div class="admin-user-actions" style="position:relative;">
                      <button class="admin-actions-btn" onclick="toggleUserActions(<%= u.id %>)">‚ãÆ</button>
                      <div class="admin-actions-menu" id="user-actions-<%= u.id %>" style="display:none;">
                        <% if (u.account_status === 'suspended') { %>
                          <button onclick="removeSuspensionAction(<%= u.id %>, '<%= u.full_name %>')">  
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                              <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                            Remove Suspension
                          </button>
                        <% } else if (u.account_status === 'banned') { %>
                          <button onclick="removeBanAction(<%= u.id %>, '<%= u.full_name %>')">  
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                              <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                            Remove Ban
                          </button>
                        <% } else if (u.account_status === 'active') { %>
                          <button onclick="suspendUserModal(<%= u.id %>, '<%= u.full_name %>')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <circle cx="12" cy="12" r="10"></circle>
                              <line x1="10" y1="15" x2="10" y2="15"></line>
                              <line x1="14" y1="15" x2="14" y2="15"></line>
                            </svg>
                            Suspend User
                          </button>
                          <button onclick="banUserAction(<%= u.id %>, '<%= u.full_name %>')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <circle cx="12" cy="12" r="10"></circle>
                              <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
                            </svg>
                            Ban User
                          </button>
                        <% } %>
                        <% if (u.seller_privileges_frozen === 1) { %>
                          <button onclick="unfreezeSellerAction(<%= u.id %>, '<%= u.full_name %>')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                            Unfreeze Seller
                          </button>
                        <% } else { %>
                          <button onclick="freezeSellerAction(<%= u.id %>, '<%= u.full_name %>')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                            Freeze Seller
                          </button>
                        <% } %>
                        <a href="/admin/users/<%= u.id %>/stats">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                          </svg>
                          View Stats
                        </a>
                        <a href="/profile/<%= u.id %>" target="_blank">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                            <polyline points="15 3 21 3 21 9"></polyline>
                            <line x1="10" y1="14" x2="21" y2="3"></line>
                          </svg>
                          View Profile
                        </a>
                        <% if (authUser.role === 'global_admin' || (authUser.role === 'super_admin' && (u.role === 'admin' || u.role === 'user'))) { %>
                          <button onclick="openPermissionEditor(<%= u.id %>, '<%- u.full_name %>', '<%- u.email %>', '<%- u.role %>', <%- JSON.stringify(u.admin_permissions || []) %>, <%- JSON.stringify(u.admin_scopes || []) %>)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <path d="M12 20h9"></path>
                              <path d="M12 4h9"></path>
                              <path d="M3 8h9"></path>
                              <path d="M3 16h9"></path>
                              <circle cx="3" cy="8" r="2"></circle>
                              <circle cx="3" cy="16" r="2"></circle>
                            </svg>
                            Adjust Permissions
                          </button>
                        <% } %>
                      </div>
                    </div>
                  <% } %>
                </div>
              </td>
            </tr>
          <% }) %>
          <% if (users.length === 0) { %>
            <tr>
              <td colspan="6" class="no-results">No users found</td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <% if (typeof total !== 'undefined' && typeof page !== 'undefined' && typeof pageSize !== 'undefined') { %>
      <% const totalPages = Math.max(Math.ceil(total / pageSize), 1); %>
      <div class="admin-pagination">
        <div class="pagination-info">
          Page <%= page %> of <%= totalPages %> (<%= total %> total users)
        </div>
        <div class="pagination-controls">
          <% const qp = q ? `&q=${encodeURIComponent(q)}` : '' %>
          <% if (page > 1) { %>
            <a class="pagination-btn" href="/admin?page=<%= page - 1 %><%= qp %>">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
              Previous
            </a>
          <% } else { %>
            <button class="pagination-btn" disabled>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
              Previous
            </button>
          <% } %>
          <% if (page < totalPages) { %>
            <a class="pagination-btn" href="/admin?page=<%= page + 1 %><%= qp %>">
              Next
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </a>
          <% } else { %>
            <button class="pagination-btn" disabled>
              Next
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </button>
          <% } %>
        </div>
      </div>
    <% } %>
  </section>

  <!-- Careers Queue -->
  <section class="admin-panel tab-panel" data-tab="careers" style="display:none;">
    <div class="panel-head">
      <h2>Career Applications</h2>
    </div>
    <div class="table-responsive">
      <div class="filter-row">
        <div class="search-input-wrapper">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <input type="text" id="filterCareers" placeholder="Filter by position, name, email..." class="admin-search-input">
        </div>
        <span class="filter-hint">Click an ID to view details</span>
        <form method="GET" action="/admin" style="margin-left:auto;display:flex;gap:8px;align-items:center;">
          <input type="hidden" name="page" value="<%= page %>">
          <input type="hidden" name="q" value="<%= q %>">
          <input type="hidden" name="caPage" value="<%= caPage %>">
          <input type="hidden" name="aaPage" value="<%= aaPage %>">
          <label class="filter-hint">Status</label>
          <select name="cStatus" class="role-select" onchange="this.form.submit()">
            <option value="" <%= !cStatus ? 'selected' : '' %>>All</option>
            <option value="new" <%= cStatus==='new'?'selected':'' %>>New</option>
            <option value="under_review" <%= cStatus==='under_review'?'selected':'' %>>Under Review</option>
            <option value="accepted" <%= cStatus==='accepted'?'selected':'' %>>Accepted</option>
            <option value="rejected" <%= cStatus==='rejected'?'selected':'' %>>Rejected</option>
          </select>
        </form>
      </div>
      <table class="admin-table" id="careersTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Position</th>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Resume</th>
            <th>Portfolio</th>
            <th>Status</th>
            <th>Submitted</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <% (careers || []).forEach(c => { %>
            <tr class="row-career" data-position="<%= c.position %>" data-name="<%= c.name %>" data-email="<%= c.email %>" data-status="<%= c.status || 'new' %>">
              <td><a href="#" class="career-view user-id" data-id="<%= c.id %>" data-json='<%- JSON.stringify(c) %>'>#<%= c.id %></a></td>
              <td><strong><%= c.position %></strong></td>
              <td><%= c.name %></td>
              <td><a href="mailto:<%= c.email %>" style="color: var(--accent);"><%= c.email %></a></td>
              <td><%= c.phone || '-' %></td>
              <td><% if (c.resume_file) { %><a href="<%= c.resume_file %>" target="_blank" style="color: var(--accent-2);">View</a><% } else { %>-<% } %></td>
              <td><% if (c.portfolio_file) { %><a href="<%= c.portfolio_file %>" target="_blank" style="color: var(--accent-2);">View</a><% } else { %>-<% } %></td>
              <td><span class="role-badge role-<%= (c.status || 'new').replace('_', '-') %>"><%= (c.status || 'new').replace('_', ' ') %></span></td>
              <td><%= new Date(c.created_at).toLocaleString() %></td>
              <td>
                <form action="/admin/careers/<%= c.id %>/status" method="POST" class="role-update-form">
                  <select name="status" class="role-select">
                    <option value="new" <%= (c.status||'new')==='new'?'selected':'' %>>New</option>
                    <option value="under_review" <%= c.status==='under_review'?'selected':'' %>>Under Review</option>
                    <option value="accepted" <%= c.status==='accepted'?'selected':'' %>>Accepted</option>
                    <option value="rejected" <%= c.status==='rejected'?'selected':'' %>>Rejected</option>
                  </select>
                  <button type="submit" class="btn-update">Save</button>
                </form>
              </td>
            </tr>
          <% }) %>
          <% if (!careers || !careers.length) { %>
            <tr><td colspan="10" class="no-results">No applications yet.</td></tr>
          <% } %>
        </tbody>
      </table>
      <div class="pager">
        <div class="pagination-info">Page <%= cPage %></div>
        <div class="pager-actions">
          <% const baseQ = `page=${page}&q=${encodeURIComponent(q||'')}&caPage=${caPage}&aaPage=${aaPage}&cStatus=${encodeURIComponent(cStatus||'')}` %>
          <% if (cPage > 1) { %>
            <a class="pagination-btn" href="/admin?cPage=<%= cPage - 1 %>&<%- baseQ %>">Prev</a>
          <% } else { %>
            <button class="pagination-btn" disabled>Prev</button>
          <% } %>
          <% if (cHasMore) { %>
            <a class="pagination-btn" href="/admin?cPage=<%= cPage + 1 %>&<%- baseQ %>">Next</a>
          <% } else { %>
            <button class="pagination-btn" disabled>Next</button>
          <% } %>
        </div>
      </div>
    </div>
  </section>

  <!-- Content Appeals Queue -->
  <section class="admin-panel tab-panel" data-tab="content-appeals" style="display:none;">
    <div class="panel-head">
      <h2>Content Appeals</h2>
    </div>
    <div class="table-responsive">
      <div class="filter-row">
        <div class="search-input-wrapper">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <input type="text" id="filterContentAppeals" placeholder="Filter by email, type, status..." class="admin-search-input">
        </div>
        <form method="GET" action="/admin" style="margin-left:auto;display:flex;gap:8px;align-items:center;">
          <input type="hidden" name="page" value="<%= page %>">
          <input type="hidden" name="q" value="<%= q %>">
          <input type="hidden" name="cPage" value="<%= cPage %>">
          <input type="hidden" name="aaPage" value="<%= aaPage %>">
          <label class="filter-hint">Status</label>
          <select name="caStatus" class="role-select" onchange="this.form.submit()">
            <option value="" <%= !caStatus ? 'selected' : '' %>>All</option>
            <option value="open" <%= caStatus==='open'?'selected':'' %>>Open</option>
            <option value="under_review" <%= caStatus==='under_review'?'selected':'' %>>Under Review</option>
            <option value="approved" <%= caStatus==='approved'?'selected':'' %>>Approved</option>
            <option value="denied" <%= caStatus==='denied'?'selected':'' %>>Denied</option>
          </select>
        </form>
      </div>
      <table class="admin-table" id="contentAppealsTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Email</th>
            <th>Type</th>
            <th>URL/ID</th>
            <th>Reason</th>
            <th>Status</th>
            <th>Submitted</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <% (contentAppeals || []).forEach(a => { %>
            <tr class="row-content-appeal" data-email="<%= a.email %>" data-type="<%= a.content_type %>" data-status="<%= a.status %>">
              <td><span class="user-id">#<%= a.id %></span></td>
              <td><a href="mailto:<%= a.email %>" style="color: var(--accent);"><%= a.email %></a></td>
              <td><strong><%= a.content_type %></strong></td>
              <td><%= a.content_url || '-' %></td>
              <td><%= a.removal_reason || '-' %></td>
              <td><span class="role-badge role-<%= a.status.replace('_', '-') %>"><%= a.status.replace('_', ' ') %></span></td>
              <td><%= new Date(a.created_at).toLocaleString() %></td>
              <td>
                <div style="display:flex;gap:4px;">
                  <button onclick="quickAppealAction('content', <%= a.id %>, 'approved')" class="quick-action-btn" style="background:#10b981;color:white;" title="Approve">‚úì</button>
                  <button onclick="quickAppealAction('content', <%= a.id %>, 'denied')" class="quick-action-btn" style="background:#ef4444;color:white;" title="Deny">‚úó</button>
                  <button onclick="viewAppealDetails('content', <%= a.id %>, <%- JSON.stringify(a).replace(/'/g, '&apos;') %>)" class="quick-action-btn" style="background:#667eea;color:white;" title="View Details">üëÅ</button>
                </div>
              </td>
            </tr>
          <% }) %>
          <% if (!contentAppeals || !contentAppeals.length) { %>
            <tr><td colspan="8" class="no-results">No content appeals submitted.</td></tr>
          <% } %>
        </tbody>
      </table>
      <div class="pager">
        <div class="pagination-info">Page <%= caPage %></div>
        <div class="pager-actions">
          <% const baseCA = `page=${page}&q=${encodeURIComponent(q||'')}&cPage=${cPage}&aaPage=${aaPage}&caStatus=${encodeURIComponent(caStatus||'')}` %>
          <% if (caPage > 1) { %>
            <a class="pagination-btn" href="/admin?caPage=<%= caPage - 1 %>&<%- baseCA %>">Prev</a>
          <% } else { %>
            <button class="pagination-btn" disabled>Prev</button>
          <% } %>
          <% if (caHasMore) { %>
            <a class="pagination-btn" href="/admin?caPage=<%= caPage + 1 %>&<%- baseCA %>">Next</a>
          <% } else { %>
            <button class="pagination-btn" disabled>Next</button>
          <% } %>
        </div>
      </div>
    </div>
  </section>

  <!-- Account Appeals Queue -->
  <section class="admin-panel tab-panel" data-tab="account-appeals" style="display:none;">
    <div class="panel-head">
      <h2>Account Appeals</h2>
    </div>
    <div class="table-responsive">
      <div class="filter-row">
        <div class="search-input-wrapper">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <input type="text" id="filterAccountAppeals" placeholder="Filter by email, username, status..." class="admin-search-input">
        </div>
        <form method="GET" action="/admin" style="margin-left:auto;display:flex;gap:8px;align-items:center;">
          <input type="hidden" name="page" value="<%= page %>">
          <input type="hidden" name="q" value="<%= q %>">
          <input type="hidden" name="cPage" value="<%= cPage %>">
          <input type="hidden" name="caPage" value="<%= caPage %>">
          <label class="filter-hint">Status</label>
          <select name="aaStatus" class="role-select" onchange="this.form.submit()">
            <option value="" <%= !aaStatus ? 'selected' : '' %>>All</option>
            <option value="open" <%= aaStatus==='open'?'selected':'' %>>Open</option>
            <option value="under_review" <%= aaStatus==='under_review'?'selected':'' %>>Under Review</option>
            <option value="approved" <%= aaStatus==='approved'?'selected':'' %>>Approved</option>
            <option value="denied" <%= aaStatus==='denied'?'selected':'' %>>Denied</option>
          </select>
        </form>
      </div>
      <table class="admin-table" id="accountAppealsTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Email</th>
            <th>Username</th>
            <th>Action</th>
            <th>Reason</th>
            <th>Status</th>
            <th>Submitted</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <% (accountAppeals || []).forEach(a => { %>
            <tr class="row-account-appeal" data-email="<%= a.email %>" data-username="<%= a.username %>" data-status="<%= a.status %>">
              <td><span class="user-id">#<%= a.id %></span></td>
              <td><a href="mailto:<%= a.email %>" style="color: var(--accent);"><%= a.email %></a></td>
              <td><strong><%= a.username %></strong></td>
              <td><%= a.account_action %></td>
              <td><%= a.violation_reason || '-' %></td>
              <td><span class="role-badge role-<%= a.status.replace('_', '-') %>"><%= a.status.replace('_', ' ') %></span></td>
              <td><%= new Date(a.created_at).toLocaleString() %></td>
              <td>
                <div style="display:flex;gap:4px;">
                  <button onclick="quickAppealAction('account', <%= a.id %>, 'approved')" class="quick-action-btn" style="background:#10b981;color:white;" title="Approve">‚úì</button>
                  <button onclick="quickAppealAction('account', <%= a.id %>, 'denied')" class="quick-action-btn" style="background:#ef4444;color:white;" title="Deny">‚úó</button>
                  <button onclick="viewAppealDetails('account', <%= a.id %>, <%- JSON.stringify(a).replace(/'/g, '&apos;') %>)" class="quick-action-btn" style="background:#667eea;color:white;" title="View Details">üëÅ</button>
                </div>
              </td>
            </tr>
          <% }) %>
          <% if (!accountAppeals || !accountAppeals.length) { %>
            <tr><td colspan="8" class="no-results">No account appeals submitted.</td></tr>
          <% } %>
        </tbody>
      </table>
      <div class="pager">
        <div class="pagination-info">Page <%= aaPage %></div>
        <div class="pager-actions">
          <% const baseAA = `page=${page}&q=${encodeURIComponent(q||'')}&cPage=${cPage}&caPage=${caPage}&aaStatus=${encodeURIComponent(aaStatus||'')}` %>
          <% if (aaPage > 1) { %>
            <a class="pagination-btn" href="/admin?aaPage=<%= aaPage - 1 %>&<%- baseAA %>">Prev</a>
          <% } else { %>
            <button class="pagination-btn" disabled>Prev</button>
          <% } %>
          <% if (aaHasMore) { %>
            <a class="pagination-btn" href="/admin?aaPage=<%= aaPage + 1 %>&<%- baseAA %>">Next</a>
          <% } else { %>
            <button class="pagination-btn" disabled>Next</button>
          <% } %>
        </div>
      </div>
    </div>
  </section>

  <!-- Services Moderation Panel -->
  <section class="admin-panel tab-panel" data-tab="services" style="display:none;">
    <div class="panel-head">
      <h2>Services Moderation</h2>
      <a href="/admin/services" class="admin-header-btn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
          <polyline points="15 3 21 3 21 9"></polyline>
          <line x1="10" y1="14" x2="21" y2="3"></line>
        </svg>
        Full Portal
      </a>
    </div>
    <div class="table-responsive">
      <p style="text-align:center;padding:40px 20px;color:#6b7280;">
        Use the <strong>Full Portal</strong> button above to access comprehensive service moderation features including hide, unhide, delete, and edit capabilities.
      </p>
      <div style="text-align:center;margin-top:20px;">
        <a href="/admin/services" class="pagination-btn" style="display:inline-flex;align-items:center;gap:8px;padding:14px 28px;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
            <path d="M2 17l10 5 10-5M2 12l10 5 10-5"></path>
          </svg>
          Open Services Moderation Portal
        </a>
      </div>
    </div>
  </section>

  <!-- User Moderation Panel -->
  <% if (authUser && (authUser.role === 'super_admin' || authUser.role === 'global_admin')) { %>
    <section class="admin-panel tab-panel" data-tab="user-moderation" style="display:none;">
      <div class="panel-head">
        <h2>User Moderation</h2>
        <a href="/admin/moderation/user-actions" class="admin-header-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
            <polyline points="15 3 21 3 21 9"></polyline>
            <line x1="10" y1="14" x2="21" y2="3"></line>
          </svg>
          Full Portal
        </a>
      </div>
      <div class="table-responsive">
        <p style="text-align:center;padding:40px 20px;color:#6b7280;">
          Use the <strong>Full Portal</strong> button above to access comprehensive user moderation features including block management, user reports, and moderator controls.
        </p>
        <div style="text-align:center;margin-top:20px;">
          <a href="/admin/moderation/user-actions" class="pagination-btn" style="display:inline-flex;align-items:center;gap:8px;padding:14px 28px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
            </svg>
            Open User Moderation Portal
          </a>
        </div>
      </div>
    </section>
  <% } %>

  <!-- Audit Logs (Super Admin Only) -->
  <% if (authUser && (authUser.role === 'super_admin' || authUser.role === 'global_admin')) { %>
    <section class="admin-panel tab-panel" data-tab="audit" style="display:none;">
      <div class="panel-head">
        <h2>Audit Logs</h2>
        <span class="badge">Latest 50</span>
      </div>
      <div class="table-responsive">
        <table class="admin-table audit-table">
          <thead>
            <tr>
              <th>Time</th>
              <th>User ID</th>
              <th>Action</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            <% (logs || []).forEach(l => { %>
              <tr>
                <td><%= new Date(l.created_at).toLocaleString() %></td>
                <td><%= l.user_id || '-' %></td>
                <td><code class="action-code"><%= l.action %></code></td>
                <td><pre class="details-pre"><%= l.details || '' %></pre></td>
              </tr>
            <% }) %>
            <% if (!logs || !logs.length) { %>
              <tr>
                <td colspan="4" class="no-results">No audit logs recorded yet.</td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </section>
  <% } %>

  <!-- Ban User Modal -->
  <!-- Add Admin Modal -->
  <div id="addAdminModal" class="admin-modal" style="display:none;">
    <div class="admin-modal-content">
      <div class="admin-modal-header">
        <h3>Add New Administrator</h3>
        <button class="admin-modal-close" onclick="closeAddAdminModal()">&times;</button>
      </div>
      <div class="admin-modal-body">
        <p style="margin-bottom:20px;color:#6b7280;">Promote an existing user to an administrative role.</p>
        
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;">Search User <span style="color:#ef4444;">*</span></label>
          <div style="position:relative;">
            <input 
              type="text" 
              id="adminUserSearch" 
              placeholder="Search by name or email..." 
              style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;"
              onkeyup="searchUsersForAdmin()"
            >
            <div id="adminUserResults" style="display:none;position:absolute;top:100%;left:0;right:0;background:white;border:2px solid #e5e7eb;border-top:none;border-radius:0 0 8px 8px;max-height:200px;overflow-y:auto;z-index:10;">
            </div>
          </div>
        </div>

        <div id="selectedUserInfo" style="display:none;padding:16px;background:#f9fafb;border:2px solid #e5e7eb;border-radius:8px;margin-bottom:16px;">
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="width:48px;height:48px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:20px;" id="selectedUserAvatar"></div>
            <div style="flex:1;">
              <div style="font-weight:700;color:#111827;font-size:16px;" id="selectedUserName"></div>
              <div style="color:#6b7280;font-size:14px;" id="selectedUserEmail"></div>
            </div>
            <button onclick="clearSelectedUser()" style="background:none;border:none;color:#6b7280;font-size:24px;cursor:pointer;padding:0;width:32px;height:32px;">&times;</button>
          </div>
        </div>

        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;">Administrative Role <span style="color:#ef4444;">*</span></label>
          <select id="adminRoleSelect" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;">
            <option value="">Select a role...</option>
            <option value="admin">Admin - Basic administrative permissions</option>
            <option value="super_admin">Super Admin - Full administrative access</option>
            <% if (authUser && authUser.role === 'global_admin') { %>
              <option value="global_admin">Global Admin - Highest level access</option>
            <% } %>
            <option value="hr">HR - Human resources management</option>
          </select>
        </div>

        <div style="padding:16px;background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;margin-bottom:16px;">
          <p style="margin:0 0 12px 0;color:#1e40af;font-weight:600;font-size:0.95rem;">Role Permissions Overview:</p>
          <ul style="margin:0;padding-left:20px;color:#1e3a8a;font-size:0.9rem;line-height:1.8;">
            <li><strong>Admin:</strong> Manage users, view content, moderate posts</li>
            <li><strong>Super Admin:</strong> All admin powers + role management + audit logs</li>
            <% if (authUser && authUser.role === 'global_admin') { %>
              <li><strong>Global Admin:</strong> Unrestricted access to all platform features</li>
            <% } %>
            <li><strong>HR:</strong> Manage career applications and recruitment</li>
          </ul>
        </div>

        <div style="padding:16px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;">
          <p style="margin:0;color:#991b1b;font-size:0.9rem;"><strong>‚ö†Ô∏è Important:</strong> Granting administrative access gives significant platform control. Only promote trusted individuals.</p>
        </div>
      </div>
      <div class="admin-modal-footer">
        <button class="admin-modal-btn secondary" onclick="closeAddAdminModal()">Cancel</button>
        <button class="admin-modal-btn primary" onclick="confirmAddAdmin()">Promote to Admin</button>
      </div>
    </div>
  </div>

  <!-- Unified User Wizard -->
  <div id="userWizardModal" class="admin-modal" style="display:none;">
    <div class="admin-modal-content" style="max-width:720px;">
      <div class="admin-modal-header">
        <div>
          <p style="margin:0;color:#a855f7;font-weight:700;text-transform:uppercase;font-size:12px;letter-spacing:1px;">Premium onboarding</p>
          <h3 style="margin:4px 0 0 0;">Add user or admin</h3>
        </div>
        <button class="admin-modal-close" onclick="closeUserWizard()">&times;</button>
      </div>
      <div class="admin-modal-body">
        <div id="wizardSteps" class="wizard-steps">
          <div class="wizard-step active" data-step="1">Basics</div>
          <div class="wizard-step" data-step="2">Access</div>
          <div class="wizard-step" data-step="3">Permissions</div>
          <div class="wizard-step" data-step="4">Confirm</div>
        </div>
        <div class="wizard-panel" data-step="1">
          <label>Full name</label>
          <input id="wizardName" type="text" placeholder="Alex Doe" class="wizard-input" />
          <label style="margin-top:12px;">Email</label>
          <input id="wizardEmail" type="email" placeholder="alex@dreamx.com" class="wizard-input" />
          <label style="margin-top:12px;">Temporary password</label>
          <input id="wizardPassword" type="text" placeholder="Auto-generate or set manually" class="wizard-input" value="Admin!123" />
        </div>
        <div class="wizard-panel" data-step="2" style="display:none;">
          <label>Role</label>
          <select id="wizardRole" class="wizard-input">
            <option value="user">User</option>
            <option value="admin">Admin</option>
            <option value="super_admin" <%= authUser.role === 'global_admin' ? '' : 'disabled' %>>Super Admin</option>
            <option value="global_admin" <%= authUser.role === 'global_admin' ? '' : 'disabled' %>>Global Admin</option>
          </select>
          <p class="wizard-hint">Admins can only create roles at or below their level.</p>
          <div class="rbac-callout" id="rbacCallout">
            <strong>RBAC quick edit</strong>
            <p>Global admins can tune platform-level RBAC defaults directly.</p>
            <% if (authUser.role === 'global_admin') { %>
              <button type="button" class="admin-modal-btn primary" style="margin-top:8px;" onclick="openRbacDrawer()">Open RBAC Console</button>
            <% } else { %>
              <span style="color:#6b7280;font-size:0.9rem;">RBAC console available to global admins.</span>
            <% } %>
          </div>
        </div>
        <div class="wizard-panel" data-step="3" style="display:none;">
          <p class="wizard-hint" id="permissionGuardrail">Toggle granular permissions for this admin. Leave blank for defaults.</p>
          <p class="wizard-hint" id="permissionUserNotice" style="display:none;color:#9ca3af;">Standard users do not receive administrative permissions.</p>
          <div class="chip-grid" id="wizardPermissionGrid">
            <% (adminPermissions || []).forEach(function(p) { %>
              <label><input type="checkbox" name="wizardPerm" value="<%= p.key %>"> <%= p.label %></label>
            <% }) %>
          </div>
          <label style="margin-top:12px;">Scope tags (comma separated)</label>
          <input id="wizardScopes" type="text" class="wizard-input" placeholder="north-america, beta" />
        </div>
        <div class="wizard-panel" data-step="4" style="display:none;">
          <div class="review-card">
            <h4>Review access</h4>
            <ul id="wizardSummary"></ul>
            <div id="wizardError" class="admin-alert admin-alert-error" style="display:none;margin-top:12px;"></div>
            <div id="wizardSuccess" class="admin-alert admin-alert-success" style="display:none;margin-top:12px;">Account created!</div>
          </div>
        </div>
      </div>
      <div class="admin-modal-footer">
        <button class="admin-modal-btn secondary" onclick="previousWizardStep()">Back</button>
        <button class="admin-modal-btn primary" id="wizardNextBtn" onclick="nextWizardStep()">Next</button>
      </div>
    </div>
  </div>

  <!-- RBAC Drawer -->
  <div id="rbacDrawer" class="admin-modal" style="display:none;align-items:flex-end;">
    <div class="admin-modal-content" style="width:100%;max-width:640px;">
      <div class="admin-modal-header">
        <h3>Role-Based Access Control</h3>
        <button class="admin-modal-close" onclick="closeRbacDrawer()">&times;</button>
      </div>
      <div class="admin-modal-body">
        <p style="color:#6b7280;">Curate platform-wide guardrails, then apply them to this wizard without leaving the flow.</p>
        <div class="rbac-grid" id="rbacPermissionList"></div>
        <label style="margin-top:16px;">Scopes to apply</label>
        <input id="rbacScopeInput" type="text" class="wizard-input" placeholder="region:emea, rollout:beta" />
        <div class="admin-alert admin-alert-info" style="margin-top:12px;">These selections will sync with the "Permissions" step when you click Apply.</div>
      </div>
      <div class="admin-modal-footer">
        <button class="admin-modal-btn secondary" onclick="closeRbacDrawer()">Close</button>
        <button class="admin-modal-btn primary" onclick="applyRbacSettings()">Apply to wizard</button>
      </div>
    </div>
  </div>

  <!-- Permission Editor -->
  <div id="permissionModal" class="admin-modal" style="display:none;">
    <div class="admin-modal-content" style="max-width:560px;">
      <div class="admin-modal-header">
        <div>
          <p style="margin:0;color:#2563eb;font-weight:700;font-size:12px;">Adjust permissions</p>
          <h3 id="permissionTitle" style="margin:4px 0 0 0;">Admin permissions</h3>
        </div>
        <button class="admin-modal-close" onclick="closePermissionModal()">&times;</button>
      </div>
      <div class="admin-modal-body">
        <p id="permissionSubtitle" style="color:#6b7280;margin-top:0;">Fine-tune access for this admin.</p>
        <div class="chip-grid" id="permissionCheckboxes"></div>
        <label style="margin-top:12px;">Scopes</label>
        <input id="permissionScopes" class="wizard-input" type="text" placeholder="region:us, product:maps" />
        <div id="permissionError" class="admin-alert admin-alert-error" style="display:none;margin-top:12px;"></div>
        <div id="permissionSuccess" class="admin-alert admin-alert-success" style="display:none;margin-top:12px;">Permissions saved.</div>
      </div>
      <div class="admin-modal-footer">
        <button class="admin-modal-btn secondary" onclick="closePermissionModal()">Close</button>
        <button class="admin-modal-btn primary" onclick="savePermissions()">Save</button>
      </div>
    </div>
  </div>

  <style>
    .wizard-steps { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-bottom:16px; }
    .wizard-step { padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; text-align:center; font-weight:700; color:#6b7280; background:#f9fafb; }
    .wizard-step.active { border-color:#8b5cf6; color:#4c1d95; background:linear-gradient(135deg,#ede9fe,#f5f3ff); }
    .wizard-step.disabled { opacity:0.4; filter:grayscale(1); }
    .wizard-input { width:100%; padding:12px; border:2px solid #e5e7eb; border-radius:10px; font-size:15px; }
    .wizard-hint { color:#6b7280; font-size:0.9rem; margin-top:8px; }
    .chip-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:10px; margin-top:8px; }
    .chip-grid label { padding:10px 12px; border:1px solid #e5e7eb; border-radius:12px; background:#f9fafb; display:flex; align-items:center; gap:8px; font-weight:600; color:#374151; }
    .chip-grid.disabled { opacity:0.5; pointer-events:none; }
    .review-card { background:#f9fafb; border:1px solid #e5e7eb; border-radius:12px; padding:14px; }
    .review-card ul { padding-left:18px; line-height:1.6; }
    .rbac-callout { margin-top:12px; padding:12px; border:1px dashed #a78bfa; border-radius:10px; background:linear-gradient(135deg,#f5f3ff,#eef2ff); }
    .rbac-pill { display:inline-flex; align-items:center; padding:8px 12px; border-radius:999px; background:#eef2ff; color:#4338ca; font-weight:700; margin-right:8px; margin-bottom:6px; }
    #rbacDrawer.open { display:flex !important; }
    .rbac-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:10px; margin-top:12px; }
    .rbac-card { padding:12px; border:1px solid #e5e7eb; border-radius:10px; background:#f9fafb; display:flex; gap:12px; align-items:flex-start; }
    .rbac-card input { margin-top:4px; }
  </style>

  <!-- Ban User Modal -->
  <div id="banUserModal" class="admin-modal" style="display:none;">
    <div class="admin-modal-content">
      <div class="admin-modal-header">
        <h3>Ban User</h3>
        <button class="admin-modal-close" onclick="closeBanModal()">&times;</button>
      </div>
      <div class="admin-modal-body">
        <p style="margin-bottom:20px;color:#6b7280;">Permanently ban <strong id="banUserName"></strong> from the platform.</p>
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;">Ban Reason <span style="color:#ef4444;">*</span></label>
          <textarea id="banReason" rows="4" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-family:inherit;" placeholder="Describe the reason for this permanent ban..."></textarea>
        </div>
        <div style="padding:16px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;margin-bottom:16px;">
          <p style="margin:0;color:#991b1b;font-size:0.9rem;"><strong>‚ö†Ô∏è Warning:</strong> This action is severe and permanent. The user will lose all access to the platform.</p>
        </div>
        <div style="margin-bottom:16px;">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="banNotifyUser" checked style="width:18px;height:18px;cursor:pointer;">
            <span style="font-weight:600;color:#374151;">‚úâÔ∏è Send email notification to user about this ban</span>
          </label>
        </div>
      </div>
      <div class="admin-modal-footer">
        <button class="admin-modal-btn secondary" onclick="closeBanModal()">Cancel</button>
        <button class="admin-modal-btn danger" onclick="confirmBan()">Ban User</button>
      </div>
    </div>
  </div>

  <!-- Suspend User Modal -->
  <div id="suspendUserModal" class="admin-modal" style="display:none;">
    <div class="admin-modal-content">
      <div class="admin-modal-header">
        <h3>Suspend User</h3>
        <button class="admin-modal-close" onclick="closeSuspendModal()">&times;</button>
      </div>
      <div class="admin-modal-body">
        <p style="margin-bottom:20px;color:#6b7280;">Temporarily suspend <strong id="suspendUserName"></strong> from the platform.</p>
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;">Suspension Duration <span style="color:#ef4444;">*</span></label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <input type="number" id="suspendDays" min="1" max="365" value="7" style="padding:12px;border:2px solid #e5e7eb;border-radius:8px;">
            <select id="suspendUnit" style="padding:12px;border:2px solid #e5e7eb;border-radius:8px;">
              <option value="days" selected>Days</option>
              <option value="hours">Hours</option>
            </select>
          </div>
        </div>
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;">Suspension Reason <span style="color:#ef4444;">*</span></label>
          <textarea id="suspendReason" rows="4" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-family:inherit;" placeholder="Describe the reason for this suspension..."></textarea>
        </div>
        <div style="padding:16px;background:#fffbeb;border:1px solid #fef3c7;border-radius:8px;margin-bottom:16px;">
          <p style="margin:0;color:#92400e;font-size:0.9rem;"><strong>‚ÑπÔ∏è Note:</strong> The user will be unable to access the platform until the suspension period ends.</p>
        </div>
        <div style="margin-bottom:16px;">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="suspendNotifyUser" checked style="width:18px;height:18px;cursor:pointer;">
            <span style="font-weight:600;color:#374151;">‚úâÔ∏è Send email notification to user about this suspension</span>
          </label>
        </div>
      </div>
      <div class="admin-modal-footer">
        <button class="admin-modal-btn secondary" onclick="closeSuspendModal()">Cancel</button>
        <button class="admin-modal-btn warning" onclick="confirmSuspend()">Suspend User</button>
      </div>
    </div>
  </div>
  
  <script src="/js/admin.js"></script>
  <script>
    // Highlight user row when returning from stats page
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const highlightId = urlParams.get('highlight');
      const wizardRoleSelect = document.getElementById('wizardRole');
      if (wizardRoleSelect) {
        wizardRoleSelect.addEventListener('change', configureAccessUI);
      }
      if (highlightId) {
        // Switch to users tab
        const usersTab = document.querySelector('[data-tab="users"]');
        if (usersTab) {
          usersTab.click();
        }
        
        // Highlight the user row
        setTimeout(() => {
          const row = document.querySelector(`tr[data-user-id="${highlightId}"]`);
          if (row) {
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            row.style.backgroundColor = '#fff3cd';
            row.style.transition = 'background-color 0.3s';
            setTimeout(() => {
              row.style.backgroundColor = '';
            }, 2000);
          }
        }, 300);
      }
    });
  </script>

  <style>
    .quick-action-btn {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }
    .quick-action-btn:hover {
      opacity: 0.8;
      transform: translateY(-1px);
    }
  </style>

  <script>
    // Add Admin Modal Functions
    let selectedUserId = null;

    function openAddAdminModal() {
      document.getElementById('addAdminModal').style.display = 'flex';
      selectedUserId = null;
      document.getElementById('adminUserSearch').value = '';
      document.getElementById('adminRoleSelect').value = '';
      document.getElementById('selectedUserInfo').style.display = 'none';
      document.getElementById('adminUserResults').style.display = 'none';
    }

    function closeAddAdminModal() {
      document.getElementById('addAdminModal').style.display = 'none';
      selectedUserId = null;
    }

    let searchTimeout;
    async function searchUsersForAdmin() {
      const query = document.getElementById('adminUserSearch').value.trim();
      const resultsDiv = document.getElementById('adminUserResults');
      
      if (query.length < 2) {
        resultsDiv.style.display = 'none';
        return;
      }

      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(async () => {
        try {
          const res = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`);
          const data = await res.json();
          const users = data.results || [];
          
          if (users.length === 0) {
            resultsDiv.innerHTML = '<div style="padding:12px;color:#6b7280;text-align:center;">No users found</div>';
            resultsDiv.style.display = 'block';
            return;
          }

          resultsDiv.innerHTML = users.map(u => `
            <div onclick="selectUser(${u.id}, '${u.full_name.replace(/'/g, "\\'")}', '${u.email}')" style="padding:12px;cursor:pointer;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;gap:12px;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
              <div style="width:36px;height:36px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:14px;">
                ${u.full_name.charAt(0).toUpperCase()}
              </div>
              <div>
                <div style="font-weight:600;color:#111827;">${u.full_name}</div>
                <div style="font-size:12px;color:#6b7280;">${u.email}</div>
              </div>
            </div>
          `).join('');
          resultsDiv.style.display = 'block';
        } catch (err) {
          console.error('Error searching users:', err);
        }
      }, 300);
    }

    function selectUser(id, name, email) {
      selectedUserId = id;
      document.getElementById('adminUserSearch').value = name;
      document.getElementById('adminUserResults').style.display = 'none';
      
      document.getElementById('selectedUserAvatar').textContent = name.charAt(0).toUpperCase();
      document.getElementById('selectedUserName').textContent = name;
      document.getElementById('selectedUserEmail').textContent = email;
      document.getElementById('selectedUserInfo').style.display = 'block';
    }

    function clearSelectedUser() {
      selectedUserId = null;
      document.getElementById('adminUserSearch').value = '';
      document.getElementById('selectedUserInfo').style.display = 'none';
    }

    async function confirmAddAdmin() {
      if (!selectedUserId) {
        alert('Please select a user first');
        return;
      }

      const role = document.getElementById('adminRoleSelect').value;
      if (!role) {
        alert('Please select an administrative role');
        return;
      }

      if (!confirm(`Are you sure you want to promote this user to ${role.replace('_', ' ')}?`)) {
        return;
      }

      try {
        const res = await fetch(`/admin/users/${selectedUserId}/role`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `role=${role}`
        });

        if (res.ok) {
          window.location.href = '/admin?success=User+promoted+to+' + role.replace('_', '+');
        } else {
          alert('Failed to update user role');
        }
      } catch (err) {
        alert('Error updating user role');
      }
    }

    // Quick appeal action
    async function quickAppealAction(type, id, status) {
      if (!confirm(`${status === 'approved' ? 'Approve' : 'Deny'} this ${type} appeal?`)) return;
      
      try {
        const res = await fetch(`/admin/appeals/${type}/${id}/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `status=${status}`
        });
        
        if (res.ok) {
          window.location.reload();
        } else {
          alert('Failed to update appeal status');
        }
      } catch (err) {
        alert('Error updating appeal');
      }
    }

    // View appeal details
    function viewAppealDetails(type, id, data) {
      const modal = document.createElement('div');
      modal.style.cssText = 'display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;';
      
      const content = document.createElement('div');
      content.style.cssText = 'background:white;border-radius:16px;padding:32px;max-width:700px;width:90%;max-height:90vh;overflow-y:auto;';
      
      let detailsHTML = `
        <div style="display:flex;justify-content:space-between;margin-bottom:20px;">
          <h2 style="margin:0;">${type === 'content' ? 'Content' : 'Account'} Appeal #${id}</h2>
          <button onclick="this.closest('[style*=fixed]').remove()" style="background:none;border:none;font-size:32px;color:#6b7280;cursor:pointer;">&times;</button>
        </div>
      `;
      
      if (type === 'content') {
        detailsHTML += `
          <p><strong>Email:</strong> <a href="mailto:${data.email}">${data.email}</a></p>
          <p><strong>Content Type:</strong> ${data.content_type}</p>
          <p><strong>Content URL:</strong> ${data.content_url || 'N/A'}</p>
          <p><strong>Removal Reason:</strong> ${data.removal_reason || 'N/A'}</p>
          <p><strong>Description:</strong></p>
          <div style="background:#f9fafb;padding:16px;border-radius:8px;margin-bottom:16px;">${(data.description || 'N/A').replace(/\n/g, '<br>')}</div>
          <p><strong>Appeal Reason:</strong></p>
          <div style="background:#f9fafb;padding:16px;border-radius:8px;margin-bottom:16px;">${(data.appeal_reason || '').replace(/\n/g, '<br>')}</div>
          <p><strong>Additional Info:</strong></p>
          <div style="background:#f9fafb;padding:16px;border-radius:8px;">${(data.additional_info || 'None').replace(/\n/g, '<br>')}</div>
        `;
      } else {
        detailsHTML += `
          <p><strong>Email:</strong> <a href="mailto:${data.email}">${data.email}</a></p>
          <p><strong>Username:</strong> ${data.username}</p>
          <p><strong>Account Action:</strong> ${data.account_action}</p>
          <p><strong>Action Date:</strong> ${data.action_date || 'N/A'}</p>
          <p><strong>Violation Reason:</strong> ${data.violation_reason || 'N/A'}</p>
          <p><strong>Appeal Explanation:</strong></p>
          <div style="background:#f9fafb;padding:16px;border-radius:8px;margin-bottom:16px;">${(data.appeal_explanation || '').replace(/\n/g, '<br>')}</div>
          <p><strong>Additional Context:</strong></p>
          <div style="background:#f9fafb;padding:16px;border-radius:8px;">${(data.additional_context || 'None').replace(/\n/g, '<br>')}</div>
        `;
      }
      
      detailsHTML += `
        <p><strong>Status:</strong> <span class="role-badge role-${data.status.replace('_', '-')}">${data.status.replace('_', ' ')}</span></p>
        <p><strong>Submitted:</strong> ${new Date(data.created_at).toLocaleString()}</p>
        <div style="display:flex;gap:12px;margin-top:20px;">
          <button onclick="quickAppealAction('${type}', ${id}, 'approved'); this.closest('[style*=fixed]').remove();" style="padding:12px 24px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Approve</button>
          <button onclick="quickAppealAction('${type}', ${id}, 'denied'); this.closest('[style*=fixed]').remove();" style="padding:12px 24px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Deny</button>
          <button onclick="this.closest('[style*=fixed]').remove()" style="padding:12px 24px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Close</button>
        </div>
      `;
      
      content.innerHTML = detailsHTML;
      modal.appendChild(content);
      document.body.appendChild(modal);
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
    }

    // Freeze/unfreeze seller privileges
    function freezeSellerAction(userId, userName) {
      if (confirm(`Freeze seller privileges for ${userName}? This will deactivate all their services.`)) {
        fetch(`/admin/users/${userId}/freeze-seller`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'action=freeze'
        }).then(res => {
          if (res.ok) location.reload();
          else alert('Failed to freeze seller privileges');
        });
      }
    }

    function unfreezeSellerAction(userId, userName) {
      if (confirm(`Restore seller privileges for ${userName}? This will reactivate their services.`)) {
        fetch(`/admin/users/${userId}/freeze-seller`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'action=unfreeze'
        }).then(res => {
          if (res.ok) location.reload();
          else alert('Failed to unfreeze seller privileges');
        });
      }
    }

    // Refund request actions
    function viewRefundRequest(id) {
      fetch(`/admin/refund-requests/${id}`, { headers: { 'Accept': 'application/json' }})
        .then(res => {
          if (!res.ok) throw new Error('Request failed');
          return res.json();
        })
        .then(payload => {
          const data = payload && (payload.data || payload);
          if (!data || (payload && payload.success === false)) {
            throw new Error((payload && payload.error) || 'Invalid response');
          }
          const audit = (payload && payload.audit) ? payload.audit : [];
          const modal = document.createElement('div');
          modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;';
          
          const content = document.createElement('div');
          content.style.cssText = 'background:white;border-radius:16px;padding:32px;max-width:800px;width:90%;max-height:90vh;overflow-y:auto;';
          
          const screenshotPath = data.screenshot
            ? (data.screenshot.startsWith('uploads/') ? `/${data.screenshot}` : `/uploads/${data.screenshot}`)
            : '';

          // Build audit trail HTML if available
          const auditHtml = (audit && audit.length)
            ? (`<div style="margin-bottom:20px;">
                <p style="margin:0 0 8px;font-weight:600;">Audit Trail</p>
                <div style="background:#f9fafb;padding:12px;border-radius:8px;border:1px solid #e5e7eb;max-height:220px;overflow:auto;">
                  ${audit.map(a => {
                    let details;
                    try { details = JSON.parse(a.details || '{}'); } catch(e){ details = {}; }
                    const status = details.status ? ` ‚Äî ${String(details.status).toUpperCase()}` : '';
                    const amount = (details.refundAmount !== undefined && details.refundAmount !== null)
                      ? ` ‚Äî Amount: $${parseFloat(details.refundAmount).toFixed(2)}` : '';
                    const who = a.admin_name || a.admin_email || 'System';
                    const ts = new Date(a.created_at).toLocaleString();
                    return `<div style="padding:8px 10px;border-bottom:1px dashed #e5e7eb;font-size:.9rem;">
                              <div style="font-weight:600;color:#374151;">${a.action.replace(/_/g,' ')}</div>
                              <div style="color:#6b7280;">${who} ‚Äî ${ts}${status}${amount}</div>
                            </div>`;
                  }).join('')}
                </div>
              </div>`)
            : '';

          content.innerHTML = `
            <div style="display:flex;justify-content:space-between;margin-bottom:20px;">
              <h2 style="margin:0;">Refund Request #${id}</h2>
              <button onclick="this.closest('[style*=fixed]').remove()" style="background:none;border:none;font-size:32px;color:#6b7280;cursor:pointer;">&times;</button>
            </div>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:24px;">
              <div>
                <p style="margin:0 0 4px;font-size:0.85rem;color:#6b7280;font-weight:600;">User</p>
                <p style="margin:0;font-weight:600;">${data.full_name}</p>
                <p style="margin:4px 0 0;font-size:0.9rem;color:#6b7280;">${data.email}</p>
              </div>
              <div>
                <p style="margin:0 0 4px;font-size:0.85rem;color:#6b7280;font-weight:600;">Amount</p>
                <p style="margin:0;font-size:1.5rem;font-weight:700;color:#10b981;">$${parseFloat(data.amount).toFixed(2)}</p>
              </div>
              <div>
                <p style="margin:0 0 4px;font-size:0.85rem;color:#6b7280;font-weight:600;">Order Date</p>
                <p style="margin:0;">${data.order_date ? new Date(data.order_date).toLocaleDateString() : 'Not provided'}</p>
              </div>
              <div>
                <p style="margin:0 0 4px;font-size:0.85rem;color:#6b7280;font-weight:600;">Transaction ID</p>
                <p style="margin:0;">${data.transaction_id || 'Not provided'}</p>
              </div>
            </div>
            <div style="margin-bottom:20px;">
              <p style="margin:0 0 8px;font-weight:600;">Charge Details</p>
              <div style="background:#f9fafb;padding:16px;border-radius:8px;">
                ${data.charge_description ? `<p style="margin:0;">${data.charge_description}</p>` : '<p style="margin:0;color:#6b7280;">No linked charge</p>'}
                ${data.charge_date ? `<p style="margin:8px 0 0;font-size:0.85rem;color:#6b7280;">Charge Date: ${new Date(data.charge_date).toLocaleDateString()}</p>` : ''}
              </div>
            </div>
            <div style="margin-bottom:20px;">
              <p style="margin:0 0 8px;font-weight:600;">Reason</p>
              <div style="background:#fef3c7;padding:16px;border-radius:8px;">
                <p style="margin:0;font-weight:600;color:#78350f;">${data.reason.replace(/_/g, ' ').toUpperCase()}</p>
                ${data.description ? `<p style="margin:12px 0 0;color:#78350f;">${data.description.replace(/\n/g, '<br>')}</p>` : ''}
              </div>
            </div>
            <div style="margin-bottom:20px;">
              <p style="margin:0 0 8px;font-weight:600;">Refund Method</p>
              <div style="background:#f9fafb;padding:16px;border-radius:8px;">
                <p style="margin:0;">${data.preferred_method.replace(/_/g, ' ').toUpperCase()}</p>
                ${data.account_email ? `<p style="margin:8px 0 0;font-size:0.9rem;color:#6b7280;">Email: ${data.account_email}</p>` : ''}
                ${data.account_last_four ? `<p style="margin:8px 0 0;font-size:0.9rem;color:#6b7280;">Last 4 digits: ${data.account_last_four}</p>` : ''}
              </div>
            </div>
            ${screenshotPath ? `
              <div style="margin-bottom:20px;">
                <p style="margin:0 0 8px;font-weight:600;">Screenshot</p>
                <img src="${screenshotPath}" style="max-width:100%;border-radius:8px;border:2px solid #e5e7eb;" />
              </div>
            ` : ''}
            <div style="margin-bottom:20px;">
              <p style="margin:0 0 8px;font-weight:600;">Status</p>
              <span class="role-badge role-${data.status}">${data.status.toUpperCase()}</span>
            </div>
            ${data.admin_notes ? `
              <div style="margin-bottom:20px;">
                <p style="margin:0 0 8px;font-weight:600;">Admin Notes</p>
                <div style="background:#f9fafb;padding:16px;border-radius:8px;">
                  <p style="margin:0;">${data.admin_notes.replace(/\n/g, '<br>')}</p>
                </div>
              </div>
            ` : ''}
            ${auditHtml}
            <p style="margin:20px 0 8px;font-size:0.85rem;color:#6b7280;">Submitted: ${new Date(data.created_at).toLocaleString()}</p>
            <div style="display:flex;gap:12px;margin-top:24px;">
                <button onclick="showRefundDecisionModal(${id}, 'approved', ${parseFloat(''+data.amount).toFixed(2)})" style="padding:12px 24px;background:#10b981;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Approve</button>
                <button onclick="showRefundDecisionModal(${id}, 'processing')" style="padding:12px 24px;background:#3b82f6;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Mark Processing</button>
                <button onclick="showRefundDecisionModal(${id}, 'denied')" style="padding:12px 24px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Deny</button>
              <button onclick="this.closest('[style*=fixed]').remove()" style="padding:12px 24px;background:#6b7280;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Close</button>
            </div>
          `;
          
          modal.appendChild(content);
          document.body.appendChild(modal);
          
          modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
          });
        })
        .catch(err => {
          console.error('Error fetching refund request:', err);
          if (typeof showError === 'function') {
            showError('Failed to load refund request details');
          } else {
            alert('Failed to load refund request details');
          }
        });
    }

    function updateRefundStatus(id, status, notes, refundAmount) {
      const formData = new URLSearchParams();
      formData.append('status', status);
      if (notes) formData.append('adminNotes', notes);
      if (refundAmount !== undefined && refundAmount !== null && refundAmount !== '') formData.append('refundAmount', refundAmount);

      return fetch(`/admin/refund-requests/${id}/update`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: formData
      }).then(res => res.json());
    }

    function showRefundDecisionModal(id, status, requestedAmount) {
      let modal = document.getElementById('refund-decision-modal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'refund-decision-modal';
        modal.innerHTML = `
          <div style="position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10001;">
            <div style="background:#fff;border-radius:16px;max-width:520px;width:92%;padding:24px;box-shadow:0 10px 40px rgba(0,0,0,0.2);">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <h3 id="refund-decision-title" style="margin:0;font-size:1.25rem;">Update Refund Request</h3>
                <button type="button" onclick="document.getElementById('refund-decision-modal').style.display='none'" style="background:none;border:none;font-size:28px;color:#6b7280;cursor:pointer;">&times;</button>
              </div>
              <div style="display:flex;flex-direction:column;gap:12px;">
                <div>
                  <label style="display:block;font-weight:600;color:#374151;margin-bottom:6px;">Status</label>
                  <select id="refund-decision-status" style="width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;">
                    <option value="approved">Approved</option>
                    <option value="processing">Processing</option>
                    <option value="denied">Denied</option>
                  </select>
                </div>
                <div id="refund-decision-amount-wrap">
                  <label style="display:block;font-weight:600;color:#374151;margin-bottom:6px;">Refund Amount</label>
                  <div style="display:flex;align-items:center;gap:6px;">
                    <span style="background:#f3f4f6;border:1px solid #e5e7eb;padding:10px;border-radius:10px;">$</span>
                    <input id="refund-decision-amount" type="number" step="0.01" min="0" style="flex:1;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;" />
                  </div>
                  <small style="color:#6b7280;">Leave blank to use the requested amount.</small>
                </div>
                <div>
                  <label style="display:block;font-weight:600;color:#374151;margin-bottom:6px;">Admin Notes</label>
                  <textarea id="refund-decision-notes" rows="4" style="width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;resize:vertical;"></textarea>
                </div>
                <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:6px;">
                  <button type="button" onclick="document.getElementById('refund-decision-modal').style.display='none'" style="padding:10px 16px;border:1px solid #e5e7eb;background:#fff;border-radius:10px;font-weight:600;cursor:pointer;">Cancel</button>
                  <button type="button" id="refund-decision-submit" style="display:inline-flex;align-items:center;gap:8px;padding:10px 16px;background:#111827;color:#fff;border:none;border-radius:10px;font-weight:700;cursor:pointer;">
                    <span class="btn-spinner" style="display:none;width:16px;height:16px;border:2px solid rgba(255,255,255,0.4);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;"></span>
                    <span class="btn-text">Update</span>
                  </button>
                </div>
              </div>
            </div>
          </div>`;
        document.body.appendChild(modal);
      }

      // Setup initial state
      document.getElementById('refund-decision-status').value = status;
      const amountWrap = document.getElementById('refund-decision-amount-wrap');
      const amountInput = document.getElementById('refund-decision-amount');
      amountWrap.style.display = status === 'approved' ? 'block' : 'none';
      amountInput.value = status === 'approved' && requestedAmount ? requestedAmount : '';
      document.getElementById('refund-decision-title').textContent = `Update Refund Request ‚Äî ${status.charAt(0).toUpperCase()+status.slice(1)}`;

      const submitBtn = document.getElementById('refund-decision-submit');
      const errorBoxId = 'refund-decision-error';
      let errorBox = document.getElementById(errorBoxId);
      if (!errorBox) {
        errorBox = document.createElement('div');
        errorBox.id = errorBoxId;
        errorBox.style.cssText = 'display:none;margin-top:8px;padding:10px 12px;border-radius:10px;background:#fee2e2;color:#991b1b;border:1px solid #fecaca;font-weight:600;';
        submitBtn.parentElement.insertAdjacentElement('beforebegin', errorBox);
      }

      // Inline validation helpers
      const ensureValidAmount = () => {
        const st = document.getElementById('refund-decision-status').value;
        const valStr = amountInput.value.trim();
        const err = [];
        if (st === 'approved') {
          if (!valStr && (requestedAmount === undefined || requestedAmount === null)) {
            err.push('Refund amount is required for approval.');
          } else if (valStr) {
            const v = parseFloat(valStr);
            if (isNaN(v) || v <= 0) err.push('Enter an amount greater than 0.');
          }
        }
        return err;
      };

      // Live validation on amount input
      amountInput.addEventListener('input', () => {
        const errs = ensureValidAmount();
        if (errs.length) {
          errorBox.textContent = errs[0];
          errorBox.style.display = 'block';
        } else {
          errorBox.style.display = 'none';
        }
      });

      submitBtn.onclick = () => {
        const notes = document.getElementById('refund-decision-notes').value;
        const amountVal = amountInput.value ? parseFloat(amountInput.value) : undefined;

        errorBox.style.display = 'none';
        const textSpan = submitBtn.querySelector('.btn-text');
        const spin = submitBtn.querySelector('.btn-spinner');
        const prevText = textSpan.textContent;
        textSpan.textContent = 'Updating...';
        spin.style.display = 'inline-block';
        submitBtn.disabled = true;

        // Validate before submit
        const errs = ensureValidAmount();
        if (errs.length) {
          errorBox.textContent = errs[0];
          errorBox.style.display = 'block';
          textSpan.textContent = prevText;
          spin.style.display = 'none';
          submitBtn.disabled = false;
          return;
        }

        updateRefundStatus(id, status, notes, amountVal)
          .then(data => {
            if (data && data.success) {
              if (typeof showSuccess === 'function') { showSuccess('Refund request updated successfully'); }
              document.getElementById('refund-decision-modal').style.display = 'none';
              location.reload();
            } else {
              throw new Error((data && data.error) || 'Failed to update refund request');
            }
          })
          .catch(err => {
            errorBox.textContent = err.message || 'Failed to update refund request. Please try again.';
            errorBox.style.display = 'block';
          })
          .finally(() => {
            textSpan.textContent = prevText;
            spin.style.display = 'none';
            submitBtn.disabled = false;
          });
      };

      // Toggle amount field on status change
      document.getElementById('refund-decision-status').onchange = (e) => {
        const st = e.target.value;
        amountWrap.style.display = st === 'approved' ? 'block' : 'none';
      };

      modal.style.display = 'block';
    }
  </script>
  <style>
    @keyframes spin { from { transform: rotate(0); } to { transform: rotate(360deg); } }
  </style>

  <!-- Refund Requests Panel -->
  <section class="admin-panel tab-panel" data-tab="refund-requests" style="display:none;">
    <style>
      .refund-status-badge {
        display: inline-flex;
        align-items: center;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.3px;
        text-transform: uppercase;
      }
      .refund-status-badge.pending {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #92400e;
        border: 1px solid #fcd34d;
      }
      .refund-status-badge.processing {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        color: #1e40af;
        border: 1px solid #93c5fd;
      }
      .refund-status-badge.approved {
        background: linear-gradient(135deg, #d1fae5, #a7f3d0);
        color: #065f46;
        border: 1px solid #6ee7b7;
      }
      .refund-status-badge.denied {
        background: linear-gradient(135deg, #fee2e2, #fecaca);
        color: #991b1b;
        border: 1px solid #fca5a5;
      }
      .refund-status-badge.completed {
        background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
        color: #3730a3;
        border: 1px solid #a5b4fc;
      }
      .refund-amount {
        font-size: 1.1rem;
        font-weight: 700;
        color: #10b981;
        text-shadow: 0 1px 2px rgba(16, 185, 129, 0.2);
      }
      .refund-reason-badge {
        display: inline-block;
        padding: 4px 10px;
        background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 0.8rem;
        color: #374151;
        font-weight: 500;
        text-transform: capitalize;
      }
      .refund-table-header {
        background: linear-gradient(135deg, #f9fafb, #f3f4f6);
        border-bottom: 2px solid #e5e7eb;
      }
      .refund-table-header th {
        padding: 16px 12px;
        font-weight: 700;
        color: #111827;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.8px;
      }
      .refund-action-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        margin: 0 4px;
      }
      .refund-action-btn.view {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        color: #1e40af;
      }
      .refund-action-btn.view:hover {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
      }
      .refund-action-btn.approve {
        background: linear-gradient(135deg, #d1fae5, #a7f3d0);
        color: #065f46;
      }
      .refund-action-btn.approve:hover {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
      }
      .refund-action-btn.deny {
        background: linear-gradient(135deg, #fee2e2, #fecaca);
        color: #991b1b;
      }
      .refund-action-btn.deny:hover {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
      }
    </style>
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:28px;">
      <div>
        <h2 class="admin-panel-title" style="font-size:1.75rem;font-weight:800;background:linear-gradient(135deg,#6366f1,#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px;">Refund Requests</h2>
        <p class="admin-panel-subtitle" style="color:#6b7280;font-size:0.95rem;">Review and process customer refund requests</p>
      </div>
      <div class="admin-filter-group" style="display:flex;gap:12px;align-items:center;">
        <select class="admin-filter" onchange="filterRefundRequests(this.value)" style="padding:10px 16px;border-radius:12px;border:2px solid #e5e7eb;background:white;font-weight:600;color:#374151;cursor:pointer;transition:all 0.2s ease;">
          <option value="">All Statuses</option>
          <option value="pending">Pending</option>
          <option value="processing">Processing</option>
          <option value="approved">Approved</option>
          <option value="denied">Denied</option>
          <option value="completed">Completed</option>
        </select>
      </div>
    </header>

    <% if (typeof refundRequests !== 'undefined' && refundRequests && refundRequests.length > 0) { %>
      <div class="admin-table-container" style="background:white;border-radius:16px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,0.08);">
        <table class="admin-table" style="width:100%;border-collapse:collapse;">
          <thead class="refund-table-header">
            <tr>
              <th>ID</th>
              <th>User</th>
              <th>Amount</th>
              <th>Reason</th>
              <th>Method</th>
              <th>Date</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% refundRequests.forEach(function(req) { %>
              <tr data-status="<%= req.status %>" style="border-bottom:1px solid #f3f4f6;transition:background 0.15s ease;">
                <td style="padding:16px 12px;"><span class="table-id" style="font-family:monospace;font-weight:700;color:#6366f1;">#<%= req.id %></span></td>
                <td style="padding:16px 12px;">
                  <div class="table-user-info">
                    <div class="table-user-name" style="font-weight:600;color:#111827;margin-bottom:2px;"><%= req.full_name %></div>
                    <div class="table-user-email" style="font-size:0.8rem;color:#6b7280;"><%= req.email %></div>
                  </div>
                </td>
                <td style="padding:16px 12px;"><span class="refund-amount">$<%= parseFloat(req.amount).toFixed(2) %></span></td>
                <td style="padding:16px 12px;">
                  <span class="refund-reason-badge"><%= req.reason.replace(/_/g, ' ') %></span>
                  <% if (req.charge_description) { %>
                    <div style="font-size:0.75rem;color:#9ca3af;margin-top:6px;"><%= req.charge_description.substring(0, 35) %>...</div>
                  <% } %>
                </td>
                <td style="padding:16px 12px;color:#4b5563;font-weight:500;text-transform:capitalize;"><%= req.preferred_method.replace(/_/g, ' ') %></td>
                <td style="padding:16px 12px;color:#6b7280;font-size:0.85rem;"><%= new Date(req.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %></td>
                <td style="padding:16px 12px;">
                  <span class="refund-status-badge <%= req.status %>"><%= req.status %></span>
                </td>
                <td style="padding:16px 12px;">
                  <div class="table-actions" style="display:flex;gap:4px;justify-content:center;">
                    <button onclick="viewRefundRequest(<%= req.id %>)" class="refund-action-btn view" title="View Details">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    </button>
                    <% if (req.status === 'pending') { %>
                      <button onclick="showRefundDecisionModal(<%= req.id %>, 'approved')" class="refund-action-btn approve" title="Approve">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                      </button>
                      <button onclick="showRefundDecisionModal(<%= req.id %>, 'denied')" class="refund-action-btn deny" title="Deny">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                      </button>
                    <% } %>
                  </div>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
    <% } else { %>
      <div class="admin-empty-state" style="text-align:center;padding:80px 20px;background:linear-gradient(135deg,#f9fafb,#f3f4f6);border-radius:20px;border:2px dashed #d1d5db;">
        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="1.5" style="margin:0 auto 20px;">
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M12 8v4l3 3M9 16h6M7 9h10"></path>
        </svg>
        <h3 style="font-size:1.4rem;font-weight:700;color:#374151;margin-bottom:8px;">No Refund Requests</h3>
        <p style="color:#6b7280;font-size:0.95rem;">No refund requests have been submitted yet.</p>
      </div>
    <% } %>

    <script>
      function filterRefundRequests(status) {
        const rows = document.querySelectorAll('[data-tab="refund-requests"] tbody tr');
        rows.forEach(row => {
          if (!status || row.getAttribute('data-status') === status) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });
      }
    </script>

    <script>
      const rbacPermissions = <%- JSON.stringify(adminPermissions || []) %>;

      let wizardStep = 1;
      let wizardTotal = 4;
      function openUserWizard() {
        wizardStep = 1;
        document.getElementById('wizardName').value = '';
        document.getElementById('wizardEmail').value = '';
        document.getElementById('wizardPassword').value = 'Admin!123';
        document.getElementById('wizardRole').value = 'user';
        document.getElementById('wizardScopes').value = '';
        document.querySelectorAll('input[name="wizardPerm"]').forEach(cb => { cb.checked = false; cb.disabled = false; });
        document.getElementById('wizardSuccess').style.display = 'none';
        document.getElementById('wizardError').style.display = 'none';
        closeRbacDrawer();
        configureAccessUI();
        updateWizardStep();
        document.getElementById('userWizardModal').style.display = 'flex';
      }
      function closeUserWizard() {
        document.getElementById('userWizardModal').style.display = 'none';
      }
      function updateWizardStep() {
        document.querySelectorAll('.wizard-step').forEach(step => {
          const s = Number(step.dataset.step);
          step.classList.toggle('active', s === wizardStep);
          step.classList.toggle('disabled', s > wizardTotal);
        });
        document.querySelectorAll('.wizard-panel').forEach(panel => {
          panel.style.display = Number(panel.dataset.step) === wizardStep ? 'block' : 'none';
        });
        document.getElementById('wizardNextBtn').textContent = wizardStep === wizardTotal ? 'Create user' : 'Next';
      }
      function nextWizardStep() {
        const role = document.getElementById('wizardRole').value;
        const isAdminRole = role !== 'user';
        if (wizardStep === 2 && !isAdminRole) {
          wizardStep = wizardTotal;
          buildWizardSummary();
          updateWizardStep();
          return;
        }
        if (wizardStep < wizardTotal) {
          wizardStep += 1;
          if (wizardStep === wizardTotal) buildWizardSummary();
          updateWizardStep();
          return;
        }
        submitWizard();
      }
      function previousWizardStep() {
        wizardStep = Math.max(1, wizardStep - 1);
        if (wizardStep === 3 && document.getElementById('wizardRole').value === 'user') {
          wizardStep = 2;
        }
        updateWizardStep();
      }
      function buildWizardSummary() {
        const summary = document.getElementById('wizardSummary');
        const perms = Array.from(document.querySelectorAll('input[name="wizardPerm"]:checked')).map(cb => cb.value);
        summary.innerHTML = '';
        const role = document.getElementById('wizardRole').value;
        ['Name: ' + document.getElementById('wizardName').value,
         'Email: ' + document.getElementById('wizardEmail').value,
         'Role: ' + role,
         'Permissions: ' + (role === 'user' ? 'not applicable for users' : (perms.join(', ') || 'default')),
         'Scopes: ' + (document.getElementById('wizardScopes').value || 'none')
        ].forEach(item => {
          const li = document.createElement('li'); li.textContent = item; summary.appendChild(li);
        });
      }
      function configureAccessUI() {
        const role = document.getElementById('wizardRole').value;
        const isAdminRole = role !== 'user';
        wizardTotal = 4;
        const permGrid = document.getElementById('wizardPermissionGrid');
        const guardrail = document.getElementById('permissionGuardrail');
        const userNotice = document.getElementById('permissionUserNotice');
        const rbacCallout = document.getElementById('rbacCallout');
        const permStep = document.querySelector('.wizard-step[data-step="3"]');
        document.querySelectorAll('input[name="wizardPerm"]').forEach(cb => {
          cb.disabled = !isAdminRole;
          if (!isAdminRole) cb.checked = false;
        });
        permGrid.classList.toggle('disabled', !isAdminRole);
        guardrail.style.display = isAdminRole ? 'block' : 'none';
        userNotice.style.display = isAdminRole ? 'none' : 'block';
        rbacCallout.style.display = isAdminRole ? 'block' : 'none';
        if (permStep) permStep.classList.toggle('disabled', !isAdminRole);
        if (!isAdminRole) {
          closeRbacDrawer();
          document.getElementById('wizardScopes').value = '';
          if (wizardStep === 3) wizardStep = 2;
        }
        updateWizardStep();
      }
      function renderRbacPermissions() {
        const list = document.getElementById('rbacPermissionList');
        if (!list) return;
        const current = new Set(Array.from(document.querySelectorAll('input[name="wizardPerm"]:checked')).map(cb => cb.value));
        list.innerHTML = '';
        rbacPermissions.forEach(p => {
          const wrapper = document.createElement('label');
          wrapper.className = 'rbac-card';
          wrapper.innerHTML = `<input type="checkbox" value="${p.key}" ${current.has(p.key) ? 'checked' : ''}>` +
            `<div><div style="font-weight:700;color:#111827;margin-bottom:4px;">${p.label}</div><div style="color:#6b7280;font-size:0.9rem;">${p.desc}</div></div>`;
          list.appendChild(wrapper);
        });
      }
      function openRbacDrawer() {
        if (document.getElementById('wizardRole').value === 'user') return;
        renderRbacPermissions();
        document.getElementById('rbacScopeInput').value = document.getElementById('wizardScopes').value;
        const drawer = document.getElementById('rbacDrawer');
        drawer.style.display = 'flex';
        drawer.classList.add('open');
      }
      function closeRbacDrawer() {
        const drawer = document.getElementById('rbacDrawer');
        drawer.classList.remove('open');
        drawer.style.display = 'none';
      }
      function applyRbacSettings() {
        if (document.getElementById('wizardRole').value === 'user') return;
        const selected = Array.from(document.querySelectorAll('#rbacPermissionList input:checked')).map(cb => cb.value);
        const wizardPerms = document.querySelectorAll('input[name="wizardPerm"]');
        wizardPerms.forEach(cb => { cb.checked = selected.includes(cb.value); });
        const scopeVal = document.getElementById('rbacScopeInput').value;
        document.getElementById('wizardScopes').value = scopeVal;
        closeRbacDrawer();
        buildWizardSummary();
      }
      async function submitWizard() {
        const errorBox = document.getElementById('wizardError');
        const successBox = document.getElementById('wizardSuccess');
        errorBox.style.display = 'none'; successBox.style.display = 'none';
        const payload = {
          fullName: document.getElementById('wizardName').value,
          email: document.getElementById('wizardEmail').value,
          password: document.getElementById('wizardPassword').value,
          role: document.getElementById('wizardRole').value,
          permissions: Array.from(document.querySelectorAll('input[name="wizardPerm"]:checked')).map(cb => cb.value),
          scopes: document.getElementById('wizardScopes').value.split(',').map(s => s.trim()).filter(Boolean)
        };
        try {
          const res = await fetch('/admin/users/wizard', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Unable to create user');
          successBox.style.display = 'block';
          document.getElementById('wizardNextBtn').textContent = 'Done';
          setTimeout(() => window.location.reload(), 900);
        } catch (e) {
          errorBox.textContent = e.message;
          errorBox.style.display = 'block';
        }
      }

      let permissionTarget = null;
      function openPermissionEditor(id, name, email, role, permissions, scopes) {
        permissionTarget = { id, permissions: permissions || [], scopes: scopes || [] };
        document.getElementById('permissionTitle').textContent = `Adjust ${name}`;
        document.getElementById('permissionSubtitle').textContent = `${email} ‚Ä¢ ${role}`;
        const container = document.getElementById('permissionCheckboxes');
        container.innerHTML = '';
        (rbacPermissions || []).forEach(opt => {
          const label = document.createElement('label');
          label.innerHTML = `<input type="checkbox" value="${opt.key}"> ${opt.label}`;
          if (permissionTarget.permissions.includes(opt.key)) label.querySelector('input').checked = true;
          container.appendChild(label);
        });
        document.getElementById('permissionScopes').value = (permissionTarget.scopes || []).join(', ');
        document.getElementById('permissionError').style.display = 'none';
        document.getElementById('permissionSuccess').style.display = 'none';
        document.getElementById('permissionModal').style.display = 'flex';
      }
      function closePermissionModal(){
        document.getElementById('permissionModal').style.display = 'none';
      }
      async function savePermissions(){
        if (!permissionTarget) return;
        const perms = Array.from(document.querySelectorAll('#permissionCheckboxes input:checked')).map(cb => cb.value);
        const scopes = document.getElementById('permissionScopes').value.split(',').map(s => s.trim()).filter(Boolean);
        const err = document.getElementById('permissionError');
        const ok = document.getElementById('permissionSuccess');
        err.style.display = 'none'; ok.style.display = 'none';
        try {
          const res = await fetch(`/admin/users/${permissionTarget.id}/permissions`, {
            method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ permissions: perms, scopes })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Unable to save');
          ok.style.display = 'block';
          setTimeout(() => window.location.reload(), 800);
        } catch (e) {
          err.textContent = e.message;
          err.style.display = 'block';
        }
      }
    </script>
  </section>

</main>

<%- include('partials/footer') %>
