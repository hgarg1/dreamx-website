<%- include('partials/header') %>



<div style="position:relative;width:100%;">
  <div style="position:relative;height:240px;background:linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);overflow:hidden;border-radius:16px;">
    <% if (user.bannerImage) { %>
      <img src="/uploads/<%= user.bannerImage %>" alt="Banner" style="width:100%;height:100%;object-fit:cover;">
    <% } %>
  </div>
  <div style="position:absolute;bottom:-80px;left:50%;transform:translateX(-50%);z-index:100;">
    <div style="position:relative;display:inline-block;">
      <% if (profilePicture) { %>
        <img id="profileAvatar" src="/uploads/<%= profilePicture %>" alt="<%= user.displayName %>" <%= typeof isOwnProfile !== 'undefined' && isOwnProfile ? 'data-is-own="true"' : '' %> style="object-fit:cover;border-radius:50%;width:160px;height:160px;border:6px solid white;box-shadow:0 8px 24px rgba(0,0,0,0.2);cursor:pointer;" <%= typeof isOwnProfile === 'undefined' || !isOwnProfile ? `ondblclick="window.location.href='/profile/${profileUserId}'"` : '' %>>
      <% } else { %>
        <div id="profileAvatar" <%= typeof isOwnProfile !== 'undefined' && isOwnProfile ? 'data-is-own="true"' : '' %> style="width:160px;height:160px;border-radius:50%;background:#8b5cf6;color:white;display:flex;align-items:center;justify-content:center;font-size:4rem;font-weight:700;border:6px solid white;box-shadow:0 8px 24px rgba(0,0,0,0.2);cursor:pointer;" <%= typeof isOwnProfile === 'undefined' || !isOwnProfile ? `ondblclick="window.location.href='/profile/${profileUserId}'"` : '' %>><%= user.displayName.charAt(0) %></div>
      <% } %>
    </div>
  </div>
</div>

<section class="profile-header-section" style="margin-top:120px;text-align:center;padding:0 20px;">
  <div style="margin-bottom:20px;">
    <h1 style="font-size:2.5rem;font-weight:800;margin:0 0 8px 0;color:#1f2937;"><%= user.displayName %></h1>
    <span style="color:#6b7280;font-size:1.1rem;font-weight:500;">@<%= user.handle %></span>
  </div>
  <div class="profile-tags">
    <% user.passions.forEach(function(p){ %>
      <span class="passion-tag"><%= p %></span>
    <% }); %>
  </div>
  <p class="profile-bio"><%= user.bio %></p>
  <div class="profile-stats">
    <div class="stat"><span class="stat-number"><%= user.stats.posts %></span><span class="stat-label">Posts</span></div>
    <div class="stat"><span class="stat-number"><%= user.stats.followers %></span><span class="stat-label">Followers</span></div>
    <div class="stat"><span class="stat-number"><%= user.stats.following %></span><span class="stat-label">Following</span></div>
    <div class="stat"><span class="stat-number"><%= user.isSeller ? user.stats.sessions : '‚Äî' %></span><span class="stat-label">Sessions Offered</span></div>
  </div>
  <div style="display:flex;gap:12px;justify-content:center;margin-top:20px;">
    <% if (typeof isOwnProfile !== 'undefined' && isOwnProfile) { %>
      <a href="/profile/edit" style="padding:10px 24px;background:#ec4899;color:white;border-radius:8px;text-decoration:none;font-weight:600;font-size:0.95rem;">Edit Profile</a>
      <a href="/messages" style="padding:10px 24px;background:#8b5cf6;color:white;border-radius:8px;text-decoration:none;font-weight:600;font-size:0.95rem;">Messages</a>
    <% } else { %>
      <button id="followBtn" data-user-id="<%= profileUserId %>" data-following="<%= typeof isFollowing !== 'undefined' && isFollowing ? 'true' : 'false' %>" style="padding:10px 24px;background:<%= typeof isFollowing !== 'undefined' && isFollowing ? '#6b7280' : '#ec4899' %>;color:white;border:none;border-radius:8px;font-weight:600;font-size:0.95rem;cursor:pointer;transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
        <%= typeof isFollowing !== 'undefined' && isFollowing ? 'Following' : 'Follow' %>
      </button>
      <a href="/messages/start/<%= profileUserId %>" style="padding:10px 24px;background:#8b5cf6;color:white;border-radius:8px;text-decoration:none;font-weight:600;font-size:0.95rem;">Message</a>
      
      <!-- User Actions Menu (Block/Report) -->
      <div style="position:relative;display:inline-block;">
        <button onclick="toggleUserActionsMenu()" style="padding:10px 16px;background:#f3f4f6;color:#374151;border:none;border-radius:8px;font-weight:600;font-size:1.2rem;cursor:pointer;transition:all 0.3s ease;">‚ãÆ</button>
        <div id="userActionsMenu" style="display:none;position:absolute;right:0;top:100%;margin-top:8px;background:white;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.15);z-index:100;min-width:180px;">
          <button onclick="openBlockModal()" style="width:100%;text-align:left;padding:12px 16px;border:none;background:none;cursor:pointer;font-size:0.9rem;color:#374151;transition:background 0.2s;" onmouseover="this.style.background='#fee2e2';this.style.color='#991b1b'" onmouseout="this.style.background='none';this.style.color='#374151'">üö´ Block User</button>
          <button onclick="openReportModal()" style="width:100%;text-align:left;padding:12px 16px;border:none;background:none;cursor:pointer;font-size:0.9rem;color:#374151;border-top:1px solid #e5e7eb;transition:background 0.2s;" onmouseover="this.style.background='#fef3c7';this.style.color='#92400e'" onmouseout="this.style.background='none';this.style.color='#374151'">‚ö†Ô∏è Report User</button>
        </div>
      </div>
    <% } %>
    
    <% if (typeof isSuperAdmin !== 'undefined' && isSuperAdmin && typeof isOwnProfile !== 'undefined' && !isOwnProfile) { %>
      <div style="position:relative;display:inline-block;" data-profile-user-id="<%= profileUserId %>" data-profile-user-name="<%= user.displayName || '' %>">
        <button id="adminActionsBtn" style="padding:10px 16px;background:#f3f4f6;color:#374151;border:none;border-radius:8px;font-weight:600;font-size:1.2rem;cursor:pointer;transition:all 0.3s ease;" onclick="document.getElementById('adminActionsMenu').style.display = document.getElementById('adminActionsMenu').style.display === 'block' ? 'none' : 'block'">‚ãÆ</button>
        <div id="adminActionsMenu" style="display:none;position:absolute;right:0;top:100%;margin-top:8px;background:white;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.15);z-index:100;min-width:200px;">
          <button onclick="openBanModalProfile()" style="width:100%;text-align:left;padding:12px 16px;border:none;background:none;cursor:pointer;font-size:0.9rem;color:#374151;transition:background 0.2s;" onmouseover="this.style.background='#fee2e2';this.style.color='#991b1b'" onmouseout="this.style.background='none';this.style.color='#374151'">üö´ Ban User</button>
          <button onclick="openSuspendModalProfile()" style="width:100%;text-align:left;padding:12px 16px;border:none;background:none;cursor:pointer;font-size:0.9rem;color:#374151;border-top:1px solid #e5e7eb;transition:background 0.2s;" onmouseover="this.style.background='#fef3c7';this.style.color='#92400e'" onmouseout="this.style.background='none';this.style.color='#374151'">‚è∏Ô∏è Suspend User</button>
          <a href="/admin/users/<%= profileUserId %>/stats" style="display:block;width:100%;text-align:left;padding:12px 16px;text-decoration:none;color:#374151;font-size:0.9rem;border-top:1px solid #e5e7eb;transition:background 0.2s;" onmouseover="this.style.background='#dbeafe'" onmouseout="this.style.background='none'">üìä View Stats</a>
        </div>
      </div>
    <% } %>
  </div>
  
  <script>
    // Follow/unfollow functionality
    const followBtn = document.getElementById('followBtn');
    if (followBtn) {
      followBtn.addEventListener('click', async function() {
        const userId = this.getAttribute('data-user-id');
        const isFollowing = this.getAttribute('data-following') === 'true';
        const endpoint = isFollowing ? `/api/users/${userId}/unfollow` : `/api/users/${userId}/follow`;
        
        try {
          const res = await fetch(endpoint, { method: 'POST' });
          const data = await res.json();
          
          if (data.success) {
            if (data.following) {
              this.textContent = 'Following';
              this.style.setProperty('background', '#6b7280', 'important');
              this.style.setProperty('background-color', '#6b7280', 'important');
              this.setAttribute('data-following', 'true');
              
              // Update follower count
              const followerStat = document.querySelector('.stat:nth-child(2) .stat-number');
              if (followerStat) followerStat.textContent = parseInt(followerStat.textContent) + 1;
            } else {
              this.textContent = 'Follow';
              this.style.setProperty('background', '#ec4899', 'important');
              this.style.setProperty('background-color', '#ec4899', 'important');
              this.setAttribute('data-following', 'false');
              
              // Update follower count
              const followerStat = document.querySelector('.stat:nth-child(2) .stat-number');
              if (followerStat) followerStat.textContent = Math.max(0, parseInt(followerStat.textContent) - 1);
            }
          }
        } catch (error) {
          console.error('Follow/unfollow error:', error);
          alert('Failed to update follow status');
        }
      });
    }
    
    // Admin actions
    function openBanModalProfile() {
      const container = document.querySelector('[data-profile-user-id]');
      const userId = container.getAttribute('data-profile-user-id');
      const userName = container.getAttribute('data-profile-user-name');
      document.getElementById('profileBanUserId').value = userId;
      document.getElementById('profileBanUserName').textContent = userName;
      document.getElementById('profileBanReason').value = '';
      document.getElementById('profileBanModal').style.display = 'flex';
    }
    
    function openBanModal(userId, userName) {
      document.getElementById('profileBanUserId').value = userId;
      document.getElementById('profileBanUserName').textContent = userName;
      document.getElementById('profileBanReason').value = '';
      document.getElementById('profileBanModal').style.display = 'flex';
    }
    
    function closeBanModal() {
      document.getElementById('profileBanModal').style.display = 'none';
    }
    
    function confirmProfileBan() {
      const userId = document.getElementById('profileBanUserId').value;
      const reason = document.getElementById('profileBanReason').value.trim();
      
      if (!reason) {
        alert('Please provide a ban reason.');
        return;
      }
      
      fetch(`/admin/users/${userId}/ban`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert('User has been banned.');
          window.location.href = '/admin';
        } else {
          alert('Error: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(err => {
        console.error('Ban error:', err);
        alert('Failed to ban user. Please try again.');
      });
    }
    
    function openSuspendModalProfile() {
      const container = document.querySelector('[data-profile-user-id]');
      const userId = container.getAttribute('data-profile-user-id');
      const userName = container.getAttribute('data-profile-user-name');
      document.getElementById('profileSuspendUserId').value = userId;
      document.getElementById('profileSuspendUserName').textContent = userName;
      document.getElementById('profileSuspendDays').value = '7';
      document.getElementById('profileSuspendReason').value = '';
      document.getElementById('profileSuspendModal').style.display = 'flex';
    }
    
    function openSuspendModal(userId, userName) {
      document.getElementById('profileSuspendUserId').value = userId;
      document.getElementById('profileSuspendUserName').textContent = userName;
      document.getElementById('profileSuspendDays').value = '7';
      document.getElementById('profileSuspendReason').value = '';
      document.getElementById('profileSuspendModal').style.display = 'flex';
    }
    
    function closeSuspendModal() {
      document.getElementById('profileSuspendModal').style.display = 'none';
    }
    
    function confirmProfileSuspend() {
      const userId = document.getElementById('profileSuspendUserId').value;
      const days = parseInt(document.getElementById('profileSuspendDays').value);
      const reason = document.getElementById('profileSuspendReason').value.trim();
      
      if (!days || days < 1) {
        alert('Please provide a valid suspension duration.');
        return;
      }
      
      if (!reason) {
        alert('Please provide a suspension reason.');
        return;
      }
      
      fetch(`/admin/users/${userId}/suspend`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ days, reason })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert(`User has been suspended for ${days} days.`);
          window.location.href = '/admin';
        } else {
          alert('Error: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(err => {
        console.error('Suspend error:', err);
        alert('Failed to suspend user. Please try again.');
      });
    }

    function banUser(userId) {
      const reason = prompt('Enter ban reason:');
      if (!reason) return;
      
      if (confirm('Are you sure you want to permanently ban this user?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/users/${userId}/ban`;
        
        const reasonInput = document.createElement('input');
        reasonInput.type = 'hidden';
        reasonInput.name = 'reason';
        reasonInput.value = reason;
        form.appendChild(reasonInput);
        
        document.body.appendChild(form);
        form.submit();
      }
    }
    
    function suspendUser(userId) {
      const duration = prompt('Enter suspension duration (e.g., 1d, 7d, 30d, 1h):');
      if (!duration) return;
      
      const reason = prompt('Enter suspension reason:');
      if (!reason) return;
      
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/admin/users/${userId}/suspend`;
      
      const durationInput = document.createElement('input');
      durationInput.type = 'hidden';
      durationInput.name = 'duration';
      durationInput.value = duration;
      form.appendChild(durationInput);
      
      const reasonInput = document.createElement('input');
      reasonInput.type = 'hidden';
      reasonInput.name = 'reason';
      reasonInput.value = reason;
      form.appendChild(reasonInput);
      
      document.body.appendChild(form);
      form.submit();
    }
    
    // Close admin menu when clicking outside
    document.addEventListener('click', function(e) {
      const menu = document.getElementById('adminActionsMenu');
      const btn = document.getElementById('adminActionsBtn');
      if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
        menu.style.display = 'none';
      }
    });

    // Service creation eligibility check
    async function checkEligibilityAndCreate() {
      try {
        const response = await fetch('/api/services/check-eligibility');
        const data = await response.json();
        
        if (data.canCreate) {
          window.location.href = '/services/new';
        } else {
          showUpgradeModal(data);
        }
      } catch (error) {
        console.error('Error checking eligibility:', error);
        alert('Failed to check eligibility. Please try again.');
      }
    }

    function showUpgradeModal(data) {
      const modal = document.getElementById('upgradeModal');
      const tierName = document.getElementById('upgradeTierName');
      const tierLimits = document.getElementById('upgradeTierLimits');
      
      const tierNames = {
        'free': 'Free User',
        'pro-buyer': 'Pro Buyer',
        'pro-seller': 'Pro Seller',
        'elite-seller': 'Elite Seller',
        'enterprise': 'Enterprise'
      };
      const tierLabel = tierNames[data.tier] || (data.tier || 'Free User');

      // Determine recommended next tier
      const nextTierMap = {
        'free': 'pro-seller',
        'pro-buyer': 'pro-seller',
        'pro-seller': 'elite-seller',
        'elite-seller': 'enterprise',
        'enterprise': 'enterprise'
      };
      const nextTier = nextTierMap[data.tier] || 'pro-seller';
      const nextTierLabel = tierNames[nextTier] || 'Pro Seller';

      // Benefits per target tier
      const benefitsByTier = {
        'pro-seller': [
          'Create up to 5 service listings',
          'Pro badge + priority in discovery',
          'Weekly insights & analytics',
          'Payment tools & basic CRM'
        ],
        'elite-seller': [
          'Unlimited service listings',
          'Top placement in discovery',
          'Advanced analytics & insights',
          'Priority support',
          'Pro CRM workflows'
        ],
        'enterprise': [
          'Unlimited listings with SLA',
          'Organization workspaces & SSO',
          'Admin controls & roles',
          'Dedicated support & onboarding'
        ]
      };
      const b = benefitsByTier[nextTier] || benefitsByTier['pro-seller'];
      
      tierName.textContent = tierLabel;
      tierLimits.innerHTML = `
        <p style="margin-bottom:16px;">You're currently on the <strong>${tierLabel}</strong> plan.</p>
        <p style="margin-bottom:16px;">Service listings: <strong>${(data.currentCount ?? 0)} / ${(data.maxServices ?? 0)}</strong></p>
        <p style="margin-bottom:20px;">To create more services, upgrade to <strong>${nextTierLabel}</strong>.</p>
        <div style="background:#f9fafb;padding:20px;border-radius:12px;margin-bottom:20px;">
          <h4 style="margin:0 0 12px 0;font-size:1.1rem;font-weight:700;">${nextTierLabel} Benefits:</h4>
          <ul style="margin:0;padding-left:20px;">
            ${b.map(item => `<li style=\"margin-bottom:8px;\">${item}</li>`).join('')}
          </ul>
        </div>
      `;
      
      modal.style.display = 'flex';

      // Update CTA to point to the right tier
      const ctaBtn = document.querySelector('#upgradeModal .admin-modal-footer .admin-modal-btn:not(.secondary)');
      if (ctaBtn) {
        ctaBtn.textContent = `Upgrade to ${nextTierLabel}`;
        ctaBtn.onclick = function() { goToBilling(nextTier); };
      }
    }

    function closeUpgradeModal() {
      document.getElementById('upgradeModal').style.display = 'none';
    }

    function goToBilling(targetTier) {
      const t = targetTier || 'pro-seller';
      window.location.href = '/pricing?highlight=' + encodeURIComponent(t);
    }
  </script>
</section>

<div class="profile-tabs-wrapper">
  <nav class="profile-tabs" aria-label="Profile sections">
    <button class="tab-btn <%= (Array.isArray(userPosts) && userPosts.length > 0) ? '' : 'active' %>" data-tab="overview">Overview</button>
    <button class="tab-btn <%= (Array.isArray(userPosts) && userPosts.length > 0) ? 'active' : '' %>" data-tab="posts">Posts
      <span class="tab-badge" style="margin-left:6px;background:#e5e7eb;color:#374151;padding:2px 8px;border-radius:999px;font-size:.8rem;font-weight:700;">
        <%= (Array.isArray(userPosts) ? userPosts.length : 0) %>
      </span>
    </button>
    <button class="tab-btn" data-tab="reels" id="reelsTabBtn">
      <span style="display:flex;align-items:center;gap:6px;">
        Reels
        <span class="tab-badge reels-count-badge" style="background:#e5e7eb;color:#374151;padding:2px 8px;border-radius:999px;font-size:.8rem;font-weight:700;">0</span>
      </span>
    </button>
    <button class="tab-btn" data-tab="projects">Projects</button>
    <button class="tab-btn" data-tab="services">Services
      <span class="tab-badge" style="margin-left:6px;background:#e5e7eb;color:#374151;padding:2px 8px;border-radius:999px;font-size:.8rem;font-weight:700;">
        <%= (Array.isArray(services) ? services.length : 0) %>
      </span>
    </button>
  </nav>

  <div class="tab-panels">
    <!-- Overview Panel -->
    <div class="tab-panel <%= (Array.isArray(userPosts) && userPosts.length > 0) ? '' : 'active' %>" id="overview">
      <div class="card card-spacious">
        <h2 class="panel-title">About</h2>
        <p class="panel-text"><%= user.bio || 'No bio added yet.' %></p>
        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;color:#6b7280;font-size:0.9rem;">
          <% if (user.onboarding && user.onboarding.daily_time_commitment) { %>
            <span style="background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;">‚è± <%= user.onboarding.daily_time_commitment %>/day</span>
          <% } %>
          <% if (user.onboarding && user.onboarding.best_time) { %>
            <span style="background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;">üïí Best time: <%= user.onboarding.best_time %></span>
          <% } %>
          <% if (user.onboarding && user.onboarding.content_format_preference) { %>
            <span style="background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;">üéØ Prefers: <%= user.onboarding.content_format_preference %></span>
          <% } %>
          <% if (user.onboarding && Array.isArray(user.onboarding.content_preferences) && user.onboarding.content_preferences.length) { %>
            <span style="background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;">‚ú® Interests: <%= user.onboarding.content_preferences.join(', ') %></span>
          <% } %>
          <% if (user.onboarding && user.onboarding.open_to_mentoring) { %>
            <span style="background:#ecfeff;border:1px solid #a5f3fc;border-radius:999px;padding:6px 10px;color:#155e75;">ü§ù Open to mentoring</span>
          <% } %>
        </div>
      </div>

      <% if (user.onboarding && user.onboarding.first_goal && (isOwnProfile || user.onboarding.first_goal_public)) { %>
        <div class="card">
          <h2 class="panel-title">Current Goal</h2>
          <div style="display:flex;flex-direction:column;gap:6px;">
            <div style="font-weight:700;color:#374151;"><%= user.onboarding.first_goal %></div>
            <% if (user.onboarding.first_goal_metric) { %>
              <div style="color:#6b7280;">Metric: <%= user.onboarding.first_goal_metric %></div>
            <% } %>
            <% if (user.onboarding.first_goal_date) { %>
              <div style="color:#6b7280;">Target by <%= new Date(user.onboarding.first_goal_date).toLocaleDateString() %></div>
            <% } %>
          </div>
        </div>
      <% } %>
      <div class="card">
        <h2 class="panel-title">Skills & Passions</h2>
        <ul class="skills-list">
          <% user.skills.forEach(function(s){ %>
            <li class="skill-item"><%= s %></li>
          <% }); %>
        </ul>
      </div>
    </div>

    <!-- Posts Panel -->
    <div class="tab-panel <%= (Array.isArray(userPosts) && userPosts.length > 0) ? 'active' : '' %>" id="posts">
      <%- include('partials/post-helpers') %>
      <section class="posts-stream" style="max-width:900px;margin:0 auto;">
        <% if (Array.isArray(userPosts) && userPosts.length > 0) { %>
          <% userPosts.forEach(function(post){ %>
            <%- include('partials/post-card', { post }) %>
          <% }); %>
        <% } else { %>
          <div style="background:white;border-radius:16px;padding:48px;text-align:center;color:#6b7280;">
            <p style="font-size:1.125rem;margin:0 0 8px 0;">No posts yet</p>
            <p style="margin:0;">When you post, they'll show up here.</p>
          </div>
        <% } %>
      </section>
    </div>

    <!-- Reels Panel -->
    <div class="tab-panel" id="reels">
      <section class="reels-grid-container" style="max-width:1200px;margin:0 auto;">
        <div id="reelsGridContent" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;">
          <!-- Reels will be loaded here dynamically -->
        </div>
        <div id="reelsEmptyState" style="background:white;border-radius:16px;padding:48px;text-align:center;color:#6b7280;display:none;">
          <p style="font-size:1.125rem;margin:0 0 8px 0;">No reels yet</p>
          <p style="margin:0;">When <%= isOwnProfile ? 'you post reels, they\'ll' : 'this user posts reels, they\'ll' %> show up here.</p>
        </div>
      </section>
    </div>

    <!-- Projects Panel -->
    <div class="tab-panel" id="projects">
      <div class="projects-grid">
        <% projects.forEach(function(pr){ %>
          <div class="project-card">
            <div class="project-card-header">
              <h3 class="project-title"><%= pr.title %></h3>
              <span class="project-tag"><%= pr.tag %></span>
            </div>
            <p class="project-desc"><%= pr.desc %></p>
            <a href="#" class="project-link">View project ‚Üí</a>
          </div>
        <% }); %>
      </div>
    </div>

    <!-- Services Panel -->
    <div class="tab-panel" id="services">
      <% if (typeof isOwnProfile !== 'undefined' && isOwnProfile) { %>
        <div style="margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;">
          <h2 style="margin:0;font-size:1.5rem;font-weight:700;">My Services</h2>
          <button onclick="checkEligibilityAndCreate()" style="padding:10px 20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">+ Create Service</button>
        </div>
      <% } %>
      
      <% if (services && services.length > 0) { %>
        <div class="services-grid">
          <% services.forEach(function(sv){ %>
            <div class="service-card">
              <div class="service-header">
                <h3 class="service-title"><%= sv.title %></h3>
                <span class="service-category"><%= sv.category %></span>
              </div>
              <p class="service-desc"><%= sv.description.substring(0, 150) %><%= sv.description.length > 150 ? '...' : '' %></p>
              <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;">
                <span style="font-size:1.25rem;font-weight:700;color:#764ba2;">$<%= (sv.price_per_hour * (sv.duration_minutes / 60)).toFixed(2) %></span>
                <span style="font-size:0.9rem;color:#6b7280;"><%= sv.duration_minutes %> min</span>
              </div>
              <a href="/services/<%= sv.id %>" class="service-btn">View details</a>
            </div>
          <% }); %>
        </div>
      <% } else { %>
        <div style="background:white;border-radius:16px;padding:48px;text-align:center;color:#6b7280;">
          <p style="font-size:1.125rem;margin:0 0 8px 0;">No services yet</p>
          <% if (typeof isOwnProfile !== 'undefined' && isOwnProfile) { %>
            <p style="margin:0 0 20px 0;">Start sharing your expertise with the community</p>
            <button onclick="checkEligibilityAndCreate()" style="padding:12px 28px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:10px;font-weight:600;cursor:pointer;transition:all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">Create Your First Service</button>
          <% } else { %>
            <p style="margin:0;">This user hasn't created any services yet.</p>
          <% } %>
        </div>
      <% } %>
    </div>
  </div>
</div>

<script>
  // Reels: click to open reels if present; long-press enlarges profile picture
  (function(){
    const avatar = document.getElementById('profileAvatar');
    if (!avatar) return;
    let pressTimer = null;
    let hasReels = false;
    let reelsData = [];
    let currentReelIndex = 0;
    const tzOffset = new Date().getTimezoneOffset();
    
    // Update profile counts live
    async function updateProfileCounts() {
      try {
        const res = await fetch(`/api/users/<%= profileUserId %>/profile-counts`);
        const data = await res.json();
        if (data.success) {
          // Update posts count
          const postsCountBadge = document.querySelector('[data-tab="posts"] .tab-badge');
          if (postsCountBadge) {
            postsCountBadge.textContent = data.posts;
          }
          // Update services count
          const servicesCountBadge = document.querySelector('[data-tab="services"] .tab-badge');
          if (servicesCountBadge) {
            servicesCountBadge.textContent = data.services;
          }
        }
      } catch (e) {
        console.error('Failed to update profile counts:', e);
      }
    }
    
    // Call on page load and set up periodic updates
    updateProfileCounts();
    setInterval(updateProfileCounts, 30000); // Update every 30 seconds
    
    async function checkReels(){
      try {
        const res = await fetch(`/api/users/<%= profileUserId %>/reels/count?tzOffset=${tzOffset}`);
        const data = await res.json();
        hasReels = (data.count || 0) > 0;
        // Add visual indicator if reels exist
        if (hasReels) {
          avatar.style.border = '6px solid #ec4899';
          avatar.style.cursor = 'pointer';
          const badge = document.createElement('div');
          badge.id = 'reelsBadge';
          badge.style.cssText = 'position:absolute;bottom:10px;right:10px;width:32px;height:32px;background:linear-gradient(135deg,#ec4899,#8b5cf6);border-radius:50%;border:3px solid white;display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 4px 12px rgba(0,0,0,0.3);pointer-events:none;';
          badge.innerHTML = 'üé¨';
          avatar.parentElement.appendChild(badge);
        }
      } catch(e) { hasReels = false; }
    }
    
    async function loadReels(){
      try {
        const res = await fetch(`/api/users/<%= profileUserId %>/reels?tzOffset=${tzOffset}`);
        const data = await res.json();
        reelsData = data.reels || [];
        const c = document.getElementById('reelsContainer');
        if (!c) return;
        if (!reelsData.length) { c.innerHTML = '<div style="color:#aaa">No active reels</div>'; return; }
        currentReelIndex = 0;
        renderReel();
      } catch(e) {
        const c = document.getElementById('reelsContainer');
        if (c) c.innerHTML = 'Failed to load reels';
      }
    }
    
    function renderReel(){
      const c = document.getElementById('reelsContainer');
      if (!c || !reelsData.length) return;
      const r = reelsData[currentReelIndex];
      const isGif = (r.media_url || '').toLowerCase().endsWith('.gif');
      const mediaHtml = r.media_url
        ? (isGif
            ? `<img id="reelImage" src="${r.media_url}" alt="Reel" style="max-width:100%;max-height:100%;cursor:pointer;"/>`
            : `<video id="reelVideo" src="${r.media_url}" playsinline autoplay loop muted style="max-width:100%;max-height:100%;cursor:pointer;"></video>`)
        : '';
      const prevBtn = currentReelIndex > 0 ? `<button onclick="window.prevReel()" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.2);color:#fff;border:none;border-radius:50%;width:48px;height:48px;cursor:pointer;font-size:24px;display:flex;align-items:center;justify-content:center;z-index:10;">‚Äπ</button>` : '';
      const nextBtn = currentReelIndex < reelsData.length - 1 ? `<button onclick="window.nextReel()" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.2);color:#fff;border:none;border-radius:50%;width:48px;height:48px;cursor:pointer;font-size:24px;display:flex;align-items:center;justify-content:center;z-index:10;">‚Ä∫</button>` : '';
      c.innerHTML = `
        <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#000;position:relative;">
          ${mediaHtml}
          ${prevBtn}
          ${nextBtn}
          <div style="position:absolute;bottom:20px;left:20px;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,0.5);pointer-events:none;">
            <div style="font-weight:700;font-size:16px;">${r.full_name || 'User'}</div>
            ${r.text_content ? `<div style="font-size:14px;margin-top:4px;">${r.text_content}</div>` : ''}
          </div>
          <div style="position:absolute;top:50px;right:10px;color:#fff;font-size:12px;background:rgba(0,0,0,0.5);padding:4px 8px;border-radius:12px;pointer-events:none;">${currentReelIndex + 1} / ${reelsData.length}</div>
          <div id="pauseIndicator" style="display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:80px;height:80px;background:rgba(0,0,0,0.7);border-radius:50%;align-items:center;justify-content:center;font-size:40px;color:#fff;pointer-events:none;">‚è∏</div>
        </div>
      `;
      
      // Add hold-to-pause functionality
      const video = document.getElementById('reelVideo');
      const pauseIndicator = document.getElementById('pauseIndicator');
      if (video) {
        let isHolding = false;
        
        const startHold = (e) => {
          e.preventDefault();
          isHolding = true;
          video.pause();
          if (pauseIndicator) pauseIndicator.style.display = 'flex';
        };
        
        const endHold = (e) => {
          if (isHolding) {
            e.preventDefault();
            isHolding = false;
            video.play();
            if (pauseIndicator) pauseIndicator.style.display = 'none';
          }
        };
        
        // Mouse events
        video.addEventListener('mousedown', startHold);
        video.addEventListener('mouseup', endHold);
        video.addEventListener('mouseleave', endHold);
        
        // Touch events
        video.addEventListener('touchstart', startHold, { passive: false });
        video.addEventListener('touchend', endHold, { passive: false });
        video.addEventListener('touchcancel', endHold);
        
        // Unmute on first tap/click
        video.addEventListener('click', () => {
          if (video.muted) video.muted = false;
        }, { once: true });
      }
    }
    
    window.nextReel = function(){
      if (currentReelIndex < reelsData.length - 1) {
        currentReelIndex++;
        renderReel();
      }
    };
    
    window.prevReel = function(){
      if (currentReelIndex > 0) {
        currentReelIndex--;
        renderReel();
      }
    };
    
    function openReels(e){ 
      if (!hasReels) return; 
      if (e) e.preventDefault();
      const overlay = document.getElementById('reelsOverlay');
      if (!overlay) return;
      overlay.style.display = 'flex';
      loadReels(); 
    }
    
    function openAvatar(){
      const overlay = document.getElementById('avatarOverlay');
      if (!overlay) return;
      overlay.style.display = 'flex';
      const img = document.getElementById('avatarOverlayImg');
      if (img && avatar.tagName === 'IMG') img.src = avatar.src;
    }
    
    checkReels();
    
    let longPressTriggered = false;
    
    avatar.addEventListener('mousedown', (e) => { 
      longPressTriggered = false;
      pressTimer = setTimeout(() => {
        longPressTriggered = true;
        openAvatar();
      }, 500); 
    });
    
    avatar.addEventListener('mouseup', (e) => { 
      clearTimeout(pressTimer);
    });
    
    avatar.addEventListener('mouseleave', () => { 
      clearTimeout(pressTimer); 
    });
    
    avatar.addEventListener('click', (e) => { 
      if (longPressTriggered) {
        longPressTriggered = false;
        return;
      }
      if (hasReels) {
        e.preventDefault();
        e.stopPropagation();
        openReels(e);
      }
    });
  })();
</script>

<%- include('partials/reels-overlay') %>

<script>
  // Simple tab switch logic
  document.addEventListener('DOMContentLoaded', function(){
    const tabButtons = document.querySelectorAll('.tab-btn');
    const panels = document.querySelectorAll('.tab-panel');
    
    // Load reels when reels tab is clicked
    let reelsLoaded = false;
    const profileUserId = <%= profileUserId %>;
    
    async function loadProfileReels() {
      if (reelsLoaded) return;
      
      try {
        const res = await fetch(`/api/users/${profileUserId}/reels`);
        const data = await res.json();
        
        const reelsGrid = document.getElementById('reelsGridContent');
        const emptyState = document.getElementById('reelsEmptyState');
        const countBadge = document.querySelector('.reels-count-badge');
        
        if (data.reels && data.reels.length > 0) {
          countBadge.textContent = data.reels.length;
          reelsGrid.innerHTML = data.reels.map(reel => `
            <div class="reel-card" onclick="openReelFromGrid('${reel.media_url}')" style="position:relative;border-radius:12px;overflow:hidden;cursor:pointer;aspect-ratio:9/16;background:#000;">
              ${String(reel.media_url || '').toLowerCase().endsWith('.gif')
                ? `<img src="${reel.media_url}" alt="Reel" style="width:100%;height:100%;object-fit:cover;"/>`
                : `<video src="${reel.media_url}" muted playsinline style="width:100%;height:100%;object-fit:cover;"></video>`}
              <div class="reel-overlay" style="position:absolute;inset:0;background:linear-gradient(to bottom,transparent 50%,rgba(0,0,0,0.7));display:flex;flex-direction:column;justify-content:flex-end;padding:16px;">
                <div style="color:#fff;font-size:0.9rem;font-weight:600;margin-bottom:4px;">${reel.text_content || ''}</div>
                <div style="color:rgba(255,255,255,0.8);font-size:0.85rem;">${new Date(reel.created_at).toLocaleDateString()}</div>
              </div>
            </div>
          `).join('');
          emptyState.style.display = 'none';
        } else {
          countBadge.textContent = '0';
          reelsGrid.innerHTML = '';
          emptyState.style.display = 'block';
        }
        
        reelsLoaded = true;
      } catch (err) {
        console.error('Error loading reels:', err);
      }
    }
    
    window.openReelFromGrid = function(mediaUrl) {
      const overlay = document.getElementById('reelsOverlay');
      if (!overlay) return;
      
      const container = document.getElementById('reelsContainer');
      const isGif = String(mediaUrl || '').toLowerCase().endsWith('.gif');
      container.innerHTML = `
        <div style="position:relative;width:100%;max-width:500px;height:90vh;background:#000;border-radius:12px;overflow:hidden;">
          ${isGif
            ? `<img id="gridReelImage" src="${mediaUrl}" alt="Reel" style="width:100%;height:100%;object-fit:contain;"/>`
            : `<video id="gridReelVideo" src="${mediaUrl}" playsinline muted autoplay loop style="width:100%;height:100%;object-fit:contain;"></video>`}
          <div id="pauseIndicator" style="display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:4rem;color:white;text-shadow:0 4px 12px rgba(0,0,0,0.5);pointer-events:none;user-select:none;">‚è∏</div>
        </div>
      `;
      
      overlay.style.display = 'flex';
      
      const video = document.getElementById('gridReelVideo');
      const pauseIndicator = document.getElementById('pauseIndicator');
      
      // Hold-to-pause functionality
      function handlePause(e) {
        e.preventDefault();
        if (video && video.paused) {
          video.play();
          pauseIndicator.style.display = 'none';
        } else {
          if (video) {
            video.pause();
            pauseIndicator.style.display = 'block';
            setTimeout(() => { pauseIndicator.style.display = 'none'; }, 600);
          }
        }
      }
      
      if (video) {
        video.addEventListener('mousedown', handlePause);
        video.addEventListener('touchstart', handlePause);
      }
      
      // Unmute on first click
      if (video) {
        video.addEventListener('click', function unmute() {
          if (video.muted) video.muted = false;
        }, { once: true });
      }
    };
    
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        tabButtons.forEach(b => b.classList.remove('active'));
        panels.forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        const target = btn.getAttribute('data-tab');
        document.getElementById(target).classList.add('active');
        
        // Load reels when reels tab is opened
        if (target === 'reels') {
          loadProfileReels();
        }
      });
    });
  });
</script>

<!-- Ban User Modal -->
<div id="profileBanModal" class="admin-modal" style="display:none;">
  <div class="admin-modal-content">
    <div class="admin-modal-header">
      <h3>Ban User</h3>
      <button class="admin-modal-close" onclick="closeBanModal()">&times;</button>
    </div>
    <div class="admin-modal-body">
      <input type="hidden" id="profileBanUserId">
      <p style="margin-bottom:20px;color:#6b7280;">Permanently ban <strong id="profileBanUserName"></strong> from the platform.</p>
      <div style="margin-bottom:16px;">
        <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;">Ban Reason <span style="color:#ef4444;">*</span></label>
        <textarea id="profileBanReason" rows="4" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-family:inherit;" placeholder="Describe the reason for this permanent ban..."></textarea>
      </div>
      <div style="padding:16px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;margin-bottom:16px;">
        <p style="margin:0;color:#991b1b;font-size:0.9rem;"><strong>‚ö†Ô∏è Warning:</strong> This action is severe and permanent. The user will lose all access to the platform.</p>
      </div>
    </div>
    <div class="admin-modal-footer">
      <button class="admin-modal-btn secondary" onclick="closeBanModal()">Cancel</button>
      <button class="admin-modal-btn danger" onclick="confirmProfileBan()">Ban User</button>
    </div>
  </div>
</div>

<!-- Suspend User Modal -->
<div id="profileSuspendModal" class="admin-modal" style="display:none;">
  <div class="admin-modal-content">
    <div class="admin-modal-header">
      <h3>Suspend User</h3>
      <button class="admin-modal-close" onclick="closeSuspendModal()">&times;</button>
    </div>
    <div class="admin-modal-body">
      <input type="hidden" id="profileSuspendUserId">
      <p style="margin-bottom:20px;color:#6b7280;">Temporarily suspend <strong id="profileSuspendUserName"></strong> from the platform.</p>
      <div style="margin-bottom:16px;">
        <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;">Suspension Duration (days) <span style="color:#ef4444;">*</span></label>
        <input type="number" id="profileSuspendDays" min="1" max="365" value="7" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;">
      </div>
      <div style="margin-bottom:16px;">
        <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;">Suspension Reason <span style="color:#ef4444;">*</span></label>
        <textarea id="profileSuspendReason" rows="4" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-family:inherit;" placeholder="Describe the reason for this suspension..."></textarea>
      </div>
      <div style="padding:16px;background:#fffbeb;border:1px solid #fef3c7;border-radius:8px;margin-bottom:16px;">
        <p style="margin:0;color:#92400e;font-size:0.9rem;"><strong>‚ÑπÔ∏è Note:</strong> The user will be unable to access the platform until the suspension period ends.</p>
      </div>
    </div>
    <div class="admin-modal-footer">
      <button class="admin-modal-btn secondary" onclick="closeSuspendModal()">Cancel</button>
      <button class="admin-modal-btn warning" onclick="confirmProfileSuspend()">Suspend User</button>
    </div>
  </div>
</div>

<style>
.admin-modal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
    align-items: center;
    justify-content: center;
}
.admin-modal[style*="display: flex"],
.admin-modal[style*="display:flex"] {
    display: flex !important;
}
.admin-modal-content {
    background: white;
    border-radius: 16px;
    max-width: 540px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 24px 80px rgba(0, 0, 0, 0.4);
}
.admin-modal-header {
    padding: 24px 28px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, rgba(255,79,163,0.05) 0%, rgba(118,75,162,0.05) 100%);
}
.admin-modal-header h3 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 800;
    background: linear-gradient(135deg, #ff4fa3, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}
.admin-modal-close {
    background: rgba(107,114,128,0.1);
    border: none;
    font-size: 2rem;
    cursor: pointer;
    color: #6b7280;
    line-height: 1;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}
.admin-modal-close:hover {
    background: rgba(239,68,68,0.1);
    color: #ef4444;
    transform: rotate(90deg);
}
.admin-modal-body {
    padding: 28px;
}
.admin-modal-footer {
    padding: 20px 28px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    background: #f9fafb;
}
.admin-modal-btn {
    padding: 12px 28px;
    border: none;
    border-radius: 10px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.95rem;
}
.admin-modal-btn.secondary {
    background: #f3f4f6;
    color: #374151;
    border: 1px solid #e5e7eb;
}
.admin-modal-btn.secondary:hover {
    background: #e5e7eb;
}
.admin-modal-btn.danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
}
.admin-modal-btn.danger:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
}
.admin-modal-btn.warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
    box-shadow: 0 4px 16px rgba(245, 158, 11, 0.3);
}
.admin-modal-btn.warning:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(245, 158, 11, 0.4);
}
</style>

<!-- Upgrade Modal -->
<div id="upgradeModal" class="admin-modal" style="display:none;">
  <div class="admin-modal-content">
    <div class="admin-modal-header">
      <h3>Upgrade Required</h3>
      <button class="admin-modal-close" onclick="closeUpgradeModal()">&times;</button>
    </div>
    <div class="admin-modal-body">
      <div style="text-align:center;margin-bottom:24px;">
        <div style="width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);margin:0 auto 16px;display:flex;align-items:center;justify-content:center;font-size:2.5rem;">üöÄ</div>
        <h3 style="margin:0 0 8px 0;font-size:1.5rem;font-weight:700;color:#374151;">Service Limit Reached</h3>
        <p style="margin:0;color:#6b7280;">You're on <span id="upgradeTierName">Free User</span></p>
      </div>
      <div id="upgradeTierLimits"></div>
    </div>
    <div class="admin-modal-footer">
      <button class="admin-modal-btn secondary" onclick="closeUpgradeModal()">Maybe Later</button>
      <button class="admin-modal-btn" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;box-shadow:0 4px 16px rgba(124,58,237,0.3);" onclick="goToBilling()">Upgrade Now</button>
    </div>
  </div>
</div>

<!-- Block User Modal -->
<div id="blockModal" class="admin-modal" style="display:none;">
  <div class="admin-modal-content" style="max-width:500px;">
    <div class="admin-modal-header">
      <h3>üö´ Block User</h3>
      <button class="admin-modal-close" onclick="closeBlockModal()">&times;</button>
    </div>
    <div class="admin-modal-body">
      <p style="color:#6b7280;margin-bottom:20px;">Blocking this user will prevent them from viewing your profile, posts, and contacting you. You can unblock them later from your settings.</p>
      <div style="margin-bottom:16px;">
        <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;">Reason (optional):</label>
        <select id="blockReason" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:0.95rem;">
          <option value="">Select a reason...</option>
          <option value="harassment">Harassment or bullying</option>
          <option value="spam">Spam or unwanted content</option>
          <option value="inappropriate">Inappropriate behavior</option>
          <option value="other">Other</option>
        </select>
      </div>
    </div>
    <div class="admin-modal-footer">
      <button class="admin-modal-btn secondary" onclick="closeBlockModal()">Cancel</button>
      <button class="admin-modal-btn danger" onclick="confirmBlock()">Block User</button>
    </div>
  </div>
</div>

<!-- Report User Modal -->
<div id="reportModal" class="admin-modal" style="display:none;">
  <div class="admin-modal-content" style="max-width:550px;">
    <div class="admin-modal-header">
      <h3>‚ö†Ô∏è Report User</h3>
      <button class="admin-modal-close" onclick="closeReportModal()">&times;</button>
    </div>
    <div class="admin-modal-body">
      <p style="color:#6b7280;margin-bottom:20px;">Help us keep the community safe by reporting users who violate our guidelines. All reports are reviewed by our moderation team.</p>
      <div style="margin-bottom:16px;">
        <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;">Reason <span style="color:#ef4444;">*</span></label>
        <select id="reportReason" required style="width:100%;padding:12px 16px;border:2px solid #e5e7eb;border-radius:12px;font-size:0.95rem;transition:all 0.3s;" onchange="handleReportReasonChange()">
          <option value="">Select a reason...</option>
          <option value="harassment">Harassment or threats</option>
          <option value="spam">Spam or scam</option>
          <option value="inappropriate">Inappropriate content</option>
          <option value="impersonation">Impersonation</option>
          <option value="hate-speech">Hate speech</option>
          <option value="violence">Violence or harmful behavior</option>
          <option value="other">Other</option>
        </select>
      </div>
      
      <!-- Dynamic fields container -->
      <div id="dynamicReportFields"></div>
      
      <div style="margin-bottom:16px;">
        <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;">Additional Details <span style="color:#ef4444;">*</span></label>
        <textarea id="reportDescription" rows="4" required placeholder="Please provide specific details about this report..." style="width:100%;padding:12px 16px;border:2px solid #e5e7eb;border-radius:12px;font-size:0.95rem;resize:vertical;transition:all 0.3s;"></textarea>
      </div>
    </div>
    <div class="admin-modal-footer">
      <button class="admin-modal-btn secondary" onclick="closeReportModal()">Cancel</button>
      <button class="admin-modal-btn warning" onclick="confirmReport()">Submit Report</button>
    </div>
  </div>
</div>

<script>
  const visitorProfileUserId = <%= profileUserId %>;
  
  function toggleUserActionsMenu() {
    const menu = document.getElementById('userActionsMenu');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
  }
  
  function openBlockModal() {
    document.getElementById('userActionsMenu').style.display = 'none';
    document.getElementById('blockModal').style.display = 'flex';
  }
  
  function closeBlockModal() {
    document.getElementById('blockModal').style.display = 'none';
    document.getElementById('blockReason').value = '';
  }
  
  function openReportModal() {
    document.getElementById('userActionsMenu').style.display = 'none';
    document.getElementById('reportModal').style.display = 'flex';
  }
  
  function closeReportModal() {
    document.getElementById('reportModal').style.display = 'none';
    document.getElementById('reportReason').value = '';
    document.getElementById('reportDescription').value = '';
    document.getElementById('dynamicReportFields').innerHTML = '';
  }
  
  function handleReportReasonChange() {
    const reason = document.getElementById('reportReason').value;
    const container = document.getElementById('dynamicReportFields');
    container.style.opacity = '0';
    container.style.maxHeight = '0';
    container.style.overflow = 'hidden';
    container.style.transition = 'opacity 0.3s ease, max-height 0.3s ease';
    
    setTimeout(() => {
      container.innerHTML = '';
      if (!reason) return;
    
    const fieldStyle = 'width:100%;padding:12px 16px;border:2px solid #e5e7eb;border-radius:12px;font-size:0.95rem;transition:all 0.3s;';
    const labelStyle = 'display:block;margin-bottom:8px;font-weight:600;color:#374151;';
    
    let fields = '';
    
    switch(reason) {
      case 'harassment':
        fields = `
          <div style="margin-bottom:16px;animation:fadeIn 0.3s ease;">
            <label style="${labelStyle}">Type of harassment: <span style="color:#ef4444;">*</span></label>
            <select id="harassmentType" style="${fieldStyle}" required>
              <option value="">Select type...</option>
              <option value="threats">Threats or intimidation</option>
              <option value="bullying">Bullying behavior</option>
              <option value="unwanted-contact">Unwanted contact</option>
              <option value="stalking">Stalking or following</option>
              <option value="doxxing">Sharing private information</option>
            </select>
          </div>
          <div style="margin-bottom:16px;animation:fadeIn 0.3s ease;">
            <label style="${labelStyle}">Is this ongoing? <span style="color:#ef4444;">*</span></label>
            <div style="display:flex;gap:16px;flex-wrap:wrap;">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:500;">
                <input type="radio" name="isOngoing" value="yes" required style="width:auto;cursor:pointer;"> Yes, it's happening repeatedly
              </label>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:500;">
                <input type="radio" name="isOngoing" value="no" required style="width:auto;cursor:pointer;"> No, this was an isolated incident
              </label>
            </div>
          </div>
        `;
        break;
      
      case 'spam':
        fields = `
          <div style="margin-bottom:16px;animation:fadeIn 0.3s ease;">
            <label style="${labelStyle}">Spam type:</label>
            <select id="spamType" style="${fieldStyle}">
              <option value="">Select type...</option>
              <option value="commercial">Commercial spam / advertising</option>
              <option value="scam">Scam or phishing attempt</option>
              <option value="repetitive">Repetitive unwanted messages</option>
              <option value="malicious-links">Malicious links</option>
              <option value="fake-engagement">Fake engagement bait</option>
            </select>
          </div>
        `;
        break;
      
      case 'inappropriate':
        fields = `
          <div style="margin-bottom:16px;animation:fadeIn 0.3s ease;">
            <label style="${labelStyle}">Content type:</label>
            <select id="inappropriateType" style="${fieldStyle}">
              <option value="">Select type...</option>
              <option value="adult">Adult/sexual content</option>
              <option value="graphic-violence">Graphic violence</option>
              <option value="self-harm">Self-harm content</option>
              <option value="illegal">Illegal activities</option>
              <option value="disturbing">Disturbing content</option>
            </select>
          </div>
          <div style="margin-bottom:16px;animation:fadeIn 0.3s ease;">
            <label style="${labelStyle}">Where did you see this?</label>
            <input type="text" id="contentLocation" placeholder="e.g., Profile picture, bio, post..." style="${fieldStyle}">
          </div>
        `;
        break;
      
      case 'impersonation':
        fields = `
          <div style="margin-bottom:16px;animation:fadeIn 0.3s ease;">
            <label style="${labelStyle}">Who are they impersonating?</label>
            <input type="text" id="impersonatedPerson" placeholder="Name or username" style="${fieldStyle}">
          </div>
          <div style="margin-bottom:16px;animation:fadeIn 0.3s ease;">
            <label style="${labelStyle}">Is this you or someone else?</label>
            <select id="impersonationTarget" style="${fieldStyle}">
              <option value="me">They're impersonating me</option>
              <option value="other">They're impersonating someone else</option>
              <option value="celebrity">They're impersonating a public figure</option>
              <option value="organization">They're impersonating an organization</option>
            </select>
          </div>
        `;
        break;
      
      case 'hate-speech':
        fields = `
          <div style="margin-bottom:16px;animation:fadeIn 0.3s ease;">
            <label style="${labelStyle}">Targeted group or characteristic:</label>
            <select id="hateSpeechTarget" style="${fieldStyle}">
              <option value="">Select category...</option>
              <option value="race">Race or ethnicity</option>
              <option value="religion">Religion</option>
              <option value="gender">Gender or gender identity</option>
              <option value="sexual-orientation">Sexual orientation</option>
              <option value="disability">Disability</option>
              <option value="nationality">Nationality or origin</option>
              <option value="other">Other protected characteristic</option>
            </select>
          </div>
        `;
        break;
      
      case 'violence':
        fields = `
          <div style="margin-bottom:16px;animation:fadeIn 0.3s ease;">
            <label style="${labelStyle}">Violence type:</label>
            <select id="violenceType" style="${fieldStyle}">
              <option value="">Select type...</option>
              <option value="threats">Threats of violence</option>
              <option value="promotion">Promoting violence</option>
              <option value="graphic">Graphic violent content</option>
              <option value="self-harm">Encouraging self-harm</option>
              <option value="dangerous-orgs">Support for dangerous organizations</option>
            </select>
          </div>
          <div style="margin-bottom:16px;background:#fef3c7;border:2px solid #fbbf24;border-radius:12px;padding:16px;animation:fadeIn 0.3s ease;">
            <p style="margin:0;color:#92400e;font-weight:600;display:flex;align-items:center;gap:8px;">
              <span style="font-size:1.2rem;">‚ö†Ô∏è</span> If you or someone else is in immediate danger, please contact local authorities or emergency services.
            </p>
          </div>
        `;
        break;
      
      case 'other':
        fields = `
          <div style="margin-bottom:16px;animation:fadeIn 0.3s ease;">
            <label style="${labelStyle}">Please specify the issue:</label>
            <input type="text" id="otherReasonType" placeholder="Brief description of the issue" style="${fieldStyle}" required>
          </div>
        `;
        break;
    }
    
    container.innerHTML = fields;
    
    // Expand container with animation
    setTimeout(() => {
      container.style.maxHeight = '1000px';
      container.style.opacity = '1';
      container.style.overflow = 'visible';
    }, 10);
    }, 150);
  }
  
  async function confirmBlock() {
    const reason = document.getElementById('blockReason').value;
    try {
      const res = await fetch(`/api/users/${visitorProfileUserId}/block`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason })
      });
      const data = await res.json();
      
      if (res.status === 403) {
        showError(data.error || 'You cannot block users at this time.', 'Block Restricted');
        closeBlockModal();
        return;
      }
      
      if (data.success) {
        showSuccess('User blocked successfully. You will no longer see their content.', 'User Blocked');
        closeBlockModal();
        setTimeout(() => window.location.reload(), 1500);
      } else {
        showError(data.error || 'Failed to block user', 'Block Failed');
      }
    } catch (error) {
      console.error('Block error:', error);
      showError('An error occurred while blocking this user. Please try again.', 'Block Failed');
    }
  }
  
  async function confirmReport() {
    const reason = document.getElementById('reportReason').value;
    const description = document.getElementById('reportDescription').value;
    
    if (!reason) {
      showWarning('Please select a reason for reporting', 'Missing Information');
      return;
    }
    
    if (!description || description.trim().length < 10) {
      showWarning('Please provide detailed information about this report (at least 10 characters)', 'Missing Information');
      return;
    }
    
    try {
      const res = await fetch(`/api/users/${visitorProfileUserId}/report`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason, description })
      });
      const data = await res.json();
      
      if (data.success) {
        showSuccess('Report submitted successfully. Our moderation team will review it.', 'Report Submitted');
        closeReportModal();
      } else {
        showError(data.error || 'Failed to submit report', 'Report Failed');
      }
    } catch (error) {
      console.error('Report error:', error);
      showError('An error occurred while submitting your report. Please try again.', 'Report Failed');
    }
  }
  
  // Close menus when clicking outside
  document.addEventListener('click', (e) => {
    const userMenu = document.getElementById('userActionsMenu');
    if (userMenu && !e.target.closest('[onclick*="toggleUserActionsMenu"]') && !e.target.closest('#userActionsMenu')) {
      userMenu.style.display = 'none';
    }
  });
</script>

<%- include('partials/footer') %>
