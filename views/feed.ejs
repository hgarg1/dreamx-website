<%- include('partials/header') %>

<div class="feed-layout">
  <!-- Left Sidebar -->
  <aside class="feed-sidebar left-sidebar">
    <h2 class="sidebar-title">Your Passions</h2>
    <div class="passion-filters">
      <% const passions = ["Coding","Music","Fitness","Art","Design","Writing"]; %>
      <% passions.forEach(function(p){ %>
        <button type="button" class="passion-pill"><%= p %></button>
      <% }); %>
    </div>
    <a href="#" class="manage-passions-link">Manage passions ‚Üí</a>
  </aside>

  <!-- Main Feed Column -->
  <main class="feed-main">
    <!-- Create Post Box -->
    <section class="create-post-box" style="background:linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,1) 100%);border-radius:20px;padding:28px;margin-bottom:28px;box-shadow:0 8px 32px rgba(0,0,0,0.08);border:1px solid rgba(255,79,163,0.1);backdrop-filter:blur(10px);">
      <div class="create-post-header" style="display:flex;gap:14px;align-items:center;margin-bottom:18px;">
        <% if (authUser && authUser.profile_picture) { %>
          <img src="/uploads/<%= authUser.profile_picture %>" alt="You" class="avatar avatar-sm" style="width:52px;height:52px;border-radius:50%;object-fit:cover;border:3px solid rgba(255,79,163,0.3);box-shadow:0 4px 12px rgba(0,0,0,0.1);">
        <% } else { %>
          <div class="avatar avatar-sm" style="width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.25rem;border:3px solid rgba(255,79,163,0.3);box-shadow:0 4px 12px rgba(0,0,0,0.1);"><%= (authUser.displayName || 'Y').charAt(0) %></div>
        <% } %>
        <button type="button" onclick="openPostComposer()" class="prompt" style="flex:1;background:#f9fafb;border:2px solid #e5e7eb;border-radius:28px;padding:14px 24px;text-align:left;color:#9ca3af;cursor:pointer;font-size:1.05rem;font-weight:500;transition:all 0.3s ease;" onmouseover="this.style.borderColor='#ff4fa3';this.style.background='rgba(255,79,163,0.03)';this.style.color='#6b7280'" onmouseout="this.style.borderColor='#e5e7eb';this.style.background='#f9fafb';this.style.color='#9ca3af'">Share a productive update...</button>
      </div>
      <div style="display:flex;gap:10px;padding-top:14px;border-top:1px solid rgba(229,231,235,0.6);">
        <button type="button" onclick="openPostComposer('image')" style="flex:1;background:linear-gradient(135deg, rgba(255,79,163,0.05), rgba(118,75,162,0.05));border:1px solid rgba(255,79,163,0.2);padding:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;color:#374151;font-weight:600;border-radius:12px;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.background='linear-gradient(135deg, rgba(255,79,163,0.15), rgba(118,75,162,0.15))';this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 16px rgba(255,79,163,0.2)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(255,79,163,0.05), rgba(118,75,162,0.05))';this.style.transform='translateY(0)';this.style.boxShadow='none'">
          <span style="font-size:1.4rem;">üì∏</span> <span>Photo</span>
        </button>
        <button type="button" onclick="openPostComposer('video')" style="flex:1;background:linear-gradient(135deg, rgba(102,126,234,0.05), rgba(118,75,162,0.05));border:1px solid rgba(102,126,234,0.2);padding:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;color:#374151;font-weight:600;border-radius:12px;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.background='linear-gradient(135deg, rgba(102,126,234,0.15), rgba(118,75,162,0.15))';this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 16px rgba(102,126,234,0.2)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(102,126,234,0.05), rgba(118,75,162,0.05))';this.style.transform='translateY(0)';this.style.boxShadow='none'">
          <span style="font-size:1.4rem;">üé¨</span> <span>Reel</span>
        </button>
        <button type="button" onclick="openPostComposer('text')" style="flex:1;background:linear-gradient(135deg, rgba(124,58,237,0.05), rgba(139,92,246,0.05));border:1px solid rgba(124,58,237,0.2);padding:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;color:#374151;font-weight:600;border-radius:12px;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.background='linear-gradient(135deg, rgba(124,58,237,0.15), rgba(139,92,246,0.15))';this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 16px rgba(124,58,237,0.2)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(124,58,237,0.05), rgba(139,92,246,0.05))';this.style.transform='translateY(0)';this.style.boxShadow='none'">
          <span style="font-size:1.4rem;">‚úçÔ∏è</span> <span>Text</span>
        </button>
      </div>
    </section>

    <!-- Post Composer Modal -->
    <div id="postComposerModal" style="display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.65);align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(8px);animation:fadeIn 0.3s ease;">
      <div style="background:white;border-radius:24px;max-width:640px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 24px 80px rgba(0,0,0,0.35);animation:slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);">
        <div style="padding:28px 32px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg, rgba(255,79,163,0.05) 0%, rgba(118,75,162,0.05) 100%);">
          <h3 style="margin:0;font-size:1.75rem;font-weight:800;background:linear-gradient(135deg, #ff4fa3, #764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Create Post</h3>
          <button type="button" onclick="closePostComposer()" style="background:rgba(107,114,128,0.1);border:none;font-size:2rem;cursor:pointer;color:#6b7280;line-height:1;width:40px;height:40px;border-radius:50%;transition:all 0.3s ease;display:flex;align-items:center;justify-content:center;" onmouseover="this.style.background='rgba(239,68,68,0.1)';this.style.color='#ef4444';this.style.transform='rotate(90deg)'" onmouseout="this.style.background='rgba(107,114,128,0.1)';this.style.color='#6b7280';this.style.transform='rotate(0deg)'">&times;</button>
        </div>
        <form id="postForm" action="/feed/post" method="POST" enctype="multipart/form-data" style="padding:32px;">
          <input type="hidden" id="postContentType" name="contentType" value="text">
          
          <div style="margin-bottom:20px;">
            <label style="display:block;margin-bottom:10px;font-weight:700;color:#111827;font-size:0.95rem;">üè∑Ô∏è Activity Label <span style="color:#6b7280;font-weight:400;font-size:0.85rem;">(optional)</span></label>
            <input type="text" name="activityLabel" placeholder="e.g., Built a project, Practiced piano, Morning workout" style="width:100%;padding:14px 16px;border:2px solid #e5e7eb;border-radius:12px;font-size:1rem;transition:all 0.3s ease;" onfocus="this.style.borderColor='#ff4fa3';this.style.boxShadow='0 0 0 4px rgba(255,79,163,0.1)'" onblur="this.style.borderColor='#e5e7eb';this.style.boxShadow='none'">
          </div>

          <div style="margin-bottom:20px;">
            <label style="display:block;margin-bottom:10px;font-weight:700;color:#111827;font-size:0.95rem;">‚ú® What did you accomplish?</label>
            <textarea name="textContent" rows="6" placeholder="Share your progress, learnings, wins, or insights with the community..." style="width:100%;padding:14px 16px;border:2px solid #e5e7eb;border-radius:12px;font-size:1rem;resize:vertical;transition:all 0.3s ease;font-family:inherit;line-height:1.6;" onfocus="this.style.borderColor='#ff4fa3';this.style.boxShadow='0 0 0 4px rgba(255,79,163,0.1)'" onblur="this.style.borderColor='#e5e7eb';this.style.boxShadow='none'" required></textarea>
          </div>

          <div id="mediaUploadSection" style="margin-bottom:20px;display:none;">
            <label style="display:block;margin-bottom:10px;font-weight:700;color:#111827;font-size:0.95rem;">üìé Upload Media</label>
            <div style="position:relative;">
              <input type="file" id="mediaInput" name="media" accept="image/*,video/*" style="width:100%;padding:14px 16px;border:2px dashed #e5e7eb;border-radius:12px;cursor:pointer;transition:all 0.3s ease;background:#f9fafb;" onmouseover="this.style.borderColor='#ff4fa3';this.style.background='rgba(255,79,163,0.02)'" onmouseout="this.style.borderColor='#e5e7eb';this.style.background='#f9fafb'">
            </div>
            <div id="mediaPreview" style="margin-top:16px;border-radius:12px;overflow:hidden;"></div>
          </div>

          <div style="display:flex;gap:12px;justify-content:flex-end;padding-top:20px;border-top:1px solid #e5e7eb;">
            <button type="button" onclick="closePostComposer()" style="padding:12px 28px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:12px;font-weight:700;cursor:pointer;transition:all 0.3s ease;color:#374151;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">Cancel</button>
            <button type="submit" style="padding:12px 32px;background:linear-gradient(135deg, #ff4fa3, #e63e8f);color:white;border:none;border-radius:12px;font-weight:700;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 16px rgba(255,79,163,0.3);" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 24px rgba(255,79,163,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 16px rgba(255,79,163,0.3)'">‚ú® Publish Post</button>
          </div>
        </form>
      </div>
    </div>

    <style>
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      @keyframes slideUp {
        from { transform: translateY(30px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
    </style>

    <script>
      function openPostComposer(type = 'text') {
        document.getElementById('postComposerModal').style.display = 'flex';
        document.getElementById('postContentType').value = type;
        const mediaSection = document.getElementById('mediaUploadSection');
        const mediaInput = document.getElementById('mediaInput');
        
        if (type === 'image') {
          mediaSection.style.display = 'block';
          mediaInput.accept = 'image/*';
          mediaInput.required = true;
        } else if (type === 'video') {
          mediaSection.style.display = 'block';
          mediaInput.accept = 'video/*';
          mediaInput.required = true;
        } else {
          mediaSection.style.display = 'none';
          mediaInput.required = false;
        }
      }

      function closePostComposer() {
        document.getElementById('postComposerModal').style.display = 'none';
        document.getElementById('postForm').reset();
        document.getElementById('mediaPreview').innerHTML = '';
      }

      document.getElementById('mediaInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const preview = document.getElementById('mediaPreview');
        preview.innerHTML = '';
        
        if (file) {
          const reader = new FileReader();
          reader.onload = function(ev) {
            if (file.type.startsWith('image/')) {
              const img = document.createElement('img');
              img.src = ev.target.result;
              img.style.maxWidth = '100%';
              img.style.borderRadius = '8px';
              preview.appendChild(img);
            } else if (file.type.startsWith('video/')) {
              const video = document.createElement('video');
              video.src = ev.target.result;
              video.controls = true;
              video.style.maxWidth = '100%';
              video.style.borderRadius = '8px';
              preview.appendChild(video);
            }
          };
          reader.readAsDataURL(file);
        }
      });
    </script>

    <!-- Posts -->
    <section class="posts-stream">
      <% if (posts && posts.length > 0) { %>
        <% posts.forEach(function(post){ %>
          <article class="post-card" style="background:white;border-radius:16px;padding:20px;margin-bottom:20px;box-shadow:0 2px 12px rgba(0,0,0,0.08);">
            <header class="post-header" style="display:flex;gap:12px;margin-bottom:16px;">
              <% if (post.profile_picture) { %>
                <img src="/uploads/<%= post.profile_picture %>" alt="<%= post.full_name %>" class="avatar" style="width:48px;height:48px;border-radius:50%;object-fit:cover;">
              <% } else { %>
                <div class="avatar" style="width:48px;height:48px;border-radius:50%;background:#7C3AED;color:white;display:flex;align-items:center;justify-content:center;font-weight:700;"><%= post.full_name.charAt(0) %></div>
              <% } %>
              <div class="post-user-meta" style="flex:1;">
                <h3 class="post-user-name" style="margin:0;font-weight:700;font-size:1rem;"><%= post.full_name %></h3>
                <div class="post-meta-line" style="color:#6b7280;font-size:0.875rem;">
                  <% if (post.activity_label) { %>
                    <span class="post-passion-tag" style="background:#ede9fe;color:#7C3AED;padding:2px 8px;border-radius:4px;font-weight:600;"><%= post.activity_label %></span>
                  <% } %>
                  <span class="post-time">‚Ä¢ <%= new Date(post.created_at).toLocaleString('en-US', { hour: 'numeric', minute: '2-digit', month: 'short', day: 'numeric' }) %></span>
                </div>
              </div>
            </header>
            <div class="post-body">
              <% if (post.text_content) { %>
                <p class="post-text" style="margin:0 0 12px 0;line-height:1.6;"><%= post.text_content %></p>
              <% } %>
              <% if (post.media_url) { %>
                <% if (post.content_type === 'image') { %>
                  <img src="<%= post.media_url %>" alt="Post image" style="width:100%;border-radius:12px;margin-top:12px;">
                <% } else if (post.content_type === 'video') { %>
                  <video src="<%= post.media_url %>" controls style="width:100%;border-radius:12px;margin-top:12px;"></video>
                <% } %>
              <% } %>
            </div>
            <footer class="post-footer" style="display:flex;gap:16px;padding-top:12px;margin-top:12px;border-top:1px solid #e5e7eb;">
              <button type="button" class="post-action like-btn" style="background:none;border:none;cursor:pointer;padding:6px 12px;border-radius:6px;font-weight:600;color:#6b7280;transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">üëç Like</button>
              <button type="button" class="post-action comment-btn" style="background:none;border:none;cursor:pointer;padding:6px 12px;border-radius:6px;font-weight:600;color:#6b7280;transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">üí¨ Comment</button>
            </footer>
          </article>
        <% }); %>
      <% } else { %>
        <div style="background:white;border-radius:16px;padding:48px;text-align:center;color:#6b7280;">
          <p style="font-size:1.125rem;margin:0 0 8px 0;">No posts yet</p>
          <p style="margin:0;">Be the first to share your progress!</p>
        </div>
      <% } %>
    </section>
  </main>

  <!-- Right Sidebar -->
  <aside class="feed-sidebar right-sidebar">
    <h2 class="sidebar-title">Find People</h2>
    <div class="user-search-box" style="background:white;border-radius:12px;padding:12px;box-shadow:0 2px 12px rgba(0,0,0,0.06);margin-bottom:16px;">
      <input id="userSearchInput" type="text" placeholder="Search by name, email, or passion" aria-label="Search users" style="width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;">
      <ul id="userSearchResults" style="list-style:none;margin:12px 0 0 0;padding:0;max-height:260px;overflow:auto;display:none;"></ul>
    </div>

    <h2 class="sidebar-title">Trending Posts</h2>
    <div class="trending-posts">
      <% trendingPosts.forEach(function(tp){ %>
        <div class="trending-post-card">
          <div class="avatar avatar-sm"><%= tp.user.charAt(0) %></div>
          <div class="trending-info">
            <span class="trending-title"><%= tp.title %></span>
            <span class="trending-user"><%= tp.user %></span>
          </div>
          <a href="/profile/<%= tp.userId %>" class="view-btn">View</a>
        </div>
      <% }); %>
    </div>

    <h2 class="sidebar-title">Recent Activity</h2>
    <div class="recent-activity">
      <% recentActivity.forEach(function(act){ %>
        <div class="activity-card">
          <span class="activity-desc"><%= act.desc %></span>
          <span class="activity-time"><%= act.time %></span>
        </div>
      <% }); %>
    </div>

    <h2 class="sidebar-title">Top Passions</h2>
    <div class="top-passions">
      <% topPassions.forEach(function(p){ %>
        <span class="passion-pill"><%= p %></span>
      <% }); %>
    </div>

    <h2 class="sidebar-title">Suggested Creators to Follow</h2>
    <div class="suggested-creators">
      <% suggestions.forEach(function(s){ %>
        <div class="creator-card">
          <div class="avatar avatar-sm"><%= s.user.charAt(0) %></div>
          <div class="creator-info">
            <span class="creator-name"><%= s.user %></span>
            <span class="creator-passion"><%= s.passion %></span>
          </div>
          <button type="button" class="follow-btn">Follow</button>
        </div>
      <% }); %>
    </div>

    <script>
      (function(){
        const input = document.getElementById('userSearchInput');
        const list = document.getElementById('userSearchResults');
        let t = null;
        async function run(q){
          if (!q) { list.style.display='none'; list.innerHTML=''; return; }
          try {
            const res = await fetch(`/api/users/search?q=${encodeURIComponent(q)}`);
            if (!res.ok) throw new Error('Search failed');
            const data = await res.json();
            const users = data.results || [];
            list.innerHTML = users.map(u => `
              <li style="display:flex;align-items:center;gap:10px;padding:8px;border-bottom:1px solid #f3f4f6;">
                ${u.profile_picture ? `<img src="/uploads/${u.profile_picture}" alt="${u.full_name}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">` : `<div style=\"width:36px;height:36px;border-radius:50%;background:#7C3AED;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;\">${(u.full_name||'U').charAt(0)}</div>`}
                <div style="flex:1;min-width:0;">
                  <div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${u.full_name}</div>
                  <div style="font-size:12px;color:#6b7280;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${u.email}</div>
                </div>
                <a href="/profile/${u.id}" style="font-size:12px;padding:6px 8px;border:1px solid #e5e7eb;border-radius:6px;color:#374151;text-decoration:none;">View</a>
                <a href="/messages/start/${u.id}" style="font-size:12px;padding:6px 8px;background:#7C3AED;color:#fff;border-radius:6px;text-decoration:none;">Message</a>
              </li>
            `).join('');
            list.style.display = users.length ? 'block' : 'none';
          } catch(e) {
            list.innerHTML = '<li style="padding:8px;color:#6b7280;">Search failed</li>';
            list.style.display = 'block';
          }
        }
        input.addEventListener('input', () => {
          clearTimeout(t); t = setTimeout(() => run(input.value.trim()), 250);
        });
      })();
    </script>
  </aside>
</div>

<%- include('partials/footer') %>
