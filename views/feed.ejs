<%- include('partials/header') %>

<!-- Feed Premium Styles -->
<link rel="stylesheet" href="/css/feed.css?v=20251117">

<div class="feed-layout">
  <!-- Left Sidebar - Reels Bubbles -->
  <aside class="feed-sidebar left-sidebar">
    <h2 class="sidebar-title" style="display:flex;justify-content:space-between;align-items:center;">Active Reels <span style="font-size:0.65rem;font-weight:600;color:#6b7280;" id="reelsPageInfo"></span></h2>
    <div class="reels-bubbles-wrapper">
      <div id="reelsBubbles" class="reels-bubbles" aria-live="polite">
        <% if (activeReels && activeReels.length) { %>
          <% activeReels.forEach(function(r){ %>
            <div class="reel-bubble" data-user-id="<%= r.user_id %>">
              <div class="reel-bubble-avatar-wrapper" onclick="viewUserReels(<%= r.user_id %>)">
                <% if (r.profile_picture) { %>
                  <img src="/uploads/<%= r.profile_picture %>" alt="<%= r.full_name %>" class="reel-bubble-avatar" />
                <% } else { %>
                  <div class="reel-bubble-avatar" style="display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#667eea,#764ba2);color:white;font-weight:700;font-size:1.4rem;">
                    <%= (r.full_name||'U').charAt(0) %>
                  </div>
                <% } %>
              </div>
              <span class="reel-bubble-name" onclick="window.location.href='/profile/<%= r.user_id %>'" style="cursor:pointer;"><%= r.full_name || 'User' %></span>
              <span class="reel-bubble-count"><%= r.reelCount %> reel<%= r.reelCount === 1 ? '' : 's' %></span>
            </div>
          <% }); %>
        <% } else { %>
          <p style="color:#9ca3af;font-size:0.9rem;text-align:center;padding:8px 0;">No active reels from people you follow</p>
        <% } %>
      </div>
      <div class="reels-bubbles-footer" style="display:flex;gap:8px;margin-top:12px;">
        <button id="reelsPrevBtn" class="bubble-btn" style="flex:1;">‚Üê Prev</button>
        <button id="reelsNextBtn" class="bubble-btn" style="flex:1;">Next ‚Üí</button>
      </div>
    </div>
    <div style="margin-top: 24px; border-top: 2px solid rgba(255,79,163,0.1); padding-top: 24px;">
      <h2 class="sidebar-title">Your Passions</h2>
      <div class="passion-filters">
        <% 
          let userPassions = [];
          if (authUser && authUser.categories) {
            try {
              const cats = JSON.parse(authUser.categories);
              if (Array.isArray(cats) && cats.length > 0) {
                userPassions = cats;
              }
            } catch(e) {}
          }
          if (userPassions.length === 0) {
            userPassions = ['Add your passions'];
          }
        %>
        <% userPassions.forEach(function(p){ %>
          <button type="button" class="passion-pill"><%= p %></button>
        <% }); %>
      </div>
      <a href="/settings" class="manage-passions-link">Manage passions ‚Üí</a>
    </div>
  </aside>

  <!-- Main Feed Column -->
  <main class="feed-main">
    <!-- Create Post Box -->
    <section class="create-post-box" style="background:linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,1) 100%);border-radius:20px;padding:28px;margin-bottom:28px;box-shadow:0 8px 32px rgba(0,0,0,0.08);border:1px solid rgba(255,79,163,0.1);backdrop-filter:blur(10px);">
      <div class="create-post-header" style="display:flex;gap:14px;align-items:center;margin-bottom:18px;">
        <% if (authUser && authUser.profile_picture) { %>
          <img src="/uploads/<%= authUser.profile_picture %>" alt="You" class="avatar avatar-sm" data-is-own="true" style="width:52px;height:52px;border-radius:50%;object-fit:cover;border:3px solid rgba(255,79,163,0.3);box-shadow:0 4px 12px rgba(0,0,0,0.1);cursor:pointer;">
        <% } else { %>
          <div class="avatar avatar-sm" data-is-own="true" style="width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.25rem;border:3px solid rgba(255,79,163,0.3);box-shadow:0 4px 12px rgba(0,0,0,0.1);cursor:pointer;"><%= (authUser.displayName || 'Y').charAt(0) %></div>
        <% } %>
        <button type="button" onclick="openPostComposer()" class="prompt" style="flex:1;background:#f9fafb;border:2px solid #e5e7eb;border-radius:28px;padding:14px 24px;text-align:left;color:#9ca3af;cursor:pointer;font-size:1.05rem;font-weight:500;transition:all 0.3s ease;" onmouseover="this.style.borderColor='#ff4fa3';this.style.background='rgba(255,79,163,0.03)';this.style.color='#6b7280'" onmouseout="this.style.borderColor='#e5e7eb';this.style.background='#f9fafb';this.style.color='#9ca3af'">Share a productive update...</button>
      </div>
      <div style="display:flex;gap:10px;padding-top:14px;border-top:1px solid rgba(229,231,235,0.6);">
        <button type="button" onclick="openPostComposer('image')" style="flex:1;background:linear-gradient(135deg, rgba(255,79,163,0.05), rgba(118,75,162,0.05));border:1px solid rgba(255,79,163,0.2);padding:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;color:#374151;font-weight:600;border-radius:12px;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.background='linear-gradient(135deg, rgba(255,79,163,0.15), rgba(118,75,162,0.15))';this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 16px rgba(255,79,163,0.2)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(255,79,163,0.05), rgba(118,75,162,0.05))';this.style.transform='translateY(0)';this.style.boxShadow='none'">
          <span style="font-size:1.4rem;">üì∏</span> <span>Photo</span>
        </button>
        <button type="button" onclick="openPostComposer('video')" style="flex:1;background:linear-gradient(135deg, rgba(102,126,234,0.05), rgba(118,75,162,0.05));border:1px solid rgba(102,126,234,0.2);padding:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;color:#374151;font-weight:600;border-radius:12px;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.background='linear-gradient(135deg, rgba(102,126,234,0.15), rgba(118,75,162,0.15))';this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 16px rgba(102,126,234,0.2)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(102,126,234,0.05), rgba(118,75,162,0.05))';this.style.transform='translateY(0)';this.style.boxShadow='none'" title="Reel (no images, videos/GIFs only)">
          <span style="font-size:1.4rem;">üé¨</span> <span>Reel</span>
        </button>
        <button type="button" onclick="openPostComposer('text')" style="flex:1;background:linear-gradient(135deg, rgba(124,58,237,0.05), rgba(139,92,246,0.05));border:1px solid rgba(124,58,237,0.2);padding:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;color:#374151;font-weight:600;border-radius:12px;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.background='linear-gradient(135deg, rgba(124,58,237,0.15), rgba(139,92,246,0.15))';this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 16px rgba(124,58,237,0.2)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(124,58,237,0.05), rgba(139,92,246,0.05))';this.style.transform='translateY(0)';this.style.boxShadow='none'">
          <span style="font-size:1.4rem;">‚úçÔ∏è</span> <span>Text</span>
        </button>
      </div>
    </section>

    <!-- Post Composer Modal -->
    <div id="postComposerModal" class="modal-backdrop" style="display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.65);align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(8px);" onclick="if(event.target.classList.contains('modal-backdrop')) closePostComposer();">
      <div class="modal-content" onclick="event.stopPropagation()" style="background:white;border-radius:24px;max-width:640px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 24px 80px rgba(0,0,0,0.35);">
        <div style="padding:28px 32px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg, rgba(255,79,163,0.05) 0%, rgba(118,75,162,0.05) 100%);">
          <h3 style="margin:0;font-size:1.75rem;font-weight:800;background:linear-gradient(135deg, #ff4fa3, #764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Create Post</h3>
          <button type="button" onclick="event.preventDefault(); closePostComposer();" style="background:rgba(107,114,128,0.1);border:none;font-size:2rem;cursor:pointer;color:#6b7280;line-height:1;width:40px;height:40px;border-radius:50%;transition:all 0.3s ease;display:flex;align-items:center;justify-content:center;" onmouseover="this.style.background='rgba(239,68,68,0.1)';this.style.color='#ef4444';this.style.transform='rotate(90deg)'" onmouseout="this.style.background='rgba(107,114,128,0.1)';this.style.color='#6b7280';this.style.transform='rotate(0deg)'">&times;</button>
        </div>
        <form id="postForm" action="/feed/post" method="POST" enctype="multipart/form-data" style="padding:32px;">
          <input type="hidden" id="postContentType" name="contentType" value="text">
          
          <div style="margin-bottom:20px;">
            <label style="display:block;margin-bottom:10px;font-weight:700;color:#111827;font-size:0.95rem;">üè∑Ô∏è Activity Label <span style="color:#6b7280;font-weight:400;font-size:0.85rem;">(optional)</span></label>
            <input type="text" name="activityLabel" placeholder="e.g., Built a project, Practiced piano, Morning workout" style="width:100%;padding:14px 16px;border:2px solid #e5e7eb;border-radius:12px;font-size:1rem;transition:all 0.3s ease;" onfocus="this.style.borderColor='#ff4fa3';this.style.boxShadow='0 0 0 4px rgba(255,79,163,0.1)'" onblur="this.style.borderColor='#e5e7eb';this.style.boxShadow='none'">
          </div>

          <div style="margin-bottom:20px;">
            <label style="display:block;margin-bottom:10px;font-weight:700;color:#111827;font-size:0.95rem;">‚ú® What did you accomplish?</label>
            <textarea name="textContent" rows="6" placeholder="Share your progress, learnings, wins, or insights with the community..." style="width:100%;padding:14px 16px;border:2px solid #e5e7eb;border-radius:12px;font-size:1rem;resize:vertical;transition:all 0.3s ease;font-family:inherit;line-height:1.6;" onfocus="this.style.borderColor='#ff4fa3';this.style.boxShadow='0 0 0 4px rgba(255,79,163,0.1)'" onblur="this.style.borderColor='#e5e7eb';this.style.boxShadow='none'" required></textarea>
          </div>

          <div id="mediaUploadSection" style="margin-bottom:20px;display:none;">
            <label style="display:block;margin-bottom:10px;font-weight:700;color:#111827;font-size:0.95rem;">üìé Upload Media</label>
            <div style="position:relative;">
              <input type="file" id="mediaInput" name="media" accept="image/*,video/*" style="width:100%;padding:14px 16px;border:2px dashed #e5e7eb;border-radius:12px;cursor:pointer;transition:all 0.3s ease;background:#f9fafb;" onmouseover="this.style.borderColor='#ff4fa3';this.style.background='rgba(255,79,163,0.02)'" onmouseout="this.style.borderColor='#e5e7eb';this.style.background='#f9fafb'">
            </div>
            <div id="mediaPreview" style="margin-top:16px;border-radius:12px;overflow:hidden;"></div>
          </div>

          <div id="audioUploadSection" style="margin-bottom:20px;">
            <label style="display:block;margin-bottom:10px;font-weight:700;color:#111827;font-size:0.95rem;">üéµ Background Audio <span style="color:#6b7280;font-weight:400;font-size:0.85rem;">(optional)</span></label>
            <div style="position:relative;">
              <input type="file" id="audioInput" name="audio" accept="audio/*" style="width:100%;padding:14px 16px;border:2px dashed rgba(255,79,163,0.3);border-radius:12px;cursor:pointer;transition:all 0.3s ease;background:rgba(255,79,163,0.02);" onmouseover="this.style.borderColor='#ff4fa3';this.style.background='rgba(255,79,163,0.05)'" onmouseout="this.style.borderColor='rgba(255,79,163,0.3)';this.style.background='rgba(255,79,163,0.02)'">
            </div>
            <div id="audioPreview" style="margin-top:12px;display:none;background:linear-gradient(135deg, rgba(255,79,163,0.08) 0%, rgba(118,75,162,0.08) 100%);border-radius:12px;padding:12px;border:1px solid rgba(255,79,163,0.2);">
              <div style="display:flex;align-items:center;gap:10px;">
                <span style="font-size:1.5rem;">üéµ</span>
                <div style="flex:1;min-width:0;">
                  <div id="audioFileName" style="font-weight:700;color:#374151;font-size:0.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></div>
                  <div style="font-size:0.75rem;color:#6b7280;">Audio will loop in background at 30% volume</div>
                </div>
                <button type="button" onclick="clearAudioUpload()" style="background:rgba(239,68,68,0.1);border:none;color:#ef4444;padding:6px 12px;border-radius:8px;cursor:pointer;font-weight:600;font-size:0.85rem;transition:all 0.3s ease;" onmouseover="this.style.background='rgba(239,68,68,0.2)'" onmouseout="this.style.background='rgba(239,68,68,0.1)'">Remove</button>
              </div>
            </div>
          </div>

          <div style="display:flex;gap:12px;justify-content:flex-end;padding-top:20px;border-top:1px solid #e5e7eb;">
            <button type="button" onclick="closePostComposer()" style="padding:12px 28px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:12px;font-weight:700;cursor:pointer;transition:all 0.3s ease;color:#374151;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">Cancel</button>
            <button type="submit" style="padding:12px 32px;background:linear-gradient(135deg, #ff4fa3, #e63e8f);color:white;border:none;border-radius:12px;font-weight:700;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 16px rgba(255,79,163,0.3);" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 24px rgba(255,79,163,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 16px rgba(255,79,163,0.3)'">‚ú® Publish Post</button>
          </div>
        </form>
      </div>
    </div>

    <style>
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      @keyframes slideUp {
        from { transform: translateY(30px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      .modal-backdrop { animation: fadeIn 0.3s ease; }
      .modal-content { animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>

    <script>
      // Global functions need to be outside DOMContentLoaded
      function openPostComposer(type = 'text') {
        const modal = document.getElementById('postComposerModal');
        if (!modal) {
          console.error('Modal not found!');
          return;
        }
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
        document.getElementById('postContentType').value = type;
        const mediaSection = document.getElementById('mediaUploadSection');
        const mediaInput = document.getElementById('mediaInput');
        
        if (type === 'image') {
          mediaSection.style.display = 'block';
          mediaInput.accept = 'image/*';
          mediaInput.required = true;
        } else if (type === 'video') {
          mediaSection.style.display = 'block';
          // Reels: Only videos and GIFs allowed; explicitly disallow images
          mediaInput.accept = 'video/*,image/gif';
          mediaInput.required = true;
        } else {
          mediaSection.style.display = 'none';
          mediaInput.required = false;
        }
      }

      function closePostComposer() {
        const modal = document.getElementById('postComposerModal');
        if (!modal) return;
        modal.style.display = 'none';
        document.body.style.overflow = ''; // Restore scrolling
        document.getElementById('postForm').reset();
        document.getElementById('mediaPreview').innerHTML = '';
        clearAudioUpload();
      }
      
      function clearAudioUpload() {
        const audioInput = document.getElementById('audioInput');
        const audioPreview = document.getElementById('audioPreview');
        if (audioInput) audioInput.value = '';
        if (audioPreview) audioPreview.style.display = 'none';
      }

      // Wait for DOM to be ready before adding event listeners
      document.addEventListener('DOMContentLoaded', function() {
        // Escape key handler
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            const modal = document.getElementById('postComposerModal');
            if (modal && modal.style.display === 'flex') {
              closePostComposer();
            }
          }
        });

        // Media input change handler
        const mediaInput = document.getElementById('mediaInput');
        if (mediaInput) {
          mediaInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        const preview = document.getElementById('mediaPreview');
        preview.innerHTML = '';
        
        if (file) {
          const type = document.getElementById('postContentType').value;
          // Enforce: if Reel, disallow static images (allow GIF via image/gif)
          if (type === 'video' && file.type.startsWith('image/') && file.type !== 'image/gif') {
            alert('Reels cannot include images. Please upload a video or GIF.');
            e.target.value = '';
            return;
          }
          const reader = new FileReader();
          reader.onload = function(ev) {
            if (file.type.startsWith('image/')) {
              const img = document.createElement('img');
              img.src = ev.target.result;
              img.style.maxWidth = '100%';
              img.style.borderRadius = '8px';
              preview.appendChild(img);
            } else if (file.type.startsWith('video/')) {
              const video = document.createElement('video');
              video.src = ev.target.result;
              video.controls = true;
              video.style.maxWidth = '100%';
              video.style.borderRadius = '8px';
              preview.appendChild(video);
            }
          };
          reader.readAsDataURL(file);
        }
          });
        }
      
        // Audio preview handler
        const audioInput = document.getElementById('audioInput');
        if (audioInput) {
          audioInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const audioPreview = document.getElementById('audioPreview');
            const audioFileName = document.getElementById('audioFileName');
            if (file) {
              audioFileName.textContent = file.name;
              audioPreview.style.display = 'block';
            } else {
              audioPreview.style.display = 'none';
            }
          });
        }
      });
    </script>

    <%- include('partials/post-helpers') %>

    <!-- Posts -->
    <section class="posts-stream">
      <% if (posts && posts.length > 0) { %>
        <% posts.forEach(function(post){ %>
          <%- include('partials/post-card', { post }) %>
        <% }); %>
      <% } else { %>
        <div style="background:white;border-radius:16px;padding:48px;text-align:center;color:#6b7280;">
          <p style="font-size:1.125rem;margin:0 0 8px 0;">No posts yet</p>
          <p style="margin:0;">Be the first to share your progress!</p>
        </div>
      <% } %>
    </section>
  </main>

  <!-- Right Sidebar -->
  <aside class="feed-sidebar right-sidebar">
    <h2 class="sidebar-title">Find People</h2>
    <div class="user-search-box" style="background:white;border-radius:12px;padding:12px;box-shadow:0 2px 12px rgba(0,0,0,0.06);margin-bottom:16px;">
      <input id="userSearchInput" type="text" placeholder="Search by name, email, or passion" aria-label="Search users" style="width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;">
      <ul id="userSearchResults" style="list-style:none;margin:12px 0 0 0;padding:0;max-height:260px;overflow:auto;display:none;"></ul>
    </div>

    <h2 class="sidebar-title">Trending Posts</h2>
    <div class="trending-posts">
      <% if (trendingPosts && trendingPosts.length > 0) { %>
        <% trendingPosts.forEach(function(tp){ %>
          <div class="trending-post-card">
            <% if (tp.profile_picture) { %>
              <div class="avatar-sm">
                <img src="/uploads/<%= tp.profile_picture %>" alt="<%= tp.user || tp.full_name %>">
              </div>
            <% } else { %>
              <div class="avatar-sm"><%= (tp.user || tp.full_name || 'U').charAt(0) %></div>
            <% } %>
            <div class="trending-info">
              <span class="trending-title"><%= tp.title || tp.text_content || 'Untitled Post' %></span>
              <span class="trending-user"><%= tp.user || tp.full_name %></span>
              <% if (tp.likes_count || tp.comments_count) { %>
                <div class="trending-stats">
                  <% if (tp.likes_count) { %>
                    <span class="trending-stat">üëç <%= tp.likes_count %></span>
                  <% } %>
                  <% if (tp.comments_count) { %>
                    <span class="trending-stat">üí¨ <%= tp.comments_count %></span>
                  <% } %>
                </div>
              <% } %>
            </div>
            <a href="<%= tp.post_id ? '/post/' + tp.post_id : '/profile/' + (tp.userId || tp.user_id) %>" class="view-btn">View</a>
          </div>
        <% }); %>
      <% } else { %>
        <div style="padding:16px;text-align:center;color:#9ca3af;font-size:.85rem;">
          No trending posts yet
        </div>
      <% } %>
    </div>

    <h2 class="sidebar-title">Recent Activity</h2>
    <div class="recent-activity">
      <% recentActivity.forEach(function(act){ %>
        <div class="activity-card">
          <span class="activity-desc"><%= act.desc %></span>
          <span class="activity-time"><%= act.time %></span>
        </div>
      <% }); %>
    </div>

    <h2 class="sidebar-title">Top Passions</h2>
    <div class="top-passions">
      <% topPassions.forEach(function(p){ %>
        <span class="passion-pill"><%= p %></span>
      <% }); %>
    </div>

    <h2 class="sidebar-title">Suggested Creators to Follow</h2>
    <div class="suggested-creators">
      <% if (suggestions && suggestions.length > 0) { %>
        <% suggestions.forEach(function(s){ %>
          <div class="creator-card">
            <% if (s.id && s.profile_picture) { %>
              <img src="/uploads/<%= s.profile_picture %>" alt="<%= s.user %>" class="avatar avatar-sm" style="width:40px;height:40px;border-radius:50%;object-fit:cover;cursor:pointer;" onclick="window.location.href='/profile/<%= s.id %>'">
            <% } else { %>
              <div class="avatar avatar-sm" style="cursor:pointer;" onclick="<% if (s.id) { %>window.location.href='/profile/<%= s.id %>'<% } %>"><%= s.user.charAt(0) %></div>
            <% } %>
            <div class="creator-info">
              <span class="creator-name" style="cursor:pointer;" onclick="<% if (s.id) { %>window.location.href='/profile/<%= s.id %>'<% } %>"><%= s.user %></span>
              <span class="creator-passion"><%= s.passion %></span>
            </div>
            <% if (s.id) { %>
              <button type="button" class="follow-btn" onclick="followCreator(<%= s.id %>, this)">Follow</button>
            <% } else { %>
              <button type="button" class="follow-btn" disabled style="opacity:0.5;">Follow</button>
            <% } %>
          </div>
        <% }); %>
      <% } else { %>
        <div style="padding:16px;text-align:center;color:#9ca3af;font-size:.85rem;">
          <p style="margin:0;">No suggestions available right now.</p>
          <p style="margin:8px 0 0 0;font-size:0.75rem;">Check back later!</p>
        </div>
      <% } %>
    </div>

    <script>
      async function followCreator(userId, btn) {
        try {
          const res = await fetch(`/api/users/${userId}/follow`, { method: 'POST' });
          const data = await res.json();
          if (data.success) {
            btn.textContent = 'Following';
            btn.style.background = '#10b981';
            btn.disabled = true;
            setTimeout(() => {
              btn.closest('.creator-card').style.transition = 'opacity 0.3s';
              btn.closest('.creator-card').style.opacity = '0';
              setTimeout(() => btn.closest('.creator-card').remove(), 300);
            }, 500);
          }
        } catch (err) {
          console.error('Follow error:', err);
        }
      }
    </script>

    <script>
      (function(){
        const input = document.getElementById('userSearchInput');
        const list = document.getElementById('userSearchResults');
        let t = null;
        async function run(q){
          if (!q) { list.style.display='none'; list.innerHTML=''; return; }
          try {
            const res = await fetch(`/api/users/search?q=${encodeURIComponent(q)}`);
            if (!res.ok) throw new Error('Search failed');
            const data = await res.json();
            const users = data.results || [];
            list.innerHTML = users.map(u => `
              <li style="display:flex;align-items:center;gap:10px;padding:8px;border-bottom:1px solid #f3f4f6;">
                ${u.profile_picture ? `<img src="/uploads/${u.profile_picture}" alt="${u.full_name}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">` : `<div style=\"width:36px;height:36px;border-radius:50%;background:#7C3AED;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;\">${(u.full_name||'U').charAt(0)}</div>`}
                <div style="flex:1;min-width:0;">
                  <div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${u.full_name}</div>
                  <div style="font-size:12px;color:#6b7280;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${u.email}</div>
                </div>
                <a href="/profile/${u.id}" style="font-size:12px;padding:6px 8px;border:1px solid #e5e7eb;border-radius:6px;color:#374151;text-decoration:none;">View</a>
                <a href="/messages/start/${u.id}" style="font-size:12px;padding:6px 8px;background:#7C3AED;color:#fff;border-radius:6px;text-decoration:none;">Message</a>
              </li>
            `).join('');
            list.style.display = users.length ? 'block' : 'none';
          } catch(e) {
            list.innerHTML = '<li style="padding:8px;color:#6b7280;">Search failed</li>';
            list.style.display = 'block';
          }
        }
        input.addEventListener('input', () => {
          clearTimeout(t); t = setTimeout(() => run(input.value.trim()), 250);
        });
      })();
    </script>
    
    <!-- Reels Bubbles Logic -->
    <style>
      .reels-bubbles-wrapper { display:flex; flex-direction:column; gap:12px; }
      .reels-bubbles-controls { display:flex; justify-content:space-between; align-items:center; }
      .reels-bubbles-page { font-size:0.7rem; color:#6b7280; }
      .reels-bubbles {
        display: grid;
        grid-template-columns: repeat(auto-fill,minmax(78px,1fr));
        gap: 16px;
        padding: 10px 0;
        min-height: 120px;
        scrollbar-width: thin;
      }
      .reels-bubbles::-webkit-scrollbar { width:6px; }
      .reels-bubbles::-webkit-scrollbar-track { background:transparent; }
      .reels-bubbles::-webkit-scrollbar-thumb { background:#e5e7eb; border-radius:4px; }
      .reel-bubble { display:flex; flex-direction:column; align-items:center; gap:6px; transition:.25s; }
      .reel-bubble:hover { transform:translateY(-3px); }
      .reel-bubble-avatar-wrapper { cursor:pointer; }
      .reel-bubble-avatar { width:64px; height:64px; border-radius:50%; object-fit:cover; padding:3px; background:linear-gradient(135deg,#ff4fa3,#764ba2); box-shadow:0 4px 12px rgba(255,79,163,.25); transition:all .3s ease; }
      .reel-bubble-avatar-wrapper:hover .reel-bubble-avatar { transform:scale(1.08); box-shadow:0 6px 16px rgba(255,79,163,.35); }
      .reel-bubble-name { font-size:.75rem; font-weight:600; color:#374151; max-width:78px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:center; transition:color .2s; }
      .reel-bubble-name:hover { color:#ff4fa3; text-decoration:underline; }
      .reel-bubble-count { font-size:.65rem; color:#ff4fa3; font-weight:700; }
      .reels-bubbles-footer { display:flex; gap:8px; margin-top:4px; }
      .bubble-btn { flex:1; padding:10px 12px; font-size:.75rem; background:linear-gradient(135deg, rgba(255,79,163,0.08), rgba(118,75,162,0.08)); border:1px solid rgba(255,79,163,0.2); border-radius:10px; cursor:pointer; font-weight:700; transition:.25s; color:#374151; }
      .bubble-btn:hover:not(:disabled) { background:linear-gradient(135deg, rgba(255,79,163,0.15), rgba(118,75,162,0.15)); border-color:rgba(255,79,163,0.4); transform:translateY(-1px); }
      .bubble-btn:disabled { opacity:.35; cursor:not-allowed; background:#f3f4f6; border-color:#e5e7eb; }
    </style>
    
    <script>
      // Load reels bubbles on page load
      let reelsPage = 1;
      const reelsPageSize = 12; // Show 12 at a time for cleaner grid
      async function loadReelsBubbles(initial=false) {
        try {
          const res = await fetch(`/api/users/following/reels?page=${reelsPage}&pageSize=${reelsPageSize}`);
          
          // Check for HTTP errors
          if (!res.ok) {
            console.error('Failed to load reels:', res.status, res.statusText);
            const container = document.getElementById('reelsBubbles');
            if (container) {
              container.innerHTML = '<p style="color:#9ca3af;font-size:0.9rem;text-align:center;padding:20px 0;">Unable to load reels. Try again later.</p>';
            }
            return;
          }
          
          const data = await res.json();
          const users = data.users || [];
          const container = document.getElementById('reelsBubbles');
          if (initial) {
            container.innerHTML = '';
          }
          if (users.length === 0 && data.page === 1) {
            container.innerHTML = '<p style="color:#9ca3af;font-size:0.9rem;text-align:center;padding:20px 0;">No active reels from people you follow</p>';
          } else {
            container.innerHTML = users.map(user => {
              const escapedName = (user.full_name || 'User').replace(/'/g, "\\'");
              return `
              <div class="reel-bubble" data-user-id="${user.id}">
                <div class="reel-bubble-avatar-wrapper" onclick="viewUserReels(${user.id})">
                  ${user.profile_picture ? `<img src="/uploads/${user.profile_picture}" alt="${escapedName}" class="reel-bubble-avatar">` : `<div class="reel-bubble-avatar" style="display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#667eea,#764ba2);color:white;font-weight:700;font-size:1.4rem;">${(user.full_name||'U').charAt(0)}</div>`}
                </div>
                <span class="reel-bubble-name" onclick="window.location.href='/profile/${user.id}'" style="cursor:pointer;">${escapedName}</span>
                <span class="reel-bubble-count">${user.reelCount} reel${user.reelCount === 1 ? '' : 's'}</span>
              </div>`;
            }).join('');
          }
          // Update controls
          const pageInfo = document.getElementById('reelsPageInfo');
          const prevBtn = document.getElementById('reelsPrevBtn');
          const nextBtn = document.getElementById('reelsNextBtn');
          
          if (data.totalPages > 0) {
            pageInfo.textContent = `Page ${data.page}/${data.totalPages}`;
          } else {
            pageInfo.textContent = '';
          }
          
          prevBtn.disabled = reelsPage <= 1;
          nextBtn.disabled = reelsPage >= data.totalPages || data.totalPages === 0;
        } catch (err) {
          console.error('Failed to load reels bubbles:', err);
          document.getElementById('reelsBubbles').innerHTML = '<p style="color:#ef4444;font-size:0.85rem;text-align:center;padding:16px 0;">Failed to load reels</p>';
        }
      }
      function viewUserReels(userId){ window.location.href = `/profile/${userId}?viewReels=true`; }
      document.getElementById('reelsPrevBtn').addEventListener('click', () => { if (reelsPage>1){ reelsPage--; loadReelsBubbles(true);} });
      document.getElementById('reelsNextBtn').addEventListener('click', () => { reelsPage++; loadReelsBubbles(true); });
      loadReelsBubbles(true);
    </script>
  </aside>
</div>

<!-- Feed Advanced Animations -->
<script src="/js/feed-animations.js"></script>

<%- include('partials/footer') %>
