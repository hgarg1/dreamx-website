<%- include('partials/header') %>

<!-- Feed Premium Styles -->
<link rel="stylesheet" href="/css/feed.css?v=20251117">

<div class="feed-layout">
  <!-- Left Sidebar - Reels Bubbles -->
  <aside class="feed-sidebar left-sidebar">
    <h2 class="sidebar-title" style="display:flex;justify-content:space-between;align-items:center;">Active Reels <span style="font-size:0.65rem;font-weight:600;color:#6b7280;" id="reelsPageInfo"></span></h2>
    <div class="reels-bubbles-wrapper">
      <div id="reelsBubbles" class="reels-bubbles" aria-live="polite">
        <% if (activeReels && activeReels.length) { %>
          <% activeReels.forEach(function(r){ %>
            <div class="reel-bubble" data-user-id="<%= r.user_id %>">
              <div class="reel-bubble-avatar-wrapper" onclick="viewUserReels(<%= r.user_id %>)">
                <% if (r.profile_picture) { %>
                  <img src="/uploads/<%= r.profile_picture %>" alt="<%= r.full_name %>" class="reel-bubble-avatar" />
                <% } else { %>
                  <div class="reel-bubble-avatar" style="display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#667eea,#764ba2);color:white;font-weight:700;font-size:1.4rem;">
                    <%= (r.full_name||'U').charAt(0) %>
                  </div>
                <% } %>
              </div>
              <span class="reel-bubble-name" onclick="window.location.href='/profile/<%= r.user_id %>'" style="cursor:pointer;"><%= r.full_name || 'User' %></span>
              <span class="reel-bubble-count"><%= r.reelCount %> reel<%= r.reelCount === 1 ? '' : 's' %></span>
            </div>
          <% }); %>
        <% } else { %>
          <div class="reels-empty-state">No active reels from people you follow</div>
        <% } %>
      </div>
      <div class="reels-bubbles-footer" style="display:flex;gap:8px;margin-top:12px;">
        <button id="reelsPrevBtn" class="bubble-btn" style="flex:1;">‚Üê Prev</button>
        <button id="reelsNextBtn" class="bubble-btn" style="flex:1;">Next ‚Üí</button>
      </div>
    </div>
    <div style="margin-top: 24px; border-top: 2px solid rgba(255,79,163,0.1); padding-top: 24px;">
      <h2 class="sidebar-title">Your Passions</h2>
      <div class="passion-filters">
        <% 
          let userPassions = [];
          if (authUser && authUser.categories) {
            try {
              const cats = JSON.parse(authUser.categories);
              if (Array.isArray(cats) && cats.length > 0) {
                userPassions = cats;
              }
            } catch(e) {}
          }
          if (userPassions.length === 0) {
            userPassions = ['Add your passions'];
          }
        %>
        <% userPassions.forEach(function(p){ %>
          <button type="button" class="passion-pill"><%= p %></button>
        <% }); %>
      </div>
      <a href="/settings" class="manage-passions-link">Manage passions ‚Üí</a>
    </div>
  </aside>

  <!-- Main Feed Column -->
  <main class="feed-main">
    <!-- Create Post Box -->
    <section class="create-post-box" style="background:linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,1) 100%);border-radius:20px;padding:28px;margin-bottom:28px;box-shadow:0 8px 32px rgba(0,0,0,0.08);border:1px solid rgba(255,79,163,0.1);backdrop-filter:blur(10px);">
      <div class="create-post-header" style="display:flex;gap:14px;align-items:center;margin-bottom:18px;">
        <% if (authUser && authUser.profile_picture) { %>
          <img src="/uploads/<%= authUser.profile_picture %>" alt="You" class="avatar avatar-sm" data-is-own="true" style="width:52px;height:52px;border-radius:50%;object-fit:cover;border:3px solid rgba(255,79,163,0.3);box-shadow:0 4px 12px rgba(0,0,0,0.1);cursor:pointer;">
        <% } else { %>
          <div class="avatar avatar-sm" data-is-own="true" style="width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.25rem;border:3px solid rgba(255,79,163,0.3);box-shadow:0 4px 12px rgba(0,0,0,0.1);cursor:pointer;"><%= (authUser.displayName || 'Y').charAt(0) %></div>
        <% } %>
        <button type="button" id="openPostComposerBtn" class="prompt" style="flex:1;background:#f9fafb;border:2px solid #e5e7eb;border-radius:28px;padding:14px 24px;text-align:left;color:#9ca3af;cursor:pointer;font-size:1.05rem;font-weight:500;transition:all 0.3s ease;" onmouseover="this.style.borderColor='#ff4fa3';this.style.background='rgba(255,79,163,0.03)';this.style.color='#6b7280'" onmouseout="this.style.borderColor='#e5e7eb';this.style.background='#f9fafb';this.style.color='#9ca3af'">Share a productive update...</button>
      </div>
      <div style="display:flex;gap:10px;padding-top:14px;border-top:1px solid rgba(229,231,235,0.6);">
        <button type="button" id="openImageComposerBtn" style="flex:1;background:linear-gradient(135deg, rgba(255,79,163,0.05), rgba(118,75,162,0.05));border:1px solid rgba(255,79,163,0.2);padding:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;color:#374151;font-weight:600;border-radius:12px;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.background='linear-gradient(135deg, rgba(255,79,163,0.15), rgba(118,75,162,0.15))';this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 16px rgba(255,79,163,0.2)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(255,79,163,0.05), rgba(118,75,162,0.05))';this.style.transform='translateY(0)';this.style.boxShadow='none'">
          <span style="font-size:1.4rem;">üì∏</span> <span>Photo</span>
        </button>
        <button type="button" id="openVideoComposerBtn" style="flex:1;background:linear-gradient(135deg, rgba(102,126,234,0.05), rgba(118,75,162,0.05));border:1px solid rgba(102,126,234,0.2);padding:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;color:#374151;font-weight:600;border-radius:12px;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.background='linear-gradient(135deg, rgba(102,126,234,0.15), rgba(118,75,162,0.15))';this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 16px rgba(102,126,234,0.2)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(102,126,234,0.05), rgba(118,75,162,0.05))';this.style.transform='translateY(0)';this.style.boxShadow='none'" title="Reel (no images, videos/GIFs only)">
          <span style="font-size:1.4rem;">üé¨</span> <span>Reel</span>
        </button>
        <button type="button" id="openTextComposerBtn" style="flex:1;background:linear-gradient(135deg, rgba(124,58,237,0.05), rgba(139,92,246,0.05));border:1px solid rgba(124,58,237,0.2);padding:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;color:#374151;font-weight:600;border-radius:12px;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.background='linear-gradient(135deg, rgba(124,58,237,0.15), rgba(139,92,246,0.15))';this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 16px rgba(124,58,237,0.2)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(124,58,237,0.05), rgba(139,92,246,0.05))';this.style.transform='translateY(0)';this.style.boxShadow='none'">
          <span style="font-size:1.4rem;">‚úçÔ∏è</span> <span>Text</span>
        </button>
      </div>
    </section>

    <!-- Post Composer Modal -->
    <div id="postComposerModal" class="feed-modal" role="dialog" aria-modal="true" aria-labelledby="postComposerTitle" aria-hidden="true">
      <div class="feed-modal__card feed-modal__card--composer">
        <div class="feed-modal__content-scroll">
          <div style="padding:28px 32px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg, rgba(255,79,163,0.04) 0%, rgba(118,75,162,0.04) 100%);border-radius:24px 24px 0 0;">
            <div>
              <div id="postComposerTitle" style="font-size:1.4rem;font-weight:800;color:#111827;">Create a <span style="background:linear-gradient(135deg, #ff4fa3, #e63e8f);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">brilliant</span> post</div>
              <div style="color:#6b7280;margin-top:6px;font-size:0.95rem;">Share a quick win, a question, or an update.</div>
            </div>
            <button id="closePostComposerBtn" aria-label="Close" class="feed-modal__icon-btn">√ó</button>
          </div>
          <form id="postForm" method="POST" action="/feed" enctype="multipart/form-data" style="padding:24px 28px 28px;">
            <input type="hidden" name="content_type" id="postContentType" value="text">
            <div style="display:flex;gap:12px;align-items:center;margin-bottom:16px;">
              <% if (authUser && authUser.profile_picture) { %>
                <img src="/uploads/<%= authUser.profile_picture %>" alt="You" class="avatar avatar-sm" data-is-own="true" style="width:52px;height:52px;border-radius:50%;object-fit:cover;border:3px solid rgba(255,79,163,0.3);box-shadow:0 4px 12px rgba(0,0,0,0.1);"> 
              <% } else { %>
                <div class="avatar avatar-sm" data-is-own="true" style="width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.25rem;border:3px solid rgba(255,79,163,0.3);box-shadow:0 4px 12px rgba(0,0,0,0.1);"><%= (authUser.displayName || 'Y').charAt(0) %></div>
              <% } %>
              <div style="flex:1;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                  <label for="postTitle" style="font-weight:700;color:#111827;">Add a title</label>
                  <span style="font-size:0.85rem;color:#9ca3af;">Optional</span>
                </div>
                <input name="title" id="postTitle" type="text" maxlength="120" placeholder="E.g. \"How I automated my weekly planning in 10 minutes\"" style="width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:12px;margin-top:6px;">
              </div>
            </div>
            <div style="margin-bottom:18px;">
              <label for="postContent" style="display:block;font-weight:700;color:#111827;margin-bottom:8px;">What's on your mind?</label>
              <textarea name="content" id="postContent" rows="4" placeholder="Share something insightful..." style="width:100%;padding:14px;border-radius:14px;border:1px solid #e5e7eb;background:#f9fafb;transition:all 0.3s ease;"></textarea>
            </div>
            <div id="mediaUploadSection" style="margin-bottom:18px;display:none;">
              <label style="display:block;margin-bottom:10px;font-weight:700;color:#111827;">Upload media</label>
              <div style="border:2px dashed #e5e7eb;padding:16px;border-radius:12px;display:flex;flex-direction:column;gap:10px;background:linear-gradient(135deg, rgba(255,79,163,0.02), rgba(118,75,162,0.02));">
                <input type="file" id="mediaInput" name="media" accept="image/*,video/*" style="padding:12px;border:1px solid #e5e7eb;border-radius:10px;background:white;">
                <div id="mediaPreview" style="border:1px solid #f3f4f6;padding:12px;border-radius:10px;background:white;"></div>
              </div>
            </div>

            <div id="audioUploadSection" style="margin-bottom:20px;">
              <label style="display:block;margin-bottom:10px;font-weight:700;color:#111827;font-size:0.95rem;">üéµ Background Audio <span style="color:#6b7280;font-weight:400;font-size:0.85rem;">(optional)</span></label>
              <div style="position:relative;">
                <input type="file" id="audioInput" name="audio" accept="audio/*" style="width:100%;padding:14px 16px;border:2px dashed rgba(255,79,163,0.3);border-radius:12px;cursor:pointer;transition:all 0.3s ease;background:rgba(255,79,163,0.02);" onmouseover="this.style.borderColor='#ff4fa3';this.style.background='rgba(255,79,163,0.05)'" onmouseout="this.style.borderColor='rgba(255,79,163,0.3)';this.style.background='rgba(255,79,163,0.02)'">
              </div>
              <div id="audioPreview" style="margin-top:12px;display:none;background:linear-gradient(135deg, rgba(255,79,163,0.08) 0%, rgba(118,75,162,0.08) 100%);border-radius:12px;padding:12px;border:1px solid rgba(255,79,163,0.2);">
                <div style="display:flex;align-items:center;gap:10px;">
                  <span style="font-size:1.5rem;">üéµ</span>
                  <div style="flex:1;min-width:0;">
                    <div id="audioFileName" style="font-weight:700;color:#374151;font-size:0.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></div>
                    <div id="audioDurationHint" style="font-size:0.75rem;color:#6b7280;">Audio will loop in background at 30% volume</div>
                  </div>
                  <button type="button" onclick="clearAudioUpload()" style="background:rgba(239,68,68,0.1);border:none;color:#ef4444;padding:6px 12px;border-radius:8px;cursor:pointer;font-weight:600;font-size:0.85rem;transition:all 0.3s ease;" onmouseover="this.style.background='rgba(239,68,68,0.2)'" onmouseout="this.style.background='rgba(239,68,68,0.1)'">Remove</button>
                </div>
              </div>
            </div>

            <div style="display:flex;gap:12px;justify-content:flex-end;padding-top:20px;border-top:1px solid #e5e7eb;">
              <button type="button" id="cancelPostComposerBtn" style="padding:12px 28px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:12px;font-weight:700;cursor:pointer;transition:all 0.3s ease;color:#374151;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">Cancel</button>
              <button type="submit" style="padding:12px 32px;background:linear-gradient(135deg, #ff4fa3, #e63e8f);color:white;border:none;border-radius:12px;font-weight:700;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 16px rgba(255,79,163,0.3);" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 24px rgba(255,79,163,0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 16px rgba(255,79,163,0.3)'">‚ú® Publish Post</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div id="audioTrimModal" class="feed-modal" role="dialog" aria-modal="true" aria-labelledby="audioTrimTitle" aria-hidden="true">
      <div class="feed-modal__card feed-modal__card--audio">
        <div style="padding:22px 26px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(135deg, rgba(255,79,163,0.06) 0%, rgba(118,75,162,0.06) 100%);">
          <div>
            <div id="audioTrimTitle" style="font-weight:800;color:#111827;font-size:1.1rem;">‚ú® Select the perfect audio moment</div>
            <div style="color:#6b7280;font-size:0.9rem;">Your reel audio is capped at <span id="trimMaxSeconds" style="font-weight:700;color:#111827;">15</span> seconds to match the video.</div>
          </div>
          <button type="button" id="closeAudioTrimBtn" aria-label="Close" class="feed-modal__icon-btn">√ó</button>
        </div>
        <div class="audio-trim-body" style="padding:22px 26px;display:flex;flex-direction:column;gap:18px;background:linear-gradient(180deg, #fff 0%, #fff5fb 100%);">
          <div class="audio-meta-row" style="display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap;">
            <div style="display:flex;gap:12px;align-items:center;">
              <div class="pill" style="background:rgba(255,79,163,0.1);color:#e63e8f;font-weight:800;font-size:0.78rem;padding:6px 12px;border-radius:999px;">Live audio editor</div>
              <div id="trimFileName" style="font-weight:800;color:#111827;min-width:160px;">Select an audio file</div>
            </div>
            <div style="display:flex;gap:10px;align-items:center;">
              <button type="button" id="trimPreviewPlayBtn" style="padding:10px 14px;border:none;border-radius:10px;background:linear-gradient(135deg, #ff4fa3, #e63e8f);color:white;font-weight:800;cursor:pointer;box-shadow:0 8px 18px rgba(255,79,163,0.25);display:flex;align-items:center;gap:8px;">
                <span id="trimPreviewPlayLabel">‚ñ∂</span> Preview clip
              </button>
              <button type="button" id="trimPreviewBackBtn" style="padding:10px 14px;border:1px solid #e5e7eb;border-radius:10px;background:#f9fafb;color:#374151;font-weight:700;cursor:pointer;">Back</button>
            </div>
          </div>

          <div class="audio-visual" style="background:linear-gradient(135deg, rgba(255,79,163,0.08), rgba(118,75,162,0.08));border:1px solid rgba(255,79,163,0.12);border-radius:14px;padding:14px;box-shadow:0 10px 24px rgba(0,0,0,0.04);">
            <div style="display:flex;align-items:center;gap:12px;">
              <div style="display:flex;flex-direction:column;gap:6px;flex:1;">
                <div id="trimFileStats" style="color:#6b7280;font-size:0.9rem;">Waiting for audio...</div>
                <div class="bar-visual" id="trimWave" style="display:grid;grid-template-columns:repeat(24,1fr);gap:4px;align-items:end;min-height:60px;">
                  <% for (let i = 0; i < 24; i++) { %>
                    <span style="display:block;height:<%= 20 + (i % 6) * 6 %>px;background:linear-gradient(180deg, rgba(255,79,163,0.7), rgba(118,75,162,0.8));border-radius:6px;opacity:0.35;"></span>
                  <% } %>
                </div>
              </div>
              <div style="min-width:120px;display:flex;flex-direction:column;gap:8px;align-items:flex-end;">
                <label for="trimPreviewVolume" style="font-weight:700;color:#111827;font-size:0.9rem;">Preview volume</label>
                <input id="trimPreviewVolume" type="range" min="0" max="1" step="0.05" value="0.7" style="accent-color:#ff4fa3;width:120px;">
              </div>
            </div>
            <audio id="trimPreviewPlayer" preload="metadata" style="width:100%;margin-top:10px;display:block;border-radius:10px;overflow:hidden;background:white;"></audio>
          </div>

          <div style="display:flex;align-items:center;gap:10px;">
            <div style="flex:1;">
              <div style="font-weight:700;color:#111827;">Start time</div>
              <div style="color:#6b7280;font-size:0.85rem;">Drag to choose where your clip begins.</div>
            </div>
            <div id="trimStartLabel" style="font-weight:800;color:#ff4fa3;min-width:80px;text-align:right;">0:00</div>
          </div>
          <input type="range" id="audioTrimRange" min="0" value="0" step="0.1" style="accent-color:#ff4fa3;" />
          <div style="display:flex;align-items:center;justify-content:space-between;color:#6b7280;font-size:0.85rem;">
            <span>Clip length: <strong id="trimClipLength">15s</strong></span>
            <span>Selection ends at <strong id="trimEndLabel">0:15</strong></span>
          </div>
          <div style="padding:14px;border-radius:12px;background:linear-gradient(135deg, rgba(255,79,163,0.08), rgba(118,75,162,0.08));border:1px solid rgba(255,79,163,0.15);color:#374151;">
            <strong>Pro tip:</strong> If your video is longer than the audio, we‚Äôll seamlessly loop your chosen segment to keep the vibe going.
          </div>
          <div style="display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap;">
            <button type="button" id="cancelAudioTrimBtn" style="padding:10px 18px;border:1px solid #e5e7eb;border-radius:10px;background:#f9fafb;color:#374151;font-weight:700;cursor:pointer;">Cancel</button>
            <button type="button" id="confirmAudioTrimBtn" style="padding:10px 22px;border:none;border-radius:10px;background:linear-gradient(135deg, #ff4fa3, #e63e8f);color:white;font-weight:800;cursor:pointer;box-shadow:0 10px 20px rgba(255,79,163,0.35);">Save Clip</button>
          </div>
        </div>
      </div>
    </div>

    <style>
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      @keyframes slideUp {
        from { transform: translateY(30px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      .feed-modal.is-active { animation: fadeIn 0.25s ease; }
      .feed-modal__card { animation: slideUp 0.35s cubic-bezier(0.4, 0, 0.2, 1); }
      body.modal-open { overflow: hidden; }
      .audio-visual .bar-visual span { transition: opacity 0.3s ease, transform 0.3s ease; }
      .audio-visual.playing .bar-visual span { opacity: 0.92 !important; transform: scaleY(1.08); }
    </style>

    <script>
      // Global functions need to be outside DOMContentLoaded
      let selectedVideoDuration = null;
      let pendingAudioFile = null;
      let audioPreviewUrl = null;
      let audioPreviewLoopHandler = null;
      let audioTrimState = { duration: 0, maxDuration: 15, start: 0, file: null };
      let activeModalCount = 0;
      let composerWasOpen = false;

      function lockBodyScroll() {
        document.body.style.overflow = 'hidden';
        document.body.classList.add('modal-open');
      }

      function unlockBodyScroll() {
        document.body.style.overflow = '';
        document.body.classList.remove('modal-open');
      }

      function showModal(modal) {
        if (!modal || modal.classList.contains('is-active')) return;
        modal.classList.add('is-active');
        modal.setAttribute('aria-hidden', 'false');
        activeModalCount++;
        lockBodyScroll();
      }

      function hideModal(modal, { unlock = true } = {}) {
        if (!modal || !modal.classList.contains('is-active')) return;
        modal.classList.remove('is-active');
        modal.setAttribute('aria-hidden', 'true');
        if (activeModalCount > 0) activeModalCount--;
        if (unlock && activeModalCount === 0) {
          unlockBodyScroll();
        }
      }

      function openPostComposer(type = 'text') {
        const modal = document.getElementById('postComposerModal');
        if (!modal) {
          console.error('Modal not found!');
          return;
        }
        showModal(modal);
        composerWasOpen = true;
        document.getElementById('postContentType').value = type;
        const mediaSection = document.getElementById('mediaUploadSection');
        const mediaInput = document.getElementById('mediaInput');

        if (type === 'image') {
          mediaSection.style.display = 'block';
          mediaInput.accept = 'image/*';
          mediaInput.required = true;
        } else if (type === 'video') {
          mediaSection.style.display = 'block';
          mediaInput.accept = 'video/*,image/gif';
          mediaInput.required = true;
        } else {
          mediaSection.style.display = 'none';
          mediaInput.required = false;
        }
      }

      function closePostComposer() {
        const modal = document.getElementById('postComposerModal');
        if (!modal) return;
        hideModal(modal);
        composerWasOpen = false;
        document.getElementById('postForm').reset();
        document.getElementById('mediaPreview').innerHTML = '';
        clearAudioUpload();
      }

      function suspendPostComposerForAudio() {
        const modal = document.getElementById('postComposerModal');
        if (modal && modal.classList.contains('is-active')) {
          hideModal(modal, { unlock: false });
          composerWasOpen = true;
        } else {
          composerWasOpen = false;
        }
      }

      function resumePostComposerAfterAudio() {
        const modal = document.getElementById('postComposerModal');
        if (composerWasOpen && modal) {
          showModal(modal);
          composerWasOpen = false;
          return true;
        }
        composerWasOpen = false;
        return false;
      }

      function clearAudioUpload() {
        const audioInput = document.getElementById('audioInput');
        const audioPreview = document.getElementById('audioPreview');
        if (audioInput) audioInput.value = '';
        if (audioPreview) audioPreview.style.display = 'none';
        const audioDurationHint = document.getElementById('audioDurationHint');
        if (audioDurationHint) audioDurationHint.textContent = 'Audio will loop in background at 30% volume';
        updateAudioTrimMeta(null, 0);
        stopAudioPreviewPlayback();
        pendingAudioFile = null;
        audioTrimState = { duration: 0, maxDuration: 15, start: 0, file: null };
      }

      function formatTime(seconds = 0) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      }

      function setAudioInputFile(file) {
        const audioInput = document.getElementById('audioInput');
        if (!audioInput || !file) return;
        const dt = new DataTransfer();
        dt.items.add(file);
        audioInput.files = dt.files;
      }

      async function getMediaDuration(file, type = 'audio') {
        return new Promise((resolve, reject) => {
          const el = document.createElement(type === 'video' ? 'video' : 'audio');
          el.preload = 'metadata';
          el.onloadedmetadata = () => {
            resolve(el.duration || 0);
            URL.revokeObjectURL(el.src);
          };
          el.onerror = () => reject(new Error('Unable to read media duration'));
          el.src = URL.createObjectURL(file);
        });
      }

      async function trimAudioFile(file, startSeconds, clipDuration) {
        const arrayBuffer = await file.arrayBuffer();
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const buffer = await audioCtx.decodeAudioData(arrayBuffer);
        const sampleRate = buffer.sampleRate;
        const startSample = Math.floor(startSeconds * sampleRate);
        const endSample = Math.min(buffer.length, startSample + Math.floor(clipDuration * sampleRate));
        const trimmedLength = Math.max(endSample - startSample, 0);
        const trimmedBuffer = audioCtx.createBuffer(buffer.numberOfChannels, trimmedLength, sampleRate);
        for (let channel = 0; channel < buffer.numberOfChannels; channel++) {
          const channelData = buffer.getChannelData(channel);
          trimmedBuffer.getChannelData(channel).set(channelData.subarray(startSample, endSample));
        }
        const wavBuffer = bufferToWave(trimmedBuffer, trimmedLength);
        const extMatch = file.name.match(/(\.[^./]+)$/);
        const trimmedName = extMatch ? file.name.replace(/(\.[^./]+)$/, '-clip$1') : `${file.name}-clip.wav`;
        const trimmedFile = new File([new DataView(wavBuffer)], trimmedName, { type: 'audio/wav' });
        await audioCtx.close();
        return trimmedFile;
      }

      function bufferToWave(abuffer, len) {
        const numOfChan = abuffer.numberOfChannels;
        const length = len * numOfChan * 2 + 44;
        const buffer = new ArrayBuffer(length);
        const view = new DataView(buffer);
        let offset = 0;

        function setUint16(data) { view.setUint16(offset, data, true); offset += 2; }
        function setUint32(data) { view.setUint32(offset, data, true); offset += 4; }

        setUint32(0x46464952); // "RIFF"
        setUint32(length - 8); // file length - 8
        setUint32(0x45564157); // "WAVE"

        setUint32(0x20746d66); // "fmt "
        setUint32(16); // length of fmt data
        setUint16(1); // PCM format
        setUint16(numOfChan);
        setUint32(abuffer.sampleRate);
        setUint32(abuffer.sampleRate * numOfChan * 2); // byte rate
        setUint16(numOfChan * 2); // block align
        setUint16(16); // bits per sample

        setUint32(0x61746164); // "data"
        setUint32(length - offset - 4); // data length

        const channels = [];
        for (let i = 0; i < numOfChan; i++) {
          channels.push(abuffer.getChannelData(i));
        }

        let sample = 0;
        while (offset < length) {
          for (let i = 0; i < numOfChan; i++) {
            const s = Math.max(-1, Math.min(1, channels[i][sample] || 0));
            view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
            offset += 2;
          }
          sample++;
        }

        return buffer;
      }

      function stopAudioPreviewPlayback(resetLabel = true) {
        const player = document.getElementById('trimPreviewPlayer');
        const visual = document.querySelector('.audio-visual');
        if (player) {
          if (audioPreviewLoopHandler) {
            player.removeEventListener('timeupdate', audioPreviewLoopHandler);
            audioPreviewLoopHandler = null;
          }
          player.pause();
          if (audioTrimState.start && !Number.isNaN(audioTrimState.start)) {
            player.currentTime = audioTrimState.start;
          }
        }
        if (resetLabel) {
          const label = document.getElementById('trimPreviewPlayLabel');
          if (label) label.textContent = '‚ñ∂';
        }
        if (visual) visual.classList.remove('playing');
        if (audioPreviewUrl) {
          URL.revokeObjectURL(audioPreviewUrl);
          audioPreviewUrl = null;
        }
      }

      function updateAudioTrimMeta(file, duration) {
        const fileNameLabel = document.getElementById('trimFileName');
        const fileStats = document.getElementById('trimFileStats');
        const prettySize = (file?.size || 0) / (1024 * 1024);
        if (fileNameLabel) fileNameLabel.textContent = file ? file.name : 'Select an audio file';
        if (fileStats) {
          fileStats.textContent = file
            ? `${formatTime(duration)} total ‚Ä¢ ${prettySize.toFixed(2)} MB`
            : 'Waiting for audio...';
        }
        const waveBars = document.querySelectorAll('#trimWave span');
        waveBars.forEach((bar, idx) => {
          const height = 18 + ((duration || 1) % (idx + 4)) * 1.5 + (idx % 5) * 3;
          bar.style.height = `${Math.min(height, 72)}px`;
          bar.style.opacity = file ? 0.65 : 0.35;
        });
      }

      function updateTrimLabels() {
        const trimStartLabel = document.getElementById('trimStartLabel');
        const trimEndLabel = document.getElementById('trimEndLabel');
        const trimClipLength = document.getElementById('trimClipLength');
        const start = audioTrimState.start || 0;
        const end = start + audioTrimState.maxDuration;
        if (trimStartLabel) trimStartLabel.textContent = formatTime(start);
        if (trimEndLabel) trimEndLabel.textContent = formatTime(end);
        if (trimClipLength) trimClipLength.textContent = `${audioTrimState.maxDuration.toFixed(0)}s`;
      }

      function syncPreviewWithTrim() {
        const player = document.getElementById('trimPreviewPlayer');
        updateTrimLabels();
        if (player && player.src) {
          player.currentTime = Math.min(audioTrimState.start, Math.max(player.duration - audioTrimState.maxDuration, 0));
        }
      }

      function setPreviewSource(file) {
        const player = document.getElementById('trimPreviewPlayer');
        if (!player || !file) return;
        stopAudioPreviewPlayback(false);
        audioPreviewUrl = URL.createObjectURL(file);
        player.src = audioPreviewUrl;
        player.currentTime = audioTrimState.start || 0;
        player.volume = Number(document.getElementById('trimPreviewVolume')?.value || 0.7);
      }

      function togglePreviewPlayback(forcePlay = null) {
        const player = document.getElementById('trimPreviewPlayer');
        const playLabel = document.getElementById('trimPreviewPlayLabel');
        const visual = document.querySelector('.audio-visual');
        if (!player || !player.src) return;
        const shouldPlay = forcePlay === null ? player.paused : forcePlay;
        if (shouldPlay) {
          player.currentTime = audioTrimState.start || 0;
          const loopEnd = (audioTrimState.start || 0) + audioTrimState.maxDuration;
          audioPreviewLoopHandler = () => {
            if (player.currentTime >= loopEnd - 0.05) {
              player.currentTime = audioTrimState.start || 0;
            }
          };
          player.addEventListener('timeupdate', audioPreviewLoopHandler);
          player.play().then(() => {
            if (playLabel) playLabel.textContent = '‚è∏';
            if (visual) visual.classList.add('playing');
          }).catch(() => {});
        } else {
          player.pause();
          if (playLabel) playLabel.textContent = '‚ñ∂';
          if (visual) visual.classList.remove('playing');
          if (audioPreviewLoopHandler) {
            player.removeEventListener('timeupdate', audioPreviewLoopHandler);
            audioPreviewLoopHandler = null;
          }
        }
      }

      function openAudioTrimModal() {
        const modal = document.getElementById('audioTrimModal');
        if (!modal) return;
        suspendPostComposerForAudio();
        showModal(modal);
      }

      function closeAudioTrimModal({ clearAudio = false } = {}) {
        const modal = document.getElementById('audioTrimModal');
        if (!modal) return;
        const shouldUnlock = !composerWasOpen;
        hideModal(modal, { unlock: shouldUnlock });
        stopAudioPreviewPlayback();
        if (!clearAudio && audioTrimState.file) {
          setAudioInputFile(audioTrimState.file);
          const audioPreview = document.getElementById('audioPreview');
          const audioFileName = document.getElementById('audioFileName');
          const audioDurationHint = document.getElementById('audioDurationHint');
          const audioInputEl = document.getElementById('audioInput');
          if (audioPreview) audioPreview.style.display = 'block';
          if (audioFileName) audioFileName.textContent = audioTrimState.file.name;
          if (audioDurationHint) {
            const hintDuration = Math.min(audioTrimState.duration || audioTrimState.maxDuration, audioTrimState.maxDuration);
            audioDurationHint.textContent = `Will loop seamlessly ‚Ä¢ ${formatTime(hintDuration)}`;
          }
          if (audioInputEl) {
            audioInputEl.dataset.trimStart = (audioTrimState.start || 0).toString();
            audioInputEl.dataset.trimEnd = (audioTrimState.start + audioTrimState.maxDuration).toFixed(2);
          }
        }
        if (clearAudio) {
          clearAudioUpload();
        }
        const postComposerVisible = resumePostComposerAfterAudio();
        if (!postComposerVisible && activeModalCount === 0) {
          unlockBodyScroll();
        }
      }

      async function handleAudioSelection(file, forceRecheck = false) {
        const audioPreview = document.getElementById('audioPreview');
        const audioFileName = document.getElementById('audioFileName');
        const audioDurationHint = document.getElementById('audioDurationHint');
        const postType = document.getElementById('postContentType')?.value || 'text';
        if (!file) {
          if (audioPreview) audioPreview.style.display = 'none';
          return;
        }

        pendingAudioFile = file;
        try {
          const duration = await getMediaDuration(file, 'audio');
          const maxDuration = postType === 'video' && selectedVideoDuration
            ? Math.min(15, selectedVideoDuration || 15)
            : 15;
          audioTrimState = { duration, maxDuration, start: 0, file };

          if (duration > maxDuration + 0.05) {
            // Configure modal
            const trimRange = document.getElementById('audioTrimRange');
            const trimMaxLabel = document.getElementById('trimMaxSeconds');
            const maxStart = Math.max(duration - maxDuration, 0);
            if (trimRange) {
              trimRange.max = maxStart.toFixed(1);
              trimRange.value = Math.min(parseFloat(trimRange.value) || 0, maxStart).toString();
            }
            const selectedStart = Math.min(Number(trimRange?.value || 0), maxStart);
            audioTrimState.start = selectedStart;
            if (trimMaxLabel) trimMaxLabel.textContent = maxDuration.toFixed(0);
            updateTrimLabels();
            updateAudioTrimMeta(file, duration);
            setPreviewSource(file);
            togglePreviewPlayback(false);
            openAudioTrimModal();
            return; // Wait for user confirmation before setting preview
          }

          setAudioInputFile(file);
          if (audioFileName) audioFileName.textContent = file.name;
          if (audioPreview) audioPreview.style.display = 'block';
          if (audioDurationHint) {
            const prettyDuration = formatTime(Math.min(duration, maxDuration));
            audioDurationHint.textContent = `Will loop seamlessly ‚Ä¢ ${prettyDuration} max`;
          }
          updateAudioTrimMeta(file, duration);
        } catch (err) {
          console.error('Audio analysis failed', err);
          if (!forceRecheck) alert('Unable to read audio file. Please try another file.');
          audioTrimState = { duration: 0, maxDuration: 15, start: 0, file: null };
          clearAudioUpload();
        }
      }

      // Wait for DOM to be ready before adding event listeners
      document.addEventListener('DOMContentLoaded', function() {
        // Escape key handler
        document.addEventListener('keydown', function(e) {
          if (e.key !== 'Escape') return;
          const audioModal = document.getElementById('audioTrimModal');
          if (audioModal?.classList.contains('is-active')) {
            closeAudioTrimModal();
            return;
          }
          const postModal = document.getElementById('postComposerModal');
          if (postModal?.classList.contains('is-active')) {
            closePostComposer();
          }
        });

        // Media input change handler
        const mediaInput = document.getElementById('mediaInput');
        if (mediaInput) {
          mediaInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('mediaPreview');
            preview.innerHTML = '';
          
          
            if (file) {
              const type = document.getElementById('postContentType').value;
              // Enforce: if Reel, disallow static images (allow GIF via image/gif)
              if (type === 'video' && file.type.startsWith('image/') && file.type !== 'image/gif') {
                alert('Reels cannot include images. Please upload a video or GIF.');
                e.target.value = '';
                return;
              }
              const reader = new FileReader();
              reader.onload = function(ev) {
                if (file.type.startsWith('image/')) {
                  const img = document.createElement('img');
                  img.src = ev.target.result;
                  img.style.maxWidth = '100%';
                  img.style.borderRadius = '8px';
                  preview.appendChild(img);
                } else if (file.type.startsWith('video/')) {
                  const video = document.createElement('video');
                  video.src = ev.target.result;
                  video.controls = true;
                  video.style.maxWidth = '100%';
                  video.style.borderRadius = '8px';
                  preview.appendChild(video);
                  getMediaDuration(file, 'video').then(d => {
                    selectedVideoDuration = d || null;
                    if (pendingAudioFile) {
                      handleAudioSelection(pendingAudioFile, true);
                    }
                  }).catch(() => { selectedVideoDuration = null; });
                }
              };
              reader.readAsDataURL(file);
            }
          });
        }

        // Audio preview handler
        const audioInput = document.getElementById('audioInput');
        if (audioInput) {
          audioInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const audioPreview = document.getElementById('audioPreview');
            if (!file) {
              if (audioPreview) audioPreview.style.display = 'none';
              return;
            }
            handleAudioSelection(file);
          });
        }
        document.getElementById('openPostComposerBtn').addEventListener('click', function() { openPostComposer('text'); });
        document.getElementById('openImageComposerBtn').addEventListener('click', function() { openPostComposer('image'); });
        document.getElementById('openVideoComposerBtn').addEventListener('click', function() { openPostComposer('video'); });
        document.getElementById('openTextComposerBtn').addEventListener('click', function() { openPostComposer('text'); });

        // Close modal
        document.getElementById('closePostComposerBtn').addEventListener('click', function(e) { e.preventDefault(); closePostComposer(); });
        document.getElementById('cancelPostComposerBtn').addEventListener('click', function(e) { e.preventDefault(); closePostComposer(); });

        // Backdrop click closes modal only if clicked outside content
        const setupModalBackdrop = (modalId, closeFn) => {
          const modal = document.getElementById(modalId);
          if (!modal) return;
          modal.addEventListener('pointerdown', (e) => {
            modal.dataset.backdropDown = e.target === modal ? 'true' : '';
          });
          modal.addEventListener('pointerup', (e) => {
            if (modal.dataset.backdropDown === 'true' && e.target === modal) {
              closeFn();
            }
            delete modal.dataset.backdropDown;
          });
          const card = modal.querySelector('.feed-modal__card');
          if (card) {
            card.addEventListener('click', (evt) => evt.stopPropagation());
          }
        };

        setupModalBackdrop('postComposerModal', closePostComposer);
        setupModalBackdrop('audioTrimModal', () => closeAudioTrimModal());

        // Audio trim modal wiring
        const trimRange = document.getElementById('audioTrimRange');
        const trimStartLabel = document.getElementById('trimStartLabel');
        const trimEndLabel = document.getElementById('trimEndLabel');
        const trimClipLength = document.getElementById('trimClipLength');
        if (trimRange) {
          trimRange.addEventListener('input', () => {
            const start = parseFloat(trimRange.value) || 0;
            audioTrimState.start = start;
            const end = start + audioTrimState.maxDuration;
            if (trimStartLabel) trimStartLabel.textContent = formatTime(start);
            if (trimEndLabel) trimEndLabel.textContent = formatTime(end);
            if (trimClipLength) trimClipLength.textContent = `${audioTrimState.maxDuration.toFixed(0)}s`;
            syncPreviewWithTrim();
          });
        }
        const closeTrimWithoutClearing = () => closeAudioTrimModal();
        document.getElementById('closeAudioTrimBtn').addEventListener('click', closeTrimWithoutClearing);
        document.getElementById('trimPreviewBackBtn').addEventListener('click', closeTrimWithoutClearing);
        document.getElementById('cancelAudioTrimBtn').addEventListener('click', () => {
          closeAudioTrimModal({ clearAudio: true });
        });
        document.getElementById('confirmAudioTrimBtn').addEventListener('click', async () => {
          if (!audioTrimState.file) { closeAudioTrimModal(); return; }
          try {
            const trimmed = await trimAudioFile(audioTrimState.file, audioTrimState.start, audioTrimState.maxDuration);
            audioTrimState.file = trimmed;
            audioTrimState.duration = audioTrimState.maxDuration;
            setAudioInputFile(trimmed);
            pendingAudioFile = trimmed;
            const audioPreview = document.getElementById('audioPreview');
            const audioFileName = document.getElementById('audioFileName');
            const audioDurationHint = document.getElementById('audioDurationHint');
            const audioInputEl = document.getElementById('audioInput');
            if (audioInputEl) {
              audioInputEl.dataset.trimStart = audioTrimState.start.toString();
              audioInputEl.dataset.trimEnd = (audioTrimState.start + audioTrimState.maxDuration).toFixed(2);
            }
            if (audioFileName) audioFileName.textContent = `${trimmed.name} (trimmed)`;
            if (audioPreview) audioPreview.style.display = 'block';
            if (audioDurationHint) audioDurationHint.textContent = `Clipped to ${formatTime(audioTrimState.maxDuration)} ‚Ä¢ loops to match video if needed`;
            updateAudioTrimMeta(trimmed, audioTrimState.maxDuration);
          } catch (err) {
            console.error('Audio trimming failed, preserving start/end markers', err);
            alert('We could not save the trimmed file, but we will loop between your chosen start and end when playing the reel.');
            setAudioInputFile(audioTrimState.file);
            const audioPreview = document.getElementById('audioPreview');
            const audioFileName = document.getElementById('audioFileName');
            const audioDurationHint = document.getElementById('audioDurationHint');
            const audioInputEl = document.getElementById('audioInput');
            if (audioInputEl) {
              audioInputEl.dataset.trimStart = audioTrimState.start.toString();
              audioInputEl.dataset.trimEnd = (audioTrimState.start + audioTrimState.maxDuration).toFixed(2);
            }
            if (audioFileName) audioFileName.textContent = `${audioTrimState.file.name} (looped segment)`;
            if (audioPreview) audioPreview.style.display = 'block';
            if (audioDurationHint) audioDurationHint.textContent = `Looping between ${formatTime(audioTrimState.start)} and ${formatTime(audioTrimState.start + audioTrimState.maxDuration)}`;
          }
          closeAudioTrimModal();
        });

        document.getElementById('trimPreviewPlayBtn').addEventListener('click', () => togglePreviewPlayback());
        const volumeSlider = document.getElementById('trimPreviewVolume');
        if (volumeSlider) {
          volumeSlider.addEventListener('input', () => {
            const player = document.getElementById('trimPreviewPlayer');
            if (player) player.volume = Number(volumeSlider.value || 0.7);
          });
        }
      });
    </script>

    <%- include('partials/post-helpers') %>

    <!-- Posts -->
    <section class="posts-stream">
      <% if (posts && posts.length > 0) { %>
        <% posts.forEach(function(post){ %>
          <%- include('partials/post-card', { post }) %>
        <% }); %>
      <% } else { %>
        <div style="background:white;border-radius:16px;padding:48px;text-align:center;color:#6b7280;">
          <p style="font-size:1.125rem;margin:0 0 8px 0;">No posts yet</p>
          <p style="margin:0;">Be the first to share your progress!</p>
        </div>
      <% } %>
    </section>
  </main>

  <!-- Right Sidebar -->
  <aside class="feed-sidebar right-sidebar">
    <h2 class="sidebar-title">Find People</h2>
    <div class="user-search-box" style="background:white;border-radius:12px;padding:12px;box-shadow:0 2px 12px rgba(0,0,0,0.06);margin-bottom:16px;">
      <input id="userSearchInput" type="text" placeholder="Search by name, email, or passion" aria-label="Search users" style="width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;">
      <ul id="userSearchResults" style="list-style:none;margin:12px 0 0 0;padding:0;max-height:260px;overflow:auto;display:none;"></ul>
    </div>

    <h2 class="sidebar-title">Trending Posts</h2>
    <div class="trending-posts">
      <% if (trendingPosts && trendingPosts.length > 0) { %>
        <% trendingPosts.forEach(function(tp){ %>
          <div class="trending-post-card">
            <% if (tp.profile_picture) { %>
              <div class="avatar-sm">
                <img src="/uploads/<%= tp.profile_picture %>" alt="<%= tp.user || tp.full_name %>">
              </div>
            <% } else { %>
              <div class="avatar-sm"><%= (tp.user || tp.full_name || 'U').charAt(0) %></div>
            <% } %>
            <div class="trending-info">
              <span class="trending-title"><%= tp.title || tp.text_content || 'Untitled Post' %></span>
              <span class="trending-user"><%= tp.user || tp.full_name %></span>
              <% if (tp.likes_count || tp.comments_count) { %>
                <div class="trending-stats">
                  <% if (tp.likes_count) { %>
                    <span class="trending-stat">üëç <%= tp.likes_count %></span>
                  <% } %>
                  <% if (tp.comments_count) { %>
                    <span class="trending-stat">üí¨ <%= tp.comments_count %></span>
                  <% } %>
                </div>
              <% } %>
            </div>
            <a href="<%= tp.post_id ? '/post/' + tp.post_id : '/profile/' + (tp.userId || tp.user_id) %>" class="view-btn">View</a>
          </div>
        <% }); %>
      <% } else { %>
        <div style="padding:16px;text-align:center;color:#9ca3af;font-size:.85rem;">
          No trending posts yet
        </div>
      <% } %>
    </div>

    <h2 class="sidebar-title">Recent Activity</h2>
    <div class="recent-activity">
      <% recentActivity.forEach(function(act){ %>
        <div class="activity-card">
          <span class="activity-desc"><%= act.desc %></span>
          <span class="activity-time"><%= act.time %></span>
        </div>
      <% }); %>
    </div>

    <h2 class="sidebar-title">Top Passions</h2>
    <div class="top-passions">
      <% topPassions.forEach(function(p){ %>
        <span class="passion-pill"><%= p %></span>
      <% }); %>
    </div>

    <h2 class="sidebar-title">Suggested Creators to Follow</h2>
    <div class="suggested-creators">
      <% if (suggestions && suggestions.length > 0) { %>
        <% suggestions.forEach(function(s){ %>
          <div class="creator-card">
            <% if (s.id && s.profile_picture) { %>
              <img src="/uploads/<%= s.profile_picture %>" alt="<%= s.user %>" class="avatar avatar-sm" style="width:40px;height:40px;border-radius:50%;object-fit:cover;cursor:pointer;" onclick="window.location.href='/profile/<%= s.id %>'">
            <% } else { %>
              <div class="avatar avatar-sm" style="cursor:pointer;" onclick="<% if (s.id) { %>window.location.href='/profile/<%= s.id %>'<% } %>"><%= s.user.charAt(0) %></div>
            <% } %>
            <div class="creator-info">
              <span class="creator-name" style="cursor:pointer;" onclick="<% if (s.id) { %>window.location.href='/profile/<%= s.id %>'<% } %>"><%= s.user %></span>
              <span class="creator-passion"><%= s.passion %></span>
            </div>
            <% if (s.id) { %>
              <button type="button" class="follow-btn" onclick="followCreator(<%= s.id %>, this)">Follow</button>
            <% } else { %>
              <button type="button" class="follow-btn" disabled style="opacity:0.5;">Follow</button>
            <% } %>
          </div>
        <% }); %>
      <% } else { %>
        <div style="padding:16px;text-align:center;color:#9ca3af;font-size:.85rem;">
          <p style="margin:0;">No suggestions available right now.</p>
          <p style="margin:8px 0 0 0;font-size:0.75rem;">Check back later!</p>
        </div>
      <% } %>
    </div>

    <script>
      async function followCreator(userId, btn) {
        try {
          const res = await fetch(`/api/users/${userId}/follow`, { method: 'POST' });
          const data = await res.json();
          if (data.success) {
            btn.textContent = 'Following';
            btn.style.background = '#10b981';
            btn.disabled = true;
            setTimeout(() => {
              btn.closest('.creator-card').style.transition = 'opacity 0.3s';
              btn.closest('.creator-card').style.opacity = '0';
              setTimeout(() => btn.closest('.creator-card').remove(), 300);
            }, 500);
          }
        } catch (err) {
          console.error('Follow error:', err);
        }
      }
    </script>

    <script>
      (function(){
        const input = document.getElementById('userSearchInput');
        const list = document.getElementById('userSearchResults');
        let t = null;
        async function run(q){
          if (!q) { list.style.display='none'; list.innerHTML=''; return; }
          try {
            const res = await fetch(`/api/users/search?q=${encodeURIComponent(q)}`);
            if (!res.ok) throw new Error('Search failed');
            const data = await res.json();
            const users = data.results || [];
            list.innerHTML = users.map(u => `
              <li style="display:flex;align-items:center;gap:10px;padding:8px;border-bottom:1px solid #f3f4f6;">
                ${u.profile_picture ? `<img src="/uploads/${u.profile_picture}" alt="${u.full_name}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">` : `<div style=\"width:36px;height:36px;border-radius:50%;background:#7C3AED;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;\">${(u.full_name||'U').charAt(0)}</div>`}
                <div style="flex:1;min-width:0;">
                  <div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${u.full_name}</div>
                  <div style="font-size:12px;color:#6b7280;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${u.email}</div>
                </div>
                <a href="/profile/${u.id}" style="font-size:12px;padding:6px 8px;border:1px solid #e5e7eb;border-radius:6px;color:#374151;text-decoration:none;">View</a>
                <a href="/messages/start/${u.id}" style="font-size:12px;padding:6px 8px;background:#7C3AED;color:#fff;border-radius:6px;text-decoration:none;">Message</a>
              </li>
            `).join('');
            list.style.display = users.length ? 'block' : 'none';
          } catch(e) {
            list.innerHTML = '<li style="padding:8px;color:#6b7280;">Search failed</li>';
            list.style.display = 'block';
          }
        }
        input.addEventListener('input', () => {
          clearTimeout(t); t = setTimeout(() => run(input.value.trim()), 250);
        });
      })();
    </script>
    
    <!-- Reels Bubbles Logic -->
    <style>
      .reels-bubbles-wrapper { display:flex; flex-direction:column; gap:12px; }
      .reels-bubbles-controls { display:flex; justify-content:space-between; align-items:center; }
      .reels-bubbles-page { font-size:0.7rem; color:#6b7280; }
      .reels-bubbles {
        display: grid;
        grid-template-columns: repeat(auto-fill,minmax(78px,1fr));
        gap: 16px;
        padding: 10px 0;
        min-height: 120px;
        scrollbar-width: thin;
      }
      .reels-bubbles::-webkit-scrollbar { width:6px; }
      .reels-bubbles::-webkit-scrollbar-track { background:transparent; }
      .reels-bubbles::-webkit-scrollbar-thumb { background:#e5e7eb; border-radius:4px; }
      .reel-bubble { display:flex; flex-direction:column; align-items:center; gap:6px; transition:.25s; }
      .reel-bubble:hover { transform:translateY(-3px); }
      .reel-bubble-avatar-wrapper { cursor:pointer; }
      .reel-bubble-avatar { width:64px; height:64px; border-radius:50%; object-fit:cover; padding:3px; background:linear-gradient(135deg,#ff4fa3,#764ba2); box-shadow:0 4px 12px rgba(255,79,163,.25); transition:all .3s ease; }
      .reel-bubble-avatar-wrapper:hover .reel-bubble-avatar { transform:scale(1.08); box-shadow:0 6px 16px rgba(255,79,163,.35); }
      .reel-bubble-name { font-size:.75rem; font-weight:600; color:#374151; max-width:78px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:center; transition:color .2s; }
      .reel-bubble-name:hover { color:#ff4fa3; text-decoration:underline; }
      .reel-bubble-count { font-size:.65rem; color:#ff4fa3; font-weight:700; }
      .reels-bubbles-footer { display:flex; gap:8px; margin-top:4px; }
      .bubble-btn { flex:1; padding:10px 12px; font-size:.75rem; background:linear-gradient(135deg, rgba(255,79,163,0.08), rgba(118,75,162,0.08)); border:1px solid rgba(255,79,163,0.2); border-radius:10px; cursor:pointer; font-weight:700; transition:.25s; color:#374151; }
      .bubble-btn:hover:not(:disabled) { background:linear-gradient(135deg, rgba(255,79,163,0.15), rgba(118,75,162,0.15)); border-color:rgba(255,79,163,0.4); transform:translateY(-1px); }
      .bubble-btn:disabled { opacity:.35; cursor:not-allowed; background:#f3f4f6; border-color:#e5e7eb; }
    </style>
    
    <script>
      // Load reels bubbles on page load
      let reelsPage = 1;
      const reelsPageSize = 12; // Show 12 at a time for cleaner grid
      async function loadReelsBubbles(initial=false) {
        try {
          const res = await fetch(`/api/users/following/reels?page=${reelsPage}&pageSize=${reelsPageSize}`);
          
          // Check for HTTP errors
          if (!res.ok) {
            console.error('Failed to load reels:', res.status, res.statusText);
            const container = document.getElementById('reelsBubbles');
            if (container) {
              if (res.status === 401) {
                container.innerHTML = '<p style="color:#9ca3af;font-size:0.9rem;text-align:center;padding:20px 0;">Please log in to view reels</p>';
              } else {
                container.innerHTML = '<p style="color:#9ca3af;font-size:0.9rem;text-align:center;padding:20px 0;">Unable to load reels. Try again later.</p>';
              }
            }
            return;
          }
          
          const data = await res.json();
          const users = data.users || [];
          const container = document.getElementById('reelsBubbles');
          if (initial) {
            container.innerHTML = '';
          }
          if (users.length === 0 && data.page === 1) {
            container.innerHTML = '<div class="reels-empty-state">No active reels from people you follow</div>';
          } else {
            container.innerHTML = users.map(user => {
              const escapedName = (user.full_name || 'User').replace(/'/g, "\\'");
              return `
              <div class="reel-bubble" data-user-id="${user.id}">
                <div class="reel-bubble-avatar-wrapper" onclick="viewUserReels(${user.id})">
                  ${user.profile_picture ? `<img src="/uploads/${user.profile_picture}" alt="${escapedName}" class="reel-bubble-avatar">` : `<div class="reel-bubble-avatar" style="display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#667eea,#764ba2);color:white;font-weight:700;font-size:1.4rem;">${(user.full_name||'U').charAt(0)}</div>`}
                </div>
                <span class="reel-bubble-name" onclick="window.location.href='/profile/${user.id}'" style="cursor:pointer;">${escapedName}</span>
                <span class="reel-bubble-count">${user.reelCount} reel${user.reelCount === 1 ? '' : 's'}</span>
              </div>`;
            }).join('');
          }
          // Update controls
          const pageInfo = document.getElementById('reelsPageInfo');
          const prevBtn = document.getElementById('reelsPrevBtn');
          const nextBtn = document.getElementById('reelsNextBtn');
          
          if (data.totalPages > 0) {
            pageInfo.textContent = `Page ${data.page}/${data.totalPages}`;
          } else {
            pageInfo.textContent = '';
          }
          
          prevBtn.disabled = reelsPage <= 1;
          nextBtn.disabled = reelsPage >= data.totalPages || data.totalPages === 0;
        } catch (err) {
          console.error('Failed to load reels bubbles:', err);
          document.getElementById('reelsBubbles').innerHTML = '<p style="color:#ef4444;font-size:0.85rem;text-align:center;padding:16px 0;">Failed to load reels</p>';
        }
      }
      function viewUserReels(userId){ window.location.href = `/profile/${userId}?viewReels=true`; }
      document.getElementById('reelsPrevBtn').addEventListener('click', () => { if (reelsPage>1){ reelsPage--; loadReelsBubbles(true);} });
      document.getElementById('reelsNextBtn').addEventListener('click', () => { reelsPage++; loadReelsBubbles(true); });
      loadReelsBubbles(true);
    </script>
  </aside>
</div>

<!-- Feed Advanced Animations -->
<script src="/js/feed-animations.js"></script>

<%- include('partials/footer') %>
