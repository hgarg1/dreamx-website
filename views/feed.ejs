<%- include('partials/header') %>

<div class="feed-layout">
  <!-- Left Sidebar -->
  <aside class="feed-sidebar left-sidebar">
    <h2 class="sidebar-title">Your Passions</h2>
    <div class="passion-filters">
      <% const passions = ["Coding","Music","Fitness","Art","Design","Writing"]; %>
      <% passions.forEach(function(p){ %>
        <button type="button" class="passion-pill"><%= p %></button>
      <% }); %>
    </div>
    <a href="#" class="manage-passions-link">Manage passions ‚Üí</a>
  </aside>

  <!-- Main Feed Column -->
  <main class="feed-main">
    <!-- Create Post Box -->
    <section class="create-post-box" style="background:white;border-radius:16px;padding:24px;margin-bottom:24px;box-shadow:0 2px 12px rgba(0,0,0,0.08);">
      <div class="create-post-header" style="display:flex;gap:12px;align-items:center;margin-bottom:16px;">
        <% if (authUser && authUser.profile_picture) { %>
          <img src="/uploads/<%= authUser.profile_picture %>" alt="You" class="avatar avatar-sm" style="width:48px;height:48px;border-radius:50%;object-fit:cover;">
        <% } else { %>
          <div class="avatar avatar-sm" style="width:48px;height:48px;border-radius:50%;background:#7C3AED;color:white;display:flex;align-items:center;justify-content:center;font-weight:700;"><%= (authUser.displayName || 'Y').charAt(0) %></div>
        <% } %>
        <button type="button" onclick="openPostComposer()" class="prompt" style="flex:1;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:24px;padding:12px 20px;text-align:left;color:#6b7280;cursor:pointer;font-size:1rem;">Share a productive update...</button>
      </div>
      <div style="display:flex;gap:12px;padding-top:12px;border-top:1px solid #e5e7eb;">
        <button type="button" onclick="openPostComposer('image')" style="flex:1;background:none;border:none;padding:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;color:#6b7280;font-weight:500;border-radius:8px;transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">
          <span style="font-size:1.25rem;">üì∏</span> Photo
        </button>
        <button type="button" onclick="openPostComposer('video')" style="flex:1;background:none;border:none;padding:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;color:#6b7280;font-weight:500;border-radius:8px;transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">
          <span style="font-size:1.25rem;">üé¨</span> Reel
        </button>
        <button type="button" onclick="openPostComposer('text')" style="flex:1;background:none;border:none;padding:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;color:#6b7280;font-weight:500;border-radius:8px;transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">
          <span style="font-size:1.25rem;">‚úçÔ∏è</span> Text
        </button>
      </div>
    </section>

    <!-- Post Composer Modal -->
    <div id="postComposerModal" style="display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;padding:20px;">
      <div style="background:white;border-radius:20px;max-width:600px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
        <div style="padding:24px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
          <h3 style="margin:0;font-size:1.5rem;font-weight:700;">Create Post</h3>
          <button type="button" onclick="closePostComposer()" style="background:none;border:none;font-size:1.75rem;cursor:pointer;color:#6b7280;line-height:1;">&times;</button>
        </div>
        <form id="postForm" action="/feed/post" method="POST" enctype="multipart/form-data" style="padding:24px;">
          <input type="hidden" id="postContentType" name="contentType" value="text">
          
          <div style="margin-bottom:16px;">
            <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;">Activity Label (optional)</label>
            <input type="text" name="activityLabel" placeholder="e.g., Built a project, Practiced piano, Workout session" style="width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:8px;font-size:1rem;">
          </div>

          <div style="margin-bottom:16px;">
            <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;">What did you accomplish?</label>
            <textarea name="textContent" rows="6" placeholder="Share your progress, learnings, or wins..." style="width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:8px;font-size:1rem;resize:vertical;" required></textarea>
          </div>

          <div id="mediaUploadSection" style="margin-bottom:16px;display:none;">
            <label style="display:block;margin-bottom:8px;font-weight:600;color:#374151;">Upload Media</label>
            <input type="file" id="mediaInput" name="media" accept="image/*,video/*" style="width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:8px;">
            <div id="mediaPreview" style="margin-top:12px;"></div>
          </div>

          <div style="display:flex;gap:12px;justify-content:flex-end;padding-top:16px;border-top:1px solid #e5e7eb;">
            <button type="button" onclick="closePostComposer()" style="padding:10px 24px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:8px;font-weight:600;cursor:pointer;">Cancel</button>
            <button type="submit" style="padding:10px 24px;background:#7C3AED;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Post</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      function openPostComposer(type = 'text') {
        document.getElementById('postComposerModal').style.display = 'flex';
        document.getElementById('postContentType').value = type;
        const mediaSection = document.getElementById('mediaUploadSection');
        const mediaInput = document.getElementById('mediaInput');
        
        if (type === 'image') {
          mediaSection.style.display = 'block';
          mediaInput.accept = 'image/*';
          mediaInput.required = true;
        } else if (type === 'video') {
          mediaSection.style.display = 'block';
          mediaInput.accept = 'video/*';
          mediaInput.required = true;
        } else {
          mediaSection.style.display = 'none';
          mediaInput.required = false;
        }
      }

      function closePostComposer() {
        document.getElementById('postComposerModal').style.display = 'none';
        document.getElementById('postForm').reset();
        document.getElementById('mediaPreview').innerHTML = '';
      }

      document.getElementById('mediaInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const preview = document.getElementById('mediaPreview');
        preview.innerHTML = '';
        
        if (file) {
          const reader = new FileReader();
          reader.onload = function(ev) {
            if (file.type.startsWith('image/')) {
              const img = document.createElement('img');
              img.src = ev.target.result;
              img.style.maxWidth = '100%';
              img.style.borderRadius = '8px';
              preview.appendChild(img);
            } else if (file.type.startsWith('video/')) {
              const video = document.createElement('video');
              video.src = ev.target.result;
              video.controls = true;
              video.style.maxWidth = '100%';
              video.style.borderRadius = '8px';
              preview.appendChild(video);
            }
          };
          reader.readAsDataURL(file);
        }
      });
    </script>

    <!-- Posts -->
    <section class="posts-stream">
      <% if (posts && posts.length > 0) { %>
        <% posts.forEach(function(post){ %>
          <article class="post-card" style="background:white;border-radius:16px;padding:20px;margin-bottom:20px;box-shadow:0 2px 12px rgba(0,0,0,0.08);">
            <header class="post-header" style="display:flex;gap:12px;margin-bottom:16px;">
              <% if (post.profile_picture) { %>
                <img src="/uploads/<%= post.profile_picture %>" alt="<%= post.full_name %>" class="avatar" style="width:48px;height:48px;border-radius:50%;object-fit:cover;">
              <% } else { %>
                <div class="avatar" style="width:48px;height:48px;border-radius:50%;background:#7C3AED;color:white;display:flex;align-items:center;justify-content:center;font-weight:700;"><%= post.full_name.charAt(0) %></div>
              <% } %>
              <div class="post-user-meta" style="flex:1;">
                <h3 class="post-user-name" style="margin:0;font-weight:700;font-size:1rem;"><%= post.full_name %></h3>
                <div class="post-meta-line" style="color:#6b7280;font-size:0.875rem;">
                  <% if (post.activity_label) { %>
                    <span class="post-passion-tag" style="background:#ede9fe;color:#7C3AED;padding:2px 8px;border-radius:4px;font-weight:600;"><%= post.activity_label %></span>
                  <% } %>
                  <span class="post-time">‚Ä¢ <%= new Date(post.created_at).toLocaleString('en-US', { hour: 'numeric', minute: '2-digit', month: 'short', day: 'numeric' }) %></span>
                </div>
              </div>
            </header>
            <div class="post-body">
              <% if (post.text_content) { %>
                <p class="post-text" style="margin:0 0 12px 0;line-height:1.6;"><%= post.text_content %></p>
              <% } %>
              <% if (post.media_url) { %>
                <% if (post.content_type === 'image') { %>
                  <img src="<%= post.media_url %>" alt="Post image" style="width:100%;border-radius:12px;margin-top:12px;">
                <% } else if (post.content_type === 'video') { %>
                  <video src="<%= post.media_url %>" controls style="width:100%;border-radius:12px;margin-top:12px;"></video>
                <% } %>
              <% } %>
            </div>
            <footer class="post-footer" style="display:flex;gap:16px;padding-top:12px;margin-top:12px;border-top:1px solid #e5e7eb;">
              <button type="button" class="post-action like-btn" style="background:none;border:none;cursor:pointer;padding:6px 12px;border-radius:6px;font-weight:600;color:#6b7280;transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">üëç Like</button>
              <button type="button" class="post-action comment-btn" style="background:none;border:none;cursor:pointer;padding:6px 12px;border-radius:6px;font-weight:600;color:#6b7280;transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">üí¨ Comment</button>
            </footer>
          </article>
        <% }); %>
      <% } else { %>
        <div style="background:white;border-radius:16px;padding:48px;text-align:center;color:#6b7280;">
          <p style="font-size:1.125rem;margin:0 0 8px 0;">No posts yet</p>
          <p style="margin:0;">Be the first to share your progress!</p>
        </div>
      <% } %>
    </section>
  </main>

  <!-- Right Sidebar -->
  <aside class="feed-sidebar right-sidebar">
    <h2 class="sidebar-title">Suggested Creators to Follow</h2>
    <div class="suggested-creators">
      <% suggestions.forEach(function(s){ %>
        <div class="creator-card">
          <div class="avatar avatar-sm"><%= s.user.charAt(0) %></div>
          <div class="creator-info">
            <span class="creator-name"><%= s.user %></span>
            <span class="creator-passion"><%= s.passion %></span>
          </div>
          <button type="button" class="follow-btn">Follow</button>
        </div>
      <% }); %>
    </div>
  </aside>
</div>

<%- include('partials/footer') %>
