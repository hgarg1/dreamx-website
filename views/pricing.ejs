<%- include('partials/header') %>
  <section class="pricing-hero particle-bg">
    <div class="pricing-hero-inner">
    font-weight: 500;
  }

  .checkbox-label input {
    width: auto;
    cursor: pointer;
  }

  .order-summary {
    background: #f9fafb;
    padding: 24px;
    border-radius: 12px;
    margin-bottom: 30px;
  }

  .order-summary h3 {
    margin: 0 0 20px;
    font-size: 1.25rem;
    font-weight: 700;
  }

  .summary-item {
    display: flex;
    justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid #e5e7eb;
  }

  .summary-item:last-child {
    border-bottom: none;
  }

  .summary-item.total {
    font-size: 1.25rem;
    font-weight: 700;
    color: #7C3AED;
    margin-top: 8px;
    padding-top: 16px;
    border-top: 2px solid #e5e7eb;
  }

  .checkout-actions {
    display: flex;
    gap: 12px;
  }

  .checkout-btn {
    flex: 1;
    padding: 14px 24px;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
  }

  .checkout-btn.primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
  }

  .checkout-btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(124, 58, 237, 0.4);
  }

  .checkout-btn.primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .checkout-btn.outline {
    background: white;
    color: #7C3AED;
    border: 2px solid #7C3AED;
  }

  .checkout-btn.outline:hover {
    background: #f5f3ff;
  }

  .success-message {
    text-align: center;
    padding: 40px 20px;
  }

  .success-icon {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    font-size: 3rem;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 24px;
    animation: scaleIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  }

  @keyframes scaleIn {
    from { 
      transform: scale(0);
      opacity: 0;
    }
    to { 
      transform: scale(1);
      opacity: 1;
    }
  }

  .tier-note {
    font-size: 0.85rem;
    color: #6b7280;
    margin-top: 12px;
    font-style: italic;
    text-align: center;
  }

  .success-message h3 {
    margin: 0 0 12px;
    font-size: 1.75rem;
    font-weight: 700;
    color: #111827;
  }

  .success-message p {
    color: #6b7280;
    margin-bottom: 30px;
    font-size: 1.1rem;
  }

  .btn-loader {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
  }

  /* Card number formatting */
  #cardNumber {
    letter-spacing: 2px;
    font-family: 'Courier New', monospace;
  }

  @media (max-width: 640px) {
    .checkout-modal-content {
      padding: 24px;
    }
    
    .form-row {
      grid-template-columns: 1fr;
    }
    
    .checkout-steps {
      margin-bottom: 30px;
    }
    
    .step-label {
      font-size: 0.75rem;
    }
  }
  </style>

  <script>
  var isLoggedIn = "<%= (typeof authUser !== 'undefined' && authUser) ? 'true' : 'false' %>";
  let currentStep = 1;
  let selectedTier = '';
  let selectedName = '';
  let selectedPrice = '';
  let selectedFeatures = [];
  let selectedTagline = '';

  function openCheckout(tierId, tierName, tierPrice, features, tagline) {
    if (isLoggedIn) {
      selectedTier = tierId;
      selectedName = tierName;
      selectedPrice = tierPrice;
      selectedFeatures = features || [];
      selectedTagline = tagline || '';
      // If selecting enterprise tier, redirect to contact
      if (tierId === 'enterprise') {
        window.location.href = '/contact';
        return;
      }
      // If selecting free tier, just redirect to settings
      if (tierId === 'free') {
        if (confirm('Switch to free tier?')) {
          fetch('/api/checkout/subscribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tier: 'free' })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              window.location.href = '/settings?success=Switched+to+free+tier';
            }
          });
        }
        return;
      }
      // Update modal content
      document.getElementById('selectedPlanName').textContent = tierName;
      document.getElementById('selectedPlanTagline').textContent = tagline;
      document.getElementById('selectedPlanPrice').textContent = tierPrice;
      // Update features list
      const featuresList = document.getElementById('selectedPlanFeatures');
      featuresList.innerHTML = '';
      selectedFeatures.forEach(feature => {
        const li = document.createElement('li');
        li.textContent = feature;
        featuresList.appendChild(li);
      });
      document.getElementById('checkoutModal').classList.add('active');
      currentStep = 1;
      updateStepDisplay();
    } else {
      window.location.href = '/login';
    }
  }

  function closeCheckout() {
    document.getElementById('checkoutModal').classList.remove('active');
    setTimeout(() => {
      currentStep = 1;
      updateStepDisplay();
      document.getElementById('paymentForm').reset();
    }, 300);
  }

  function nextStep() {
    if (currentStep === 2) {
      // Validate payment form
      const form = document.getElementById('paymentForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      // Update confirmation
      const cardType = document.getElementById('cardType').value;
      const cardNumber = document.getElementById('cardNumber').value;
      const lastFour = cardNumber.replace(/\s/g, '').slice(-4);
      
      document.getElementById('confirmPlanName').textContent = selectedName;
      document.getElementById('confirmPlanPrice').textContent = selectedPrice;
      document.getElementById('confirmCardInfo').textContent = 
        cardType.charAt(0).toUpperCase() + cardType.slice(1) + ' •••• ' + lastFour;
    }
    
    if (currentStep < 3) {
      currentStep++;
      updateStepDisplay();
    }
  }

  function prevStep() {
    if (currentStep > 1) {
      currentStep--;
      updateStepDisplay();
    }
  }

  function updateStepDisplay() {
    // Update step indicators
    document.querySelectorAll('.checkout-step').forEach((step, index) => {
      step.classList.remove('active', 'completed');
      if (index + 1 === currentStep) {
        step.classList.add('active');
      } else if (index + 1 < currentStep) {
        step.classList.add('completed');
      }
    });
    
    // Update content visibility
    document.querySelectorAll('.checkout-step-content').forEach((content, index) => {
      content.style.display = (index + 1 === currentStep) ? 'block' : 'none';
    });
  }

  function processPayment() {
    const confirmBtn = document.getElementById('confirmBtn');
    const btnText = confirmBtn.querySelector('.btn-text');
    const btnLoader = confirmBtn.querySelector('.btn-loader');
    
    // Show loading state
    confirmBtn.disabled = true;
    btnText.style.display = 'none';
    btnLoader.style.display = 'inline';
    
    // Gather form data
    const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
    const paymentData = {
      tier: selectedTier,
      cardType: document.getElementById('cardType').value,
      cardNumber: cardNumber,
      expiryMonth: document.getElementById('expiryMonth').value,
      expiryYear: document.getElementById('expiryYear').value,
      cvv: document.getElementById('cvv').value,
      saveCard: document.getElementById('saveCard').checked
    };
    
    // Process payment
    fetch('/api/checkout/subscribe', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(paymentData)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Show success message
        document.getElementById('successPlanName').textContent = selectedName;
        currentStep = 4;
        updateStepDisplay();
      } else {
        alert(data.error || 'Payment failed. Please try again.');
        confirmBtn.disabled = false;
        btnText.style.display = 'inline';
        btnLoader.style.display = 'none';
      }
    })
    .catch(error => {
      console.error('Payment error:', error);
      alert('An error occurred. Please try again.');
      confirmBtn.disabled = false;
      btnText.style.display = 'inline';
      btnLoader.style.display = 'none';
    });
  }

  // Format card number with spaces
  document.addEventListener('DOMContentLoaded', function() {
    const cardNumberInput = document.getElementById('cardNumber');
    if (cardNumberInput) {
      cardNumberInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s/g, '');
        let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
        e.target.value = formattedValue;
      });
    }
  });
  </script>

<%- include('partials/footer') %>
