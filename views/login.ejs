<%- include('partials/header') %>

<!-- Login Page -->
<section class="auth-page">
    <div class="container">
        <div class="auth-card">
            <!-- Header -->
            <div class="auth-header">
                <h1>Welcome back to Dream X</h1>
                <p class="auth-subtitle">Log in to keep building your dreams.</p>
            </div>

            <!-- Error Display -->
            <% if(typeof error !== 'undefined' && error){ %>
              <div style="background:#ffe6ef;color:#c30055;padding:.75rem 1rem;border-radius:8px;margin-bottom:1rem;font-size:.85rem;font-weight:600;">
                <%= error %>
              </div>
            <% } %>

            <!-- Login Form -->
            <form class="auth-form" action="/login" method="POST">
                <!-- Email Field -->
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        required 
                        placeholder="you@example.com"
                        autocomplete="email"
                    >
                </div>

                <!-- Password Field -->
                <div class="form-group">
                    <label for="password">Password</label>
                    <input
                        type="password"
                        id="password"
                        name="password" 
                        required 
                        placeholder="Enter your password"
                        autocomplete="current-password"
                    >
                    <small class="helper-text">We never share your credentials.</small>
                    <div style="margin-top:8px;">
                        <a href="/forgot-password" class="auth-link" style="font-weight:700;">Forgot your password?</a>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn btn-primary btn-full">Log In</button>
            </form>

            <!-- Divider -->
            <div class="auth-divider">
                <span>or</span>
            </div>

                        <!-- Passkey Sign-in -->
                                                <button id="btn-passkey-login" class="btn btn-secondary btn-full" type="button" style="margin-bottom:10px;">Sign in with Passkey</button>
                                                <script>
                                                    document.addEventListener('DOMContentLoaded', function() {
                                                        const btn = document.getElementById('btn-passkey-login');
                                                        if (!btn || !window.SimpleWebAuthnBrowser) return;
                                                        btn.addEventListener('click', async () => {
                                                            try {
                                                                const emailInput = document.getElementById('email');
                                                                const emailVal = (emailInput && emailInput.value ? emailInput.value : '').trim();
                                                                const query = emailVal ? `?email=${encodeURIComponent(emailVal)}` : '';

                                                                const optsRes = await fetch(`/webauthn/authentication/options${query}`, { credentials: 'same-origin' });
                                                                if (!optsRes.ok) {
                                                                    const err = await optsRes.json().catch(() => ({}));
                                                                    const msg = err && err.error ? err.error : `Failed to get authentication options (${optsRes.status})`;
                                                                    alert(msg);
                                                                    return;
                                                                }
                                                                const opts = await optsRes.json();
                                                                if (!opts || !opts.challenge) {
                                                                    console.error('Invalid authentication options:', opts);
                                                                    alert('Passkey sign-in unavailable: invalid options received.');
                                                                    return;
                                                                }
                                                                const asseResp = await SimpleWebAuthnBrowser.startAuthentication(opts);
                                                                const verifyRes = await fetch('/webauthn/authentication/verify', {
                                                                    method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin', body: JSON.stringify(asseResp)
                                                                });
                                                                let out = {};
                                                                try {
                                                                    out = await verifyRes.json();
                                                                } catch (_) {
                                                                    // Fall through to generic error handling below
                                                                }
                                                                if (!verifyRes.ok) {
                                                                    const msg = out && out.error ? out.error : `Passkey sign-in failed (${verifyRes.status})`;
                                                                    alert(msg);
                                                                    return;
                                                                }
                                                                if (out.verified) {
                                                                    if (typeof window.clearServiceWorkerCache === 'function') {
                                                                        window.clearServiceWorkerCache();
                                                                    }
                                                                    window.location.href = '/feed';
                                                                } else {
                                                                    const msg = out && out.error ? out.error : 'Passkey sign-in failed';
                                                                    alert(msg);
                                                                }
                                                            } catch (e) {
                                                                console.error(e);
                                                                alert('This device may not support passkeys here.');
                                                            }
                                                        });
                                                    });
                                                </script>

            <!-- OAuth Providers -->
            <% const gp = providers && providers.googleEnabled; %>
            <% const mp = providers && providers.microsoftEnabled; %>
            <% const ap = providers && providers.appleEnabled; %>

            <div class="oauth-buttons">
            <% if (gp) { %>
            <a href="/auth/google" class="btn btn-google" style="display:flex;align-items:center;justify-content:center;gap:8px;text-decoration:none;">
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.875 2.684-6.615z" fill="#4285F4"/>
                    <path d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z" fill="#34A853"/>
                    <path d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707s.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z" fill="#FBBC05"/>
                    <path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" fill="#EA4335"/>
                </svg>
                Continue with Google
            </a>
            <% } else { %>
            <button class="btn btn-google" disabled style="opacity:.6;cursor:not-allowed;">Google not configured</button>
            <% } %>

            <% if (mp) { %>
            <a href="/auth/microsoft" class="btn btn-microsoft" style="display:flex;align-items:center;justify-content:center;gap:8px;text-decoration:none;background:#2F2F2F;border:2px solid #2F2F2F;color:#fff;padding:0.75rem 1.5rem;border-radius:8px;font-size:1rem;font-weight:600;">
                <svg width="21" height="21" viewBox="0 0 21 21" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="10" height="10" fill="#F25022"/>
                    <rect x="11" width="10" height="10" fill="#7FBA00"/>
                    <rect y="11" width="10" height="10" fill="#00A4EF"/>
                    <rect x="11" y="11" width="10" height="10" fill="#FFB900"/>
                </svg>
                Sign in with Microsoft
            </a>
            <% } else { %>
            <button class="btn btn-full" disabled style="opacity:.6;cursor:not-allowed;background:#2F2F2F;border:2px solid #2F2F2F;color:#fff;padding:0.75rem 1.5rem;border-radius:8px;font-size:1rem;font-weight:600;">Microsoft not configured</button>
            <% } %>

                        <% if (ap) { %>
                        <a href="/auth/apple" class="apple-signin" aria-label="Continue with Apple">
                            <svg aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" focusable="false" style="color:#fff;">
                                <path d="M16.365 1.43c0 1.14-.47 2.244-1.223 3.06-.783.85-2.06 1.5-3.144 1.43-.13-1.1.52-2.27 1.266-3.03.86-.86 2.31-1.48 3.1-1.46zM20.86 17.05c-.6 1.38-.89 1.98-1.67 3.2-1.08 1.65-2.6 3.7-4.48 3.72-1.67.03-2.1-1.07-4.37-1.06-2.26.02-2.75 1.09-4.43 1.06-1.87-.03-3.31-1.87-4.4-3.52-3.01-4.57-3.32-9.93-1.47-12.77 1.32-2.02 3.4-3.2 5.36-3.2 1.99 0 3.24 1.08 4.89 1.08 1.62 0 2.61-1.08 4.9-1.08 1.76 0 3.63.96 4.94 2.62-4.33 2.37-3.63 8.57.63 10.03z"/>
                            </svg>
                            <span>continue with apple</span>
                        </a>
                        <% } else { %>
                        <button class="apple-signin" disabled title="Apple requires HTTPS callback" aria-disabled="true" style="opacity:.6;cursor:not-allowed;">
                            <svg aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" focusable="false" style="color:#fff;">
                                <path d="M16.365 1.43c0 1.14-.47 2.244-1.223 3.06-.783.85-2.06 1.5-3.144 1.43-.13-1.1.52-2.27 1.266-3.03.86-.86 2.31-1.48 3.1-1.46zM20.86 17.05c-.6 1.38-.89 1.98-1.67 3.2-1.08 1.65-2.6 3.7-4.48 3.72-1.67.03-2.1-1.07-4.37-1.06-2.26.02-2.75 1.09-4.43 1.06-1.87-.03-3.31-1.87-4.4-3.52-3.01-4.57-3.32-9.93-1.47-12.77 1.32-2.02 3.4-3.2 5.36-3.2 1.99 0 3.24 1.08 4.89 1.08 1.62 0 2.61-1.08 4.9-1.08 1.76 0 3.63.96 4.94 2.62-4.33 2.37-3.63 8.57.63 10.03z"/>
                            </svg>
                            <span>continue with apple</span>
                        </button>
                        <% } %>
            </div>

            <!-- Sign Up Link -->
            <div class="auth-footer">
                <p>Don't have an account? <a href="/register" class="auth-link">Sign up</a></p>
            </div>
        </div>
    </div>
</section>

<%- include('partials/footer') %>
