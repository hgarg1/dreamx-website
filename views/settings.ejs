<%- include('partials/header') %>

<section class="settings-wrapper">
  <h1 class="settings-title">Settings</h1>

  <!-- Toast Notification (replaces bulky inline success/error banners) -->
  <!-- Toasts now provided globally via footer include -->
  
  <% if (typeof refund_submitted !== 'undefined' && refund_submitted) { %>
    <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:20px;border-radius:12px;margin-bottom:24px;box-shadow:0 4px 12px rgba(16,185,129,0.3);">
      <h3 style="margin:0 0 8px;font-size:1.2rem;font-weight:700;">‚úì Refund Request Submitted</h3>
      <p style="margin:0;font-size:0.95rem;opacity:0.95;">Your refund request has been successfully submitted. Our team will review it within 3-5 business days and notify you via email.</p>
    </div>
  <% } %>

  <!-- Account Section -->
  <div class="settings-card">
    <h2 class="settings-card-title">Account</h2>
    <form action="/settings/account" method="POST">
      <div class="settings-field-group">
        <label class="settings-label" for="accountEmail">Email</label>
        <input id="accountEmail" name="email" type="email" class="settings-input" value="<%= authUser.email %>" required />
      </div>
      <div class="settings-field-group">
        <label class="settings-label" for="accountDisplayName">Display Name</label>
        <input id="accountDisplayName" name="displayName" type="text" class="settings-input" value="<%= authUser.displayName %>" required />
      </div>
      <div class="settings-field-group">
        <label class="settings-label" for="accountHandle">Handle</label>
        <div style="position:relative;">
          <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#6b7280;font-weight:500;">@</span>
          <input id="accountHandle" name="handle" type="text" class="settings-input" 
                 style="padding-left:28px;" 
                 value="<%= authUser.handle || '' %>" 
                 pattern="[a-z0-9_]{3,20}"
                 required />
        </div>
        <small style="color:#6b7280;font-size:0.8rem;margin-top:4px;display:block;">
          3-20 characters: lowercase letters, numbers, and underscores only
        </small>
      </div>
      <div class="settings-actions-inline">
        <button type="submit" class="settings-btn primary">Update Account</button>
      </div>
    </form>
    <div class="settings-actions-inline" style="margin-top:16px;border-top:1px solid #eee;padding-top:16px;">
      <button onclick="document.getElementById('passwordModal').style.display='block'" class="settings-link" style="background:none;border:none;cursor:pointer;color:#7C3AED;text-decoration:underline;">Change password ‚Üí</button>
    </div>
  </div>

  <!-- Password Change Modal -->
  <div id="passwordModal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;">
    <div style="background:white;padding:32px;border-radius:16px;max-width:480px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
      <h3 style="margin:0 0 20px;font-size:1.5rem;font-weight:700;">Change Password</h3>
      <form action="/settings/password" method="POST">
        <div class="settings-field-group">
          <label class="settings-label" for="currentPassword">Current Password</label>
          <input id="currentPassword" name="currentPassword" type="password" class="settings-input" required />
        </div>
        <div class="settings-field-group">
          <label class="settings-label" for="newPassword">New Password</label>
          <input id="newPassword" name="newPassword" type="password" class="settings-input" required />
          <div id="pwdStrength" style="margin-top:8px;display:none;">
            <div style="display:flex;gap:4px;margin-bottom:6px;">
              <div class="strength-bar" data-level="1"></div>
              <div class="strength-bar" data-level="2"></div>
              <div class="strength-bar" data-level="3"></div>
              <div class="strength-bar" data-level="4"></div>
              <div class="strength-bar" data-level="5"></div>
            </div>
            <div id="pwdStrengthText" style="font-size:0.85rem;"></div>
            <ul id="pwdChecklist" style="font-size:0.8rem;color:#666;margin:6px 0 0 0;padding:0 0 0 18px;list-style:none;">
              <li id="pwd-length"><span style="color:#ccc;">‚úó</span> At least 8 characters</li>
              <li id="pwd-upper"><span style="color:#ccc;">‚úó</span> One uppercase letter</li>
              <li id="pwd-lower"><span style="color:#ccc;">‚úó</span> One lowercase letter</li>
              <li id="pwd-number"><span style="color:#ccc;">‚úó</span> One number</li>
              <li id="pwd-special"><span style="color:#ccc;">‚úó</span> One special character</li>
            </ul>
          </div>
        </div>
        <div class="settings-field-group">
          <label class="settings-label" for="confirmPassword">Confirm New Password</label>
          <input id="confirmPassword" name="confirmPassword" type="password" class="settings-input" required />
        </div>
        <div style="display:flex;gap:12px;margin-top:24px;">
          <button type="submit" class="settings-btn primary">Change Password</button>
          <button type="button" onclick="document.getElementById('passwordModal').style.display='none'" class="settings-btn" style="background:#eee;">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <style>
    #passwordModal { display: none; }
    #passwordModal[style*="display:flex"], #passwordModal[style*="display: flex"] { display: flex !important; }
    .strength-bar {
      height: 6px;
      flex: 1;
      background: #e0e0e0;
      border-radius: 3px;
      transition: background-color 0.3s;
    }
    .strength-bar.active-weak { background: #ef4444; }
    .strength-bar.active-fair { background: #f97316; }
    .strength-bar.active-good { background: #eab308; }
    .strength-bar.active-strong { background: #22c55e; }
    .strength-bar.active-excellent { background: #10b981; }
  </style>

  <script>
    const pwdInput = document.getElementById('newPassword');
    const pwdStrengthDiv = document.getElementById('pwdStrength');
    const pwdStrengthText = document.getElementById('pwdStrengthText');
    const pwdBars = document.querySelectorAll('.strength-bar');
    
    const pwdChecks = {
      length: { el: document.getElementById('pwd-length'), test: (p) => p.length >= 8 },
      upper: { el: document.getElementById('pwd-upper'), test: (p) => /[A-Z]/.test(p) },
      lower: { el: document.getElementById('pwd-lower'), test: (p) => /[a-z]/.test(p) },
      number: { el: document.getElementById('pwd-number'), test: (p) => /[0-9]/.test(p) },
      special: { el: document.getElementById('pwd-special'), test: (p) => /[^A-Za-z0-9]/.test(p) }
    };

    pwdInput.addEventListener('input', function() {
      const pwd = this.value;
      if (!pwd) {
        pwdStrengthDiv.style.display = 'none';
        return;
      }
      pwdStrengthDiv.style.display = 'block';
      
      let score = 0;
      Object.values(pwdChecks).forEach(c => {
        if (c.test(pwd)) score++;
      });

      pwdBars.forEach((bar, i) => {
        bar.className = 'strength-bar';
        if (i < score) {
          if (score === 1) bar.classList.add('active-weak');
          else if (score === 2) bar.classList.add('active-fair');
          else if (score === 3) bar.classList.add('active-good');
          else if (score === 4) bar.classList.add('active-strong');
          else bar.classList.add('active-excellent');
        }
      });

      const labels = ['Weak', 'Fair', 'Good', 'Strong', 'Excellent'];
      const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#10b981'];
      pwdStrengthText.textContent = labels[score - 1] || '';
      pwdStrengthText.style.color = colors[score - 1] || '#666';

      Object.keys(pwdChecks).forEach(key => {
        const check = pwdChecks[key];
        const icon = check.el.querySelector('span');
        if (check.test(pwd)) {
          icon.style.color = '#22c55e';
          icon.textContent = '‚úì';
        } else {
          icon.style.color = '#ccc';
          icon.textContent = '‚úó';
        }
      });
    });

    document.querySelector('[onclick*="passwordModal"]').addEventListener('click', function() {
      document.getElementById('passwordModal').style.display = 'flex';
    });
  </script>

  <!-- Account Status Section -->
  <div class="settings-card">
    <h2 class="settings-card-title">Account Status</h2>
    <% 
      const accountStatus = authUser.account_status || 'active';
      const suspensionUntil = authUser.suspension_until;
      const suspensionReason = authUser.suspension_reason;
    %>
    
    <% if (accountStatus === 'active') { %>
      <div style="display:flex;align-items:center;gap:16px;padding:20px;background:linear-gradient(135deg, #10b981, #059669);border-radius:12px;">
        <div style="flex-shrink:0;">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
        </div>
        <div style="color:white;">
          <h3 style="margin:0 0 4px;font-size:1.25rem;font-weight:700;">Account in Good Standing</h3>
          <p style="margin:0;font-size:0.9rem;opacity:0.9;">Your account is active with full access to all features.</p>
        </div>
      </div>
    <% } else if (accountStatus === 'suspended') { %>
      <div style="display:flex;align-items:center;gap:16px;padding:20px;background:linear-gradient(135deg, #f59e0b, #d97706);border-radius:12px;">
        <div style="flex-shrink:0;">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="10" y1="15" x2="10" y2="15"></line>
            <line x1="14" y1="15" x2="14" y2="15"></line>
          </svg>
        </div>
        <div style="color:white;">
          <h3 style="margin:0 0 4px;font-size:1.25rem;font-weight:700;">Account Suspended</h3>
          <% if (suspensionReason) { %>
            <p style="margin:0 0 8px;font-size:0.9rem;opacity:0.9;"><strong>Reason:</strong> <%= suspensionReason %></p>
          <% } %>
          <% if (suspensionUntil) { %>
            <p style="margin:0;font-size:0.9rem;opacity:0.9;">
              <strong>Suspension ends:</strong> <%= new Date(suspensionUntil).toLocaleString() %>
            </p>
          <% } %>
        </div>
      </div>
      <div style="margin-top:16px;">
        <a href="/account-appeal" class="settings-btn" style="display:inline-block;background:#f59e0b;color:white;text-decoration:none;">Appeal Suspension</a>
      </div>
    <% } else if (accountStatus === 'banned') { %>
      <div style="display:flex;align-items:center;gap:16px;padding:20px;background:linear-gradient(135deg, #ef4444, #dc2626);border-radius:12px;">
        <div style="flex-shrink:0;">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
          </svg>
        </div>
        <div style="color:white;">
          <h3 style="margin:0 0 4px;font-size:1.25rem;font-weight:700;">Account Banned</h3>
          <% if (suspensionReason) { %>
            <p style="margin:0;font-size:0.9rem;opacity:0.9;"><strong>Reason:</strong> <%= suspensionReason %></p>
          <% } else { %>
            <p style="margin:0;font-size:0.9rem;opacity:0.9;">Your account has been permanently banned for violating our community guidelines.</p>
          <% } %>
        </div>
      </div>
      <div style="margin-top:16px;">
        <a href="/account-appeal" class="settings-btn" style="display:inline-block;background:#ef4444;color:white;text-decoration:none;">Appeal Ban</a>
      </div>
    <% } %>
  </div>

  <!-- Notifications Section -->
  <div class="settings-card">
    <h2 class="settings-card-title">Notifications</h2>
    <form action="/settings/notifications" method="POST" class="settings-form">
      <label class="toggle-row">
        <input type="checkbox" name="email_notifications" <%= authUser.email_notifications ? 'checked' : '' %> />
        <span>Email notifications</span>
      </label>
      <label class="toggle-row">
        <input type="checkbox" name="push_notifications" <%= authUser.push_notifications ? 'checked' : '' %> />
        <span>Push notifications</span>
      </label>
      <label class="toggle-row">
        <input type="checkbox" name="message_notifications" <%= authUser.message_notifications ? 'checked' : '' %> />
        <span>New message notifications</span>
      </label>
      <div class="settings-actions-inline" style="gap:8px;">
        <button type="button" id="enablePushNowBtn" class="settings-btn primary">Enable Push Now</button>
      </div>
      <div class="settings-actions-inline">
        <button type="submit" class="settings-btn primary">Save Notification Preferences</button>
      </div>
    </form>
  </div>

  <!-- Connected Accounts -->
  <div class="settings-card">
    <h2 class="settings-card-title">Connected Accounts</h2>
    <p class="settings-note">Link your social accounts for faster sign-in.</p>
    <div style="display:flex;flex-direction:column;gap:12px;">
      <div style="display:flex;align-items:center;gap:12px;justify-content:space-between;">
        <div>Google</div>
        <div>
          <% if (linked && linked.google) { %>
            <form action="/settings/connections/unlink" method="POST" style="display:inline;">
              <input type="hidden" name="provider" value="google" />
              <button type="submit" class="settings-btn" style="background:#fee2e2;color:#991b1b;border:1px solid #fecaca;">Disconnect</button>
            </form>
          <% } else { %>
            <a href="/auth/google?mode=link" class="btn-provider btn-google" style="text-decoration:none;">
              <svg width="18" height="18" viewBox="0 0 48 48" aria-hidden="true"><path fill="#EA4335" d="M24 9.5c3.54 0 6.72 1.22 9.22 3.6l6.9-6.9C35.9 2.4 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.99 6.2C12.52 13.22 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.5 24c0-1.64-.15-3.2-.44-4.7H24v9.02h12.7c-.55 2.98-2.2 5.5-4.7 7.2l7.17 5.57C43.92 37.5 46.5 31.3 46.5 24z"/><path fill="#FBBC05" d="M10.55 27.98c-.5-1.5-.79-3.1-.79-4.98s.29-3.48.79-4.98l-7.99-6.2C.92 14.24 0 18.02 0 23s.92 8.76 2.56 11.18l7.99-6.2z"/><path fill="#34A853" d="M24 46c6.48 0 11.92-2.13 15.89-5.8l-7.17-5.57c-2 1.35-4.56 2.17-8.72 2.17-6.26 0-11.48-3.72-13.45-9.72l-7.99 6.2C6.51 42.62 14.62 46 24 46z"/></svg>
              <span>Connect</span>
            </a>
          <% } %>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:12px;justify-content:space-between;">
        <div>Microsoft</div>
        <div>
          <% if (linked && linked.microsoft) { %>
            <form action="/settings/connections/unlink" method="POST" style="display:inline;">
              <input type="hidden" name="provider" value="microsoft" />
              <button type="submit" class="settings-btn" style="background:#fee2e2;color:#991b1b;border:1px solid #fecaca;">Disconnect</button>
            </form>
          <% } else { %>
            <a href="/auth/microsoft?mode=link" class="btn-provider btn-microsoft" style="text-decoration:none;">
              <svg width="18" height="18" viewBox="0 0 23 23" aria-hidden="true">
                <rect width="10" height="10" x="1" y="1" fill="#F25022"/>
                <rect width="10" height="10" x="12" y="1" fill="#7FBA00"/>
                <rect width="10" height="10" x="1" y="12" fill="#00A4EF"/>
                <rect width="10" height="10" x="12" y="12" fill="#FFB900"/>
              </svg>
              <span>Connect</span>
            </a>
          <% } %>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:12px;justify-content:space-between;">
        <div>Apple</div>
        <div>
          <% if (linked && linked.apple) { %>
            <form action="/settings/connections/unlink" method="POST" style="display:inline;">
              <input type="hidden" name="provider" value="apple" />
              <button type="submit" class="settings-btn" style="background:#fee2e2;color:#991b1b;border:1px solid #fecaca;">Disconnect</button>
            </form>
          <% } else { %>
            <a href="/auth/apple?mode=link" class="btn-provider btn-apple" aria-label="Connect Apple" style="text-decoration:none;">
              <svg aria-hidden="true" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" focusable="false">
                <path d="M16.365 1.43c0 1.14-.47 2.244-1.223 3.06-.783.85-2.06 1.5-3.144 1.43-.13-1.1.52-2.27 1.266-3.03.86-.86 2.31-1.48 3.1-1.46zM20.86 17.05c-.6 1.38-.89 1.98-1.67 3.2-1.08 1.65-2.6 3.7-4.48 3.72-1.67.03-2.1-1.07-4.37-1.06-2.26.02-2.75 1.09-4.43 1.06-1.87-.03-3.31-1.87-4.4-3.52-3.01-4.57-3.32-9.93-1.47-12.77 1.32-2.02 3.4-3.2 5.36-3.2 1.99 0 3.24 1.08 4.89 1.08 1.62 0 2.61-1.08 4.9-1.08 1.76 0 3.63.96 4.94 2.62-4.33 2.37-3.63 8.57.63 10.03z"/>
              </svg>
              <span>Connect Apple</span>
            </a>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Passkeys (WebAuthn) -->
  <div class="settings-card">
    <h2 class="settings-card-title">Passkeys</h2>
    <p class="settings-note">Create a passkey to sign in with Face ID, Touch ID, or your device‚Äôs screen lock.</p>
    <div class="settings-actions-inline">
      <button id="btn-create-passkey" class="settings-btn primary" type="button">Create a Passkey</button>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const btn = document.getElementById('btn-create-passkey');
        if (!btn || !window.SimpleWebAuthnBrowser) return;
        btn.addEventListener('click', async () => {
          try {
            const optsRes = await fetch('/webauthn/registration/options');
            const opts = await optsRes.json();
            const attResp = await SimpleWebAuthnBrowser.startRegistration(opts);
            const verifyRes = await fetch('/webauthn/registration/verify', {
              method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(attResp)
            });
            const out = await verifyRes.json();
            if (out.verified) {
              alert('Passkey saved to this device!');
            } else {
              alert('Could not save passkey on this device.');
            }
          } catch (e) {
            console.error(e);
            alert('Passkey setup is not available on this browser or origin.');
          }
        });
      });
    </script>
  </div>

  <!-- Billing Section -->
  <div class="settings-card">
    <h2 class="settings-card-title">Billing</h2>
    <p class="settings-note" style="color:#6b7280;margin-bottom:20px;">Manage your subscription and payment methods.</p>
    
    <!-- Current Subscription -->
    <div style="background:#f9fafb;padding:20px;border-radius:12px;margin-bottom:20px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <div>
          <h3 style="font-size:1.1rem;font-weight:700;margin:0;text-transform:capitalize;"><%= subscription.tier.replace('-', ' ') %> Plan</h3>
          <p style="color:#6b7280;font-size:0.9rem;margin:4px 0 0;">
            Status: <span class="status-badge <%= (subscription.status === 'active' ? 'is-active' : 'is-cancelled') %>"><%= subscription.status %></span>
          </p>
        </div>
        <button onclick="document.getElementById('subscriptionModal').style.display='flex'" class="settings-btn primary">Manage Subscription</button>
      </div>
      <% if (subscription.ends_at) { %>
        <p style="color:#6b7280;font-size:0.85rem;margin:8px 0 0;">
          <%= subscription.auto_renew ? 'Renews' : 'Ends' %> on: <%= new Date(subscription.ends_at).toLocaleDateString() %>
        </p>
      <% } %>
    </div>
    
    <div style="display:flex;gap:16px;flex-wrap:wrap;">
      <button onclick="document.getElementById('paymentMethodsModal').style.display='flex'" class="settings-link" style="color:#ec4899;text-decoration:none;font-weight:600;display:inline-flex;align-items:center;gap:4px;background:none;border:none;cursor:pointer;">Payment methods ‚Üí</button>
      <button onclick="document.getElementById('invoicesModal').style.display='flex'" class="settings-link" style="color:#ec4899;text-decoration:none;font-weight:600;display:inline-flex;align-items:center;gap:4px;background:none;border:none;cursor:pointer;">View invoices ‚Üí</button>
      <button onclick="document.getElementById('chargesModal').style.display='flex'" class="settings-link" style="color:#ec4899;text-decoration:none;font-weight:600;display:inline-flex;align-items:center;gap:4px;background:none;border:none;cursor:pointer;">Billing history ‚Üí</button>
    </div>
  </div>

  <!-- Subscription Management Modal -->
  <div id="subscriptionModal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;">
    <div style="background:white;padding:32px;border-radius:16px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
      <h3 style="margin:0 0 20px;font-size:1.5rem;font-weight:700;">Manage Subscription</h3>
      
      <div style="background:#f9fafb;padding:20px;border-radius:12px;margin-bottom:20px;">
        <p style="font-weight:600;margin:0 0 8px;">Current Plan: <span style="text-transform:capitalize;"><%= subscription.tier.replace('-', ' ') %></span></p>
          <p style="color:#6b7280;font-size:0.9rem;margin:0;">Want to change your plan? Visit the <a href="/pricing" style="color:#7C3AED;">pricing page</a> to upgrade or downgrade.</p>
      </div>
      
      <% if (subscription.tier !== 'free' && subscription.status === 'active') { %>
        <form action="/settings/billing/subscription/cancel" method="POST" onsubmit="return confirm('Are you sure you want to cancel your subscription? You will lose access to premium features at the end of your billing period.');">
          <button type="submit" class="settings-btn" style="background:#fee2e2;color:#991b1b;border:1px solid #fecaca;width:100%;margin-bottom:12px;">Cancel Subscription</button>
        </form>
      <% } %>
      
      <button type="button" onclick="document.getElementById('subscriptionModal').style.display='none'" class="settings-btn" style="background:#eee;width:100%;">Close</button>
    </div>
  </div>

  <!-- Billing History Modal -->
  <div id="chargesModal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;">
    <div style="background:white;padding:32px;border-radius:16px;max-width:800px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
        <h3 style="margin:0;font-size:1.5rem;font-weight:700;">Billing History & Charges</h3>
        <a href="/refund-request" class="settings-btn" style="background:linear-gradient(135deg,#ff4fa3,#764ba2);color:white;text-decoration:none;padding:10px 20px;font-size:0.9rem;">Request Refund</a>
      </div>
      
      <% if (charges && charges.length > 0) { %>
        <div style="background:#fffbeb;border-left:4px solid #f59e0b;padding:16px;border-radius:8px;margin-bottom:24px;">
          <p style="margin:0;font-size:0.9rem;color:#92400e;">
            <strong>üí° Need help?</strong> If you have any issues with a charge, you can request a refund using the button above.
          </p>
        </div>
        
        <div style="overflow-x:auto;">
          <table style="width:100%;border-collapse:collapse;">
            <thead>
              <tr style="background:#f9fafb;">
                <th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;font-weight:600;">Date</th>
                <th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;font-weight:600;">Description</th>
                <th style="padding:12px;text-align:right;border-bottom:2px solid #e5e7eb;font-weight:600;">Amount</th>
                <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;font-weight:600;">Status</th>
              </tr>
            </thead>
            <tbody>
              <% charges.forEach(function(charge) { %>
                <tr>
                  <td style="padding:12px;border-bottom:1px solid #e5e7eb;"><%= new Date(charge.charge_date).toLocaleDateString() %></td>
                  <td style="padding:12px;border-bottom:1px solid #e5e7eb;">
                    <%= charge.description %>
                    <% if (charge.tier) { %>
                      <span style="display:inline-block;margin-left:8px;padding:2px 8px;background:#dbeafe;color:#1e40af;font-size:0.75rem;border-radius:4px;"><%= charge.tier.replace('-', ' ') %></span>
                    <% } %>
                  </td>
                  <td style="padding:12px;border-bottom:1px solid #e5e7eb;text-align:right;font-weight:600;">$<%= charge.amount.toFixed(2) %></td>
                  <td style="padding:12px;border-bottom:1px solid #e5e7eb;text-align:center;">
                    <span class="charge-status <%= charge.status === 'completed' ? 'completed' : (charge.status === 'pending' ? 'pending' : 'refunded') %>"><%= charge.status %></span>
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      <% } else { %>
        <div style="text-align:center;padding:40px 20px;">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#d1d5db" stroke-width="2" style="margin:0 auto 16px;">
            <line x1="12" y1="1" x2="12" y2="23"></line>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
          </svg>
          <p style="color:#6b7280;margin:0;">No charges yet. Your billing history will appear here.</p>
        </div>
      <% } %>
      
      <!-- Upcoming Charges -->
      <% if (subscription && subscription.tier !== 'free' && subscription.status === 'active' && subscription.auto_renew && subscription.ends_at) { %>
        <div style="margin-top:32px;padding-top:24px;border-top:2px solid #e5e7eb;">
          <h4 style="font-size:1.1rem;font-weight:700;margin:0 0 16px;">Upcoming Charges</h4>
          <div style="background:linear-gradient(135deg,#f0f9ff,#e0f2fe);padding:20px;border-radius:12px;border:1px solid #bae6fd;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div>
                <p style="margin:0 0 4px;font-weight:600;color:#0c4a6e;"><%= subscription.tier.replace('-', ' ') %> Plan Renewal</p>
                <p style="margin:0;font-size:0.85rem;color:#0369a1;">Next billing date: <%= new Date(subscription.ends_at).toLocaleDateString() %></p>
              </div>
              <div style="text-align:right;">
                <p style="margin:0;font-size:1.25rem;font-weight:700;color:#0c4a6e;">
                  $<%=
                    subscription.tier === 'pro' ? '9.99' :
                    subscription.tier === 'pro-seller' ? '19.99' :
                    subscription.tier === 'elite-seller' ? '49.99' :
                    subscription.tier === 'enterprise' ? '99.99' : '0.00'
                  %>
                </p>
              </div>
            </div>
          </div>
        </div>
      <% } %>
      
      <button type="button" onclick="document.getElementById('chargesModal').style.display='none'" class="settings-btn" style="background:#eee;width:100%;margin-top:20px;">Close</button>
    </div>
  </div>

  <style>
    .charge-status{display:inline-block;padding:4px 12px;border-radius:12px;font-weight:600;text-transform:capitalize;font-size:0.85rem;background:#f3f4f6;color:#111827;}
    .charge-status.completed{background:#d1fae5;color:#065f46;}
    .charge-status.pending{background:#fef3c7;color:#92400e;}
    .charge-status.refunded{background:#dbeafe;color:#1e40af;}
  </style>

  <!-- Payment Methods Modal -->
  <div id="paymentMethodsModal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;">
    <div style="background:white;padding:32px;border-radius:16px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
      <h3 style="margin:0 0 20px;font-size:1.5rem;font-weight:700;">Payment Methods</h3>
      
      <% if (paymentMethods.length > 0) { %>
        <div style="margin-bottom:24px;">
          <% paymentMethods.forEach(function(pm) { %>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:16px;background:#f9fafb;border-radius:8px;margin-bottom:12px;">
              <div>
                <p style="margin:0;font-weight:600;text-transform:capitalize;"><%= pm.card_type %> ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ <%= pm.last_four %></p>
                <p style="margin:4px 0 0;font-size:0.85rem;color:#6b7280;">Expires <%= pm.expiry_month %>/<%= pm.expiry_year %></p>
                <% if (pm.is_default) { %>
                  <span style="display:inline-block;margin-top:4px;padding:2px 8px;background:#dbeafe;color:#1e40af;font-size:0.75rem;border-radius:4px;font-weight:600;">Default</span>
                <% } %>
              </div>
              <div style="display:flex;gap:8px;">
                <% if (!pm.is_default) { %>
                  <form action="/settings/billing/payment-methods/<%= pm.id %>/set-default" method="POST" style="display:inline;">
                    <button type="submit" class="settings-btn" style="font-size:0.85rem;padding:6px 12px;">Set Default</button>
                  </form>
                <% } %>
                <form action="/settings/billing/payment-methods/<%= pm.id %>/delete" method="POST" style="display:inline;" onsubmit="return confirm('Remove this payment method?');">
                  <button type="submit" class="settings-btn" style="background:#fee2e2;color:#991b1b;font-size:0.85rem;padding:6px 12px;">Remove</button>
                </form>
              </div>
            </div>
          <% }); %>
        </div>
      <% } else { %>
        <p style="color:#6b7280;margin-bottom:24px;">No payment methods saved yet.</p>
      <% } %>
      
      <button type="button" onclick="document.getElementById('addPaymentMethodForm').style.display='block';this.style.display='none'" class="settings-btn primary" style="width:100%;margin-bottom:12px;">+ Add Payment Method</button>
      
      <form id="addPaymentMethodForm" action="/settings/billing/payment-methods/add" method="POST" style="display:none;margin-bottom:12px;">
        <div class="settings-field-group">
          <label class="settings-label">Card Type</label>
          <select name="cardType" class="settings-input" required>
            <option value="visa">Visa</option>
            <option value="mastercard">Mastercard</option>
            <option value="amex">American Express</option>
            <option value="discover">Discover</option>
          </select>
        </div>
        <div class="settings-field-group">
          <label class="settings-label">Card Number (last 4 digits)</label>
          <input name="lastFour" type="text" class="settings-input" pattern="[0-9]{4}" maxlength="4" placeholder="1234" required />
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div class="settings-field-group">
            <label class="settings-label">Expiry Month</label>
            <input name="expiryMonth" type="number" class="settings-input" min="1" max="12" placeholder="12" required />
          </div>
          <div class="settings-field-group">
            <label class="settings-label">Expiry Year</label>
            <input name="expiryYear" type="number" class="settings-input" min="2025" max="2050" placeholder="2025" required />
          </div>
        </div>
        <label class="toggle-row" style="margin-bottom:16px;">
          <input type="checkbox" name="isDefault" />
          <span>Set as default payment method</span>
        </label>
        <button type="submit" class="settings-btn primary" style="width:100%;">Save Payment Method</button>
      </form>
      
      <button type="button" onclick="document.getElementById('paymentMethodsModal').style.display='none'" class="settings-btn" style="background:#eee;width:100%;">Close</button>
    </div>
  </div>

  <!-- Invoices Modal -->
  <div id="invoicesModal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;">
    <div style="background:white;padding:32px;border-radius:16px;max-width:700px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
      <h3 style="margin:0 0 20px;font-size:1.5rem;font-weight:700;">Billing History</h3>
      
      <% if (invoices.length > 0) { %>
        <div style="overflow-x:auto;">
          <table style="width:100%;border-collapse:collapse;">
            <thead>
              <tr style="background:#f9fafb;">
                <th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;font-weight:600;">Date</th>
                <th style="padding:12px;text-align:left;border-bottom:2px solid #e5e7eb;font-weight:600;">Plan</th>
                <th style="padding:12px;text-align:right;border-bottom:2px solid #e5e7eb;font-weight:600;">Amount</th>
                <th style="padding:12px;text-align:center;border-bottom:2px solid #e5e7eb;font-weight:600;">Status</th>
              </tr>
            </thead>
            <tbody>
              <% invoices.forEach(function(inv) { %>
                <tr>
                  <td style="padding:12px;border-bottom:1px solid #e5e7eb;"><%= new Date(inv.invoice_date).toLocaleDateString() %></td>
                  <td style="padding:12px;border-bottom:1px solid #e5e7eb;text-transform:capitalize;"><%= inv.tier.replace('-', ' ') %></td>
                  <td style="padding:12px;border-bottom:1px solid #e5e7eb;text-align:right;font-weight:600;">$<%= inv.amount.toFixed(2) %></td>
                  <td style="padding:12px;border-bottom:1px solid #e5e7eb;text-align:center;">
                    <span class="inv-status <%= inv.status === 'paid' ? 'paid' : 'unpaid' %>"><%= inv.status %></span>
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      <% } else { %>
        <p style="color:#6b7280;">No invoices yet.</p>
      <% } %>
      
      <button type="button" onclick="document.getElementById('invoicesModal').style.display='none'" class="settings-btn" style="background:#eee;width:100%;margin-top:20px;">Close</button>
    </div>
  </div>

  <style>
    #subscriptionModal, #paymentMethodsModal, #invoicesModal, #chargesModal { display: none; }
    #subscriptionModal[style*="display:flex"], #subscriptionModal[style*="display: flex"],
    #paymentMethodsModal[style*="display:flex"], #paymentMethodsModal[style*="display: flex"],
    #invoicesModal[style*="display:flex"], #invoicesModal[style*="display: flex"],
    #chargesModal[style*="display:flex"], #chargesModal[style*="display: flex"] { 
      display: flex !important; 
    }
    .status-badge{font-weight:600;text-transform:capitalize;}
    .status-badge.is-active{color:#10b981;}
    .status-badge.is-cancelled{color:#ef4444;}
    .inv-status{display:inline-block;padding:4px 12px;border-radius:12px;font-weight:600;text-transform:capitalize;font-size:0.85rem;background:#f3f4f6;color:#111827;}
    .inv-status.paid{background:#d1fae5;color:#065f46;}
    .inv-status.unpaid{background:#fee2e2;color:#991b1b;}
  </style>

  <!-- Privacy Section -->
  <div class="settings-card">
    <h2 class="settings-card-title">Privacy</h2>
    <form action="/settings/privacy" method="POST" class="settings-form">
      <div class="settings-field-group">
        <label class="settings-label" for="profile_visibility">Profile visibility</label>
        <select id="profile_visibility" name="profile_visibility" class="settings-input" required>
          <option value="public" <%= (authUser.profile_visibility || 'public') === 'public' ? 'selected' : '' %>>Public ‚Äì visible to anyone</option>
          <option value="members" <%= (authUser.profile_visibility || 'public') === 'members' ? 'selected' : '' %>>Members ‚Äì only logged‚Äëin users</option>
          <option value="private" <%= (authUser.profile_visibility || 'public') === 'private' ? 'selected' : '' %>>Private ‚Äì only you</option>
        </select>
        <small style="color:#6b7280;font-size:0.85rem;">Controls who can view your profile details.</small>
      </div>

      <div class="settings-field-group">
        <label class="settings-label" for="allow_messages_from">Direct messages</label>
        <select id="allow_messages_from" name="allow_messages_from" class="settings-input" required>
          <option value="everyone" <%= (authUser.allow_messages_from || 'everyone') === 'everyone' ? 'selected' : '' %>>Allow messages from everyone</option>
          <option value="no_one" <%= (authUser.allow_messages_from || 'everyone') === 'no_one' ? 'selected' : '' %>>Block new messages</option>
        </select>
        <small style="color:#6b7280;font-size:0.85rem;">When blocked, others cannot start new chats with you.</small>
      </div>

      <label class="toggle-row">
        <input type="checkbox" name="discoverable_by_email" <%= authUser.discoverable_by_email ? 'checked' : '' %> />
        <span>Allow people to find me by my email</span>
      </label>

      <label class="toggle-row">
        <input type="checkbox" name="show_online_status" <%= authUser.show_online_status ? 'checked' : '' %> />
        <span>Show my online status</span>
      </label>

      <label class="toggle-row">
        <input type="checkbox" name="read_receipts" <%= authUser.read_receipts ? 'checked' : '' %> />
        <span>Send read receipts</span>
      </label>

      <div class="settings-actions-inline">
        <button type="submit" class="settings-btn primary">Save Privacy Settings</button>
      </div>
    </form>
  </div>

  <!-- Cashout Section (for eligible tiers) -->
  <% 
    const tier = subscription ? subscription.tier : 'free';
    const eligibleForCashout = ['pro_seller', 'elite_seller', 'enterprise'].includes(tier);
  %>
  <% if (eligibleForCashout) { %>
  <div class="settings-card">
    <h2 class="settings-card-title">Cashout & Banking</h2>
    <p style="color:#6b7280;margin-bottom:20px;">Configure your banking details to receive payments from your services.</p>
    
    <form action="/settings/banking" method="POST">
      <div class="settings-field-group">
        <label class="settings-label" for="bankCountry">Country</label>
        <select id="bankCountry" name="bankCountry" class="settings-input" required>
          <option value="">Select country</option>
          <option value="US" <%= authUser.bank_account_country === 'US' ? 'selected' : '' %>>United States</option>
          <option value="CA" <%= authUser.bank_account_country === 'CA' ? 'selected' : '' %>>Canada</option>
          <option value="GB" <%= authUser.bank_account_country === 'GB' ? 'selected' : '' %>>United Kingdom</option>
          <option value="AU" <%= authUser.bank_account_country === 'AU' ? 'selected' : '' %>>Australia</option>
        </select>
      </div>
      
      <div class="settings-field-group">
        <label class="settings-label" for="bankAccount">Account Number</label>
        <input id="bankAccount" name="bankAccount" type="text" class="settings-input" 
               value="<%= authUser.bank_account_number ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + authUser.bank_account_number.slice(-4) : '' %>" 
               placeholder="Enter account number" />
        <small style="color:#6b7280;font-size:0.8rem;">Your account details are encrypted and secure.</small>
      </div>
      
      <div class="settings-field-group">
        <label class="settings-label" for="routingNumber">Routing Number</label>
        <input id="routingNumber" name="routingNumber" type="text" class="settings-input" 
               value="<%= authUser.bank_routing_number || '' %>" 
               placeholder="Enter routing number" />
      </div>
      
      <div class="settings-actions-inline">
        <button type="submit" class="settings-btn primary">Update Banking Info</button>
      </div>
    </form>
  </div>
  <% } %>

  <!-- Danger Zone: Account Deletion -->
  <div class="settings-card" style="border:2px solid #fee2e2;background:#fffbeb;">
    <h2 class="settings-card-title" style="color:#dc2626;">Danger Zone</h2>
    <p style="color:#991b1b;margin-bottom:16px;font-weight:500;">‚ö†Ô∏è Deleting your account is permanent and cannot be undone.</p>
    <button type="button" onclick="document.getElementById('deleteAccountModal').style.display='flex'" 
            class="settings-btn" style="background:#fee2e2;color:#991b1b;border:2px solid #dc2626;font-weight:600;">Delete Account</button>
  </div>

  <!-- Delete Account Confirmation Modal -->
  <div id="deleteAccountModal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;">
    <div style="background:white;padding:32px;border-radius:16px;max-width:500px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.4);">
      <h3 style="margin:0 0 16px;font-size:1.5rem;font-weight:700;color:#dc2626;">Delete Your Account?</h3>
      <p style="color:#374151;margin-bottom:20px;line-height:1.6;">This action is <strong>permanent</strong> and will:</p>
      <ul style="color:#6b7280;margin-bottom:24px;line-height:1.8;padding-left:20px;">
        <li>Delete all your posts, messages, and services</li>
        <li>Remove your profile and account data</li>
        <li>Cancel any active subscriptions</li>
        <li>Forfeit any pending payouts</li>
      </ul>
      <p style="color:#991b1b;font-weight:600;margin-bottom:20px;">Type "DELETE" to confirm:</p>
      <form action="/settings/delete-account" method="POST" onsubmit="return confirm('Are you absolutely sure? This cannot be undone.');">
        <input type="text" id="deleteConfirm" name="confirmation" class="settings-input" placeholder="Type DELETE" required 
               pattern="DELETE" title="Must type DELETE exactly" style="margin-bottom:16px;" />
        <div style="display:flex;gap:12px;">
          <button type="submit" class="settings-btn" style="flex:1;background:#dc2626;color:white;font-weight:600;">Yes, Delete My Account</button>
          <button type="button" onclick="document.getElementById('deleteAccountModal').style.display='none'" 
                  class="settings-btn" style="flex:1;background:#e5e7eb;">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <style>
    #deleteAccountModal { display: none; }
    #deleteAccountModal[style*="display:flex"], #deleteAccountModal[style*="display: flex"] { display: flex !important; }
  </style>

  <!-- Your Passions Section -->
  <div class="settings-card">
    <h2 class="settings-card-title" style="text-transform:uppercase;font-size:0.875rem;font-weight:700;letter-spacing:0.05em;color:#374151;margin-bottom:16px;">YOUR PASSIONS</h2>
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px;">
      <% 
        const row = getUserById ? (typeof getUserById === 'function' ? getUserById(authUser.id) : null) : null;
        const userPassions = row && row.categories ? JSON.parse(row.categories) : [];
        if (userPassions.length > 0) {
          userPassions.forEach(function(passion) {
      %>
        <span style="padding:8px 20px;border-radius:24px;background:white;border:2px solid #e5e7eb;color:#374151;font-weight:600;font-size:0.9rem;"><%= passion %></span>
      <% 
          });
        } else {
      %>
        <span style="color:#6b7280;font-size:0.9rem;">No passions selected yet</span>
      <% } %>
    </div>
    <a href="/profile/edit" class="settings-link" style="color:#ec4899;text-decoration:none;font-weight:600;display:inline-flex;align-items:center;gap:4px;">Manage passions ‚Üí</a>
  </div>
</section>

<%- include('partials/footer') %>
